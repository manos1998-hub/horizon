<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Dining App - PERFECT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* ========== COMPLETE STYLES – UNCHANGED ========== */
        :root {
            --primary: #e63946;
            --primary-dark: #c1121f;
            --secondary: #457b9d;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #dc3545;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --admin: #6c757d;
            --background: #fefefe;
            --text: #212529;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
            --menu-bg: #ffffff;
            --cart-bg: #ffffff;
            --payment-bg: #ffffff;
            --button-text: #ffffff;
            --font-primary: 'Poppins', sans-serif;
            --font-secondary: 'Playfair Display', serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-primary); background-color: var(--background); color: var(--text); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header { background-color: var(--header-bg); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; position: relative; }
        .logo { font-family: var(--font-secondary); font-size: 36px; font-weight: 600; color: var(--primary); display: flex; align-items: center; flex: 1; }
        .logo i { margin-right: 30px; }
        .logo-img { width: 70px; height: 70px; border-radius: 8px; margin-right: 12px; object-fit: cover; display: none; }
        .header-center { display: flex; justify-content: center; flex: 1; }
        .help-button { background-color: transparent; border: 2px solid var(--secondary); color: var(--secondary); padding: 8px 20px; border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .help-button:hover { background-color: var(--secondary); color: var(--button-text); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(69, 123, 157, 0.2); }
        .header-right { display: flex; justify-content: flex-end; align-items: center; flex: 1; gap: 15px; }
        .my-orders-button { background-color: var(--secondary); color: var(--button-text); border: none; padding: 8px 16px; border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 15px; white-space: nowrap; }
        .my-orders-button:hover { background-color: var(--secondary); filter: brightness(0.9); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(69, 123, 157, 0.2); }
        .table-info { background-color: var(--light-gray); padding: 8px 16px; border-radius: 50px; font-weight: 500; display: flex; align-items: center; }
        .table-info i { margin-right: 8px; color: var(--secondary); }
        .app-section { display: none; padding: 30px 0; min-height: calc(100vh - 80px); background-color: var(--background); }
        .active-section { display: block; }
        .scanner-section { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .scanner-container { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 40px; width: 100%; max-width: 500px; margin: 20px auto; }
        .qr-placeholder { width: 250px; height: 250px; background: linear-gradient(45deg, var(--light-gray), var(--card-bg)); border-radius: 12px; margin: 30px auto; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .qr-placeholder::before { content: ""; position: absolute; width: 100%; height: 100%; background-image: linear-gradient(90deg, transparent 49%, rgba(0,0,0,0.05) 50%, transparent 51%), linear-gradient(transparent 49%, rgba(0,0,0,0.05) 50%, transparent 51%); background-size: 30px 30px; }
        .qr-placeholder i { font-size: 70px; color: var(--gray); margin-bottom: 15px; z-index: 1; }
        .qr-placeholder span { color: var(--gray); font-size: 16px; z-index: 1; }
        .demo-tables { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 30px; }
        .table-btn { padding: 12px 24px; background-color: var(--card-bg); border: 2px solid var(--light-gray); border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s; color: var(--text); }
        .table-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .section-title { font-family: var(--font-secondary); font-size: 32px; margin-bottom: 10px; color: var(--text); }
        .section-subtitle { color: var(--gray); margin-bottom: 30px; font-size: 16px; }
        .category-tabs { display: flex; overflow-x: auto; margin-bottom: 30px; padding-bottom: 5px; }
        .category-tab { padding: 10px 20px; background-color: var(--card-bg); border: none; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.3s; color: var(--text); }
        .category-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .menu-item { background-color: var(--card-bg); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: transform 0.3s; }
        .menu-item:hover { transform: translateY(-5px); }
        .item-image { height: 180px; background-color: var(--light-gray); background-size: cover; background-position: center; position: relative; }
        .item-content { padding: 20px; }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .item-name { font-size: 18px; font-weight: 600; color: var(--text); }
        .item-price { color: var(--primary); font-weight: 600; font-size: 18px; }
        .item-description { color: var(--gray); font-size: 14px; margin-bottom: 15px; }
        .item-footer { display: flex; justify-content: space-between; align-items: center; }
        .item-tags { display: flex; gap: 5px; }
        .item-tag { font-size: 11px; padding: 3px 8px; border-radius: 20px; background-color: var(--light-gray); color: var(--text); }
        .add-to-cart { background-color: var(--primary); color: var(--button-text); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s; }
        .add-to-cart:hover { background-color: var(--primary-dark); }
        .cart-container { display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; }
        .cart-items { background-color: var(--cart-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 25px; margin-bottom: 25px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--light-gray); }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-name { font-weight: 500; margin-bottom: 5px; color: var(--text); }
        .cart-item-price { color: var(--primary); font-weight: 500; }
        .cart-item-controls { display: flex; align-items: center; gap: 15px; }
        .quantity-control { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { width: 30px; height: 30px; border-radius: 50%; background-color: var(--light-gray); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); }
        .quantity { font-weight: 500; min-width: 20px; text-align: center; color: var(--text); }
        .remove-item { color: var(--gray); cursor: pointer; transition: color 0.3s; }
        .remove-item:hover { color: var(--primary); }
        .cart-summary { background-color: var(--cart-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 25px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; color: var(--text); }
        .summary-total { font-size: 20px; font-weight: 600; border-top: 2px solid var(--light-gray); padding-top: 15px; margin-top: 10px; }
        .summary-total .amount { color: var(--primary); }
        .payment-container { max-width: 600px; margin: 0 auto; }
        .payment-options { background-color: var(--payment-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; margin-bottom: 25px; }
        .option-group { margin-bottom: 30px; }
        .option-group:last-child { margin-bottom: 0; }
        .option-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--text); }
        .option-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .option-card { border: 2px solid var(--light-gray); border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; text-align: center; background-color: var(--card-bg); color: var(--text); }
        .option-card:hover { border-color: var(--primary); }
        .option-card.selected { border-color: var(--primary); background-color: rgba(230, 57, 70, 0.05); }
        .option-icon { font-size: 28px; margin-bottom: 10px; color: var(--secondary); }
        .option-name { font-weight: 500; margin-bottom: 5px; }
        .option-desc { font-size: 13px; color: var(--gray); }
        .payment-actions { display: flex; justify-content: space-between; margin-top: 30px; }
        .btn { padding: 15px 30px; border-radius: 8px; font-weight: 500; cursor: pointer; border: none; font-size: 16px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: var(--primary); color: var(--button-text); }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--card-bg); color: var(--text); border: 2px solid var(--light-gray); }
        .btn-secondary:hover { border-color: var(--gray); }
        .btn-success { background-color: var(--success); color: var(--button-text); }
        .btn-success:hover { background-color: #21867a; }
        .btn-danger { background-color: var(--danger); color: var(--button-text); }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: var(--warning); color: var(--text); }
        .btn-warning:hover { background-color: #d4ac2e; }
        .btn-help { background-color: var(--secondary); color: var(--button-text); border: none; }
        .btn-help:hover { background-color: #386c8a; }
        .btn i { margin-right: 8px; }
        .my-orders-container { max-width: 900px; margin: 0 auto; }
        .orders-list { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .order-card { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; transition: transform 0.3s; }
        .order-card:hover { transform: translateY(-3px); }
        .order-card-header { padding: 20px; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--light); }
        .order-card-title { font-size: 18px; font-weight: 600; color: var(--text); }
        .order-card-time { font-size: 14px; color: var(--gray); }
        .order-card-body { padding: 20px; }
        .order-items-summary { margin-bottom: 15px; }
        .order-item-summary { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--light-gray); color: var(--text); }
        .order-item-summary:last-child { border-bottom: none; }
        .order-item-summary-name { display: flex; align-items: center; gap: 10px; }
        .order-item-summary-quantity { background-color: var(--light-gray); color: var(--text); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .order-card-footer { padding: 15px 20px; background-color: var(--light); border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; }
        .order-total-summary { font-weight: 600; color: var(--primary); }
        .order-status-badge { display: inline-block; padding: 6px 15px; border-radius: 20px; font-size: 13px; font-weight: 500; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-preparing { background-color: #d1ecf1; color: #0c5460; }
        .status-ready { background-color: #d4edda; color: #155724; }
        .status-served { background-color: #cce5ff; color: #004085; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .no-orders-message { text-align: center; padding: 60px 20px; color: var(--gray); }
        .no-orders-message i { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }
        .no-orders-message h3 { margin-bottom: 10px; font-size: 22px; }
        .confirmation-container { max-width: 700px; margin: 0 auto; }
        .confirmation-card { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 40px; margin-bottom: 25px; text-align: center; }
        .confirmation-icon { width: 80px; height: 80px; background-color: rgba(42, 157, 143, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; }
        .confirmation-icon i { font-size: 36px; color: var(--success); }
        .order-number { font-size: 28px; font-weight: 600; color: var(--text); margin-bottom: 10px; }
        .order-number span { color: var(--primary); }
        .order-message { color: var(--gray); margin-bottom: 30px; font-size: 16px; }
        .order-details { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; margin-bottom: 25px; }
        .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--light-gray); }
        .details-title { font-size: 20px; font-weight: 600; color: var(--text); }
        .details-table { font-weight: 500; color: var(--secondary); }
        .order-items { margin-bottom: 30px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--light-gray); color: var(--text); }
        .order-item:last-child { border-bottom: none; }
        .order-item-name { display: flex; align-items: center; gap: 10px; }
        .order-item-quantity { background-color: var(--light-gray); color: var(--text); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; }
        .order-item-price { font-weight: 500; }
        .order-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 600; padding-top: 15px; margin-top: 15px; border-top: 2px solid var(--light-gray); color: var(--text); }
        .order-total .amount { color: var(--primary); }
        .payment-details { background-color: rgba(69, 123, 157, 0.05); border-radius: 10px; padding: 20px; margin-top: 25px; }
        .payment-details-title { font-weight: 600; margin-bottom: 15px; color: var(--secondary); }
        .payment-info { display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--text); }
        .payment-info:last-child { margin-bottom: 0; }
        .info-label { color: var(--gray); }
        .info-value { font-weight: 500; }
        .estimated-time { background-color: rgba(233, 196, 106, 0.1); border-radius: 10px; padding: 20px; margin-top: 25px; display: flex; align-items: center; gap: 15px; }
        .time-icon { font-size: 24px; color: var(--warning); }
        .time-text { font-size: 15px; color: var(--text); }
        .time-text strong { color: var(--text); }
        .cart-floating { position: fixed; bottom: 30px; right: 30px; background-color: var(--primary); color: var(--button-text); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; box-shadow: 0 6px 20px rgba(230, 57, 70, 0.3); z-index: 99; transition: all 0.3s; }
        .cart-floating:hover { background-color: var(--primary-dark); transform: translateY(-3px); }
        .cart-count { position: absolute; top: -5px; right: -5px; background-color: var(--secondary); color: var(--button-text); width: 24px; height: 24px; border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .admin-mode header { border-bottom: 3px solid var(--warning); }
        .admin-mode .admin-badge { background-color: var(--warning); color: var(--text); padding: 8px 16px; border-radius: 50px; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .admin-mode .logout-button { background-color: var(--danger); color: var(--button-text); border: none; padding: 8px 16px; border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .logout-button:hover { background-color: #c82333; transform: translateY(-2px); }
        .admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .admin-container { background-color: var(--card-bg); border-radius: var(--radius); width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative; }
        .admin-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; color: var(--gray); cursor: pointer; }
        .admin-tabs { display: flex; border-bottom: 2px solid var(--light-gray); margin-bottom: 25px; overflow-x: auto; }
        .admin-tab { padding: 12px 25px; background: none; border: none; font-weight: 500; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; color: var(--text); white-space: nowrap; }
        .admin-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .admin-content { display: none; }
        .admin-content.active { display: block; }
        .admin-form-group { margin-bottom: 20px; }
        .admin-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text); }
        .admin-input, .admin-textarea, .admin-select { width: 100%; padding: 10px 15px; border: 1px solid var(--light-gray); border-radius: 8px; font-family: var(--font-primary); font-size: 14px; background-color: var(--card-bg); color: var(--text); }
        .admin-textarea { min-height: 100px; resize: vertical; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .admin-card { background-color: var(--light); border-radius: 10px; padding: 20px; border: 1px solid var(--light-gray); transition: all 0.2s; }
        .admin-card:active { opacity: 0.7; }
        .admin-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .admin-card-title { font-weight: 600; font-size: 16px; color: var(--text); }
        .admin-card-actions { display: flex; gap: 8px; }
        .admin-small-btn { padding: 5px 10px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; }
        .tag-input-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .tag-display { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .tag-item { background-color: var(--light-gray); padding: 3px 8px; border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 5px; color: var(--text); }
        .categories-management { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .categories-list { flex: 1; min-width: 300px; }
        .add-category-form { flex: 1; min-width: 300px; }
        .categories-list-container { background-color: var(--light); border-radius: 10px; padding: 20px; max-height: 300px; overflow-y: auto; }
        .category-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--card-bg); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--light-gray); cursor: grab; transition: all 0.2s; }
        .category-item:last-child { margin-bottom: 0; }
        .category-item.dragging { opacity: 0.5; cursor: grabbing; }
        .category-item-name { font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .category-item-count { background-color: var(--light-gray); color: var(--text); padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .drag-handle-category { cursor: grab; color: var(--gray); margin-right: 8px; }
        .theme-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; max-height: 500px; overflow-y: auto; padding: 10px; }
        .theme-card { border: 2px solid var(--light-gray); border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s; background-color: var(--card-bg); }
        .theme-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .theme-card.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2); }
        .theme-colors-preview { height: 100px; display: grid; grid-template-columns: repeat(5, 1fr); }
        .theme-info { padding: 15px; text-align: center; }
        .theme-name { font-weight: 600; margin-bottom: 5px; color: var(--text); }
        .theme-category { font-size: 12px; color: var(--gray); background-color: var(--light-gray); padding: 2px 8px; border-radius: 10px; display: inline-block; }
        .theme-preview-small { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .theme-preview-small div { height: 4px; border-radius: 2px; }
        .customization-panel { display: flex; flex-direction: column; gap: 30px; }
        .customization-section { background-color: var(--light); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); }
        .section-title-small { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .font-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .font-option { padding: 20px; border-radius: 10px; border: 2px solid var(--light-gray); background-color: var(--card-bg); cursor: pointer; transition: all 0.3s; text-align: left; }
        .font-option:hover { border-color: var(--primary); transform: translateY(-2px); }
        .font-option.selected { border-color: var(--primary); background-color: rgba(230, 57, 70, 0.1); }
        .font-preview-large { font-size: 20px; font-weight: 600; margin-bottom: 10px; }
        .font-details { font-size: 14px; color: var(--gray); }
        .color-customization { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .color-option { padding: 15px; border-radius: 10px; background-color: var(--card-bg); border: 1px solid var(--light-gray); }
        .color-label { font-weight: 600; margin-bottom: 10px; display: block; color: var(--text); }
        .color-preview { width: 100%; height: 40px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.1); }
        .color-input-group { display: flex; align-items: center; gap: 10px; }
        .color-input { width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer; background: none; }
        .color-value { font-family: monospace; font-size: 14px; flex: 1; }
        .customization-preview { background-color: var(--card-bg); border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow); border: 2px solid var(--light-gray); margin-top: 20px; }
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray); }
        .preview-restaurant-name { font-family: var(--font-secondary); font-size: 22px; font-weight: 600; color: var(--primary); }
        .preview-content-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .preview-card { padding: 20px; border-radius: 10px; background-color: var(--light-gray); margin-bottom: 15px; }
        .preview-menu-item { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .preview-button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .preview-btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; border: none; }
        .customization-actions { display: flex; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray); }
        .image-upload-container { margin-bottom: 20px; }
        .image-preview { width: 100%; height: 200px; background-color: var(--light-gray); border-radius: 8px; margin-top: 10px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        .image-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-preview-placeholder { text-align: center; color: var(--gray); }
        .image-preview-placeholder i { font-size: 48px; margin-bottom: 10px; opacity: 0.5; }
        .upload-actions { display: flex; gap: 10px; margin-top: 10px; }
        .upload-btn { flex: 1; }
        .remove-image-btn { background-color: var(--light-gray); color: var(--text); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .remove-image-btn:hover { background-color: var(--gray); color: var(--button-text); }
        .notification { position: fixed; top: 100px; right: 30px; background-color: var(--card-bg); color: var(--text); padding: 15px 25px; border-radius: 8px; box-shadow: var(--shadow); display: flex; align-items: center; z-index: 1000; transform: translateX(150%); transition: transform 0.5s; border-left: 4px solid var(--success); }
        .notification.show { transform: translateX(0); }
        .notification i { margin-right: 10px; color: var(--success); font-size: 20px; }
        .admin-dashboard-section { display: none; padding: 30px 0; min-height: calc(100vh - 80px); }
        .admin-dashboard-section.active-section { display: block; }
        .admin-dashboard-container { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; width: 100%; }
        .admin-code-prompt { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .admin-code-container { background-color: var(--card-bg); border-radius: var(--radius); width: 100%; max-width: 400px; padding: 40px; text-align: center; box-shadow: var(--shadow); }
        .admin-code-icon { width: 80px; height: 80px; background-color: rgba(233, 196, 106, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; }
        .admin-code-icon i { font-size: 36px; color: var(--warning); }
        .admin-code-title { font-size: 24px; font-weight: 600; margin-bottom: 15px; color: var(--text); }
        .admin-code-subtitle { color: var(--gray); margin-bottom: 25px; }
        .admin-code-input { width: 100%; padding: 15px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 18px; text-align: center; letter-spacing: 3px; margin-bottom: 20px; font-family: 'Poppins', monospace; background-color: var(--card-bg); color: var(--text); }
        .admin-code-input:focus { border-color: var(--primary); outline: none; }

        /* ===== NEW STYLES FOR SUBCATEGORIES (OPTIONS) ===== */
        .item-options-indicator { font-size: 12px; color: var(--secondary); margin-top: 8px; display: flex; align-items: center; gap: 5px; }
        .item-options-indicator i { font-size: 12px; }
        .options-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2001; display: none; align-items: center; justify-content: center; padding: 20px; }
        .options-modal-container { background-color: var(--card-bg); border-radius: var(--radius); max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 30px; box-shadow: var(--shadow); }
        .options-modal-title { font-family: var(--font-secondary); font-size: 24px; margin-bottom: 5px; color: var(--text); }
        .options-modal-price { color: var(--primary); font-weight: 600; font-size: 20px; margin-bottom: 20px; }
        .option-group { margin-bottom: 25px; border-bottom: 1px solid var(--light-gray); padding-bottom: 20px; }
        .option-group-title { font-weight: 600; margin-bottom: 15px; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .option-group-title i { color: var(--secondary); }
        .choice-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-left: 10px; }
        .choice-label { display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1; }
        .choice-name { color: var(--text); }
        .choice-price { color: var(--gray); font-size: 14px; }
        .choice-price-positive { color: var(--success); }
        .choice-price-negative { color: var(--danger); }
        .options-total { margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--light-gray); display: flex; justify-content: space-between; font-size: 18px; font-weight: 600; }
        .options-total-amount { color: var(--primary); }
        .options-modal-actions { display: flex; gap: 15px; margin-top: 25px; }
        .option-group-radio, .option-group-checkbox { display: flex; flex-direction: column; gap: 8px; }
        .admin-options-section { margin-top: 25px; padding: 20px; background-color: var(--light); border-radius: 10px; }
        .admin-option-group { background-color: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--light-gray); }
        .admin-option-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .admin-option-group-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .admin-choice-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .admin-choice-input { flex: 1; }
        .admin-choice-price { width: 100px; }
        .add-choice-btn { margin-top: 10px; }
        /* ===== NEW STYLE FOR COMMENT FIELDS ===== */
        .comment-field { margin: 10px 0; }
        .comment-field textarea { width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: 8px; font-family: var(--font-primary); resize: vertical; }
        /* ===== DRAG AND DROP STYLES ===== */
        .admin-card.dragging { opacity: 0.5; cursor: grabbing; }
        .admin-card[draggable="true"] { cursor: grab; }
        .admin-card[draggable="true"]:active { cursor: grabbing; }
        .drag-handle { cursor: grab; padding: 5px; margin-right: 8px; color: var(--gray); }
        .drag-handle-category { cursor: grab; color: var(--gray); margin-right: 8px; }

        @media (max-width: 992px) { .theme-gallery { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } .font-options { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
        @media (max-width: 768px) { 
            .theme-gallery { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); } 
            .preview-content-grid { grid-template-columns: 1fr; } 
            .customization-actions { flex-direction: column; } 
            .payment-actions { flex-direction: column; gap: 15px; } 
            .btn { width: 100%; } 
            .cart-floating { bottom: 20px; right: 20px; width: 55px; height: 55px; } 
            .confirmation-card, .order-details { padding: 25px 20px; } 
            .details-header { flex-direction: column; align-items: flex-start; gap: 10px; } 
            .nav-container { flex-direction: column; gap: 15px; padding: 15px 0; } 
            .logo, .header-center, .header-right { width: 100%; justify-content: center; } 
            .header-center { order: 3; margin-top: 10px; } 
            .help-button { width: 100%; justify-content: center; } 
            .header-right { flex-direction: column; gap: 10px; } 
            .my-orders-button { width: 100%; justify-content: center; } 
            .table-info { margin-top: 10px; width: 100%; justify-content: center; } 
            .admin-container { padding: 20px 15px; } 
            .admin-tabs { flex-wrap: wrap; } 
            .admin-tab { padding: 10px 15px; font-size: 14px; } 
            .categories-management { flex-direction: column; } 
            .upload-actions { flex-direction: column; } 
            .color-customization { grid-template-columns: 1fr; } 
            .options-modal-container { padding: 20px; } 
            .choice-item { flex-direction: column; align-items: flex-start; gap: 5px; } 
            .options-modal-actions { flex-direction: column; } 
        }
        @media (max-width: 480px) { 
            .theme-gallery { grid-template-columns: repeat(2, 1fr); } 
            .scanner-container { padding: 25px 20px; } 
            .qr-placeholder { width: 200px; height: 200px; } 
            .section-title { font-size: 26px; } 
            .option-cards { grid-template-columns: 1fr; } 
            .order-number { font-size: 24px; } 
            .help-button { padding: 8px 15px; font-size: 14px; } 
            .my-orders-button { padding: 8px 15px; font-size: 14px; } 
            .theme-previews { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>
    <!-- ========== HEADER ========== -->
    <header>
        <div class="container nav-container">
            <div class="logo" id="restaurantLogo">
                <img src="" alt="Restaurant Logo" class="logo-img" id="logoImage">
                <i class="fas fa-utensils" id="logoIcon"></i>
                <span id="restaurantName">DineEasy</span>
            </div>
            <div class="header-center">
                <button class="help-button" id="headerHelpButton">
                    <i class="fas fa-headset"></i> Χρειάζεστε βοήθεια?
                </button>
            </div>
            <div class="header-right">
                <button class="my-orders-button" id="myOrdersButton" style="display: none;">
                    <i class="fas fa-clipboard-list"></i> Οι Παραγγελίες μου
                </button>
                <div class="table-info" id="tableInfo">
                    <i class="fas fa-qrcode"></i> Scan QR to begin
                </div>
            </div>
        </div>
    </header>

    <!-- ========== SCANNER SECTION ========== -->
    <section id="scannerSection" class="app-section active-section">
        <div class="container scanner-section">
            <div class="scanner-container">
                <h2 class="section-title">Scan Table QR Code</h2>
                <p class="section-subtitle">Point your camera at the QR code on your table to get started</p>
                <div class="qr-placeholder">
                    <i class="fas fa-qrcode"></i>
                    <span>QR Scanner Area</span>
                </div>
                <p style="margin: 20px 0; color: var(--gray);">For demo purposes, select a table:</p>
                <div class="demo-tables">
                    <button class="table-btn" data-table="Table 1">Table 1</button>
                    <button class="table-btn" data-table="Table 2">Table 2</button>
                    <button class="table-btn" data-table="Table 3">Table 3</button>
                    <button class="table-btn" data-table="Table 4">Table 4</button>
                    <button class="table-btn" data-table="Table 5">Table 5</button>
                    <button class="table-btn" data-table="VIP Table">VIP Table</button>
                    <button class="table-btn" data-table="Admin" style="border-color: var(--warning); color: var(--warning);">Admin</button>
                </div>
                <p style="margin-top: 30px; font-size: 14px; color: var(--gray);"><i class="fas fa-info-circle"></i> Once scanned, you'll be able to view the menu and place your order.</p>
                <p style="margin-top: 10px; font-size: 14px; color: var(--warning);"><i class="fas fa-shield-alt"></i> Select "Admin" table to access the admin panel (requires code).</p>
            </div>
        </div>
    </section>

    <!-- ========== MENU SECTION ========== -->
    <section id="menuSection" class="app-section">
        <div class="container">
            <h2 class="section-title" id="menuTitle">Our Menu</h2>
            <p class="section-subtitle" id="menuSubtitle">Select items to add to your order</p>
            <div class="category-tabs" id="categoryTabs"></div>
            <div class="menu-grid" id="menuGrid"></div>
        </div>
    </section>

    <!-- ========== CART SECTION ========== -->
    <section id="cartSection" class="app-section">
        <div class="container">
            <h2 class="section-title">Your Order</h2>
            <p class="section-subtitle" id="cartSubtitle">Review your order before payment</p>
            <div class="cart-container">
                <div class="cart-items" id="cartItems">
                    <div class="empty-cart" style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Your cart is empty</p>
                    </div>
                </div>
                <div class="cart-summary">
                    <div class="summary-row"><span>Subtotal (tax included)</span><span id="subtotal">$0.00</span></div>
                    <div class="summary-row summary-total"><span>Total</span><span class="amount" id="total">$0.00</span></div>
                    <div class="payment-actions">
                        <button class="btn btn-secondary" id="backToMenuBtn"><i class="fas fa-arrow-left"></i> Πίσω στο Μενού</button>
                        <button class="btn btn-primary" id="proceedToPaymentBtn">Proceed to Payment <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== PAYMENT SECTION ========== -->
    <section id="paymentSection" class="app-section">
        <div class="container">
            <h2 class="section-title">Payment</h2>
            <p class="section-subtitle">Complete your order with payment</p>
            <div class="payment-container">
                <div class="payment-options">
                    <div class="option-group">
                        <div class="option-title">Payment Method</div>
                        <div class="option-cards">
                            <div class="option-card" data-payment="card"><div class="option-icon"><i class="fas fa-credit-card"></i></div><div class="option-name">Credit/Debit Card</div><div class="option-desc">Pay with your card</div></div>
                            <div class="option-card" data-payment="cash"><div class="option-icon"><i class="fas fa-money-bill-wave"></i></div><div class="option-name">Cash</div><div class="option-desc">Pay with cash</div></div>
                        </div>
                    </div>
                    <div class="option-group">
                        <div class="option-title">Payment Time</div>
                        <div class="option-cards">
                            <div class="option-card" data-time="now"><div class="option-icon"><i class="fas fa-bolt"></i></div><div class="option-name">Pay Now</div><div class="option-desc">Complete payment immediately</div></div>
                            <div class="option-card" data-time="later"><div class="option-icon"><i class="fas fa-clock"></i></div><div class="option-name">Pay Later</div><div class="option-desc">Pay at the counter when leaving</div></div>
                        </div>
                    </div>
                </div>
                <div class="cart-summary">
                    <div class="summary-row"><span>Subtotal (tax included)</span><span id="paymentSubtotal">$0.00</span></div>
                    <div class="summary-row summary-total"><span>Total</span><span class="amount" id="paymentTotal">$0.00</span></div>
                    <div class="payment-actions">
                        <button class="btn btn-secondary" id="backToCartBtn"><i class="fas fa-arrow-left"></i> Back to Cart</button>
                        <button class="btn btn-primary" id="confirmPaymentBtn"><i class="fas fa-check"></i> Confirm Payment</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== MY ORDERS SECTION ========== -->
    <section id="myOrdersSection" class="app-section">
        <div class="container my-orders-container">
            <h2 class="section-title">Οι Παραγγελίες μου</h2>
            <p class="section-subtitle" id="myOrdersSubtitle">View all your current and past orders</p>
            <div class="orders-list" id="ordersList"></div>
            <div class="payment-actions">
                <button class="btn btn-secondary" id="backToMenuFromOrdersBtn"><i class="fas fa-arrow-left"></i> Πίσω στο Μενού</button>
                <button class="btn btn-primary" id="placeNewOrderBtn"><i class="fas fa-plus"></i> Νέα Παραγγελία</button>
            </div>
        </div>
    </section>

    <!-- ========== CONFIRMATION SECTION ========== -->
    <section id="confirmationSection" class="app-section">
        <div class="container confirmation-container">
            <div class="confirmation-card">
                <div class="confirmation-icon"><i class="fas fa-check"></i></div>
                <h2 class="section-title">Order Confirmed!</h2>
                <div class="order-number">Order #<span id="orderNumberDisplay">0000</span></div>
                <p class="order-message">Thank you for your order. Your food will be prepared shortly.</p>
                <div class="payment-actions" style="justify-content: center; gap: 15px;">
                    <button class="btn btn-success" id="newOrderBtn"><i class="fas fa-utensils"></i> Start New Order</button>
                    <button class="btn btn-secondary" id="viewMyOrdersBtn"><i class="fas fa-clipboard-list"></i> Προβολή των Παραγγελιών μου</button>
                </div>
            </div>
            <div class="order-details">
                <div class="details-header"><div class="details-title">Order Details</div><div class="details-table" id="confirmationTable">Table: -</div></div>
                <div class="order-items" id="confirmationItems"></div>
                <div class="order-total"><span>Total Amount (tax included)</span><span class="amount" id="confirmationTotal">$0.00</span></div>
                <div class="payment-details">
                    <div class="payment-details-title">Payment Information</div>
                    <div class="payment-info"><div class="info-label">Payment Method:</div><div class="info-value" id="confirmationPaymentMethod">-</div></div>
                    <div class="payment-info"><div class="info-label">Payment Time:</div><div class="info-value" id="confirmationPaymentTime">-</div></div>
                    <div class="payment-info"><div class="info-label">Order Status:</div><div class="info-value" id="confirmationOrderStatus" style="color: var(--success);">Confirmed</div></div>
                </div>
                <div class="estimated-time"><div class="time-icon"><i class="fas fa-clock"></i></div><div class="time-text"><strong>Estimated preparation time:</strong> <span id="estimatedTime">15-25</span> minutes</div></div>
            </div>
            <div class="payment-actions">
                <button class="btn btn-secondary" id="viewMenuBtn"><i class="fas fa-book-open"></i> View Full Menu</button>
                <button class="btn btn-primary" id="needHelpBtn"><i class="fas fa-headset"></i> Χρειάζεστε βοήθεια?</button>
            </div>
        </div>
    </section>

    <!-- ========== ADMIN DASHBOARD SECTION ========== -->
    <section id="adminDashboardSection" class="admin-dashboard-section">
        <div class="container">
            <div class="admin-dashboard-container">
                <h2 style="margin-bottom: 25px; color: var(--primary);"><i class="fas fa-lock"></i> Admin Control Panel</h2>
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="restaurant">Restaurant Settings</button>
                    <button class="admin-tab" data-tab="menu">Menu Management</button>
                    <button class="admin-tab" data-tab="categories">Category Management</button>
                    <button class="admin-tab" data-tab="orders">Order Management</button>
                    <button class="admin-tab" data-tab="customization">Visual Customization</button>
                    <button class="admin-tab" data-tab="system">System Tools</button>
                </div>
                <!-- Restaurant Settings -->
                <div class="admin-content active" id="restaurantTab">
                    <div class="admin-form-group"><label class="admin-label">Restaurant Name</label><input type="text" class="admin-input" id="adminRestaurantName" value="DineEasy"></div>
                    <div class="image-upload-container">
                        <label class="admin-label">Restaurant Logo</label>
                        <div class="image-preview" id="logoPreview"><div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div></div>
                        <div class="upload-actions">
                            <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                            <button class="btn btn-secondary upload-btn" id="uploadLogoBtn"><i class="fas fa-upload"></i> Upload Logo</button>
                            <button class="remove-image-btn" id="removeLogoBtn"><i class="fas fa-trash"></i> Remove</button>
                        </div>
                    </div>
                    <div class="admin-form-group"><label class="admin-label">Tax Rate (%)</label><input type="number" class="admin-input" id="adminTaxRate" value="8" min="0" max="50" step="0.1"></div>
                    <div class="admin-form-group"><label class="admin-label">Estimated Preparation Time (minutes)</label><input type="text" class="admin-input" id="adminPrepTime" value="15-25"></div>
                    <div class="admin-form-group"><label class="admin-label">Welcome Message</label><textarea class="admin-textarea" id="adminWelcomeMessage" placeholder="Welcome to our restaurant..."></textarea></div>
                    <button class="btn btn-primary" id="saveRestaurantSettings"><i class="fas fa-save"></i> Save Restaurant Settings</button>
                </div>
                <!-- Menu Management -->
                <div class="admin-content" id="menuTab">
                    <div style="margin-bottom: 25px;"><button class="btn btn-success" id="addMenuItemBtn"><i class="fas fa-plus"></i> Add New Menu Item</button></div>
                    <div class="admin-grid" id="menuItemsList"></div>
                    <div id="editMenuItemForm" style="display: none;">
                        <h3 style="margin-bottom: 20px;">Edit Menu Item</h3>
                        <div class="admin-form-group"><label class="admin-label">Item Name</label><input type="text" class="admin-input" id="editItemName"></div>
                        <div class="admin-form-group"><label class="admin-label">Description</label><textarea class="admin-textarea" id="editItemDescription"></textarea></div>
                        <div class="admin-form-group"><label class="admin-label">Price (with tax)</label><input type="number" class="admin-input" id="editItemPrice" step="0.01" min="0"></div>
                        <div class="admin-form-group"><label class="admin-label">Category</label><select class="admin-select" id="editItemCategory"></select></div>
                        <div class="image-upload-container">
                            <label class="admin-label">Item Image</label>
                            <div class="image-preview" id="itemImagePreview"><div class="image-preview-placeholder"><i class="fas fa-utensils"></i><p>No image uploaded</p></div></div>
                            <div class="upload-actions">
                                <input type="file" id="itemImageUpload" accept="image/*" style="display: none;">
                                <button class="btn btn-secondary upload-btn" id="uploadItemImageBtn"><i class="fas fa-upload"></i> Upload Image</button>
                                <button class="remove-image-btn" id="removeItemImageBtn"><i class="fas fa-trash"></i> Remove</button>
                            </div>
                        </div>
                        <div class="admin-form-group"><label class="admin-label">Tags (separate with commas)</label><input type="text" class="admin-input" id="editItemTags" placeholder="Vegetarian, Popular, Spicy"></div>
                        <div class="payment-actions">
                            <button class="btn btn-secondary" id="cancelEditBtn"><i class="fas fa-times"></i> Cancel</button>
                            <button class="btn btn-primary" id="saveMenuItemBtn"><i class="fas fa-save"></i> Save Changes</button>
                        </div>
                    </div>
                </div>
                <!-- Category Management -->
                <div class="admin-content" id="categoriesTab">
                    <h3 style="margin-bottom: 20px;">Manage Categories</h3>
                    <p style="margin-bottom: 25px; color: var(--gray);">Add, edit, or remove menu categories. Note: You cannot delete categories that have menu items assigned to them.</p>
                    <div class="categories-management">
                        <div class="categories-list"><h4 style="margin-bottom: 15px;">Existing Categories</h4><div class="categories-list-container" id="categoriesListContainer"></div></div>
                        <div class="add-category-form">
                            <h4 style="margin-bottom: 15px;">Add New Category</h4>
                            <div class="admin-form-group"><label class="admin-label">Category Name</label><input type="text" class="admin-input" id="newCategoryName" placeholder="e.g., Sides, Salads, Breakfast"></div>
                            <div class="admin-form-group"><label class="admin-label">Display Name</label><input type="text" class="admin-input" id="newCategoryDisplayName" placeholder="e.g., Side Dishes"><small style="color: var(--gray);">How it will appear in the menu tabs</small></div>
                            <button class="btn btn-success" id="addCategoryBtn"><i class="fas fa-plus"></i> Add Category</button>
                        </div>
                    </div>
                </div>
                <!-- Order Management (with Delete by Table) -->
                <div class="admin-content" id="ordersTab">
                    <div class="admin-form-group"><label class="admin-label">Filter by Status</label><select class="admin-select" id="orderStatusFilter"><option value="all">All Orders</option><option value="pending">Pending</option><option value="preparing">Preparing</option><option value="ready">Ready</option><option value="served">Served</option><option value="cancelled">Cancelled</option></select></div>
                    <div id="adminOrdersList"><p style="text-align: center; color: var(--gray); padding: 40px;">No orders yet. Orders will appear here when customers place them.</p></div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);">
                        <h4 style="margin-bottom: 15px;"><i class="fas fa-trash-alt"></i> Delete Orders by Table</h4>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label class="admin-label">Select Table</label>
                                <select class="admin-select" id="tableSelectForDelete">
                                    <option value="">-- No tables with orders --</option>
                                </select>
                            </div>
                            <button class="btn btn-danger" id="deleteOrdersForTableBtn" style="flex: 0 0 auto;"><i class="fas fa-trash"></i> Delete Orders for Selected Table</button>
                        </div>
                        <p style="margin-top: 10px; font-size: 13px; color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> This action cannot be undone. Orders will be permanently deleted from the database.</p>
                    </div>
                </div>
                <!-- Visual Customization -->
                <div class="admin-content" id="customizationTab">
                    <div class="customization-panel">
                        <div class="customization-section">
                            <div class="section-title-small"><i class="fas fa-palette"></i> Choose a Theme (20 Unique Options)</div>
                            <p style="margin-bottom: 20px; color: var(--gray);">Select from our collection of 20 modern and cozy themes.</p>
                            <div class="theme-gallery" id="themeGallery"></div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                                <div style="font-weight: 500; margin-bottom: 10px; color: var(--text);">Current Theme: <span id="currentThemeName">Default</span> <span class="theme-category" id="currentThemeCategory">Modern</span></div>
                                <button class="btn btn-primary" id="applyThemeBtn" style="width: 100%;"><i class="fas fa-check"></i> Apply Selected Theme</button>
                            </div>
                        </div>
                        <div class="customization-section">
                            <div class="section-title-small"><i class="fas fa-font"></i> Font Selection</div>
                            <p style="margin-bottom: 20px; color: var(--gray);">Choose a font that matches your restaurant's personality.</p>
                            <div class="font-options" id="fontOptions"></div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                                <div style="font-weight: 500; margin-bottom: 10px; color: var(--text);">Current Font: <span id="currentFontName">Poppins</span></div>
                                <button class="btn btn-secondary" id="applyFontBtn" style="width: 100%;"><i class="fas fa-check"></i> Apply Selected Font</button>
                            </div>
                        </div>
                        <div class="customization-section">
                            <div class="section-title-small"><i class="fas fa-sliders-h"></i> Custom Color Adjustments</div>
                            <p style="margin-bottom: 20px; color: var(--gray);">Fine-tune individual colors if needed.</p>
                            <div class="color-customization" id="colorCustomization"></div>
                        </div>
                    </div>
                    <div class="customization-preview">
                        <div class="preview-header"><div class="preview-restaurant-name" id="previewRestaurantName">Restaurant Preview</div><div style="font-size: 14px; color: var(--gray);">Live Preview</div></div>
                        <div class="preview-content-grid">
                            <div>
                                <div class="preview-card"><div style="font-weight: 600; margin-bottom: 15px; color: var(--text);">Sample Menu Item</div>
                                    <div class="preview-menu-item"><span>Margherita Pizza</span><span style="color: var(--primary); font-weight: 600;">$14.99</span></div>
                                    <div class="preview-menu-item"><span>Caesar Salad</span><span style="color: var(--primary); font-weight: 600;">$9.99</span></div>
                                    <div style="margin-top: 15px;"><button style="background-color: var(--primary); color: var(--button-text); border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer;">Add to Cart</button></div>
                                </div>
                                <div style="background-color: var(--background); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid var(--light-gray);">
                                    <div style="color: var(--text); font-weight: 500; margin-bottom: 10px;">Customer Note:</div>
                                    <div style="color: var(--gray); font-size: 14px;">"The theme creates a welcoming atmosphere for our guests."</div>
                                </div>
                            </div>
                            <div>
                                <div class="preview-button-group">
                                    <button class="preview-btn" style="background-color: var(--primary); color: var(--button-text);">Primary Button</button>
                                    <button class="preview-btn" style="background-color: var(--secondary); color: white;">Secondary Button</button>
                                    <button class="preview-btn" style="background-color: var(--success); color: white;">Success Button</button>
                                </div>
                                <div class="preview-card" style="margin-top: 15px;"><div style="font-weight: 600; margin-bottom: 10px; color: var(--text);">Order Summary</div>
                                    <div class="preview-menu-item"><span>Subtotal</span><span>$24.98</span></div>
                                    <div class="preview-menu-item"><span>Total</span><span style="color: var(--primary); font-weight: 600;">$24.98</span></div>
                                </div>
                                <div style="background-color: var(--light-gray); padding: 15px; border-radius: 8px; margin-top: 15px;"><div style="color: var(--text); font-size: 14px;">This is how text will appear in light gray areas.</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="customization-actions">
                        <button class="btn btn-secondary" id="resetCustomizationBtn"><i class="fas fa-undo"></i> Reset to Default</button>
                        <button class="btn btn-primary" id="saveCustomizationBtn"><i class="fas fa-save"></i> Save All Changes</button>
                    </div>
                </div>
                <!-- System Tools -->
                <div class="admin-content" id="systemTab">
                    <h3 style="margin-bottom: 20px;">System Management</h3>
                    <div class="admin-grid">
                        <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Clear All Orders</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Remove all order history from the system.</p><button class="btn btn-danger" id="clearOrdersBtn"><i class="fas fa-trash"></i> Clear Orders</button></div>
                        <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Reset Menu to Default</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Restore the original menu items.</p><button class="btn btn-warning" id="resetMenuBtn"><i class="fas fa-redo"></i> Reset Menu</button></div>
                        <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Export Data</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Download all restaurant data as JSON.</p><button class="btn btn-secondary" id="exportDataBtn"><i class="fas fa-download"></i> Export Data</button></div>
                        <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Import Data</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Upload and restore from a backup file.</p><input type="file" id="importDataInput" style="display: none;" accept=".json"><button class="btn btn-secondary" id="importDataBtn"><i class="fas fa-upload"></i> Import Data</button></div>
                    </div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);"><h4 style="margin-bottom: 15px;">System Statistics</h4><div id="systemStats"></div></div>
                </div>
            </div>
        </div>
    </section>

    <!-- ========== ADMIN PANEL (MODAL) ========== -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-container">
            <button class="admin-close" id="adminClose"><i class="fas fa-times"></i></button>
            <h2 style="margin-bottom: 25px; color: var(--primary);"><i class="fas fa-lock"></i> Admin Control Panel</h2>
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="restaurant">Restaurant Settings</button>
                <button class="admin-tab" data-tab="menu">Menu Management</button>
                <button class="admin-tab" data-tab="categories">Category Management</button>
                <button class="admin-tab" data-tab="orders">Order Management</button>
                <button class="admin-tab" data-tab="customization">Visual Customization</button>
                <button class="admin-tab" data-tab="system">System Tools</button>
            </div>
            <!-- Restaurant Settings Modal -->
            <div class="admin-content active" id="restaurantTabModal">
                <div class="admin-form-group"><label class="admin-label">Restaurant Name</label><input type="text" class="admin-input" id="adminRestaurantNameModal" value="DineEasy"></div>
                <div class="image-upload-container">
                    <label class="admin-label">Restaurant Logo</label>
                    <div class="image-preview" id="logoPreviewModal"><div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div></div>
                    <div class="upload-actions">
                        <input type="file" id="logoUploadModal" accept="image/*" style="display: none;">
                        <button class="btn btn-secondary upload-btn" id="uploadLogoBtnModal"><i class="fas fa-upload"></i> Upload Logo</button>
                        <button class="remove-image-btn" id="removeLogoBtnModal"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                </div>
                <div class="admin-form-group"><label class="admin-label">Tax Rate (%)</label><input type="number" class="admin-input" id="adminTaxRateModal" value="8" min="0" max="50" step="0.1"></div>
                <div class="admin-form-group"><label class="admin-label">Estimated Preparation Time (minutes)</label><input type="text" class="admin-input" id="adminPrepTimeModal" value="15-25"></div>
                <div class="admin-form-group"><label class="admin-label">Welcome Message</label><textarea class="admin-textarea" id="adminWelcomeMessageModal" placeholder="Welcome to our restaurant..."></textarea></div>
                <button class="btn btn-primary" id="saveRestaurantSettingsModal"><i class="fas fa-save"></i> Save Restaurant Settings</button>
            </div>
            <!-- Menu Management Modal -->
            <div class="admin-content" id="menuTabModal">
                <div style="margin-bottom: 25px;"><button class="btn btn-success" id="addMenuItemBtnModal"><i class="fas fa-plus"></i> Add New Menu Item</button></div>
                <div class="admin-grid" id="menuItemsListModal"></div>
            </div>
            <!-- Category Management Modal -->
            <div class="admin-content" id="categoriesTabModal">
                <h3 style="margin-bottom: 20px;">Manage Categories</h3>
                <p style="margin-bottom: 25px; color: var(--gray);">Add, edit, or remove menu categories. Note: You cannot delete categories that have menu items assigned to them.</p>
                <div class="categories-management">
                    <div class="categories-list"><h4 style="margin-bottom: 15px;">Existing Categories</h4><div class="categories-list-container" id="categoriesListContainerModal"></div></div>
                    <div class="add-category-form">
                        <h4 style="margin-bottom: 15px;">Add New Category</h4>
                        <div class="admin-form-group"><label class="admin-label">Category Name</label><input type="text" class="admin-input" id="newCategoryNameModal" placeholder="e.g., Sides, Salads, Breakfast"></div>
                        <div class="admin-form-group"><label class="admin-label">Display Name</label><input type="text" class="admin-input" id="newCategoryDisplayNameModal" placeholder="e.g., Side Dishes"><small style="color: var(--gray);">How it will appear in the menu tabs</small></div>
                        <button class="btn btn-success" id="addCategoryBtnModal"><i class="fas fa-plus"></i> Add Category</button>
                    </div>
                </div>
            </div>
            <!-- Order Management Modal + Delete by Table -->
            <div class="admin-content" id="ordersTabModal">
                <div class="admin-form-group"><label class="admin-label">Filter by Status</label><select class="admin-select" id="orderStatusFilterModal"><option value="all">All Orders</option><option value="pending">Pending</option><option value="preparing">Preparing</option><option value="ready">Ready</option><option value="served">Served</option><option value="cancelled">Cancelled</option></select></div>
                <div id="adminOrdersListModal"><p style="text-align: center; color: var(--gray); padding: 40px;">No orders yet. Orders will appear here when customers place them.</p></div>
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);">
                    <h4 style="margin-bottom: 15px;"><i class="fas fa-trash-alt"></i> Delete Orders by Table</h4>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label class="admin-label">Select Table</label>
                            <select class="admin-select" id="tableSelectForDeleteModal">
                                <option value="">-- No tables with orders --</option>
                            </select>
                        </div>
                        <button class="btn btn-danger" id="deleteOrdersForTableBtnModal" style="flex: 0 0 auto;"><i class="fas fa-trash"></i> Delete Orders for Selected Table</button>
                    </div>
                    <p style="margin-top: 10px; font-size: 13px; color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> This action cannot be undone. Orders will be permanently deleted from the database.</p>
                </div>
            </div>
            <!-- Visual Customization Modal (simplified) -->
            <div class="admin-content" id="customizationTabModal">
                <h3 style="margin-bottom: 20px;">Visual Customization</h3>
                <p style="margin-bottom: 25px; color: var(--gray);">Quick visual customization options.</p>
                <div style="margin-bottom: 30px;"><div style="font-weight: 500; margin-bottom: 15px; color: var(--text);">Theme Selection</div><div class="theme-gallery" id="themeGalleryModal"></div></div>
                <div style="margin-bottom: 30px;"><div style="font-weight: 500; margin-bottom: 15px; color: var(--text);">Font Selection</div><div class="font-options" id="fontOptionsModal"></div></div>
                <div class="customization-actions"><button class="btn btn-secondary" id="resetCustomizationBtnModal"><i class="fas fa-undo"></i> Reset</button><button class="btn btn-primary" id="saveCustomizationBtnModal"><i class="fas fa-save"></i> Save</button></div>
            </div>
            <!-- System Tools Modal -->
            <div class="admin-content" id="systemTabModal">
                <h3 style="margin-bottom: 20px;">System Management</h3>
                <div class="admin-grid">
                    <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Clear All Orders</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Remove all order history from the system.</p><button class="btn btn-danger" id="clearOrdersBtnModal"><i class="fas fa-trash"></i> Clear Orders</button></div>
                    <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Reset Menu to Default</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Restore the original menu items.</p><button class="btn btn-warning" id="resetMenuBtnModal"><i class="fas fa-redo"></i> Reset Menu</button></div>
                    <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Export Data</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Download all restaurant data as JSON.</p><button class="btn btn-secondary" id="exportDataBtnModal"><i class="fas fa-download"></i> Export Data</button></div>
                    <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Import Data</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Upload and restore from a backup file.</p><input type="file" id="importDataInputModal" style="display: none;" accept=".json"><button class="btn btn-secondary" id="importDataBtnModal"><i class="fas fa-upload"></i> Import Data</button></div>
                </div>
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);"><h4 style="margin-bottom: 15px;">System Statistics</h4><div id="systemStatsModal"></div></div>
            </div>
        </div>
    </div>

    <!-- ========== ADMIN CODE PROMPT ========== -->
    <div class="admin-code-prompt" id="adminCodePrompt">
        <div class="admin-code-container">
            <div class="admin-code-icon"><i class="fas fa-lock"></i></div>
            <h3 class="admin-code-title">Admin Access Required</h3>
            <p class="admin-code-subtitle">Please enter the admin code to continue</p>
            <input type="password" class="admin-code-input" id="adminCodeInput" placeholder="Enter 4-digit code" maxlength="4" autocomplete="off">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancelAdminCodeBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="submitAdminCodeBtn" style="flex: 1;">Submit</button>
            </div>
        </div>
    </div>

    <!-- ========== ADMIN CHANGE CONFIRMATION PROMPT ========== -->
    <div class="admin-code-prompt" id="adminChangePrompt">
        <div class="admin-code-container">
            <div class="admin-code-icon"><i class="fas fa-shield-alt"></i></div>
            <h3 class="admin-code-title">Confirm Changes</h3>
            <p class="admin-code-subtitle">Please enter the confirmation code to save changes</p>
            <input type="password" class="admin-code-input" id="adminChangeCodeInput" placeholder="Enter 4-digit code" maxlength="4" autocomplete="off">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancelChangeBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="submitChangeCodeBtn" style="flex: 1;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- ========== OPTIONS MODAL ========== -->
    <div class="options-modal" id="optionsModal">
        <div class="options-modal-container">
            <div id="optionsModalContent"></div>
        </div>
    </div>

    <!-- ========== CART FLOATING BUTTON ========== -->
    <div class="cart-floating" id="cartFloating">
        <i class="fas fa-shopping-cart"></i>
        <div class="cart-count" id="cartCount">0</div>
    </div>

    <!-- ========== NOTIFICATION ========== -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div id="notificationText">Item added to cart!</div>
    </div>

    <script>
        // ========== FIREBASE INITIALIZATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCtO20G2Ssl9cvB6CP1xfCh2Ldf4GMdGUg",
            authDomain: "foodmenu-b1fc2.firebaseapp.com",
            projectId: "foodmenu-b1fc2",
            storageBucket: "foodmenu-b1fc2.firebasestorage.app",
            messagingSenderId: "730100337020",
            appId: "1:730100337020:web:dd3dc58846c8207a693cf9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ========== STATE ==========
        const state = {
            currentTable: null,
            cart: [],
            selectedPaymentMethod: null,
            selectedPaymentTime: null,
            currentOrderNumber: null,
            restaurantInfo: {
                name: "DineEasy",
                taxRate: 8,
                estimatedPrepTime: "15-25",
                logoImage: "",
                welcomeMessage: ""
            },
            menuItems: [],
            orders: [],
            adminAccessCode: "3232",
            adminChangeCode: "6262",
            categories: [],
            isAdminMode: false,
            pendingAdminAction: null,
            currentImageUpload: null,
            customization: {
                primary: "#e63946",
                primaryDark: "#c1121f",
                secondary: "#457b9d",
                light: "#f8f9fa",
                dark: "#212529",
                gray: "#6c757d",
                lightGray: "#e9ecef",
                success: "#2a9d8f",
                warning: "#e9c46a",
                danger: "#dc3545",
                shadow: "0 4px 12px rgba(0, 0, 0, 0.08)",
                radius: "12px",
                background: "#fefefe",
                text: "#212529",
                cardBg: "#ffffff",
                headerBg: "#ffffff",
                menuBg: "#ffffff",
                cartBg: "#ffffff",
                paymentBg: "#ffffff",
                buttonText: "#ffffff",
                fontPrimary: "'Poppins', sans-serif",
                fontSecondary: "'Playfair Display', serif"
            },
            currentTheme: "default",
            currentFont: "poppins"
        };

        // ========== DEFAULT DATA ==========
        const defaultMenuItems = [];
        const defaultCategories = [
            { id: "pizza", name: "pizza", displayName: "Pizza", isDefault: true, displayOrder: 0 },
            { id: "salads", name: "salads", displayName: "Salads", isDefault: true, displayOrder: 1 },
            { id: "pasta", name: "pasta", displayName: "Pasta", isDefault: true, displayOrder: 2 },
            { id: "main", name: "main", displayName: "Main Courses", isDefault: true, displayOrder: 3 },
            { id: "desserts", name: "desserts", displayName: "Desserts", isDefault: true, displayOrder: 4 },
            { id: "beverages", name: "beverages", displayName: "Beverages", isDefault: true, displayOrder: 5 }
        ];

        // ========== THEMES & FONTS ==========
        const themes = {
            default: { name: "Classic Modern", category: "Modern", primary: "#e63946", secondary: "#457b9d", background: "#fefefe", text: "#212529", cardBg: "#ffffff", lightGray: "#e9ecef" },
            midnight: { name: "Midnight Elegance", category: "Modern", primary: "#6c63ff", secondary: "#4cc9f0", background: "#121212", text: "#f5f5f5", cardBg: "#1e1e1e", lightGray: "#2d2d2d" },
            autumn: { name: "Autumn Cozy", category: "Cozy", primary: "#e76f51", secondary: "#f4a261", background: "#fefae0", text: "#283618", cardBg: "#ffffff", lightGray: "#faedcd" },
            coffee: { name: "Coffee Shop", category: "Cozy", primary: "#6f4e37", secondary: "#c19a6b", background: "#f5e9d9", text: "#3e2723", cardBg: "#ffffff", lightGray: "#e6d5c3" },
            forest: { name: "Forest Retreat", category: "Natural", primary: "#2a9d8f", secondary: "#e9c46a", background: "#f1faee", text: "#1d3557", cardBg: "#ffffff", lightGray: "#a8dadc" },
            sage: { name: "Sage Garden", category: "Natural", primary: "#84a98c", secondary: "#52796f", background: "#f8f9fa", text: "#354f52", cardBg: "#ffffff", lightGray: "#cad2c5" },
            citrus: { name: "Citrus Fresh", category: "Vibrant", primary: "#ff9f1c", secondary: "#ffbf69", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#ffe8d6" },
            berry: { name: "Berry Bliss", category: "Vibrant", primary: "#9d4edd", secondary: "#c77dff", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#e0aaff" },
            ocean: { name: "Ocean Breeze", category: "Calm", primary: "#0077b6", secondary: "#00b4d8", background: "#f8f9fa", text: "#03045e", cardBg: "#ffffff", lightGray: "#caf0f8" },
            lavender: { name: "Lavender Dream", category: "Calm", primary: "#9c89b8", secondary: "#b8bedd", background: "#f8f9fa", text: "#4a4e69", cardBg: "#ffffff", lightGray: "#f0e6ef" },
            gold: { name: "Golden Luxury", category: "Luxury", primary: "#d4af37", secondary: "#f9d976", background: "#1a1a1a", text: "#f5f5f5", cardBg: "#2d2d2d", lightGray: "#3d3d3d" },
            velvet: { name: "Velvet Night", category: "Luxury", primary: "#7209b7", secondary: "#3a0ca3", background: "#0a0a0a", text: "#f5f5f5", cardBg: "#1a1a1a", lightGray: "#2d2d2d" },
            minimalist: { name: "Pure Minimal", category: "Minimalist", primary: "#495057", secondary: "#6c757d", background: "#ffffff", text: "#212529", cardBg: "#f8f9fa", lightGray: "#e9ecef" },
            paper: { name: "Paper White", category: "Minimalist", primary: "#adb5bd", secondary: "#ced4da", background: "#ffffff", text: "#343a40", cardBg: "#f8f9fa", lightGray: "#e9ecef" },
            retro: { name: "Retro Diner", category: "Retro", primary: "#ff6b6b", secondary: "#4ecdc4", background: "#fff9db", text: "#2d3436", cardBg: "#ffffff", lightGray: "#ffeaa7" },
            vintage: { name: "Vintage Charm", category: "Retro", primary: "#dda15e", secondary: "#bc6c25", background: "#fefae0", text: "#283618", cardBg: "#ffffff", lightGray: "#faedcd" },
            corporate: { name: "Corporate Blue", category: "Professional", primary: "#2c3e50", secondary: "#3498db", background: "#ecf0f1", text: "#2c3e50", cardBg: "#ffffff", lightGray: "#bdc3c7" },
            slate: { name: "Slate Professional", category: "Professional", primary: "#34495e", secondary: "#7f8c8d", background: "#f5f7fa", text: "#2c3e50", cardBg: "#ffffff", lightGray: "#dcdde1" },
            candy: { name: "Candy Shop", category: "Playful", primary: "#ff5d8f", secondary: "#ff97b7", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#ffcad4" },
            tropical: { name: "Tropical Paradise", category: "Playful", primary: "#06d6a0", secondary: "#118ab2", background: "#f8f9fa", text: "#073b4c", cardBg: "#ffffff", lightGray: "#cbf3f0" }
        };
        const fonts = {
            poppins: { name: "Poppins", primary: "'Poppins', sans-serif", secondary: "'Playfair Display', serif" },
            roboto: { name: "Roboto", primary: "'Roboto', sans-serif", secondary: "'Roboto Slab', serif" },
            opensans: { name: "Open Sans", primary: "'Open Sans', sans-serif", secondary: "'Merriweather', serif" },
            lato: { name: "Lato", primary: "'Lato', sans-serif", secondary: "'Playfair Display', serif" },
            montserrat: { name: "Montserrat", primary: "'Montserrat', sans-serif", secondary: "'Cardo', serif" },
            inter: { name: "Inter", primary: "'Inter', sans-serif", secondary: "'Inter', serif" }
        };
        const importantColors = [
            { id: "primary", label: "Primary Color" },
            { id: "secondary", label: "Secondary Color" },
            { id: "background", label: "Background" },
            { id: "text", label: "Text Color" },
            { id: "cardBg", label: "Card Background" },
            { id: "lightGray", label: "Light Gray" }
        ];

        // ========== DOM ELEMENTS ==========
        const scannerSection = document.getElementById('scannerSection');
        const menuSection = document.getElementById('menuSection');
        const cartSection = document.getElementById('cartSection');
        const paymentSection = document.getElementById('paymentSection');
        const myOrdersSection = document.getElementById('myOrdersSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const adminDashboardSection = document.getElementById('adminDashboardSection');
        const tableInfo = document.getElementById('tableInfo');
        const menuSubtitle = document.getElementById('menuSubtitle');
        const cartSubtitle = document.getElementById('cartSubtitle');
        const myOrdersSubtitle = document.getElementById('myOrdersSubtitle');
        const menuGrid = document.getElementById('menuGrid');
        const categoryTabs = document.getElementById('categoryTabs');
        const cartItems = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');
        const cartFloating = document.getElementById('cartFloating');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const orderNumberDisplay = document.getElementById('orderNumberDisplay');
        const confirmationTable = document.getElementById('confirmationTable');
        const confirmationItems = document.getElementById('confirmationItems');
        const confirmationTotal = document.getElementById('confirmationTotal');
        const confirmationPaymentMethod = document.getElementById('confirmationPaymentMethod');
        const confirmationPaymentTime = document.getElementById('confirmationPaymentTime');
        const confirmationOrderStatus = document.getElementById('confirmationOrderStatus');
        const headerHelpButton = document.getElementById('headerHelpButton');
        const restaurantName = document.getElementById('restaurantName');
        const menuTitle = document.getElementById('menuTitle');
        const estimatedTime = document.getElementById('estimatedTime');
        const myOrdersButton = document.getElementById('myOrdersButton');
        const ordersList = document.getElementById('ordersList');
        const logoImage = document.getElementById('logoImage');
        const logoIcon = document.getElementById('logoIcon');
        const adminPanel = document.getElementById('adminPanel');
        const adminClose = document.getElementById('adminClose');
        const adminCodePrompt = document.getElementById('adminCodePrompt');
        const adminCodeInput = document.getElementById('adminCodeInput');
        const submitAdminCodeBtn = document.getElementById('submitAdminCodeBtn');
        const cancelAdminCodeBtn = document.getElementById('cancelAdminCodeBtn');
        const adminChangePrompt = document.getElementById('adminChangePrompt');
        const adminChangeCodeInput = document.getElementById('adminChangeCodeInput');
        const submitChangeCodeBtn = document.getElementById('submitChangeCodeBtn');
        const cancelChangeBtn = document.getElementById('cancelChangeBtn');
        const optionsModal = document.getElementById('optionsModal');
        const optionsModalContent = document.getElementById('optionsModalContent');

        // ========== GRANULAR FIRESTORE SAVE ==========
        async function saveRestaurantInfo() { try { await db.collection('settings').doc('restaurantInfo').set(state.restaurantInfo); } catch (e) { console.error(e); } }
        async function saveMenuItem(item) { try { await db.collection('menuItems').doc(item.id.toString()).set(item); } catch (e) { console.error(e); } }
        async function deleteMenuItemFirestore(id) { try { await db.collection('menuItems').doc(id.toString()).delete(); } catch (e) { console.error(e); } }
        async function saveCategories() { try { const sorted = [...state.categories].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)); await db.collection('settings').doc('categories').set({ list: sorted }); } catch (e) { console.error(e); } }
        async function saveOrder(order) { try { await db.collection('orders').doc(order.orderNumber).set(order); } catch (e) { console.error(e); } }
        async function deleteOrderFirestore(orderId) { try { await db.collection('orders').doc(orderId).delete(); } catch (e) { console.error(e); } }
        async function saveCustomization() { try { await db.collection('settings').doc('customization').set(state.customization); } catch (e) { console.error(e); } }

        // ========== INITIAL LOAD ==========
        async function loadInitialData() {
            try {
                const [restDoc, menuSnap, ordersSnap, catDoc, customDoc] = await Promise.all([
                    db.collection('settings').doc('restaurantInfo').get(),
                    db.collection('menuItems').get(),
                    db.collection('orders').get(),
                    db.collection('settings').doc('categories').get(),
                    db.collection('settings').doc('customization').get()
                ]);
                if (restDoc.exists) state.restaurantInfo = restDoc.data();
                else await db.collection('settings').doc('restaurantInfo').set(state.restaurantInfo);
                
                state.menuItems = menuSnap.docs.map(doc => {
                    const d = doc.data();
                    d.displayOrder = d.displayOrder ?? Number(doc.id) ?? 999;
                    return { id: Number(doc.id), ...d, options: d.options || [] };
                }).sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
                
                state.orders = ordersSnap.docs.map(doc => ({ ...doc.data(), orderNumber: doc.id }));
                
                if (catDoc.exists) {
                    state.categories = catDoc.data().list || [];
                    state.categories.forEach((c,i)=> { if (c.displayOrder===undefined) c.displayOrder=i; });
                    state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
                } else {
                    state.categories = [...defaultCategories];
                    await db.collection('settings').doc('categories').set({ list: state.categories });
                }
                
                if (customDoc.exists) state.customization = customDoc.data();
                else await db.collection('settings').doc('customization').set(state.customization);
                
                determineCurrentTheme();
                determineCurrentFont();
                applyCustomization();
                updateRestaurantUI();
                updateCategoryTabs();
                displayMenuItems('all');
            } catch (e) { console.error("loadInitialData", e); }
        }

        // ========== REAL‑TIME LISTENERS ==========
        function setupListeners() {
            db.collection('orders').onSnapshot(snap => {
                state.orders = snap.docs.map(d => ({ ...d.data(), orderNumber: d.id }));
                if (!state.isAdminMode && document.querySelector('#myOrdersSection.active-section')) loadMyOrders();
                if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                    loadOrdersForAdmin();
                    loadSystemStats();
                    populateTableSelect('tableSelectForDelete');
                    if (adminPanel.style.display === 'flex') populateTableSelect('tableSelectForDeleteModal');
                }
            });
            db.collection('menuItems').onSnapshot(snap => {
                const incoming = snap.docs.map(doc => {
                    const d = doc.data();
                    d.displayOrder = d.displayOrder ?? Number(doc.id) ?? 999;
                    return { id: Number(doc.id), ...d, options: d.options || [] };
                }).sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
                state.menuItems = incoming;
                if (!state.isAdminMode && document.querySelector('#menuSection.active-section')) {
                    const activeCat = document.querySelector('.category-tab.active')?.dataset?.category || 'all';
                    displayMenuItems(activeCat);
                }
                if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                    const activeTab = document.querySelector('#adminDashboardSection .admin-tab.active')?.dataset?.tab;
                    if (activeTab === 'menu') loadMenuItemsForAdmin();
                }
                if (adminPanel.style.display === 'flex') loadMenuItemsForAdminModal();
            });
            db.collection('settings').doc('categories').onSnapshot(doc => {
                if (doc.exists) {
                    const catData = doc.data();
                    state.categories = catData.list || [];
                    state.categories.forEach((c,i)=> { if (c.displayOrder===undefined) c.displayOrder=i; });
                    state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
                }
                updateCategoryTabs();
                ['editItemCategory','editItemCategoryModal'].forEach(id => {
                    const sel = document.getElementById(id);
                    if (sel) {
                        const cur = sel.value;
                        sel.innerHTML = '';
                        state.categories.forEach(cat => {
                            const opt = document.createElement('option');
                            opt.value = cat.id; opt.textContent = cat.displayName;
                            sel.appendChild(opt);
                        });
                        if (cur && state.categories.some(c=>c.id===cur)) sel.value = cur;
                    }
                });
                if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                    const activeTab = document.querySelector('#adminDashboardSection .admin-tab.active')?.dataset?.tab;
                    if (activeTab === 'categories') loadCategoriesForAdmin();
                }
                if (adminPanel.style.display === 'flex') loadCategoriesForAdminModal();
            });
        }

        // ========== UI HELPERS ==========
        function determineCurrentTheme() {
            for (const [id, t] of Object.entries(themes)) {
                if (state.customization.primary === t.primary && state.customization.secondary === t.secondary && state.customization.background === t.background) {
                    state.currentTheme = id; return;
                }
            }
            state.currentTheme = "custom";
        }
        function determineCurrentFont() {
            for (const [id, f] of Object.entries(fonts)) {
                if (state.customization.fontPrimary === f.primary) { state.currentFont = id; return; }
            }
            state.currentFont = "poppins";
        }
        function applyCustomization() {
            const root = document.documentElement;
            Object.keys(state.customization).forEach(k => {
                if (k === 'fontPrimary' || k === 'fontSecondary') root.style.setProperty(`--${k}`, state.customization[k]);
                else root.style.setProperty(`--${k}`, state.customization[k]);
            });
            const previewName = document.getElementById('previewRestaurantName');
            if (previewName) { previewName.style.color = state.customization.primary; previewName.style.fontFamily = state.customization.fontSecondary; }
        }
        function updateRestaurantUI() {
            restaurantName.textContent = state.restaurantInfo.name;
            menuTitle.textContent = state.restaurantInfo.name + " Menu";
            estimatedTime.textContent = state.restaurantInfo.estimatedPrepTime;
            if (state.restaurantInfo.logoImage) { logoImage.src = state.restaurantInfo.logoImage; logoImage.style.display = 'block'; logoIcon.style.display = 'none'; }
            else { logoImage.style.display = 'none'; logoIcon.style.display = 'block'; }
        }
        function updateCategoryTabs() {
            if (!categoryTabs) return;
            categoryTabs.innerHTML = '';
            const sorted = [...state.categories].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            const all = document.createElement('button');
            all.className = 'category-tab active'; all.setAttribute('data-category', 'all'); all.textContent = 'All';
            all.addEventListener('click', function() { document.querySelectorAll('.category-tab').forEach(t=>t.classList.remove('active')); this.classList.add('active'); displayMenuItems('all'); });
            categoryTabs.appendChild(all);
            sorted.forEach(cat => {
                const tab = document.createElement('button');
                tab.className = 'category-tab'; tab.setAttribute('data-category', cat.id); tab.textContent = cat.displayName;
                tab.addEventListener('click', function() { document.querySelectorAll('.category-tab').forEach(t=>t.classList.remove('active')); this.classList.add('active'); displayMenuItems(cat.id); });
                categoryTabs.appendChild(tab);
            });
        }
        function displayMenuItems(category) {
            if (!menuGrid) return;
            menuGrid.innerHTML = '';
            const filtered = category === 'all' ? [...state.menuItems].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)) : state.menuItems.filter(i=>i.category===category).sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            if (filtered.length === 0) { menuGrid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--gray);"><i class="fas fa-utensils" style="font-size:50px; margin-bottom:15px; opacity:0.5;"></i><p>No items in this category yet.</p></div>'; return; }
            filtered.forEach(item => {
                const el = document.createElement('div'); el.className = 'menu-item';
                const imgStyle = item.image ? `background-image: url('${item.image}')` : 'background-color: var(--light-gray)';
                let optInd = '';
                if (item.options && item.options.length) optInd = `<div class="item-options-indicator"><i class="fas fa-sliders-h"></i> Με επιλογές</div>`;
                el.innerHTML = `<div class="item-image" style="${imgStyle}"></div><div class="item-content"><div class="item-header"><div class="item-name">${item.name}</div><div class="item-price">$${item.price.toFixed(2)}</div></div><div class="item-description">${item.description}</div>${optInd}<div class="item-footer"><div class="item-tags">${item.tags.map(t=>`<span class="item-tag">${t}</span>`).join('')}</div><button class="add-to-cart" data-id="${item.id}"><i class="fas fa-plus"></i></button></div></div>`;
                el.querySelector('.add-to-cart').addEventListener('click', ()=> addToCart(item.id));
                menuGrid.appendChild(el);
            });
        }
        // ----- CART FUNCTIONS -----
        function addToCart(itemId) {
            const item = state.menuItems.find(i=>i.id===itemId);
            if (!item) return;
            if (item.options && item.options.length) openOptionsModal(item);
            else addToCartWithOptions(itemId, []);
        }
        function addToCartWithOptions(itemId, selectedOptions = []) {
            if (state.isAdminMode) return;
            const menuItem = state.menuItems.find(i=>i.id===itemId);
            if (!menuItem) return;
            const itemPrice = menuItem.price + selectedOptions.reduce((sum,o)=>sum+(o.price||0),0);
            const cartItem = {
                id: menuItem.id, name: menuItem.name, basePrice: menuItem.price, price: itemPrice, quantity: 1,
                selectedOptions: selectedOptions.map(o=>({ groupName: o.groupName, choiceName: o.choiceName, price: o.price||0, isComment: o.isComment||false }))
            };
            const idx = state.cart.findIndex(i=> i.id===cartItem.id && JSON.stringify(i.selectedOptions.filter(x=>!x.isComment)) === JSON.stringify(cartItem.selectedOptions.filter(x=>!x.isComment)));
            if (idx !== -1) {
                const sameComments = JSON.stringify(state.cart[idx].selectedOptions.filter(x=>x.isComment)) === JSON.stringify(cartItem.selectedOptions.filter(x=>x.isComment));
                if (sameComments) state.cart[idx].quantity += 1;
                else state.cart.push(cartItem);
            } else state.cart.push(cartItem);
            updateCart();
            showNotification(`${menuItem.name} added to cart`);
        }
        function openOptionsModal(item) {
            let html = `<h3 class="options-modal-title">${item.name}</h3><div class="options-modal-price">$${item.price.toFixed(2)}</div><div class="item-description" style="margin-bottom:20px;">${item.description}</div>`;
            item.options.forEach((g, gi) => {
                if (g.type === 'text') {
                    html += `<div class="option-group"><div class="option-group-title"><i class="fas fa-comment"></i> ${g.name}</div><div class="comment-field"><textarea class="admin-textarea" placeholder="Enter your comment here..." id="comment_${g.id||gi}"></textarea></div></div>`;
                } else {
                    html += `<div class="option-group"><div class="option-group-title"><i class="fas fa-tag"></i> ${g.name} ${g.type==='radio'?'<span style="font-size:12px; color:var(--gray);">(choose one)</span>':'<span style="font-size:12px; color:var(--gray);">(choose any)</span>'}</div><div class="${g.type==='radio'?'option-group-radio':'option-group-checkbox'}">`;
                    g.choices.forEach((c, ci) => {
                        let priceText = ''; let priceClass = '';
                        if (c.price>0) { priceText = `+$${c.price.toFixed(2)}`; priceClass = 'choice-price-positive'; }
                        else if (c.price<0) { priceText = `-$${Math.abs(c.price).toFixed(2)}`; priceClass = 'choice-price-negative'; }
                        if (g.type==='radio') html += `<div class="choice-item"><label class="choice-label"><input type="radio" name="group_${g.id||gi}" value="${c.name}" data-price="${c.price}" data-group-name="${g.name}" data-choice-name="${c.name}"> <span class="choice-name">${c.name}</span></label><span class="choice-price ${priceClass}">${priceText}</span></div>`;
                        else html += `<div class="choice-item"><label class="choice-label"><input type="checkbox" name="group_${g.id||gi}" value="${c.name}" data-price="${c.price}" data-group-name="${g.name}" data-choice-name="${c.name}"> <span class="choice-name">${c.name}</span></label><span class="choice-price ${priceClass}">${priceText}</span></div>`;
                    });
                    html += `</div></div>`;
                }
            });
            html += `<div class="options-total"><span>Total:</span><span class="options-total-amount" id="optionsTotalAmount">$${item.price.toFixed(2)}</span></div><div class="options-modal-actions"><button class="btn btn-secondary" id="cancelOptionsBtn"><i class="fas fa-times"></i> Cancel</button><button class="btn btn-primary" id="confirmOptionsBtn"><i class="fas fa-check"></i> Add to Cart</button></div>`;
            optionsModalContent.innerHTML = html;
            optionsModal.style.display = 'flex';
            const inputs = optionsModal.querySelectorAll('input[type="radio"], input[type="checkbox"]');
            const updateTotal = () => {
                let extra = 0;
                inputs.forEach(i => { if ((i.type==='radio'||i.type==='checkbox') && i.checked) extra += parseFloat(i.dataset.price||0); });
                document.getElementById('optionsTotalAmount').textContent = `$${(item.price + extra).toFixed(2)}`;
            };
            inputs.forEach(i => i.addEventListener('change', updateTotal));
            document.getElementById('cancelOptionsBtn').addEventListener('click', ()=> { optionsModal.style.display = 'none'; });
            document.getElementById('confirmOptionsBtn').addEventListener('click', ()=> {
                let selected = [];
                inputs.forEach(i => { if (i.checked) selected.push({ groupName: i.dataset.groupName, choiceName: i.dataset.choiceName, price: parseFloat(i.dataset.price||0), isComment: false }); });
                item.options.forEach((g,gi) => {
                    if (g.type === 'text') {
                        const cf = document.getElementById(`comment_${g.id||gi}`);
                        if (cf && cf.value.trim() !== '') selected.push({ groupName: g.name, choiceName: cf.value.trim(), price: 0, isComment: true });
                    }
                });
                addToCartWithOptions(item.id, selected);
                optionsModal.style.display = 'none';
            });
        }
        function updateCart() {
            if (state.isAdminMode) return;
            const totalItems = state.cart.reduce((s,i)=>s+i.quantity,0);
            cartCount.textContent = totalItems;
            if (state.cart.length === 0) cartItems.innerHTML = '<div class="empty-cart" style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i><p>Your cart is empty</p></div>';
            else {
                cartItems.innerHTML = '';
                state.cart.forEach(item => {
                    const el = document.createElement('div'); el.className = 'cart-item';
                    let optHtml = '';
                    if (item.selectedOptions && item.selectedOptions.length) {
                        optHtml = '<div style="font-size:12px; color:var(--gray); margin-top:5px;">';
                        item.selectedOptions.forEach(o => {
                            if (o.isComment) optHtml += `<div><i class="fas fa-comment"></i> ${o.groupName}: "${o.choiceName}"</div>`;
                            else optHtml += `<div>• ${o.groupName}: ${o.choiceName} ${o.price>0 ? `+$${o.price.toFixed(2)}` : o.price<0 ? `-$${Math.abs(o.price).toFixed(2)}` : ''}</div>`;
                        });
                        optHtml += '</div>';
                    }
                    el.innerHTML = `<div class="cart-item-info"><div class="cart-item-name">${item.name}</div>${optHtml}<div class="cart-item-price">$${item.price.toFixed(2)}</div></div><div class="cart-item-controls"><div class="quantity-control"><button class="quantity-btn decrease" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-minus"></i></button><span class="quantity">${item.quantity}</span><button class="quantity-btn increase" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-plus"></i></button></div><div class="remove-item" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-trash"></i></div></div>`;
                    cartItems.appendChild(el);
                });
                document.querySelectorAll('.decrease').forEach(b => b.addEventListener('click', function() { updateCartItemQuantity(parseInt(this.dataset.id), JSON.parse(this.dataset.options||'[]'), -1); }));
                document.querySelectorAll('.increase').forEach(b => b.addEventListener('click', function() { updateCartItemQuantity(parseInt(this.dataset.id), JSON.parse(this.dataset.options||'[]'), 1); }));
                document.querySelectorAll('.remove-item').forEach(b => b.addEventListener('click', function() { removeFromCart(parseInt(this.dataset.id), JSON.parse(this.dataset.options||'[]')); }));
            }
            updateCartSummary();
        }
        function updateCartItemQuantity(id, opts, delta) {
            const idx = state.cart.findIndex(i => i.id===id && JSON.stringify(i.selectedOptions)===JSON.stringify(opts));
            if (idx !== -1) {
                state.cart[idx].quantity += delta;
                if (state.cart[idx].quantity <= 0) state.cart.splice(idx,1);
                updateCart();
            }
        }
        function removeFromCart(id, opts) {
            const idx = state.cart.findIndex(i => i.id===id && JSON.stringify(i.selectedOptions)===JSON.stringify(opts));
            if (idx !== -1) { const item = state.cart[idx]; state.cart.splice(idx,1); updateCart(); showNotification(`${item.name} removed from cart`); }
        }
        function calculateSubtotal() { return state.cart.reduce((s,i)=>s + i.price * i.quantity, 0); }
        function calculateTotal() { return calculateSubtotal(); }
        function updateCartSummary() {
            const sub = calculateSubtotal(); const tot = calculateTotal();
            document.getElementById('subtotal').textContent = `$${sub.toFixed(2)}`;
            document.getElementById('total').textContent = `$${tot.toFixed(2)}`;
        }
        function updatePaymentSummary() {
            const sub = calculateSubtotal(); const tot = calculateTotal();
            document.getElementById('paymentSubtotal').textContent = `$${sub.toFixed(2)}`;
            document.getElementById('paymentTotal').textContent = `$${tot.toFixed(2)}`;
        }
        function generateOrderNumber() { return `ORD-${Math.floor(1000+Math.random()*9000)}`; }
        function showOrderConfirmation(order) {
            orderNumberDisplay.textContent = order.orderNumber;
            confirmationTable.textContent = `Table: ${order.table}`;
            confirmationItems.innerHTML = '';
            order.items.forEach(i => {
                let opt = '';
                if (i.selectedOptions && i.selectedOptions.length) {
                    opt = '<div style="font-size:12px; color:var(--gray);">' + i.selectedOptions.map(o => o.isComment ? `${o.groupName}: "${o.choiceName}"` : `${o.groupName}: ${o.choiceName}`).join(', ') + '</div>';
                }
                confirmationItems.innerHTML += `<div class="order-item"><div class="order-item-name"><div class="order-item-quantity">${i.quantity}</div><div>${i.name}${opt}</div></div><div class="order-item-price">$${(i.price*i.quantity).toFixed(2)}</div></div>`;
            });
            confirmationTotal.textContent = `$${order.total.toFixed(2)}`;
            confirmationPaymentMethod.textContent = order.paymentMethod === 'card' ? 'Credit/Debit Card' : 'Cash';
            confirmationPaymentTime.textContent = order.paymentTime === 'now' ? 'Pay Now' : 'Pay Later';
            confirmationOrderStatus.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
        }
        function resetCart() { state.cart = []; updateCart(); }
        function resetOrder() {
            state.cart = []; state.selectedPaymentMethod = null; state.selectedPaymentTime = null; state.currentOrderNumber = null; state.currentTable = null;
            updateCart(); document.querySelectorAll('.option-card').forEach(c=>c.classList.remove('selected'));
            tableInfo.innerHTML = `<i class="fas fa-qrcode"></i> Scan QR to begin`;
            menuSubtitle.textContent = 'Select items to add to your order';
            myOrdersButton.style.display = 'none';
        }
        function showNotification(msg) { notificationText.textContent = msg; notification.classList.add('show'); setTimeout(()=>notification.classList.remove('show'),3000); }
        function showSection(id) {
            document.querySelectorAll('.app-section, .admin-dashboard-section').forEach(s=>{ s.classList.remove('active-section'); s.style.display='none'; });
            const sec = document.getElementById(id);
            if (sec) { sec.style.display = 'block'; setTimeout(()=>sec.classList.add('active-section'),10); }
            if (id==='cartSection' && state.currentTable && !state.isAdminMode) cartSubtitle.textContent = `Your order for ${state.currentTable}`;
            if (id==='menuSection' && state.currentTable && !state.isAdminMode) menuSubtitle.textContent = state.cart.length===0 ? `Select items to add to your order for ${state.currentTable}` : `Continue adding items to your order for ${state.currentTable}`;
            if (id==='myOrdersSection' && state.currentTable && !state.isAdminMode) loadMyOrders();
            if (state.isAdminMode) cartFloating.style.display = 'none'; else if (id!=='scannerSection') cartFloating.style.display = 'flex';
        }
        function loadMyOrders() {
            if (!state.currentTable || state.isAdminMode) { ordersList.innerHTML = '<div class="no-orders-message"><i class="fas fa-clipboard-list"></i><h3>No Table Selected</h3><p>Please select a table first to view your orders.</p></div>'; return; }
            const tableOrders = state.orders.filter(o=>o.table===state.currentTable);
            if (tableOrders.length===0) { ordersList.innerHTML = '<div class="no-orders-message"><i class="fas fa-clipboard-list"></i><h3>No Orders Yet</h3><p>You haven\'t placed any orders yet. Start by selecting items from the menu.</p></div>'; return; }
            tableOrders.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
            ordersList.innerHTML = '';
            tableOrders.forEach(o => {
                const card = document.createElement('div'); card.className = 'order-card';
                const date = new Date(o.timestamp).toLocaleString();
                let badge = ''; switch(o.status) { case 'pending': badge='<span class="order-status-badge status-pending">Pending</span>'; break; case 'preparing': badge='<span class="order-status-badge status-preparing">Preparing</span>'; break; case 'ready': badge='<span class="order-status-badge status-ready">Ready</span>'; break; case 'served': badge='<span class="order-status-badge status-served">Served</span>'; break; case 'cancelled': badge='<span class="order-status-badge status-cancelled">Cancelled</span>'; }
                let itemsSum = '';
                if (o.items.length<=3) itemsSum = o.items.map(i=>`<div class="order-item-summary"><div class="order-item-summary-name"><div class="order-item-summary-quantity">${i.quantity}</div><div>${i.name}</div></div><div>$${(i.price*i.quantity).toFixed(2)}</div></div>`).join('');
                else {
                    const first = o.items.slice(0,3); const rem = o.items.length-3;
                    itemsSum = first.map(i=>`<div class="order-item-summary"><div class="order-item-summary-name"><div class="order-item-summary-quantity">${i.quantity}</div><div>${i.name}</div></div><div>$${(i.price*i.quantity).toFixed(2)}</div></div>`).join('');
                    itemsSum += `<div class="order-item-summary"><div class="order-item-summary-name" style="margin-left: 10px; font-style: italic;">+${rem} more item${rem>1?'s':''}</div><div></div></div>`;
                }
                card.innerHTML = `<div class="order-card-header"><div><div class="order-card-title">Order #${o.orderNumber}</div><div class="order-card-time">${date}</div></div><div>${badge}</div></div><div class="order-card-body"><div class="order-items-summary">${itemsSum}</div><div style="margin-top:15px;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Payment Method:</span><span>${o.paymentMethod==='card'?'Card':'Cash'}</span></div><div style="display:flex; justify-content:space-between;"><span>Payment Time:</span><span>${o.paymentTime==='now'?'Pay Now':'Pay Later'}</span></div></div></div><div class="order-card-footer"><div class="order-total-summary">Total: $${o.total.toFixed(2)}</div><div style="font-size:14px; color:var(--gray);">${o.status==='pending'?'Your order is being processed':o.status==='preparing'?'Your food is being prepared':o.status==='ready'?'Your order is ready':o.status==='served'?'Your order has been served':'Your order has been cancelled'}</div></div>`;
                ordersList.appendChild(card);
            });
            myOrdersSubtitle.textContent = `You have ${tableOrders.length} order${tableOrders.length!==1?'s':''} for ${state.currentTable}`;
        }

        // ========== 🚀 AUTO‑LOGIN FROM URL (NEVER ASKS FOR CODE UNLESS CLICKED MANUALLY) ==========
        function selectTable(name, isAutoLogin = false) {
            state.currentTable = name;
            // 🔥 CRITICAL FIX: Auto‑login from QR code NEVER triggers admin code prompt
            if (name.toLowerCase() === "admin") {
                if (isAutoLogin) {
                    // If someone scans an "Admin" QR code, just show a notification and stay on scanner
                    showNotification("Admin access requires manual click on the Admin button.");
                    return;
                } else {
                    // Manual click on Admin button → show code prompt
                    showAdminCodePrompt();
                    return;
                }
            }
            // Normal table selection
            tableInfo.innerHTML = `<i class="fas fa-chair"></i> ${name}`;
            menuSubtitle.textContent = `Select items to add to your order for ${name}`;
            cartSubtitle.textContent = `Your order for ${name}`;
            localStorage.setItem('dineEasyTable', name);
            showNotification(`Table ${name} selected. Welcome!`);
            resetCart();
            updateCategoryTabs();
            displayMenuItems('all');
            myOrdersButton.style.display = 'flex';
            showSection('menuSection');
        }

        function autoLoginFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const tableParam = urlParams.get('table');
            if (tableParam) {
                const tableName = decodeURIComponent(tableParam);
                // Pass isAutoLogin = true so it never asks for code
                selectTable(tableName, true);
            }
        }

        function showHelpNotification() { if (state.currentTable) showNotification(`Ένας σερβιτόρος θα σας εξυπηρετήσει σύντομα.`); else showNotification('Ένας σερβιτόρος θα σας εξυπηρετήσει σύντομα.'); }

        // ========== ADMIN MODE ==========
        function showAdminCodePrompt() { adminCodePrompt.style.display = 'flex'; adminCodeInput.focus(); }
        function showAdminChangePrompt(action) { state.pendingAdminAction = action; adminChangePrompt.style.display = 'flex'; adminChangeCodeInput.focus(); }
        function enterAdminMode() {
            state.isAdminMode = true; state.currentTable = "Admin";
            document.body.classList.add('admin-mode');
            document.querySelector('.header-center').innerHTML = '<div class="admin-badge"><i class="fas fa-shield-alt"></i> Administrator Mode</div>';
            document.querySelector('.header-right').innerHTML = '<button class="logout-button" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</button>';
            document.getElementById('logoutButton').addEventListener('click', exitAdminMode);
            cartFloating.style.display = 'none';
            showSection('adminDashboardSection');
            loadAdminDashboardData();
            localStorage.setItem('dineEasyAdminMode', 'true');
            showNotification("Admin mode activated. Full administrative access granted.");
        }
        function exitAdminMode() {
            state.isAdminMode = false; state.currentTable = null;
            document.body.classList.remove('admin-mode');
            document.querySelector('.header-center').innerHTML = '<button class="help-button" id="headerHelpButton"><i class="fas fa-headset"></i> Χρειάζεστε βοήθεια?</button>';
            document.querySelector('.header-right').innerHTML = '<button class="my-orders-button" id="myOrdersButton" style="display: none;"><i class="fas fa-clipboard-list"></i> Οι Παραγγελίες μου</button><div class="table-info" id="tableInfo"><i class="fas fa-qrcode"></i> Scan QR to begin</div>';
            document.getElementById('headerHelpButton').addEventListener('click', showHelpNotification);
            cartFloating.style.display = 'flex';
            showSection('scannerSection');
            localStorage.removeItem('dineEasyAdminMode');
            showNotification("Logged out of admin mode.");
        }

        // ========== DRAG AND DROP – FULLY FIXED ==========
        async function makeAdminGridDraggable(gridId) {
            const grid = document.getElementById(gridId); if (!grid) return;
            let dragged = null;
            grid.addEventListener('dragstart', e => {
                const card = e.target.classList.contains('admin-card')?e.target:e.target.closest('.admin-card');
                if (card) { dragged = card; card.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', card.dataset.itemId||''); }
            });
            grid.addEventListener('dragend', e => { if (dragged) { dragged.classList.remove('dragging'); dragged=null; } });
            grid.addEventListener('dragover', e => e.preventDefault());
            grid.addEventListener('drop', async function(e) {
                e.preventDefault(); if (!dragged) return;
                const target = e.target.classList.contains('admin-card')?e.target:e.target.closest('.admin-card');
                if (!target || target===dragged) return;
                const items = Array.from(grid.children).filter(c=>c.classList.contains('admin-card'));
                const dragIdx = items.indexOf(dragged), targetIdx = items.indexOf(target);
                if (dragIdx===-1 || targetIdx===-1) return;
                if (dragIdx<targetIdx) grid.insertBefore(dragged, target.nextSibling);
                else grid.insertBefore(dragged, target);
                
                const updated = Array.from(grid.children).filter(c=>c.classList.contains('admin-card'));
                updated.forEach((c, idx) => {
                    const id = parseInt(c.dataset.itemId);
                    const mi = state.menuItems.find(m => m.id === id);
                    if (mi) mi.displayOrder = idx;
                });
                state.menuItems.sort((a,b) => (a.displayOrder||0) - (b.displayOrder||0));
                
                await Promise.all(state.menuItems.map(item => saveMenuItem(item)));
                showNotification("Menu order updated");
                loadMenuItemsForAdmin();
                displayMenuItems(document.querySelector('.category-tab.active')?.dataset?.category || 'all');
            });
        }
        function makeCategoriesDraggable(containerId) {
            const c = document.getElementById(containerId); if (!c) return;
            let dragged = null;
            c.addEventListener('dragstart', e => {
                const item = e.target.classList.contains('category-item')?e.target:e.target.closest('.category-item');
                if (item) { dragged = item; item.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', item.dataset.categoryId||''); }
            });
            c.addEventListener('dragend', e => { if (dragged) { dragged.classList.remove('dragging'); dragged=null; } });
            c.addEventListener('dragover', e => e.preventDefault());
            c.addEventListener('drop', async function(e) {
                e.preventDefault(); if (!dragged) return;
                const target = e.target.classList.contains('category-item')?e.target:e.target.closest('.category-item');
                if (!target || target===dragged) return;
                const items = Array.from(c.children).filter(el=>el.classList.contains('category-item'));
                const dragIdx = items.indexOf(dragged), targetIdx = items.indexOf(target);
                if (dragIdx===-1 || targetIdx===-1) return;
                if (dragIdx<targetIdx) c.insertBefore(dragged, target.nextSibling);
                else c.insertBefore(dragged, target);
                const updated = Array.from(c.children).filter(el=>el.classList.contains('category-item'));
                updated.forEach((el, i) => {
                    const catId = el.dataset.categoryId;
                    const cat = state.categories.find(ca=>ca.id===catId);
                    if (cat) cat.displayOrder = i;
                });
                state.categories.sort((a,b) => (a.displayOrder||0) - (b.displayOrder||0));
                await saveCategories();
                updateCategoryTabs();
            });
        }

        // ========== DELETE ORDERS BY TABLE ==========
        function populateTableSelect(selectId) {
            const sel = document.getElementById(selectId); if (!sel) return;
            const tables = [...new Set(state.orders.filter(o=>o.table&&o.table.toLowerCase()!=='admin').map(o=>o.table))].sort();
            sel.innerHTML = '';
            if (tables.length===0) sel.innerHTML = '<option value="">-- No tables with orders --</option>';
            else {
                const def = document.createElement('option'); def.value = ''; def.textContent = '-- Select a table --'; sel.appendChild(def);
                tables.forEach(t => {
                    const opt = document.createElement('option'); opt.value = t; opt.textContent = t + ` (${state.orders.filter(o=>o.table===t).length} orders)`;
                    sel.appendChild(opt);
                });
            }
        }
        async function deleteOrdersForTable(tableName) {
            if (!tableName) { showNotification('Please select a table.'); return; }
            const toDelete = state.orders.filter(o=>o.table===tableName);
            if (toDelete.length===0) { showNotification(`No orders for table "${tableName}".`); return; }
            if (!confirm(`Delete ALL orders for table "${tableName}"?`)) return;
            state.orders = state.orders.filter(o=>o.table!==tableName);
            loadOrdersForAdmin();
            if (adminPanel.style.display === 'flex') loadOrdersForAdminModal();
            populateTableSelect('tableSelectForDelete');
            populateTableSelect('tableSelectForDeleteModal');
            showNotification(`Deleted ${toDelete.length} orders.`);
            await Promise.all(toDelete.map(o=>deleteOrderFirestore(o.orderNumber)));
        }

        // ========== ADMIN DASHBOARD ==========
        function loadAdminDashboardData() {
            document.getElementById('adminRestaurantName').value = state.restaurantInfo.name;
            document.getElementById('adminTaxRate').value = state.restaurantInfo.taxRate;
            document.getElementById('adminPrepTime').value = state.restaurantInfo.estimatedPrepTime;
            document.getElementById('adminWelcomeMessage').value = state.restaurantInfo.welcomeMessage || '';
            updateLogoPreview();
            loadMenuItemsForAdmin();
            loadCategoriesForAdmin();
            loadOrdersForAdmin();
            loadSystemStats();
            loadCustomizationSettings();

            document.querySelectorAll('#adminDashboardSection .admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tid = this.dataset.tab;
                    document.querySelectorAll('#adminDashboardSection .admin-tab').forEach(t=>t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('#adminDashboardSection .admin-content').forEach(c=>c.classList.remove('active'));
                    document.getElementById(tid+'Tab').classList.add('active');
                    if (tid==='customization') setTimeout(initializeCustomizationTab,100);
                    if (tid==='categories') setTimeout(()=>makeCategoriesDraggable('categoriesListContainer'),200);
                    if (tid==='orders') { loadOrdersForAdmin(); populateTableSelect('tableSelectForDelete'); }
                });
            });
            document.getElementById('uploadLogoBtn').addEventListener('click', ()=>document.getElementById('logoUpload').click());
            document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
            document.getElementById('removeLogoBtn').addEventListener('click', removeLogo);
            document.getElementById('saveRestaurantSettings').addEventListener('click', ()=> showAdminChangePrompt(saveRestaurantSettingsOptimistic));
            document.getElementById('addMenuItemBtn').addEventListener('click', ()=> openEditMenuItemForm(null));
            document.getElementById('addCategoryBtn').addEventListener('click', ()=> showAdminChangePrompt(addCategoryOptimistic));
            document.getElementById('orderStatusFilter').addEventListener('change', loadOrdersForAdmin);
            document.getElementById('clearOrdersBtn').addEventListener('click', ()=> showAdminChangePrompt(clearAllOrdersOptimistic));
            document.getElementById('resetMenuBtn').addEventListener('click', ()=> showAdminChangePrompt(async function() { if (confirm("Reset menu to default?")) { state.menuItems = [...defaultMenuItems]; await Promise.all(state.menuItems.map(i=>saveMenuItem(i))); loadMenuItemsForAdmin(); displayMenuItems('all'); showNotification("Menu reset."); } }));
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', ()=> document.getElementById('importDataInput').click());
            document.getElementById('importDataInput').addEventListener('change', (e)=> showAdminChangePrompt(()=>importData(e)));
            document.getElementById('deleteOrdersForTableBtn').addEventListener('click', function() {
                const sel = document.getElementById('tableSelectForDelete');
                if (sel.value) showAdminChangePrompt(()=>deleteOrdersForTable(sel.value));
                else showNotification('Please select a table.');
            });
            adminDashboardSection.addEventListener('click', e => {
                if (e.target.classList.contains('update-status') || e.target.closest('.update-status')) {
                    const btn = e.target.classList.contains('update-status')?e.target:e.target.closest('.update-status');
                    const oid = btn.dataset.orderId;
                    const sel = document.querySelector(`select[data-order-id="${oid}"]`);
                    if (sel && oid) updateOrderStatusOptimistic(oid, sel.value);
                }
            });
            setTimeout(()=>{ makeAdminGridDraggable('menuItemsList'); makeCategoriesDraggable('categoriesListContainer'); populateTableSelect('tableSelectForDelete'); },500);
        }
        function updateLogoPreview() {
            const p = document.getElementById('logoPreview'); const p2 = document.getElementById('logoPreviewModal');
            if (state.restaurantInfo.logoImage) { p.innerHTML = `<img src="${state.restaurantInfo.logoImage}" alt="Restaurant Logo">`; if (p2) p2.innerHTML = `<img src="${state.restaurantInfo.logoImage}" alt="Restaurant Logo">`; }
            else { p.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div>'; if (p2) p2.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div>'; }
        }
        function handleLogoUpload(e) {
            const file = e.target.files[0]; if (!file || !file.type.match('image.*')) return;
            const reader = new FileReader();
            reader.onload = function(ev) { state.restaurantInfo.logoImage = ev.target.result; updateLogoPreview(); updateRestaurantUI(); showNotification("Logo uploaded. Don't forget to save."); };
            reader.readAsDataURL(file);
        }
        function removeLogo() { state.restaurantInfo.logoImage = ""; updateLogoPreview(); updateRestaurantUI(); showNotification("Logo removed. Don't forget to save."); }
        async function saveRestaurantSettingsOptimistic() {
            state.restaurantInfo.name = document.getElementById('adminRestaurantName').value;
            state.restaurantInfo.taxRate = parseFloat(document.getElementById('adminTaxRate').value);
            state.restaurantInfo.estimatedPrepTime = document.getElementById('adminPrepTime').value;
            state.restaurantInfo.welcomeMessage = document.getElementById('adminWelcomeMessage').value;
            updateRestaurantUI();
            showNotification("Restaurant settings saved.");
            await saveRestaurantInfo();
        }
        // --- MENU ADMIN ---
        function loadMenuItemsForAdmin() {
            const list = document.getElementById('menuItemsList'); list.innerHTML = '';
            if (state.menuItems.length===0) { list.innerHTML = '<p style="text-align: center; color: var(--gray);">No menu items found.</p>'; return; }
            const sorted = [...state.menuItems].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            sorted.forEach(item => {
                const card = document.createElement('div'); card.className = 'admin-card'; card.setAttribute('draggable','true'); card.dataset.itemId = item.id;
                const img = item.image ? `<div style="height:120px; background-image:url('${item.image}'); background-size:cover; background-position:center; border-radius:8px; margin-bottom:10px;"></div>` : `<div style="height:120px; background-color:var(--light-gray); border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:var(--gray);"><i class="fas fa-utensils"></i></div>`;
                card.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><i class="fas fa-grip-vertical drag-handle"></i></div>${img}<div class="admin-card-header"><div class="admin-card-title">${item.name}</div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-item" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-secondary duplicate-item" data-id="${item.id}"><i class="fas fa-copy"></i></button><button class="admin-small-btn btn-danger delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div><p style="margin-bottom:10px; font-size:14px;">${item.description}</p><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:600; color:var(--primary);">$${item.price.toFixed(2)}</span><span style="font-size:12px; color:var(--gray);">${getCategoryDisplayName(item.category)}</span></div><div class="tag-display">${item.tags.map(t=>`<span class="tag-item">${t}</span>`).join('')}</div>`;
                if (item.options?.length) card.innerHTML += `<div style="margin-top:10px; font-size:12px; color:var(--secondary);"><i class="fas fa-tasks"></i> ${item.options.length} option group(s)</div>`;
                list.appendChild(card);
            });
            document.querySelectorAll('.edit-item').forEach(b=> b.addEventListener('click', function() { openEditMenuItemForm(parseInt(this.dataset.id)); }));
            document.querySelectorAll('.duplicate-item').forEach(b=> b.addEventListener('click', function() { duplicateMenuItemOptimistic(parseInt(this.dataset.id)); }));
            document.querySelectorAll('.delete-item').forEach(b=> b.addEventListener('click', function() { const id = parseInt(this.dataset.id); showAdminChangePrompt(()=>deleteMenuItemOptimistic(id)); }));
            makeAdminGridDraggable('menuItemsList');
        }
        async function duplicateMenuItemOptimistic(id) {
            const orig = state.menuItems.find(i=>i.id===id); if (!orig) return;
            const newId = state.menuItems.length ? Math.max(...state.menuItems.map(i=>i.id))+1 : 1;
            const maxOrder = state.menuItems.reduce((m,i)=>Math.max(m,i.displayOrder||0),0);
            const newItem = { ...orig, id: newId, name: `${orig.name} (copy)`, displayOrder: maxOrder+1 };
            state.menuItems.push(newItem);
            state.menuItems.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            loadMenuItemsForAdmin(); displayMenuItems('all');
            showNotification(`"${newItem.name}" duplicated.`);
            await saveMenuItem(newItem);
        }
        function openEditMenuItemForm(id) {
            const form = document.getElementById('editMenuItemForm'); const list = document.getElementById('menuItemsList'); const catSel = document.getElementById('editItemCategory');
            catSel.innerHTML = '';
            state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c=> { const o = document.createElement('option'); o.value=c.id; o.textContent=c.displayName; catSel.appendChild(o); });
            const oldOpt = document.getElementById('adminOptionsSection'); if (oldOpt) oldOpt.remove();
            if (id) {
                const item = state.menuItems.find(i=>i.id===id);
                if (item) {
                    document.getElementById('editItemName').value = item.name;
                    document.getElementById('editItemDescription').value = item.description;
                    document.getElementById('editItemPrice').value = item.price;
                    document.getElementById('editItemCategory').value = item.category;
                    document.getElementById('editItemTags').value = item.tags.join(', ');
                    updateItemImagePreview(item.image);
                    form.dataset.itemId = id;
                    buildOptionsAdminUI(item.options||[]);
                }
            } else {
                document.getElementById('editItemName').value = '';
                document.getElementById('editItemDescription').value = '';
                document.getElementById('editItemPrice').value = '';
                document.getElementById('editItemCategory').value = state.categories[0]?.id || '';
                document.getElementById('editItemTags').value = '';
                updateItemImagePreview('');
                form.dataset.itemId = '';
                buildOptionsAdminUI([]);
            }
            document.getElementById('uploadItemImageBtn').addEventListener('click', ()=>document.getElementById('itemImageUpload').click());
            document.getElementById('itemImageUpload').addEventListener('change', handleItemImageUpload);
            document.getElementById('removeItemImageBtn').addEventListener('click', ()=>{ updateItemImagePreview(''); state.currentImageUpload = null; });
            list.style.display = 'none'; form.style.display = 'block';
            document.getElementById('cancelEditBtn').onclick = function() { form.style.display = 'none'; list.style.display = 'block'; };
            document.getElementById('saveMenuItemBtn').onclick = function() { showAdminChangePrompt(saveMenuItemOptimistic); };
        }
        function buildOptionsAdminUI(options) {
            const form = document.getElementById('editMenuItemForm');
            const sec = document.createElement('div'); sec.id = 'adminOptionsSection'; sec.className = 'admin-options-section';
            sec.innerHTML = `<h4 style="margin-bottom:15px;"><i class="fas fa-tasks"></i> Options / Subcategories</h4><div id="optionsGroupsContainer"></div><button type="button" class="btn btn-secondary" id="addOptionGroupBtn"><i class="fas fa-plus"></i> Add Option Group</button>`;
            const tagsGrp = document.querySelector('.admin-form-group:has(#editItemTags)');
            if (tagsGrp) tagsGrp.parentNode.insertBefore(sec, tagsGrp.nextSibling);
            else form.appendChild(sec);
            const container = document.getElementById('optionsGroupsContainer');
            function render() {
                container.innerHTML = '';
                options.forEach((g, gi) => {
                    const grp = document.createElement('div'); grp.className = 'admin-option-group';
                    grp.innerHTML = `<div class="admin-option-group-header"><div class="admin-option-group-title"><i class="fas fa-layer-group"></i> <input type="text" class="admin-input" style="width:150px;" placeholder="Group name" value="${g.name}" id="group_name_${gi}"><select class="admin-select" style="width:140px;" id="group_type_${gi}"><option value="radio" ${g.type==='radio'?'selected':''}>Single choice</option><option value="checkbox" ${g.type==='checkbox'?'selected':''}>Multiple choice</option><option value="text" ${g.type==='text'?'selected':''}>Comment field</option></select></div><button class="admin-small-btn btn-danger remove-group" data-index="${gi}"><i class="fas fa-trash"></i></button></div><div id="choices_${gi}" class="choices-container"></div>${g.type!=='text'?'<button class="btn btn-secondary add-choice-btn" data-group-index="'+gi+'"><i class="fas fa-plus"></i> Add Choice</button>':''}`;
                    container.appendChild(grp);
                    if (g.type !== 'text') {
                        const chc = document.getElementById(`choices_${gi}`);
                        g.choices.forEach((c, ci) => {
                            const row = document.createElement('div'); row.className = 'admin-choice-item';
                            row.innerHTML = `<input type="text" class="admin-input admin-choice-input" placeholder="Choice name" value="${c.name||''}" id="choice_name_${gi}_${ci}"><input type="number" class="admin-input admin-choice-price" placeholder="Price adj." step="0.01" value="${c.price||0}" id="choice_price_${gi}_${ci}"><button class="admin-small-btn btn-danger remove-choice" data-group="${gi}" data-choice="${ci}"><i class="fas fa-times"></i></button>`;
                            chc.appendChild(row);
                            row.querySelector(`#choice_name_${gi}_${ci}`).addEventListener('input', e=> { if (!options[gi].choices[ci]) options[gi].choices[ci] = {}; options[gi].choices[ci].name = e.target.value; });
                            row.querySelector(`#choice_price_${gi}_${ci}`).addEventListener('input', e=> { if (!options[gi].choices[ci]) options[gi].choices[ci] = {}; options[gi].choices[ci].price = parseFloat(e.target.value)||0; });
                            row.querySelector('.remove-choice').addEventListener('click', ()=> { options[gi].choices.splice(ci,1); render(); });
                        });
                        grp.querySelector('.add-choice-btn').addEventListener('click', ()=> { options[gi].choices.push({ name: '', price: 0 }); render(); });
                    }
                    grp.querySelector('.remove-group').addEventListener('click', ()=> { options.splice(gi,1); render(); });
                    grp.querySelector(`#group_name_${gi}`).addEventListener('input', e=> { options[gi].name = e.target.value; });
                    grp.querySelector(`#group_type_${gi}`).addEventListener('change', e=> { options[gi].type = e.target.value; if (options[gi].type==='text') options[gi].choices = []; else if (!options[gi].choices) options[gi].choices = []; render(); });
                });
            }
            render();
            document.getElementById('addOptionGroupBtn').addEventListener('click', ()=> { options.push({ id: Date.now()+Math.random(), name: 'New Group', type: 'radio', choices: [] }); render(); });
        }
        function updateItemImagePreview(data) {
            const pv = document.getElementById('itemImagePreview');
            if (data) { pv.innerHTML = `<img src="${data}" alt="Menu Item Image">`; state.currentImageUpload = data; }
            else { pv.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-utensils"></i><p>No image uploaded</p></div>'; state.currentImageUpload = null; }
        }
        function handleItemImageUpload(e) {
            const file = e.target.files[0]; if (!file || !file.type.match('image.*')) return;
            const reader = new FileReader();
            reader.onload = ev => { updateItemImagePreview(ev.target.result); showNotification("Image uploaded. Don't forget to save."); };
            reader.readAsDataURL(file);
        }
        async function saveMenuItemOptimistic() {
            const id = document.getElementById('editMenuItemForm').dataset.itemId;
            const name = document.getElementById('editItemName').value;
            const desc = document.getElementById('editItemDescription').value;
            const price = parseFloat(document.getElementById('editItemPrice').value);
            const cat = document.getElementById('editItemCategory').value;
            const tags = document.getElementById('editItemTags').value.split(',').map(t=>t.trim()).filter(t=>t);
            if (!name||!desc||!price||!cat) { showNotification("Please fill all required fields."); return; }
            let options = [];
            const optSec = document.getElementById('adminOptionsSection');
            if (optSec) {
                const grps = optSec.querySelectorAll('.admin-option-group');
                grps.forEach((g,gi)=> {
                    const gn = g.querySelector(`#group_name_${gi}`)?.value;
                    const gt = g.querySelector(`#group_type_${gi}`)?.value;
                    if (!gn) return;
                    const choices = [];
                    if (gt !== 'text') {
                        const rows = g.querySelectorAll('.admin-choice-item');
                        rows.forEach((r,ci)=> {
                            const n = r.querySelector(`#choice_name_${gi}_${ci}`)?.value?.trim();
                            const p = parseFloat(r.querySelector(`#choice_price_${gi}_${ci}`)?.value) || 0;
                            if (n) choices.push({ name: n, price: p });
                        });
                    }
                    if (gn.trim() && (gt==='text' || choices.length>0)) options.push({ id: 'opt_'+Date.now()+'_'+gi, name: gn.trim(), type: gt, choices });
                });
            }
            if (id) {
                const idx = state.menuItems.findIndex(i=>i.id===parseInt(id));
                if (idx!==-1) {
                    state.menuItems[idx] = { ...state.menuItems[idx], name, description: desc, price, category: cat, image: state.currentImageUpload||state.menuItems[idx].image, tags, options };
                }
            } else {
                const newId = state.menuItems.length ? Math.max(...state.menuItems.map(i=>i.id))+1 : 1;
                const maxOrder = state.menuItems.reduce((m,i)=>Math.max(m,i.displayOrder||0),0);
                state.menuItems.push({ id: newId, name, description: desc, price, category: cat, image: state.currentImageUpload||'', tags, options, displayOrder: maxOrder+1 });
            }
            state.menuItems.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            document.getElementById('editMenuItemForm').style.display = 'none';
            document.getElementById('menuItemsList').style.display = 'block';
            state.currentImageUpload = null;
            loadMenuItemsForAdmin();
            displayMenuItems('all');
            showNotification(id ? "Menu item updated." : "Menu item added.");
            if (id) { const it = state.menuItems.find(i=>i.id===parseInt(id)); if (it) await saveMenuItem(it); }
            else { const newItem = state.menuItems[state.menuItems.length-1]; await saveMenuItem(newItem); }
        }
        async function deleteMenuItemOptimistic(id) {
            if (!confirm("Delete this menu item?")) return;
            const item = state.menuItems.find(i=>i.id===id);
            state.menuItems = state.menuItems.filter(i=>i.id!==id);
            loadMenuItemsForAdmin();
            displayMenuItems('all');
            showNotification(`"${item?.name}" deleted.`);
            await deleteMenuItemFirestore(id);
        }
        // --- CATEGORY ADMIN ---
        function loadCategoriesForAdmin() {
            const con = document.getElementById('categoriesListContainer'); con.innerHTML = '';
            if (state.categories.length===0) { con.innerHTML = '<p style="text-align:center; color:var(--gray); padding:20px;">No categories added yet.</p>'; return; }
            state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c => {
                const cnt = state.menuItems.filter(i=>i.category===c.id).length;
                const el = document.createElement('div'); el.className = 'category-item'; el.setAttribute('draggable','true'); el.dataset.categoryId = c.id;
                el.innerHTML = `<div style="display:flex; align-items:center;"><i class="fas fa-grip-vertical drag-handle-category"></i><span class="category-item-name">${c.displayName}</span><span class="category-item-count">${cnt} item${cnt!==1?'s':''}</span></div><div class="admin-card-actions"><button class="admin-small-btn btn-danger delete-category" data-id="${c.id}"><i class="fas fa-trash"></i></button></div>`;
                con.appendChild(el);
            });
            document.querySelectorAll('.delete-category').forEach(b=> b.addEventListener('click', function() { const id = this.dataset.id; showAdminChangePrompt(()=>deleteCategoryOptimistic(id)); }));
            makeCategoriesDraggable('categoriesListContainer');
        }
        async function addCategoryOptimistic() {
            const ni = document.getElementById('newCategoryName'); const di = document.getElementById('newCategoryDisplayName');
            const id = ni.value.trim().toLowerCase().replace(/\s+/g,'-'); const disp = di.value.trim() || ni.value.trim();
            if (!id) { showNotification("Please enter a category name."); return; }
            if (state.categories.some(c=>c.id===id)) { showNotification("Category already exists."); return; }
            const maxOrder = state.categories.reduce((m,c)=>Math.max(m,c.displayOrder||0),0);
            state.categories.push({ id, name: id, displayName: disp, isDefault: false, displayOrder: maxOrder+1 });
            state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            loadCategoriesForAdmin(); updateCategoryTabs();
            ni.value = ''; di.value = '';
            showNotification(`Category "${disp}" added.`);
            await saveCategories();
        }
        async function deleteCategoryOptimistic(id) {
            const cat = state.categories.find(c=>c.id===id); if (!cat) return;
            const used = state.menuItems.filter(i=>i.category===id).length;
            if (used>0) { showNotification(`Cannot delete "${cat.displayName}" – it has ${used} menu item(s).`); return; }
            if (!confirm(`Delete category "${cat.displayName}"?`)) return;
            state.categories = state.categories.filter(c=>c.id!==id);
            loadCategoriesForAdmin(); updateCategoryTabs();
            showNotification(`Category "${cat.displayName}" deleted.`);
            await saveCategories();
        }
        function getCategoryDisplayName(id) { const c = state.categories.find(c=>c.id===id); return c ? c.displayName : id; }

        // --- ORDER ADMIN ---
        function loadOrdersForAdmin() {
            const list = document.getElementById('adminOrdersList'); const filter = document.getElementById('orderStatusFilter').value;
            let filtered = filter==='all' ? [...state.orders] : state.orders.filter(o=>o.status===filter);
            filtered.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
            if (filtered.length===0) { list.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No orders found.</p>'; return; }
            list.innerHTML = '';
            filtered.forEach(o => {
                const card = document.createElement('div'); card.className = 'admin-card'; card.style.marginBottom = '15px';
                const date = new Date(o.timestamp).toLocaleString();
                let badge = ''; switch(o.status) { case 'pending': badge='<span class="order-status-badge status-pending">Pending</span>'; break; case 'preparing': badge='<span class="order-status-badge status-preparing">Preparing</span>'; break; case 'ready': badge='<span class="order-status-badge status-ready">Ready</span>'; break; case 'served': badge='<span class="order-status-badge status-served">Served</span>'; break; case 'cancelled': badge='<span class="order-status-badge status-cancelled">Cancelled</span>'; }
                let itemsHtml = '';
                o.items.forEach(item => {
                    itemsHtml += `<div style="margin-bottom:8px;"><div style="display:flex; justify-content:space-between;"><span><strong>${item.quantity}x ${item.name}</strong></span><span style="color:var(--primary);">$${(item.price*item.quantity).toFixed(2)}</span></div>`;
                    if (item.selectedOptions?.length) {
                        itemsHtml += '<div style="margin-left:20px; font-size:12px; color:var(--gray);">';
                        item.selectedOptions.forEach(opt => {
                            if (opt.isComment) itemsHtml += `<div><i class="fas fa-comment"></i> ${opt.groupName}: "${opt.choiceName}"</div>`;
                            else itemsHtml += `<div>• ${opt.groupName}: ${opt.choiceName} ${opt.price>0?`(+$${opt.price.toFixed(2)})`:opt.price<0?`(-$${Math.abs(opt.price).toFixed(2)})`:''}</div>`;
                        });
                        itemsHtml += '</div>';
                    }
                    itemsHtml += '</div>';
                });
                card.innerHTML = `<div class="admin-card-header"><div><div class="admin-card-title">Order #${o.orderNumber}</div><div style="font-size:12px; color:var(--gray);">${date}</div></div><div>${badge}</div></div><p style="margin-bottom:10px; font-size:14px;"><strong>Table:</strong> ${o.table}<br><strong>Items:</strong></p><div style="margin-bottom:15px;">${itemsHtml}</div><p style="margin-bottom:10px; font-size:14px;"><strong>Total:</strong> $${o.total.toFixed(2)}<br><strong>Payment:</strong> ${o.paymentMethod==='card'?'Card':'Cash'} (${o.paymentTime==='now'?'Pay Now':'Pay Later'})</p><div style="display:flex; gap:10px; margin-top:15px;"><select class="admin-select" style="flex:1;" data-order-id="${o.orderNumber}"><option value="pending" ${o.status==='pending'?'selected':''}>Pending</option><option value="preparing" ${o.status==='preparing'?'selected':''}>Preparing</option><option value="ready" ${o.status==='ready'?'selected':''}>Ready</option><option value="served" ${o.status==='served'?'selected':''}>Served</option><option value="cancelled" ${o.status==='cancelled'?'selected':''}>Cancelled</option></select><button class="btn btn-primary btn-small update-status" data-order-id="${o.orderNumber}" style="padding:8px 15px;">Update</button></div>`;
                list.appendChild(card);
            });
            populateTableSelect('tableSelectForDelete');
            populateTableSelect('tableSelectForDeleteModal');
        }
        async function updateOrderStatusOptimistic(orderId, newStatus) {
            const idx = state.orders.findIndex(o=>o.orderNumber===orderId);
            if (idx!==-1) {
                state.orders[idx].status = newStatus;
                loadOrdersForAdmin();
                if (state.currentTable === state.orders[idx].table) loadMyOrders();
                showNotification(`Order #${orderId} status updated.`);
                await saveOrder(state.orders[idx]);
            }
        }
        async function clearAllOrdersOptimistic() {
            if (!confirm("Clear ALL orders? This cannot be undone.")) return;
            const toDelete = [...state.orders];
            state.orders = [];
            loadOrdersForAdmin(); loadMyOrders();
            populateTableSelect('tableSelectForDelete'); populateTableSelect('tableSelectForDeleteModal');
            showNotification("All orders cleared.");
            await Promise.all(toDelete.map(o=>deleteOrderFirestore(o.orderNumber)));
        }

        // --- SYSTEM ---
        function loadSystemStats() {
            const stats = document.getElementById('systemStats');
            const total = state.orders.length;
            const revenue = state.orders.reduce((s,o)=>s+o.total,0);
            const avg = total>0 ? revenue/total : 0;
            const pending = state.orders.filter(o=>o.status==='pending').length;
            const prep = state.orders.filter(o=>o.status==='preparing').length;
            const ready = state.orders.filter(o=>o.status==='ready').length;
            const served = state.orders.filter(o=>o.status==='served').length;
            const cancelled = state.orders.filter(o=>o.status==='cancelled').length;
            stats.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:15px;"><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">${total}</div><div style="font-size:14px; color:var(--gray);">Total Orders</div></div><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">$${revenue.toFixed(2)}</div><div style="font-size:14px; color:var(--gray);">Total Revenue</div></div><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">$${avg.toFixed(2)}</div><div style="font-size:14px; color:var(--gray);">Average Order</div></div><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">${state.menuItems.length}</div><div style="font-size:14px; color:var(--gray);">Menu Items</div></div><div style="background-color:var(--light); padding:15px; border-radius:8px;"><div style="font-size:24px; font-weight:600; color:var(--primary);">${state.categories.length}</div><div style="font-size:14px; color:var(--gray);">Categories</div></div></div><div style="margin-top:20px;"><h5 style="margin-bottom:10px;">Order Status Distribution</h5><div style="display:flex; gap:10px; flex-wrap:wrap;"><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#fff3cd; border-radius:2px;"></div><span>Pending: ${pending}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#d1ecf1; border-radius:2px;"></div><span>Preparing: ${prep}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#d4edda; border-radius:2px;"></div><span>Ready: ${ready}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#cce5ff; border-radius:2px;"></div><span>Served: ${served}</span></div><div style="display:flex; align-items:center; gap:5px;"><div style="width:12px; height:12px; background-color:#f8d7da; border-radius:2px;"></div><span>Cancelled: ${cancelled}</span></div></div></div>`;
        }
        function exportData() {
            const data = { restaurantInfo: state.restaurantInfo, menuItems: state.menuItems, orders: state.orders, categories: state.categories, customization: state.customization, exportDate: new Date().toISOString() };
            const str = JSON.stringify(data,null,2); const uri = 'data:application/json;charset=utf-8,'+encodeURIComponent(str);
            const a = document.createElement('a'); a.href = uri; a.download = `dineeasy-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); showNotification("Data exported successfully.");
        }
        async function importData(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(ev) {
                try {
                    const d = JSON.parse(ev.target.result);
                    if (confirm("Importing will replace ALL current data. Are you sure?")) {
                        if (d.restaurantInfo) state.restaurantInfo = d.restaurantInfo;
                        if (d.menuItems) state.menuItems = d.menuItems;
                        if (d.orders) state.orders = d.orders;
                        if (d.categories) state.categories = d.categories;
                        if (d.customization) state.customization = d.customization;
                        await Promise.all(state.menuItems.map(i=>saveMenuItem(i)));
                        await saveCategories();
                        await Promise.all(state.orders.map(o=>saveOrder(o)));
                        await saveRestaurantInfo();
                        await saveCustomization();
                        updateRestaurantUI(); displayMenuItems('all'); updateCategoryTabs(); applyCustomization();
                        loadMenuItemsForAdmin(); loadCategoriesForAdmin(); loadOrdersForAdmin(); loadSystemStats();
                        showNotification("Data imported successfully.");
                    }
                } catch { showNotification("Error importing data. Invalid file format."); }
            }; reader.readAsText(file); e.target.value = '';
        }

        // --- CUSTOMIZATION ---
        function loadCustomizationSettings() {}
        function initializeCustomizationTab() {
            const g = document.getElementById('themeGallery'); g.innerHTML = '';
            Object.entries(themes).forEach(([tid, t]) => {
                const el = document.createElement('div'); el.className = `theme-card ${tid===state.currentTheme?'selected':''}`; el.dataset.theme = tid;
                el.innerHTML = `<div class="theme-colors-preview"><div style="background-color:${t.primary};"></div><div style="background-color:${t.secondary};"></div><div style="background-color:${t.background};"></div><div style="background-color:${t.text};"></div><div style="background-color:${t.cardBg};"></div></div><div class="theme-info"><div class="theme-name">${t.name}</div><span class="theme-category">${t.category}</span><div class="theme-preview-small"><div style="background-color:${t.primary};"></div><div style="background-color:${t.secondary};"></div><div style="background-color:${t.lightGray};"></div></div></div>`;
                el.addEventListener('click', function() { g.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('selected')); this.classList.add('selected'); document.getElementById('currentThemeName').textContent = t.name; document.getElementById('currentThemeCategory').textContent = t.category; });
                g.appendChild(el);
            });
            document.getElementById('applyThemeBtn').addEventListener('click', function() {
                const sel = g.querySelector('.theme-card.selected'); if (sel) applyTheme(sel.dataset.theme);
            });
            const fg = document.getElementById('fontOptions'); fg.innerHTML = '';
            Object.entries(fonts).forEach(([fid, f]) => {
                const el = document.createElement('div'); el.className = `font-option ${fid===state.currentFont?'selected':''}`; el.dataset.font = fid; el.dataset.primary = f.primary; el.dataset.secondary = f.secondary;
                el.innerHTML = `<div class="font-preview-large" style="font-family:${f.primary.replace(/'/g,'')};">${f.name}</div><div class="font-details"><div style="font-family:${f.primary.replace(/'/g,'')}; margin-bottom:5px;">The quick brown fox</div><div style="font-family:${f.secondary.replace(/'/g,'')}; font-style:italic;">Elegant restaurant menu</div></div>`;
                el.addEventListener('click', function() { fg.querySelectorAll('.font-option').forEach(f=>f.classList.remove('selected')); this.classList.add('selected'); document.getElementById('currentFontName').textContent = f.name; });
                fg.appendChild(el);
            });
            document.getElementById('applyFontBtn').addEventListener('click', function() {
                const sel = fg.querySelector('.font-option.selected'); if (sel) applyFont(sel.dataset.font, sel.dataset.primary, sel.dataset.secondary);
            });
            const cc = document.getElementById('colorCustomization'); cc.innerHTML = '';
            importantColors.forEach(col => {
                const el = document.createElement('div'); el.className = 'color-option';
                el.innerHTML = `<div class="color-label">${col.label}</div><div class="color-preview" style="background-color: ${state.customization[col.id]};"></div><div class="color-input-group"><input type="color" class="color-input" id="color-${col.id}" value="${state.customization[col.id]}"><div class="color-value">${state.customization[col.id]}</div></div>`;
                const inp = el.querySelector('.color-input'); const val = el.querySelector('.color-value'); const pre = el.querySelector('.color-preview');
                inp.addEventListener('input', function() { const v = this.value; val.textContent = v; pre.style.backgroundColor = v; state.customization[col.id] = v; state.currentTheme = "custom"; g.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('selected')); document.getElementById('currentThemeName').textContent = "Custom"; document.getElementById('currentThemeCategory').textContent = "Custom"; applyCustomization(); });
                cc.appendChild(el);
            });
            document.getElementById('resetCustomizationBtn').addEventListener('click', function() { if (confirm("Reset all visual customization to default values?")) { resetCustomization(); setTimeout(initializeCustomizationTab,100); } });
            document.getElementById('saveCustomizationBtn').addEventListener('click', saveCustomizationOptimistic);
            const curTheme = themes[state.currentTheme]; if (curTheme) { document.getElementById('currentThemeName').textContent = curTheme.name; document.getElementById('currentThemeCategory').textContent = curTheme.category; }
            else { document.getElementById('currentThemeName').textContent = "Custom"; document.getElementById('currentThemeCategory').textContent = "Custom"; }
            document.getElementById('currentFontName').textContent = fonts[state.currentFont]?.name || "Poppins";
        }
        function applyTheme(id) {
            if (!themes[id]) return;
            const t = themes[id]; state.currentTheme = id;
            state.customization.primary = t.primary; state.customization.primaryDark = darkenColor(t.primary,20);
            state.customization.secondary = t.secondary; state.customization.background = t.background; state.customization.text = t.text;
            state.customization.cardBg = t.cardBg; state.customization.lightGray = t.lightGray; state.customization.buttonText = getContrastColor(t.primary);
            applyCustomization(); updateColorInputs();
            document.querySelectorAll('#themeGallery .theme-card').forEach(c=>c.classList.remove('selected'));
            const sel = document.querySelector(`#themeGallery .theme-card[data-theme="${id}"]`);
            if (sel) { sel.classList.add('selected'); document.getElementById('currentThemeName').textContent = t.name; document.getElementById('currentThemeCategory').textContent = t.category; }
            showNotification(`"${t.name}" theme applied.`);
        }
        function applyFont(id, pri, sec) { state.currentFont = id; state.customization.fontPrimary = pri; state.customization.fontSecondary = sec; applyCustomization(); document.querySelectorAll('#fontOptions .font-option').forEach(f=>f.classList.remove('selected')); const sel = document.querySelector(`#fontOptions .font-option[data-font="${id}"]`); if (sel) { sel.classList.add('selected'); document.getElementById('currentFontName').textContent = fonts[id].name; } showNotification(`"${fonts[id].name}" font applied.`); }
        function updateColorInputs() { importantColors.forEach(col=>{ const inp = document.getElementById(`color-${col.id}`); if (inp) { const val = inp.parentElement.querySelector('.color-value'); const pre = inp.parentElement.parentElement.querySelector('.color-preview'); if (inp && val && pre) { inp.value = state.customization[col.id]; val.textContent = state.customization[col.id]; pre.style.backgroundColor = state.customization[col.id]; } } }); }
        async function saveCustomizationOptimistic() { showNotification("Visual customization saved."); await saveCustomization(); }
        function resetCustomization() {
            state.customization = { primary: "#e63946", primaryDark: "#c1121f", secondary: "#457b9d", light: "#f8f9fa", dark: "#212529", gray: "#6c757d", lightGray: "#e9ecef", success: "#2a9d8f", warning: "#e9c46a", danger: "#dc3545", shadow: "0 4px 12px rgba(0, 0, 0, 0.08)", radius: "12px", background: "#fefefe", text: "#212529", cardBg: "#ffffff", headerBg: "#ffffff", menuBg: "#ffffff", cartBg: "#ffffff", paymentBg: "#ffffff", buttonText: "#ffffff", fontPrimary: "'Poppins', sans-serif", fontSecondary: "'Playfair Display', serif" };
            state.currentTheme = "default"; state.currentFont = "poppins"; applyCustomization();
        }
        function darkenColor(c,p) { const n = parseInt(c.replace("#",""),16); const a = Math.round(2.55*p); const r = (n>>16)-a, g = (n>>8&0x00FF)-a, b = (n&0x0000FF)-a; return "#" + (0x1000000 + (r<255?r<1?0:r:255)*0x10000 + (g<255?g<1?0:g:255)*0x100 + (b<255?b<1?0:b:255)).toString(16).slice(1); }
        function getContrastColor(h) { const r=parseInt(h.substr(1,2),16), g=parseInt(h.substr(3,2),16), b=parseInt(h.substr(5,2),16), yiq=((r*299)+(g*587)+(b*114))/1000; return yiq>=128?'#000000':'#ffffff'; }

        // --- MODAL ADMIN (simplified) ---
        function setupAdminPanel() {
            adminClose.addEventListener('click', ()=> adminPanel.style.display = 'none');
            document.querySelectorAll('#adminPanel .admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tid = this.dataset.tab;
                    document.querySelectorAll('#adminPanel .admin-tab').forEach(t=>t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('#adminPanel .admin-content').forEach(c=>c.classList.remove('active'));
                    document.getElementById(tid+'TabModal').classList.add('active');
                    if (tid==='customization') setTimeout(initializeModalCustomizationTab,100);
                    if (tid==='menu') setTimeout(()=>makeAdminGridDraggable('menuItemsListModal'),500);
                    if (tid==='categories') setTimeout(()=>makeCategoriesDraggable('categoriesListContainerModal'),200);
                    if (tid==='orders') { loadOrdersForAdminModal(); populateTableSelect('tableSelectForDeleteModal'); }
                });
            });
            document.getElementById('adminRestaurantNameModal').value = state.restaurantInfo.name;
            document.getElementById('adminTaxRateModal').value = state.restaurantInfo.taxRate;
            document.getElementById('adminPrepTimeModal').value = state.restaurantInfo.estimatedPrepTime;
            document.getElementById('adminWelcomeMessageModal').value = state.restaurantInfo.welcomeMessage || '';
            updateLogoPreview();
            loadMenuItemsForAdminModal();
            loadCategoriesForAdminModal();
            document.getElementById('deleteOrdersForTableBtnModal').addEventListener('click', function() {
                const sel = document.getElementById('tableSelectForDeleteModal');
                if (sel.value) showAdminChangePrompt(()=>deleteOrdersForTable(sel.value));
                else showNotification('Please select a table.');
            });
        }
        function loadMenuItemsForAdminModal() {
            const list = document.getElementById('menuItemsListModal'); if (!list) return;
            list.innerHTML = '';
            if (state.menuItems.length===0) { list.innerHTML = '<p style="text-align: center; color: var(--gray);">No menu items found.</p>'; return; }
            const sorted = [...state.menuItems].sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0));
            sorted.forEach(item => {
                const card = document.createElement('div'); card.className = 'admin-card'; card.setAttribute('draggable','true'); card.dataset.itemId = item.id;
                const img = item.image ? `<div style="height:120px; background-image:url('${item.image}'); background-size:cover; background-position:center; border-radius:8px; margin-bottom:10px;"></div>` : `<div style="height:120px; background-color:var(--light-gray); border-radius:8px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; color:var(--gray);"><i class="fas fa-utensils"></i></div>`;
                card.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><i class="fas fa-grip-vertical drag-handle"></i></div>${img}<div class="admin-card-header"><div class="admin-card-title">${item.name}</div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-item-modal" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-secondary duplicate-item-modal" data-id="${item.id}"><i class="fas fa-copy"></i></button><button class="admin-small-btn btn-danger delete-item-modal" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div><p style="margin-bottom:10px; font-size:14px;">${item.description}</p><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:600; color:var(--primary);">$${item.price.toFixed(2)}</span><span style="font-size:12px; color:var(--gray);">${getCategoryDisplayName(item.category)}</span></div><div class="tag-display">${item.tags.map(t=>`<span class="tag-item">${t}</span>`).join('')}</div>`;
                if (item.options?.length) card.innerHTML += `<div style="margin-top:10px; font-size:12px; color:var(--secondary);"><i class="fas fa-tasks"></i> ${item.options.length} option group(s)</div>`;
                list.appendChild(card);
            });
            document.querySelectorAll('.edit-item-modal').forEach(b=> b.addEventListener('click', function() { const id = parseInt(this.dataset.id); openEditMenuItemForm(id); adminPanel.style.display = 'none'; }));
            document.querySelectorAll('.duplicate-item-modal').forEach(b=> b.addEventListener('click', function() { duplicateMenuItemOptimistic(parseInt(this.dataset.id)); }));
            document.querySelectorAll('.delete-item-modal').forEach(b=> b.addEventListener('click', function() { const id = parseInt(this.dataset.id); showAdminChangePrompt(()=>deleteMenuItemOptimistic(id)); }));
            makeAdminGridDraggable('menuItemsListModal');
        }
        function loadCategoriesForAdminModal() {
            const con = document.getElementById('categoriesListContainerModal'); if (!con) return;
            con.innerHTML = '';
            if (state.categories.length===0) { con.innerHTML = '<p style="text-align:center; color:var(--gray); padding:20px;">No categories added yet.</p>'; return; }
            state.categories.sort((a,b)=>(a.displayOrder||0)-(b.displayOrder||0)).forEach(c => {
                const cnt = state.menuItems.filter(i=>i.category===c.id).length;
                const el = document.createElement('div'); el.className = 'category-item'; el.setAttribute('draggable','true'); el.dataset.categoryId = c.id;
                el.innerHTML = `<div style="display:flex; align-items:center;"><i class="fas fa-grip-vertical drag-handle-category"></i><span class="category-item-name">${c.displayName}</span><span class="category-item-count">${cnt} item${cnt!==1?'s':''}</span></div><div class="admin-card-actions"><button class="admin-small-btn btn-danger delete-category-modal" data-id="${c.id}"><i class="fas fa-trash"></i></button></div>`;
                con.appendChild(el);
            });
            document.querySelectorAll('.delete-category-modal').forEach(b=> b.addEventListener('click', function() { const id = this.dataset.id; showAdminChangePrompt(()=>deleteCategoryOptimistic(id)); }));
            makeCategoriesDraggable('categoriesListContainerModal');
        }
        function loadOrdersForAdminModal() {
            const list = document.getElementById('adminOrdersListModal'); const filter = document.getElementById('orderStatusFilterModal').value;
            let filtered = filter==='all' ? [...state.orders] : state.orders.filter(o=>o.status===filter);
            filtered.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
            if (filtered.length===0) { list.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No orders found.</p>'; return; }
            list.innerHTML = '';
            filtered.forEach(o => {
                const card = document.createElement('div'); card.className = 'admin-card'; card.style.marginBottom = '15px';
                const date = new Date(o.timestamp).toLocaleString();
                let badge = ''; switch(o.status) { case 'pending': badge='<span class="order-status-badge status-pending">Pending</span>'; break; case 'preparing': badge='<span class="order-status-badge status-preparing">Preparing</span>'; break; case 'ready': badge='<span class="order-status-badge status-ready">Ready</span>'; break; case 'served': badge='<span class="order-status-badge status-served">Served</span>'; break; case 'cancelled': badge='<span class="order-status-badge status-cancelled">Cancelled</span>'; }
                let itemsHtml = '';
                o.items.forEach(item => {
                    itemsHtml += `<div style="margin-bottom:8px;"><div style="display:flex; justify-content:space-between;"><span><strong>${item.quantity}x ${item.name}</strong></span><span style="color:var(--primary);">$${(item.price*item.quantity).toFixed(2)}</span></div>`;
                    if (item.selectedOptions?.length) {
                        itemsHtml += '<div style="margin-left:20px; font-size:12px; color:var(--gray);">';
                        item.selectedOptions.forEach(opt => {
                            if (opt.isComment) itemsHtml += `<div><i class="fas fa-comment"></i> ${opt.groupName}: "${opt.choiceName}"</div>`;
                            else itemsHtml += `<div>• ${opt.groupName}: ${opt.choiceName} ${opt.price>0?`(+$${opt.price.toFixed(2)})`:opt.price<0?`(-$${Math.abs(opt.price).toFixed(2)})`:''}</div>`;
                        });
                        itemsHtml += '</div>';
                    }
                    itemsHtml += '</div>';
                });
                card.innerHTML = `<div class="admin-card-header"><div><div class="admin-card-title">Order #${o.orderNumber}</div><div style="font-size:12px; color:var(--gray);">${date}</div></div><div>${badge}</div></div><p style="margin-bottom:10px; font-size:14px;"><strong>Table:</strong> ${o.table}<br><strong>Items:</strong></p><div style="margin-bottom:15px;">${itemsHtml}</div><p style="margin-bottom:10px; font-size:14px;"><strong>Total:</strong> $${o.total.toFixed(2)}<br><strong>Payment:</strong> ${o.paymentMethod==='card'?'Card':'Cash'} (${o.paymentTime==='now'?'Pay Now':'Pay Later'})</p><div style="display:flex; gap:10px; margin-top:15px;"><select class="admin-select" style="flex:1;" data-order-id="${o.orderNumber}"><option value="pending" ${o.status==='pending'?'selected':''}>Pending</option><option value="preparing" ${o.status==='preparing'?'selected':''}>Preparing</option><option value="ready" ${o.status==='ready'?'selected':''}>Ready</option><option value="served" ${o.status==='served'?'selected':''}>Served</option><option value="cancelled" ${o.status==='cancelled'?'selected':''}>Cancelled</option></select><button class="btn btn-primary btn-small update-status-modal" data-order-id="${o.orderNumber}" style="padding:8px 15px;">Update</button></div>`;
                list.appendChild(card);
            });
            populateTableSelect('tableSelectForDeleteModal');
            document.querySelectorAll('.update-status-modal').forEach(b=> b.addEventListener('click', function() { const oid = this.dataset.orderId; const sel = document.querySelector(`select[data-order-id="${oid}"]`); if (sel && oid) updateOrderStatusOptimistic(oid, sel.value); }));
        }
        function initializeModalCustomizationTab() {
            const g = document.getElementById('themeGalleryModal'); if (!g) return;
            g.innerHTML = '';
            const modalThemes = Object.entries(themes).slice(0,8);
            modalThemes.forEach(([tid,t]) => {
                const el = document.createElement('div'); el.className = `theme-card ${tid===state.currentTheme?'selected':''}`; el.dataset.theme = tid;
                el.innerHTML = `<div class="theme-colors-preview"><div style="background-color:${t.primary};"></div><div style="background-color:${t.secondary};"></div><div style="background-color:${t.background};"></div><div style="background-color:${t.text};"></div><div style="background-color:${t.cardBg};"></div></div><div class="theme-info"><div class="theme-name">${t.name}</div><span class="theme-category">${t.category}</span></div>`;
                el.addEventListener('click', function() { g.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('selected')); this.classList.add('selected'); });
                g.appendChild(el);
            });
            const fg = document.getElementById('fontOptionsModal'); if (!fg) return;
            fg.innerHTML = '';
            Object.entries(fonts).forEach(([fid,f]) => {
                const el = document.createElement('div'); el.className = `font-option ${fid===state.currentFont?'selected':''}`; el.dataset.font = fid;
                el.innerHTML = `<div class="font-preview-large" style="font-family:${f.primary.replace(/'/g,'')};">${f.name}</div>`;
                el.addEventListener('click', function() { fg.querySelectorAll('.font-option').forEach(f=>f.classList.remove('selected')); this.classList.add('selected'); });
                fg.appendChild(el);
            });
            document.getElementById('resetCustomizationBtnModal').addEventListener('click', function() { if (confirm("Reset all visual customization to default values?")) { resetCustomization(); setTimeout(initializeModalCustomizationTab,100); showNotification("Customization reset in modal."); } });
            document.getElementById('saveCustomizationBtnModal').addEventListener('click', function() {
                const selTheme = g.querySelector('.theme-card.selected'); if (selTheme) applyTheme(selTheme.dataset.theme);
                const selFont = fg.querySelector('.font-option.selected'); if (selFont) { const fid = selFont.dataset.font; const f = fonts[fid]; if (f) applyFont(fid, f.primary, f.secondary); }
                saveCustomizationOptimistic(); showNotification("Customization saved from modal.");
            });
        }

        // ========== EVENT LISTENERS ==========
        async function initApp() {
            await loadInitialData();
            setupListeners();
            
            // Auto‑login from URL – now works without any code prompt
            autoLoginFromUrl();

            // Table selection (manual)
            document.querySelectorAll('.table-btn').forEach(btn => btn.addEventListener('click', function() { selectTable(this.dataset.table, false); }));

            // Cart
            cartFloating.addEventListener('click', function() { if (!state.isAdminMode) showSection('cartSection'); });
            document.getElementById('backToMenuBtn').addEventListener('click', ()=> showSection('menuSection'));
            document.getElementById('proceedToPaymentBtn').addEventListener('click', function() { if (state.cart.length===0) { showNotification('Please add items to your cart before proceeding to payment'); return; } updatePaymentSummary(); showSection('paymentSection'); });
            document.getElementById('backToCartBtn').addEventListener('click', ()=> showSection('cartSection'));

            // Payment method
            document.querySelectorAll('.option-card[data-payment]').forEach(card => {
                card.addEventListener('click', function() { document.querySelectorAll('.option-card[data-payment]').forEach(c=>c.classList.remove('selected')); this.classList.add('selected'); state.selectedPaymentMethod = this.dataset.payment; });
            });
            document.querySelectorAll('.option-card[data-time]').forEach(card => {
                card.addEventListener('click', function() { document.querySelectorAll('.option-card[data-time]').forEach(c=>c.classList.remove('selected')); this.classList.add('selected'); state.selectedPaymentTime = this.dataset.time; });
            });
            document.getElementById('confirmPaymentBtn').addEventListener('click', placeOrderOptimistic);

            // Confirmation & orders
            document.getElementById('newOrderBtn').addEventListener('click', function() { resetOrder(); showSection('scannerSection'); });
            document.getElementById('viewMyOrdersBtn').addEventListener('click', function() { loadMyOrders(); showSection('myOrdersSection'); });
            document.getElementById('viewMenuBtn').addEventListener('click', function() { resetCart(); state.selectedPaymentMethod = null; state.selectedPaymentTime = null; document.querySelectorAll('.option-card').forEach(c=>c.classList.remove('selected')); if (state.currentTable) menuSubtitle.textContent = `Start a new order for ${state.currentTable}`; showSection('menuSection'); showNotification('Ready to start a new order!'); });
            document.getElementById('needHelpBtn').addEventListener('click', showHelpNotification);
            headerHelpButton.addEventListener('click', showHelpNotification);
            myOrdersButton.addEventListener('click', function() { loadMyOrders(); showSection('myOrdersSection'); });
            document.getElementById('backToMenuFromOrdersBtn').addEventListener('click', ()=> showSection('menuSection'));
            document.getElementById('placeNewOrderBtn').addEventListener('click', function() { resetCart(); showSection('menuSection'); });

            // Admin code
            submitAdminCodeBtn.addEventListener('click', function() { if (adminCodeInput.value === state.adminAccessCode) { adminCodePrompt.style.display = 'none'; adminCodeInput.value = ''; enterAdminMode(); } else { showNotification("Incorrect admin code."); adminCodeInput.value = ''; adminCodeInput.focus(); } });
            cancelAdminCodeBtn.addEventListener('click', function() { adminCodePrompt.style.display = 'none'; adminCodeInput.value = ''; showSection('scannerSection'); });
            submitChangeCodeBtn.addEventListener('click', function() { if (adminChangeCodeInput.value === state.adminChangeCode) { adminChangePrompt.style.display = 'none'; adminChangeCodeInput.value = ''; if (state.pendingAdminAction) { state.pendingAdminAction(); } state.pendingAdminAction = null; } else { showNotification("Incorrect confirmation code."); adminChangeCodeInput.value = ''; adminChangeCodeInput.focus(); } });
            cancelChangeBtn.addEventListener('click', function() { adminChangePrompt.style.display = 'none'; adminChangeCodeInput.value = ''; state.pendingAdminAction = null; showNotification("Changes cancelled."); });

            // Admin panel
            setupAdminPanel();

            if (localStorage.getItem('dineEasyAdminMode') === 'true') { showAdminCodePrompt(); }
        }

        // Optimistic order placement
        window.placeOrderOptimistic = async function() {
            if (!state.selectedPaymentMethod || !state.selectedPaymentTime) { showNotification('Please select payment method and time'); return; }
            if (state.cart.length === 0) { showNotification('Cart is empty'); return; }
            const orderNumber = generateOrderNumber();
            const order = {
                orderNumber, table: state.currentTable,
                items: state.cart.map(item => ({ ...item })),
                paymentMethod: state.selectedPaymentMethod, paymentTime: state.selectedPaymentTime,
                subtotal: calculateSubtotal(), total: calculateTotal(),
                status: 'pending', timestamp: new Date().toISOString(), customerNotes: ""
            };
            state.orders.push(order);
            showOrderConfirmation(order);
            showSection('confirmationSection');
            resetCart();
            showNotification(`Order #${orderNumber} confirmed!`);
            await saveOrder(order);
        };

        initApp();
    </script>
</body>
</html>
