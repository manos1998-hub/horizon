<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Dining App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #e63946;
            --primary-dark: #c1121f;
            --secondary: #457b9d;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #dc3545;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --admin: #6c757d;
            --background: #fefefe;
            --text: #212529;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
            --menu-bg: #ffffff;
            --cart-bg: #ffffff;
            --payment-bg: #ffffff;
            --button-text: #ffffff;
            --font-primary: 'Poppins', sans-serif;
            --font-secondary: 'Playfair Display', serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header & Navigation */
        header {
            background-color: var(--header-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            position: relative;
        }

        .logo {
            font-family: var(--font-secondary);
            font-size: 36px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            flex: 1;
        }

        .logo i {
            margin-right: 10px;
        }

        .logo-img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin-right: 14px;
            object-fit: cover;
            display: none;
        }

        .header-center {
            display: flex;
            justify-content: center;
            flex: 1;
        }

        .help-button {
            background-color: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .help-button:hover {
            background-color: var(--secondary);
            color: var(--button-text);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(69, 123, 157, 0.2);
        }

        .header-right {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex: 1;
            gap: 15px;
        }

        .my-orders-button {
            background-color: var(--secondary);
            color: var(--button-text);
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            white-space: nowrap;
        }

        .my-orders-button:hover {
            background-color: var(--secondary);
            filter: brightness(0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(69, 123, 157, 0.2);
        }

        .table-info {
            background-color: var(--light-gray);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .table-info i {
            margin-right: 8px;
            color: var(--secondary);
        }

        /* Drag & drop visual feedback */
            .admin-card.dragging,
            .category-item.dragging {
                opacity: 0.5;
                cursor: grabbing;
            }

            .admin-card.drag-over,
            .category-item.drag-over {
                border: 2px dashed var(--primary);
                background-color: rgba(230, 57, 70, 0.05);
            }

            .drag-handle {
                cursor: grab;
            }

            .drag-handle:active {
                cursor: grabbing;
            }

        /* Main App Sections */
        .app-section {
            display: none;
            padding: 30px 0;
            min-height: calc(100vh - 80px);
            background-color: var(--background);
        }

        .active-section {
            display: block;
        }

        /* QR Scanner Section */
        .scanner-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .scanner-container {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
        }

        .qr-placeholder {
            width: 250px;
            height: 250px;
            background: linear-gradient(45deg, var(--light-gray), var(--card-bg));
            border-radius: 12px;
            margin: 30px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .qr-placeholder::before {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(90deg, transparent 49%, rgba(0, 0, 0, 0.05) 50%, transparent 51%),
                linear-gradient(transparent 49%, rgba(0, 0, 0, 0.05) 50%, transparent 51%);
            background-size: 30px 30px;
        }

        .qr-placeholder i {
            font-size: 70px;
            color: var(--gray);
            margin-bottom: 15px;
            z-index: 1;
        }

        .qr-placeholder span {
            color: var(--gray);
            font-size: 16px;
            z-index: 1;
        }

        .demo-tables {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .table-btn {
            padding: 12px 24px;
            background-color: var(--card-bg);
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text);
        }

        .table-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
        }

        /* Menu Section */
        .section-title {
            font-family: var(--font-secondary);
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--text);
        }

        .section-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .category-tabs {
            display: flex;
            overflow-x: auto;
            margin-bottom: 30px;
            padding-bottom: 5px;
        }

        .category-tab {
            padding: 10px 20px;
            background-color: var(--card-bg);
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            color: var(--text);
        }

        .category-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .menu-item {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .menu-item:hover {
            transform: translateY(-5px);
        }

        .item-image {
            height: 180px;
            background-color: var(--light-gray);
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .item-content {
            padding: 20px;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .item-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .item-price {
            color: var(--primary);
            font-weight: 600;
            font-size: 18px;
        }

        .item-description {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-tags {
            display: flex;
            gap: 5px;
        }

        .item-tag {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 20px;
            background-color: var(--light-gray);
            color: var(--text);
        }
        /* NEW: Subcategory display for menu items */
        .item-subcategories {
            font-size: 12px;
            color: var(--secondary);
            margin-bottom: 10px;
            margin-top: -5px;
        }

        .add-to-cart {
            background-color: var(--primary);
            color: var(--button-text);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-to-cart:hover {
            background-color: var(--primary-dark);
        }

        /* Cart Section */
        .cart-container {
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
        }

        .cart-items {
            background-color: var(--cart-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex-grow: 1;
        }

        .cart-item-name {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text);
        }

        .cart-item-price {
            color: var(--primary);
            font-weight: 500;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--light-gray);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
        }

        .quantity {
            font-weight: 500;
            min-width: 20px;
            text-align: center;
            color: var(--text);
        }

        .remove-item {
            color: var(--gray);
            cursor: pointer;
            transition: color 0.3s;
        }

        .remove-item:hover {
            color: var(--primary);
        }

        .cart-summary {
            background-color: var(--cart-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: var(--text);
        }

        .summary-total {
            font-size: 20px;
            font-weight: 600;
            border-top: 2px solid var(--light-gray);
            padding-top: 15px;
            margin-top: 10px;
        }

        .summary-total .amount {
            color: var(--primary);
        }

        /* Payment Section */
        .payment-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .payment-options {
            background-color: var(--payment-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 25px;
        }

        .option-group {
            margin-bottom: 30px;
        }

        .option-group:last-child {
            margin-bottom: 0;
        }

        .option-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
        }

        .option-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .option-card {
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: var(--card-bg);
            color: var(--text);
        }

        .option-card:hover {
            border-color: var(--primary);
        }

        .option-card.selected {
            border-color: var(--primary);
            background-color: rgba(230, 57, 70, 0.05);
        }

        .option-icon {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--secondary);
        }

        .option-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .option-desc {
            font-size: 13px;
            color: var(--gray);
        }

        .payment-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--button-text);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--text);
            border: 2px solid var(--light-gray);
        }

        .btn-secondary:hover {
            border-color: var(--gray);
        }

        .btn-success {
            background-color: var(--success);
            color: var(--button-text);
        }

        .btn-success:hover {
            background-color: #21867a;
        }

        .btn-danger {
            background-color: var(--danger);
            color: var(--button-text);
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--text);
        }

        .btn-warning:hover {
            background-color: #d4ac2e;
        }

        .btn-help {
            background-color: var(--secondary);
            color: var(--button-text);
            border: none;
        }

        .btn-help:hover {
            background-color: #386c8a;
        }

        .btn i {
            margin-right: 8px;
        }

        /* My Orders Section */
        .my-orders-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .order-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.3s;
        }

        .order-card:hover {
            transform: translateY(-3px);
        }

        .order-card-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light);
        }

        .order-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .order-card-time {
            font-size: 14px;
            color: var(--gray);
        }

        .order-card-body {
            padding: 20px;
        }

        .order-items-summary {
            margin-bottom: 15px;
        }

        .order-item-summary {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-gray);
            color: var(--text);
        }

        .order-item-summary:last-child {
            border-bottom: none;
        }

        .order-item-summary-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-item-summary-quantity {
            background-color: var(--light-gray);
            color: var(--text);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .order-card-footer {
            padding: 15px 20px;
            background-color: var(--light);
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-total-summary {
            font-weight: 600;
            color: var(--primary);
        }

        .order-status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-preparing {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status-ready {
            background-color: #d4edda;
            color: #155724;
        }

        .status-served {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .no-orders-message {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .no-orders-message i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-orders-message h3 {
            margin-bottom: 10px;
            font-size: 22px;
        }

        /* Order Confirmation Section */
        .confirmation-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .confirmation-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 40px;
            margin-bottom: 25px;
            text-align: center;
        }

        .confirmation-icon {
            width: 80px;
            height: 80px;
            background-color: rgba(42, 157, 143, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
        }

        .confirmation-icon i {
            font-size: 36px;
            color: var(--success);
        }

        .order-number {
            font-size: 28px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
        }

        .order-number span {
            color: var(--primary);
        }

        .order-message {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .order-details {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 25px;
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .details-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text);
        }

        .details-table {
            font-weight: 500;
            color: var(--secondary);
        }

        .order-items {
            margin-bottom: 30px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--light-gray);
            color: var(--text);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-item-quantity {
            background-color: var(--light-gray);
            color: var(--text);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .order-item-price {
            font-weight: 500;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            font-weight: 600;
            padding-top: 15px;
            margin-top: 15px;
            border-top: 2px solid var(--light-gray);
            color: var(--text);
        }

        .order-total .amount {
            color: var(--primary);
        }

        .payment-details {
            background-color: rgba(69, 123, 157, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
        }

        .payment-details-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary);
        }

        .payment-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--text);
        }

        .payment-info:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: var(--gray);
        }

        .info-value {
            font-weight: 500;
        }

        .estimated-time {
            background-color: rgba(233, 196, 106, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .time-icon {
            font-size: 24px;
            color: var(--warning);
        }

        .time-text {
            font-size: 15px;
            color: var(--text);
        }

        .time-text strong {
            color: var(--text);
        }

        /* Cart Floating Button */
        .cart-floating {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--primary);
            color: var(--button-text);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(230, 57, 70, 0.3);
            z-index: 99;
            transition: all 0.3s;
        }

        .cart-floating:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
        }

        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--secondary);
            color: var(--button-text);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Admin Mode Styles */
        .admin-mode header {
            border-bottom: 3px solid var(--warning);
        }

        .admin-mode .admin-badge {
            background-color: var(--warning);
            color: var(--text);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .admin-mode .logout-button {
            background-color: var(--danger);
            color: var(--button-text);
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
        }

        .logout-button:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        /* Admin Panel (for customer mode) */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .admin-container {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .admin-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
        }

        .admin-tabs {
            display: flex;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .admin-tab {
            padding: 12px 25px;
            background: none;
            border: none;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: var(--text);
            white-space: nowrap;
        }

        .admin-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        .admin-form-group {
            margin-bottom: 20px;
        }

        .admin-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .admin-input,
        .admin-textarea,
        .admin-select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-family: var(--font-primary);
            font-size: 14px;
            background-color: var(--card-bg);
            color: var(--text);
        }

        .admin-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .admin-card {
            background-color: var(--light);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--light-gray);
        }

        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .admin-card-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--text);
        }

        .admin-card-actions {
            display: flex;
            gap: 8px;
        }

        .admin-small-btn {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        /* ----- NEW: Reorder controls for admin ----- */
        .reorder-arrows {
            display: flex;
            gap: 5px;
        }
        .reorder-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 14px;
            padding: 3px;
            border-radius: 4px;
        }
        .reorder-btn:hover {
            background-color: var(--light-gray);
            color: var(--text);
        }
        .admin-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }


        .tag-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tag-display {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .tag-item {
            background-color: var(--light-gray);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text);
        }

        /* Category Management */
        .categories-management {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .categories-list {
            flex: 1;
            min-width: 300px;
        }

        .add-category-form {
            flex: 1;
            min-width: 300px;
        }

        .categories-list-container {
            background-color: var(--light);
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--light-gray);
        }

        .category-item:last-child {
            margin-bottom: 0;
        }

        .category-item-name {
            font-weight: 500;
            color: var(--text);
        }

        .category-item-count {
            background-color: var(--light-gray);
            color: var(--text);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        /* UPDATED VISUAL CUSTOMIZATION STYLES - 20 THEMES */
        .theme-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .theme-card {
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            background-color: var(--card-bg);
        }

        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .theme-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2);
        }

        .theme-colors-preview {
            height: 100px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
        }

        .theme-info {
            padding: 15px;
            text-align: center;
        }

        .theme-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text);
        }

        .theme-category {
            font-size: 12px;
            color: var(--gray);
            background-color: var(--light-gray);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .theme-preview-small {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }

        .theme-preview-small div {
            height: 4px;
            border-radius: 2px;
        }

        .customization-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .customization-section {
            background-color: var(--light);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .section-title-small {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .font-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .font-option {
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--light-gray);
            background-color: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .font-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .font-option.selected {
            border-color: var(--primary);
            background-color: rgba(230, 57, 70, 0.1);
        }

        .font-preview-large {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .font-details {
            font-size: 14px;
            color: var(--gray);
        }

        .color-customization {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .color-option {
            padding: 15px;
            border-radius: 10px;
            background-color: var(--card-bg);
            border: 1px solid var(--light-gray);
        }

        .color-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
            color: var(--text);
        }

        .color-preview {
            width: 100%;
            height: 40px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .color-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-input {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: none;
        }

        .color-value {
            font-family: monospace;
            font-size: 14px;
            flex: 1;
        }

        .customization-preview {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            border: 2px solid var(--light-gray);
            margin-top: 20px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .preview-restaurant-name {
            font-family: var(--font-secondary);
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
        }

        .preview-content-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .preview-card {
            padding: 20px;
            border-radius: 10px;
            background-color: var(--light-gray);
            margin-bottom: 15px;
        }

        .preview-menu-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .preview-button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .preview-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            border: none;
        }

        .customization-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--light-gray);
        }

        /* Image Upload Styles */
        .image-upload-container {
            margin-bottom: 20px;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            background-color: var(--light-gray);
            border-radius: 8px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-preview-placeholder {
            text-align: center;
            color: var(--gray);
        }

        .image-preview-placeholder i {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .upload-btn {
            flex: 1;
        }

        .remove-image-btn {
            background-color: var(--light-gray);
            color: var(--text);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .remove-image-btn:hover {
            background-color: var(--gray);
            color: var(--button-text);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background-color: var(--card-bg);
            color: var(--text);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.5s;
            border-left: 4px solid var(--success);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            margin-right: 10px;
            color: var(--success);
            font-size: 20px;
        }

        /* NEW: Real-time notification for new orders */
        .order-notification {
            position: fixed;
            top: 100px;
            left: 30px;
            background-color: var(--card-bg);
            color: var(--text);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            z-index: 1000;
            transform: translateX(-150%);
            transition: transform 0.5s;
            border-left: 4px solid var(--primary);
            max-width: 300px;
        }

        .order-notification.show {
            transform: translateX(0);
        }

        .order-notification i {
            margin-right: 10px;
            color: var(--primary);
            font-size: 20px;
        }

        /* Admin Dashboard Section (Shown only in Admin Mode) */
        .admin-dashboard-section {
            display: none;
            padding: 30px 0;
            min-height: calc(100vh - 80px);
        }

        .admin-dashboard-section.active-section {
            display: block;
        }

        .admin-dashboard-container {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            width: 100%;
        }

        /* Admin Code Prompt */
        .admin-code-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .admin-code-container {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .admin-code-icon {
            width: 80px;
            height: 80px;
            background-color: rgba(233, 196, 106, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
        }

        .admin-code-icon i {
            font-size: 36px;
            color: var(--warning);
        }

        .admin-code-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
        }

        .admin-code-subtitle {
            color: var(--gray);
            margin-bottom: 25px;
        }

        .admin-code-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 20px;
            font-family: 'Poppins', monospace;
            background-color: var(--card-bg);
            color: var(--text);
        }

        .admin-code-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Admin Change Confirmation Prompt */
        .admin-code-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        /* NEW: Subcategory Option Modal Styles */
        .subcategory-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .subcategory-modal-container {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .subcategory-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
        }

        .subcategory-option-group {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .subcategory-option-group:last-child {
            border-bottom: none;
        }

        .subcategory-option-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
        }

        .subcategory-option-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .subcategory-option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: var(--light-gray);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .subcategory-option-item:hover {
            background-color: rgba(69, 123, 157, 0.1);
        }

        .subcategory-option-item.selected {
            border-color: var(--primary);
            background-color: rgba(230, 57, 70, 0.1);
        }

        .subcategory-option-name {
            font-weight: 500;
            color: var(--text);
        }

        .subcategory-option-price {
            font-weight: 600;
            color: var(--primary);
        }

        .subcategory-summary {
            background-color: var(--light-gray);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 25px;
        }

        .subcategory-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: var(--text);
        }

        .subcategory-summary-item:last-child {
            margin-bottom: 0;
        }

        .subcategory-summary-total {
            font-weight: 600;
            color: var(--primary);
            font-size: 18px;
            border-top: 1px solid var(--gray);
            padding-top: 10px;
            margin-top: 10px;
        }

        /* NEW: Subcategory display in cart */
        .cart-subcategory-options {
            margin-top: 5px;
            font-size: 13px;
            color: var(--gray);
        }

        .cart-subcategory-option {
            display: block;
            margin-left: 10px;
        }

        /* NEW: Subcategory management styles in admin */
        .subcategory-management {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
        }

        .subcategory-item {
            background-color: var(--light-gray);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .subcategory-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subcategory-item-title {
            font-weight: 600;
            color: var(--text);
        }

        .subcategory-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px 10px;
            background-color: var(--card-bg);
            border-radius: 6px;
        }

        .subcategory-option:last-child {
            margin-bottom: 0;
        }



        /* Responsive */
        @media (max-width: 992px) {
            .theme-gallery {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .font-options {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .theme-gallery {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }

            .preview-content-grid {
                grid-template-columns: 1fr;
            }

            .customization-actions {
                flex-direction: column;
            }

            .payment-actions {
                flex-direction: column;
                gap: 15px;
            }

            .btn {
                width: 100%;
            }

            .cart-floating {
                bottom: 20px;
                right: 20px;
                width: 55px;
                height: 55px;
            }

            .confirmation-card,
            .order-details {
                padding: 25px 20px;
            }

            .details-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .nav-container {
                flex-direction: column;
                gap: 15px;
                padding: 15px 0;
            }

            .logo,
            .header-center,
            .header-right {
                width: 100%;
                justify-content: center;
            }

            .header-center {
                order: 3;
                margin-top: 10px;
            }

            .help-button {
                width: 100%;
                justify-content: center;
            }

            .header-right {
                flex-direction: column;
                gap: 10px;
            }

            .my-orders-button {
                width: 100%;
                justify-content: center;
            }

            .table-info {
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }

            .admin-container {
                padding: 20px 15px;
            }

            .admin-tabs {
                flex-wrap: wrap;
            }

            .admin-tab {
                padding: 10px 15px;
                font-size: 14px;
            }

            .categories-management {
                flex-direction: column;
            }

            .upload-actions {
                flex-direction: column;
            }

            .color-customization {
                grid-template-columns: 1fr;
            }

            .order-notification {
                left: 20px;
                right: 20px;
                max-width: none;
            }

            .subcategory-modal-container {
                padding: 20px 15px;
                max-height: 90vh;
            }
        }

        @media (max-width: 480px) {
            .theme-gallery {
                grid-template-columns: repeat(2, 1fr);
            }

            .scanner-container {
                padding: 25px 20px;
            }

            .qr-placeholder {
                width: 200px;
                height: 200px;
            }

            .section-title {
                font-size: 26px;
            }

            .option-cards {
                grid-template-columns: 1fr;
            }

            .order-number {
                font-size: 24px;
            }

            .help-button {
                padding: 8px 15px;
                font-size: 14px;
            }

            .my-orders-button {
                padding: 8px 15px;
                font-size: 14px;
            }

            .theme-previews {
                grid-template-columns: 1fr;
            }
        }

        /* My Orders Header */
        .my-orders-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .my-orders-header-content {
            flex: 1;
        }

        .refresh-orders-btn {
            padding: 10px 20px;
            background-color: var(--secondary);
            color: var(--button-text);
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .refresh-orders-btn:hover {
            background-color: #386c8a;
            transform: translateY(-2px);
        }

        /* Admin Order Management Header */
        .admin-orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-orders-header-left {
            flex: 1;
            min-width: 250px;
        }

        .refresh-admin-orders-btn {
            padding: 10px 20px;
            background-color: var(--secondary);
            color: var(--button-text);
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .refresh-admin-orders-btn:hover {
            background-color: #386c8a;
            transform: translateY(-2px);
        }

        .refresh-admin-orders-btn .fa-spin {
            animation: fa-spin 1s infinite linear;
        }

        @keyframes fa-spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header>
        <div class="container nav-container">
            <div class="logo" id="restaurantLogo">
                <img src="" alt="Restaurant Logo" class="logo-img" id="logoImage">
                <i class="fas fa-utensils" id="logoIcon"></i>
                <span id="restaurantName">DineEasy</span>
            </div>

            <div class="header-center">
                <button class="help-button" id="headerHelpButton">
                    <i class="fas fa-headset"></i>
                    Need Help?
                </button>
            </div>

            <div class="header-right">
                <button class="my-orders-button" id="myOrdersButton" style="display: none;">
                    <i class="fas fa-clipboard-list"></i>
                    My Orders
                </button>
                <div class="table-info" id="tableInfo">
                    <i class="fas fa-qrcode"></i>
                    Scan QR to begin
                </div>
            </div>
        </div>
    </header>

    <!-- QR Scanner Section -->
    <section id="scannerSection" class="app-section active-section">
        <div class="container scanner-section">
            <div class="scanner-container">
                <h2 class="section-title">Scan Table QR Code</h2>
                <p class="section-subtitle">Point your camera at the QR code on your table to get started</p>

                <div class="qr-placeholder">
                    <i class="fas fa-qrcode"></i>
                    <span>QR Scanner Area</span>
                </div>

                <p style="margin: 20px 0; color: var(--gray);">For demo purposes, select a table:</p>

                <div class="demo-tables">
                    <button class="table-btn" data-table="Table 1">Table 1</button>
                    <button class="table-btn" data-table="Table 2">Table 2</button>
                    <button class="table-btn" data-table="Table 3">Table 3</button>
                    <button class="table-btn" data-table="Table 4">Table 4</button>
                    <button class="table-btn" data-table="Table 5">Table 5</button>
                    <button class="table-btn" data-table="VIP Table">VIP Table</button>
                    <button class="table-btn" data-table="Admin"
                        style="border-color: var(--warning); color: var(--warning);">Admin</button>
                </div>

                <p style="margin-top: 30px; font-size: 14px; color: var(--gray);">
                    <i class="fas fa-info-circle"></i> Once scanned, you'll be able to view the menu and place your
                    order.
                </p>
                <p style="margin-top: 10px; font-size: 14px; color: var(--warning);">
                    <i class="fas fa-shield-alt"></i> Select "Admin" table to access the admin panel (requires code).
                </p>
            </div>
        </div>
    </section>

    <!-- Menu Section -->
    <section id="menuSection" class="app-section">
        <div class="container">
            <h2 class="section-title" id="menuTitle">Our Menu</h2>
            <p class="section-subtitle" id="menuSubtitle">Select items to add to your order</p>

            <div class="category-tabs" id="categoryTabs">
                <!-- Category tabs will be dynamically added here -->
            </div>

            <div class="menu-grid" id="menuGrid">
                <!-- Menu items will be dynamically added here -->
            </div>
        </div>
    </section>

    <!-- Cart Section -->
    <section id="cartSection" class="app-section">
        <div class="container">
            <h2 class="section-title">Your Order</h2>
            <p class="section-subtitle" id="cartSubtitle">Review your order before payment</p>

            <div class="cart-container">
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be dynamically added here -->
                    <div class="empty-cart" style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Your cart is empty</p>
                    </div>
                </div>

                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal (tax included)</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Total</span>
                        <span class="amount" id="total">$0.00</span>
                    </div>

                    <div class="payment-actions">
                        <button class="btn btn-secondary" id="backToMenuBtn">
                            <i class="fas fa-arrow-left"></i> Back to Menu
                        </button>
                        <button class="btn btn-primary" id="proceedToPaymentBtn">
                            Proceed to Payment <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Payment Section -->
    <section id="paymentSection" class="app-section">
        <div class="container">
            <h2 class="section-title">Payment</h2>
            <p class="section-subtitle">Complete your order with payment</p>

            <div class="payment-container">
                <div class="payment-options">
                    <div class="option-group">
                        <div class="option-title">Payment Method</div>
                        <div class="option-cards">
                            <div class="option-card" data-payment="card">
                                <div class="option-icon">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div class="option-name">Credit/Debit Card</div>
                                <div class="option-desc">Pay with your card</div>
                            </div>
                            <div class="option-card" data-payment="cash">
                                <div class="option-icon">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="option-name">Cash</div>
                                <div class="option-desc">Pay with cash</div>
                            </div>
                        </div>
                    </div>

                    <div class="option-group">
                        <div class="option-title">Payment Time</div>
                        <div class="option-cards">
                            <div class="option-card" data-time="now">
                                <div class="option-icon">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div class="option-name">Pay Now</div>
                                <div class="option-desc">Complete payment immediately</div>
                            </div>
                            <div class="option-card" data-time="later">
                                <div class="option-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="option-name">Pay Later</div>
                                <div class="option-desc">Pay at the counter when leaving</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal (tax included)</span>
                        <span id="paymentSubtotal">$0.00</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Total</span>
                        <span class="amount" id="paymentTotal">$0.00</span>
                    </div>

                    <div class="payment-actions">
                        <button class="btn btn-secondary" id="backToCartBtn">
                            <i class="fas fa-arrow-left"></i> Back to Cart
                        </button>
                        <button class="btn btn-primary" id="confirmPaymentBtn">
                            <i class="fas fa-check"></i> Confirm Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- My Orders Section -->
    <section id="myOrdersSection" class="app-section">
        <div class="container my-orders-container">
            <div class="my-orders-header">
                <div class="my-orders-header-content">
                    <h2 class="section-title">My Orders</h2>
                    <p class="section-subtitle" id="myOrdersSubtitle">View all your current and past orders</p>
                </div>
                <button class="refresh-orders-btn" id="refreshOrdersBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Orders
                </button>
            </div>

            <div class="orders-list" id="ordersList">
                <!-- Orders will be dynamically added here -->
            </div>

            <div class="payment-actions">
                <button class="btn btn-secondary" id="backToMenuFromOrdersBtn">
                    <i class="fas fa-arrow-left"></i> Back to Menu
                </button>
                <button class="btn btn-primary" id="placeNewOrderBtn">
                    <i class="fas fa-plus"></i> Place New Order
                </button>
            </div>
        </div>
    </section>

    <!-- Order Confirmation Section -->
    <section id="confirmationSection" class="app-section">
        <div class="container confirmation-container">
            <div class="confirmation-card">
                <div class="confirmation-icon">
                    <i class="fas fa-check"></i>
                </div>
                <h2 class="section-title">Order Confirmed!</h2>
                <div class="order-number">Order #<span id="orderNumberDisplay">0000</span></div>
                <p class="order-message">Thank you for your order. Your food will be prepared shortly.</p>

                <div class="payment-actions" style="justify-content: center; gap: 15px;">
                    <button class="btn btn-success" id="newOrderBtn">
                        <i class="fas fa-utensils"></i> Start New Order
                    </button>
                    <button class="btn btn-secondary" id="viewMyOrdersBtn">
                        <i class="fas fa-clipboard-list"></i> View My Orders
                    </button>
                </div>
            </div>

            <div class="order-details">
                <div class="details-header">
                    <div class="details-title">Order Details</div>
                    <div class="details-table" id="confirmationTable">Table: -</div>
                </div>

                <div class="order-items" id="confirmationItems">
                    <!-- Order items will be dynamically added here -->
                </div>

                <div class="order-total">
                    <span>Total Amount (tax included)</span>
                    <span class="amount" id="confirmationTotal">$0.00</span>
                </div>

                <div class="payment-details">
                    <div class="payment-details-title">Payment Information</div>
                    <div class="payment-info">
                        <div class="info-label">Payment Method:</div>
                        <div class="info-value" id="confirmationPaymentMethod">-</div>
                    </div>
                    <div class="payment-info">
                        <div class="info-label">Payment Time:</div>
                        <div class="info-value" id="confirmationPaymentTime">-</div>
                    </div>
                    <div class="payment-info">
                        <div class="info-label">Order Status:</div>
                        <div class="info-value" id="confirmationOrderStatus" style="color: var(--success);">Confirmed
                        </div>
                    </div>
                </div>

                <div class="estimated-time">
                    <div class="time-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="time-text">
                        <strong>Estimated preparation time:</strong> <span id="estimatedTime">15-25</span> minutes
                    </div>
                </div>
            </div>

            <div class="payment-actions">
                <button class="btn btn-secondary" id="viewMenuBtn">
                    <i class="fas fa-book-open"></i> View Full Menu
                </button>
                <button class="btn btn-primary" id="needHelpBtn">
                    <i class="fas fa-headset"></i> Need Help?
                </button>
            </div>
        </div>
    </section>

    <!-- Admin Dashboard Section (Shown only when Admin table is selected) -->
    <section id="adminDashboardSection" class="admin-dashboard-section">
        <div class="container">
            <div class="admin-dashboard-container">
                <h2 style="margin-bottom: 25px; color: var(--primary);">
                    <i class="fas fa-lock"></i> Admin Control Panel
                </h2>

                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="restaurant">Restaurant Settings</button>
                    <button class="admin-tab" data-tab="menu">Menu Management</button>
                    <button class="admin-tab" data-tab="categories">Category Management</button>
                    <button class="admin-tab" data-tab="orders">Order Management</button>
                    <button class="admin-tab" data-tab="customization">Visual Customization</button>
                    <button class="admin-tab" data-tab="system">System Tools</button>
                </div>

                <!-- Restaurant Settings Tab -->
                <div class="admin-content active" id="restaurantTab">
                    <div class="admin-form-group">
                        <label class="admin-label">Restaurant Name</label>
                        <input type="text" class="admin-input" id="adminRestaurantName" value="DineEasy">
                    </div>

                    <div class="image-upload-container">
                        <label class="admin-label">Restaurant Logo</label>
                        <div class="image-preview" id="logoPreview">
                            <div class="image-preview-placeholder">
                                <i class="fas fa-image"></i>
                                <p>No logo uploaded</p>
                            </div>
                        </div>
                        <div class="upload-actions">
                            <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                            <button class="btn btn-secondary upload-btn" id="uploadLogoBtn">
                                <i class="fas fa-upload"></i> Upload Logo
                            </button>
                            <button class="remove-image-btn" id="removeLogoBtn">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>

                    <div class="admin-form-group">
                        <label class="admin-label">Tax Rate (%)</label>
                        <input type="number" class="admin-input" id="adminTaxRate" value="8" min="0" max="50"
                            step="0.1">
                    </div>

                    <div class="admin-form-group">
                        <label class="admin-label">Estimated Preparation Time (minutes)</label>
                        <input type="text" class="admin-input" id="adminPrepTime" value="15-25">
                    </div>

                    <div class="admin-form-group">
                        <label class="admin-label">Welcome Message</label>
                        <textarea class="admin-textarea" id="adminWelcomeMessage"
                            placeholder="Welcome to our restaurant..."></textarea>
                    </div>

                    <button class="btn btn-primary" id="saveRestaurantSettings">
                        <i class="fas fa-save"></i> Save Restaurant Settings
                    </button>
                </div>

                <!-- Menu Management Tab -->
                <div class="admin-content" id="menuTab">
                    <div style="margin-bottom: 25px;">
                        <button class="btn btn-success" id="addMenuItemBtn">
                            <i class="fas fa-plus"></i> Add New Menu Item
                        </button>
                    </div>

                    <div class="admin-grid" id="menuItemsList">
                        <!-- Menu items will be dynamically added here -->
                    </div>

                    <!-- Edit Menu Item Form (Hidden by default) -->
                    <div id="editMenuItemForm" style="display: none;">
                        <h3 style="margin-bottom: 20px;">Edit Menu Item</h3>

                        <div class="admin-form-group">
                            <label class="admin-label">Item Name</label>
                            <input type="text" class="admin-input" id="editItemName">
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-label">Description</label>
                            <textarea class="admin-textarea" id="editItemDescription"></textarea>
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-label">Price (with tax)</label>
                            <input type="number" class="admin-input" id="editItemPrice" step="0.01" min="0">
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-label">Category</label>
                            <select class="admin-select" id="editItemCategory">
                                <!-- Categories will be dynamically populated -->
                            </select>
                        </div>

                        <div class="image-upload-container">
                            <label class="admin-label">Item Image</label>
                            <div class="image-preview" id="itemImagePreview">
                                <div class="image-preview-placeholder">
                                    <i class="fas fa-utensils"></i>
                                    <p>No image uploaded</p>
                                </div>
                            </div>
                            <div class="upload-actions">
                                <input type="file" id="itemImageUpload" accept="image/*" style="display: none;">
                                <button class="btn btn-secondary upload-btn" id="uploadItemImageBtn">
                                    <i class="fas fa-upload"></i> Upload Image
                                </button>
                                <button class="remove-image-btn" id="removeItemImageBtn">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-label">Tags (separate with commas)</label>
                            <input type="text" class="admin-input" id="editItemTags"
                                placeholder="Vegetarian, Popular, Spicy">
                        </div>

                        <!-- NEW: Subcategory Management Section -->
                        <div class="subcategory-management">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="section-title-small" style="margin-bottom: 0;">
                                    <i class="fas fa-list-alt"></i>
                                    Subcategories & Options
                                </div>
                                <button type="button" class="btn btn-secondary" id="addSubcategoryBtn">
                                    <i class="fas fa-plus"></i> Add Subcategory
                                </button>
                            </div>
                            <p style="margin-bottom: 20px; color: var(--gray); font-size: 14px;">
                                Add subcategories like "Sugar Level", "Ice Level", etc. with options like "No Sugar", "Less Sugar", etc.
                                You can add prices to each option for additional charges.
                            </p>
                            <div id="subcategoriesContainer">
                                <!-- Subcategories will be dynamically added here -->
                            </div>
                        </div>

                        <div class="payment-actions">
                            <button class="btn btn-secondary" id="cancelEditBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn btn-primary" id="saveMenuItemBtn">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Category Management Tab -->
                <div class="admin-content" id="categoriesTab">
                    <h3 style="margin-bottom: 20px;">Manage Categories</h3>
                    <p style="margin-bottom: 25px; color: var(--gray);">
                        Add, edit, or remove menu categories. Note: You cannot delete categories that have menu items
                        assigned to them.
                    </p>

                    <div class="categories-management">
                        <div class="categories-list">
                            <h4 style="margin-bottom: 15px;">Existing Categories</h4>
                            <div class="categories-list-container" id="categoriesListContainer">
                                <!-- Categories will be dynamically added here -->
                            </div>
                        </div>

                        <div class="add-category-form">
                            <h4 style="margin-bottom: 15px;">Add New Category</h4>
                            <div class="admin-form-group">
                                <label class="admin-label">Category Name</label>
                                <input type="text" class="admin-input" id="newCategoryName"
                                    placeholder="e.g., Sides, Salads, Breakfast">
                            </div>
                            <div class="admin-form-group">
                                <label class="admin-label">Display Name</label>
                                <input type="text" class="admin-input" id="newCategoryDisplayName"
                                    placeholder="e.g., Side Dishes">
                                <small style="color: var(--gray);">How it will appear in the menu tabs</small>
                            </div>
                            <button class="btn btn-success" id="addCategoryBtn">
                                <i class="fas fa-plus"></i> Add Category
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Order Management Tab with Refresh Button -->
                <div class="admin-content" id="ordersTab">
                    <div class="admin-orders-header">
                        <div class="admin-orders-header-left">
                            <label class="admin-label">Filter by Status</label>
                            <select class="admin-select" id="orderStatusFilter">
                                <option value="all">All Orders</option>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="ready">Ready</option>
                                <option value="served">Served</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="removed">Removed</option>
                            </select>
                        </div>
                        <button class="refresh-admin-orders-btn" id="refreshAdminOrdersBtn">
                            <i class="fas fa-sync-alt"></i> Refresh Orders
                        </button>
                    </div>

                    <div id="adminOrdersList">
                        <!-- Orders will be dynamically added here -->
                        <p style="text-align: center; color: var(--gray); padding: 40px;">
                            No orders yet. Orders will appear here when customers place them.
                        </p>
                    </div>
                </div>

                <!-- UPDATED VISUAL CUSTOMIZATION TAB WITH 20 THEMES -->
                <div class="admin-content" id="customizationTab">
                    <div class="customization-panel">
                        <div class="customization-section">
                            <div class="section-title-small">
                                <i class="fas fa-palette"></i>
                                Choose a Theme (20 Unique Options)
                            </div>
                            <p style="margin-bottom: 20px; color: var(--gray);">
                                Select from our collection of 20 modern and cozy themes. Each theme is designed to
                                create a unique dining experience for your customers.
                            </p>

                            <div class="theme-gallery" id="themeGallery">
                                <!-- 20 themes will be dynamically added here -->
                            </div>

                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                                <div style="font-weight: 500; margin-bottom: 10px; color: var(--text);">
                                    Current Theme: <span id="currentThemeName">Default</span>
                                    <span class="theme-category" id="currentThemeCategory">Modern</span>
                                </div>
                                <button class="btn btn-primary" id="applyThemeBtn" style="width: 100%;">
                                    <i class="fas fa-check"></i> Apply Selected Theme
                                </button>
                            </div>
                        </div>

                        <div class="customization-section">
                            <div class="section-title-small">
                                <i class="fas fa-font"></i>
                                Font Selection
                            </div>
                            <p style="margin-bottom: 20px; color: var(--gray);">
                                Choose a font that matches your restaurant's personality.
                            </p>

                            <div class="font-options" id="fontOptions">
                                <!-- Font options will be dynamically added here -->
                            </div>

                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                                <div style="font-weight: 500; margin-bottom: 10px; color: var(--text);">
                                    Current Font: <span id="currentFontName">Poppins</span>
                                </div>
                                <button class="btn btn-secondary" id="applyFontBtn" style="width: 100%;">
                                    <i class="fas fa-check"></i> Apply Selected Font
                                </button>
                            </div>
                        </div>

                        <div class="customization-section">
                            <div class="section-title-small">
                                <i class="fas fa-sliders-h"></i>
                                Custom Color Adjustments
                            </div>
                            <p style="margin-bottom: 20px; color: var(--gray);">
                                Fine-tune individual colors if needed.
                            </p>

                            <div class="color-customization" id="colorCustomization">
                                <!-- Color customization options will be dynamically added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Live Preview -->
                    <div class="customization-preview">
                        <div class="preview-header">
                            <div class="preview-restaurant-name" id="previewRestaurantName">Restaurant Preview</div>
                            <div style="font-size: 14px; color: var(--gray);">Live Preview</div>
                        </div>

                        <div class="preview-content-grid">
                            <div>
                                <div class="preview-card">
                                    <div style="font-weight: 600; margin-bottom: 15px; color: var(--text);">Sample Menu
                                        Item</div>
                                    <div class="preview-menu-item">
                                        <span>Margherita Pizza</span>
                                        <span style="color: var(--primary); font-weight: 600;">$14.99</span>
                                    </div>
                                    <div class="preview-menu-item">
                                        <span>Caesar Salad</span>
                                        <span style="color: var(--primary); font-weight: 600;">$9.99</span>
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <button
                                            style="background-color: var(--primary); color: var(--button-text); border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer;">
                                            Add to Cart
                                        </button>
                                    </div>
                                </div>

                                <div
                                    style="background-color: var(--background); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid var(--light-gray);">
                                    <div style="color: var(--text); font-weight: 500; margin-bottom: 10px;">Customer
                                        Note:</div>
                                    <div style="color: var(--gray); font-size: 14px;">"The theme creates a welcoming
                                        atmosphere for our guests."</div>
                                </div>
                            </div>
                            <div>
                                <div class="preview-button-group">
                                    <button class="preview-btn"
                                        style="background-color: var(--primary); color: var(--button-text);">
                                        Primary Button
                                    </button>
                                    <button class="preview-btn"
                                        style="background-color: var(--secondary); color: white;">
                                        Secondary Button
                                    </button>
                                    <button class="preview-btn" style="background-color: var(--success); color: white;">
                                        Success Button
                                    </button>
                                </div>

                                <div class="preview-card" style="margin-top: 15px;">
                                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--text);">Order
                                        Summary</div>
                                    <div class="preview-menu-item">
                                        <span>Subtotal</span>
                                        <span>$24.98</span>
                                    </div>
                                    <div class="preview-menu-item">
                                        <span>Total</span>
                                        <span style="color: var(--primary); font-weight: 600;">$24.98</span>
                                    </div>
                                </div>

                                <div
                                    style="background-color: var(--light-gray); padding: 15px; border-radius: 8px; margin-top: 15px;">
                                    <div style="color: var(--text); font-size: 14px;">This is how text will appear in
                                        light gray areas.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save/Reset Buttons -->
                    <div class="customization-actions">
                        <button class="btn btn-secondary" id="resetCustomizationBtn">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                        <button class="btn btn-primary" id="saveCustomizationBtn">
                            <i class="fas fa-save"></i> Save All Changes
                        </button>
                    </div>
                </div>

                <!-- System Tools Tab -->
                <div class="admin-content" id="systemTab">
                    <h3 style="margin-bottom: 20px;">System Management</h3>

                    <div class="admin-grid">
                        <div class="admin-card">
                            <div class="admin-card-header">
                                <div class="admin-card-title">Clear All Orders</div>
                            </div>
                            <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">
                                Remove all order history from the system.
                            </p>
                            <button class="btn btn-danger" id="clearOrdersBtn">
                                <i class="fas fa-trash"></i> Clear Orders
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header">
                                <div class="admin-card-title">Reset Menu to Default</div>
                            </div>
                            <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">
                                Restore the original menu items.
                            </p>
                            <button class="btn btn-warning" id="resetMenuBtn">
                                <i class="fas fa-redo"></i> Reset Menu
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header">
                                <div class="admin-card-title">Export Data</div>
                            </div>
                            <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">
                                Download all restaurant data as JSON.
                            </p>
                            <button class="btn btn-secondary" id="exportDataBtn">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                        </div>

                        <div class="admin-card">
                            <div class="admin-card-header">
                                <div class="admin-card-title">Import Data</div>
                            </div>
                            <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">
                                Upload and restore from a backup file.
                            </p>
                            <input type="file" id="importDataInput" style="display: none;" accept=".json">
                            <button class="btn btn-secondary" id="importDataBtn">
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);">
                        <h4 style="margin-bottom: 15px;">System Statistics</h4>
                        <div id="systemStats">
                            <!-- Statistics will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- NEW: Subcategory Options Modal -->
    <div class="subcategory-modal" id="subcategoryModal">
        <div class="subcategory-modal-container">
            <button class="subcategory-modal-close" id="subcategoryModalClose">
                <i class="fas fa-times"></i>
            </button>
            
            <h3 id="subcategoryModalTitle">Customize Your Item</h3>
            <p id="subcategoryModalDescription" style="color: var(--gray); margin-bottom: 20px;"></p>
            
            <div id="subcategoryOptionsContainer">
                <!-- Subcategory options will be dynamically added here -->
            </div>
            
            <div class="subcategory-summary" id="subcategorySummary">
                <div class="subcategory-summary-item">
                    <span>Base Price:</span>
                    <span id="subcategoryBasePrice">$0.00</span>
                </div>
                <div class="subcategory-summary-item">
                    <span>Additional Options:</span>
                    <span id="subcategoryAdditionalPrice">$0.00</span>
                </div>
                <div class="subcategory-summary-item subcategory-summary-total">
                    <span>Total Price:</span>
                    <span id="subcategoryTotalPrice">$0.00</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="cancelSubcategoryBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="addToCartWithOptionsBtn" style="flex: 1;">
                    Add to Cart
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Modal for customer mode) -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-container">
            <button class="admin-close" id="adminClose">
                <i class="fas fa-times"></i>
            </button>

            <h2 style="margin-bottom: 25px; color: var(--primary);">
                <i class="fas fa-lock"></i> Admin Control Panel
            </h2>

            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="restaurant">Restaurant Settings</button>
                <button class="admin-tab" data-tab="menu">Menu Management</button>
                <button class="admin-tab" data-tab="categories">Category Management</button>
                <button class="admin-tab" data-tab="orders">Order Management</button>
                <button class="admin-tab" data-tab="customization">Visual Customization</button>
                <button class="admin-tab" data-tab="system">System Tools</button>
            </div>

            <!-- Restaurant Settings Tab -->
            <div class="admin-content active" id="restaurantTabModal">
                <div class="admin-form-group">
                    <label class="admin-label">Restaurant Name</label>
                    <input type="text" class="admin-input" id="adminRestaurantNameModal" value="DineEasy">
                </div>

                <div class="image-upload-container">
                    <label class="admin-label">Restaurant Logo</label>
                    <div class="image-preview" id="logoPreviewModal">
                        <div class="image-preview-placeholder">
                            <i class="fas fa-image"></i>
                            <p>No logo uploaded</p>
                        </div>
                    </div>
                    <div class="upload-actions">
                        <input type="file" id="logoUploadModal" accept="image/*" style="display: none;">
                        <button class="btn btn-secondary upload-btn" id="uploadLogoBtnModal">
                            <i class="fas fa-upload"></i> Upload Logo
                        </button>
                        <button class="remove-image-btn" id="removeLogoBtnModal">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>

                <div class="admin-form-group">
                    <label class="admin-label">Tax Rate (%)</label>
                    <input type="number" class="admin-input" id="adminTaxRateModal" value="8" min="0" max="50"
                        step="0.1">
                </div>

                <div class="admin-form-group">
                    <label class="admin-label">Estimated Preparation Time (minutes)</label>
                    <input type="text" class="admin-input" id="adminPrepTimeModal" value="15-25">
                </div>

                <div class="admin-form-group">
                    <label class="admin-label">Welcome Message</label>
                    <textarea class="admin-textarea" id="adminWelcomeMessageModal"
                        placeholder="Welcome to our restaurant..."></textarea>
                </div>

                <button class="btn btn-primary" id="saveRestaurantSettingsModal">
                    <i class="fas fa-save"></i> Save Restaurant Settings
                </button>
            </div>

            <!-- Menu Management Tab -->
            <div class="admin-content" id="menuTabModal">
                <div style="margin-bottom: 25px;">
                    <button class="btn btn-success" id="addMenuItemBtnModal">
                        <i class="fas fa-plus"></i> Add New Menu Item
                    </button>
                </div>

                <div class="admin-grid" id="menuItemsListModal">
                    <!-- Menu items will be dynamically added here -->
                </div>
            </div>

            <!-- Category Management Tab -->
            <div class="admin-content" id="categoriesTabModal">
                <h3 style="margin-bottom: 20px;">Manage Categories</h3>
                <p style="margin-bottom: 25px; color: var(--gray);">
                    Add, edit, or remove menu categories. Note: You cannot delete categories that have menu items
                    assigned to them.
                </p>

                <div class="categories-management">
                    <div class="categories-list">
                        <h4 style="margin-bottom: 15px;">Existing Categories</h4>
                        <div class="categories-list-container" id="categoriesListContainerModal">
                            <!-- Categories will be dynamically added here -->
                        </div>
                    </div>

                    <div class="add-category-form">
                        <h4 style="margin-bottom: 15px;">Add New Category</h4>
                        <div class="admin-form-group">
                            <label class="admin-label">Category Name</label>
                            <input type="text" class="admin-input" id="newCategoryNameModal"
                                placeholder="e.g., Sides, Salads, Breakfast">
                        </div>
                        <div class="admin-form-group">
                            <label class="admin-label">Display Name</label>
                            <input type="text" class="admin-input" id="newCategoryDisplayNameModal"
                                placeholder="e.g., Side Dishes">
                            <small style="color: var(--gray);">How it will appear in the menu tabs</small>
                        </div>
                        <button class="btn btn-success" id="addCategoryBtnModal">
                            <i class="fas fa-plus"></i> Add Category
                        </button>
                    </div>
                </div>
            </div>

            <!-- Order Management Tab with Refresh Button -->
            <div class="admin-content" id="ordersTabModal">
                <div class="admin-orders-header">
                    <div class="admin-orders-header-left">
                        <label class="admin-label">Filter by Status</label>
                        <select class="admin-select" id="orderStatusFilterModal">
                            <option value="all">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready</option>
                            <option value="served">Served</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="removed">Removed</option>
                        </select>
                    </div>
                    <button class="refresh-admin-orders-btn" id="refreshAdminOrdersBtnModal">
                        <i class="fas fa-sync-alt"></i> Refresh Orders
                    </button>
                </div>

                <div id="adminOrdersListModal">
                    <!-- Orders will be dynamically added here -->
                    <p style="text-align: center; color: var(--gray); padding: 40px;">
                        No orders yet. Orders will appear here when customers place them.
                    </p>
                </div>
            </div>

            <!-- Simplified Visual Customization Tab for Modal -->
            <div class="admin-content" id="customizationTabModal">
                <h3 style="margin-bottom: 20px;">Visual Customization</h3>
                <p style="margin-bottom: 25px; color: var(--gray);">
                    Quick visual customization options.
                </p>

                <div style="margin-bottom: 30px;">
                    <div style="font-weight: 500; margin-bottom: 15px; color: var(--text);">Theme Selection</div>
                    <div class="theme-gallery" id="themeGalleryModal">
                        <!-- Theme previews will be dynamically added here -->
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <div style="font-weight: 500; margin-bottom: 15px; color: var(--text);">Font Selection</div>
                    <div class="font-options" id="fontOptionsModal">
                        <!-- Font options will be dynamically added here -->
                    </div>
                </div>

                <div class="customization-actions">
                    <button class="btn btn-secondary" id="resetCustomizationBtnModal">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button class="btn btn-primary" id="saveCustomizationBtnModal">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>

            <!-- System Tools Tab -->
            <div class="admin-content" id="systemTabModal">
                <h3 style="margin-bottom: 20px;">System Management</h3>

                <div class="admin-grid">
                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">Clear All Orders</div>
                        </div>
                        <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">
                            Remove all order history from the system.
                        </p>
                        <button class="btn btn-danger" id="clearOrdersBtnModal">
                            <i class="fas fa-trash"></i> Clear Orders
                        </button>
                    </div>

                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">Reset Menu to Default</div>
                        </div>
                        <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">
                            Restore the original menu items.
                        </p>
                        <button class="btn btn-warning" id="resetMenuBtnModal">
                            <i class="fas fa-redo"></i> Reset Menu
                        </button>
                    </div>

                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">Export Data</div>
                        </div>
                        <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">
                            Download all restaurant data as JSON.
                        </p>
                        <button class="btn btn-secondary" id="exportDataBtnModal">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                    </div>

                    <div class="admin-card">
                        <div class="admin-card-header">
                            <div class="admin-card-title">Import Data</div>
                        </div>
                        <p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">
                            Upload and restore from a backup file.
                        </p>
                        <input type="file" id="importDataInputModal" style="display: none;" accept=".json">
                        <button class="btn btn-secondary" id="importDataBtnModal">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                    </div>
                </div>

                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);">
                    <h4 style="margin-bottom: 15px;">System Statistics</h4>
                    <div id="systemStatsModal">
                        <!-- Statistics will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Code Prompt -->
    <div class="admin-code-prompt" id="adminCodePrompt">
        <div class="admin-code-container">
            <div class="admin-code-icon">
                <i class="fas fa-lock"></i>
            </div>
            
            <h3 class="admin-code-title">Admin Access Required</h3>
            <p class="admin-code-subtitle">Please enter the admin code to continue</p>
            <input type="password" class="admin-code-input" id="adminCodeInput" placeholder="Enter 4-digit code"
                maxlength="4" autocomplete="off">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancelAdminCodeBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="submitAdminCodeBtn" style="flex: 1;">
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Change Confirmation Prompt -->
    <div class="admin-code-prompt" id="adminChangePrompt">
        <div class="admin-code-container">
            <div class="admin-code-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h3 class="admin-code-title">Confirm Changes</h3>
            <p class="admin-code-subtitle">Please enter the confirmation code to save changes</p>
            <input type="password" class="admin-code-input" id="adminChangeCodeInput" placeholder="Enter 4-digit code"
                maxlength="4" autocomplete="off">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancelChangeBtn" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="submitChangeCodeBtn" style="flex: 1;">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Real-time Order Notification for Admin -->
    <div class="order-notification" id="orderNotification">
        <i class="fas fa-bell"></i>
        <div id="orderNotificationText">New order received!</div>
    </div>

    <!-- Cart Floating Button -->
    <div class="cart-floating" id="cartFloating">
        <i class="fas fa-shopping-cart"></i>
        <div class="cart-count" id="cartCount">0</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div id="notificationText">Item added to cart!</div>
    </div>

    <!-- Sound Effects Audio Elements -->
    <audio id="addToCartSound" preload="auto">
        <source src="cart-add.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <audio id="paymentConfirmSound" preload="auto">
        <source src="payment-confirm.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtO20G2Ssl9cvB6CP1xfCh2Ldf4GMdGUg",
            authDomain: "foodmenu-b1fc2.firebaseapp.com",
            projectId: "foodmenu-b1fc2",
            storageBucket: "foodmenu-b1fc2.firebasestorage.app",
            messagingSenderId: "730100337020",
            appId: "1:730100337020:web:dd3dc58846c8207a693cf9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // ----- 1. ENSURE SORT ORDER ON LOAD -----
        function ensureSortOrders() {
            // Menu items
            let maxSort = 0;
            state.menuItems.forEach((item, idx) => {
                if (item.sortOrder === undefined) item.sortOrder = idx;
                if (item.sortOrder > maxSort) maxSort = item.sortOrder;
            });
            // Categories
            state.categories.forEach((cat, idx) => {
                if (cat.sortOrder === undefined) cat.sortOrder = idx;
            });
        }

        // ----- 2. DUPLICATE MENU ITEM -----
        function duplicateMenuItem(itemId) {
            const original = state.menuItems.find(i => i.id === itemId);
            if (!original) return;
            const copy = JSON.parse(JSON.stringify(original));
            copy.id = Math.max(...state.menuItems.map(i => i.id), 0) + 1;
            copy.name = `${copy.name} (Copy)`;
            copy.sortOrder = Math.max(...state.menuItems.map(i => i.sortOrder || 0), 0) + 1;
            state.menuItems.push(copy);
            saveToLocalStorage();
            db.collection("menu").doc(copy.id.toString()).set(copy).catch(console.error);
            if (state.isAdminMode) {
                loadMenuItemsForAdmin();
                loadMenuItemsForAdminModal();
            }
            showNotification(`"${copy.name}" duplicated`);
        }

    
        // Application State
        const state = {
            currentTable: null,
            cart: [],
            selectedPaymentMethod: null,
            selectedPaymentTime: null,
            currentOrderNumber: null,
            restaurantInfo: {
                name: "DineEasy",
                taxRate: 8,
                estimatedPrepTime: "15-25",
                logoImage: "",
                welcomeMessage: ""
            },
            menuItems: [],
            orders: [],
            orderStats: {
                totalOrders: 0,
                totalRevenue: 0,
                avgOrderValue: 0,
                pendingOrders: 0,
                preparingOrders: 0,
                readyOrders: 0,
                servedOrders: 0,
                cancelledOrders: 0,
                removedOrders: 0
            },
            adminAccessCode: "3232",
            adminChangeCode: "6262",
            categories: [],
            isAdminMode: false,
            pendingAdminAction: null,
            currentImageUpload: null,
            customization: {
                primary: "#e63946",
                primaryDark: "#c1121f",
                secondary: "#457b9d",
                light: "#f8f9fa",
                dark: "#212529",
                gray: "#6c757d",
                lightGray: "#e9ecef",
                success: "#2a9d8f",
                warning: "#e9c46a",
                danger: "#dc3545",
                shadow: "0 4px 12px rgba(0, 0, 0, 0.08)",
                radius: "12px",
                background: "#fefefe",
                text: "#212529",
                cardBg: "#ffffff",
                headerBg: "#ffffff",
                menuBg: "#ffffff",
                cartBg: "#ffffff",
                paymentBg: "#ffffff",
                buttonText: "#ffffff",
                fontPrimary: "'Poppins', sans-serif",
                fontSecondary: "'Playfair Display', serif"
            },
            currentTheme: "default",
            currentFont: "poppins",
            lastOrderUpdate: 0,
            // NEW: Temporary storage for subcategory selections
            currentSubcategorySelections: null,
            currentMenuItemForSubcategories: null
        };

        // Default Menu Data with Tax Included in Prices
        const defaultMenuItems = [];

        // 20 UNIQUE THEMES - MODERN AND COZY
        const themes = {
            default: {
                name: "Classic Modern",
                category: "Modern",
                primary: "#e63946",
                secondary: "#457b9d",
                background: "#fefefe",
                text: "#212529",
                cardBg: "#ffffff",
                lightGray: "#e9ecef"
            },
            midnight: {
                name: "Midnight Elegance",
                category: "Modern",
                primary: "#6c63ff",
                secondary: "#4cc9f0",
                background: "#121212",
                text: "#f5f5f5",
                cardBg: "#1e1e1e",
                lightGray: "#2d2d2d"
            },
            autumn: {
                name: "Autumn Cozy",
                category: "Cozy",
                primary: "#e76f51",
                secondary: "#f4a261",
                background: "#fefae0",
                text: "#283618",
                cardBg: "#ffffff",
                lightGray: "#faedcd"
            },
            coffee: {
                name: "Coffee Shop",
                category: "Cozy",
                primary: "#6f4e37",
                secondary: "#c19a6b",
                background: "#f5e9d9",
                text: "#3e2723",
                cardBg: "#ffffff",
                lightGray: "#e6d5c3"
            },
            forest: {
                name: "Forest Retreat",
                category: "Natural",
                primary: "#2a9d8f",
                secondary: "#e9c46a",
                background: "#f1faee",
                text: "#1d3557",
                cardBg: "#ffffff",
                lightGray: "#a8dadc"
            },
            sage: {
                name: "Sage Garden",
                category: "Natural",
                primary: "#84a98c",
                secondary: "#52796f",
                background: "#f8f9fa",
                text: "#354f52",
                cardBg: "#ffffff",
                lightGray: "#cad2c5"
            },
            citrus: {
                name: "Citrus Fresh",
                category: "Vibrant",
                primary: "#ff9f1c",
                secondary: "#ffbf69",
                background: "#f8f9fa",
                text: "#212529",
                cardBg: "#ffffff",
                lightGray: "#ffe8d6"
            },
            berry: {
                name: "Berry Bliss",
                category: "Vibrant",
                primary: "#9d4edd",
                secondary: "#c77dff",
                background: "#f8f9fa",
                text: "#212529",
                cardBg: "#ffffff",
                lightGray: "#e0aaff"
            },
            ocean: {
                name: "Ocean Breeze",
                category: "Calm",
                primary: "#0077b6",
                secondary: "#00b4d8",
                background: "#f8f9fa",
                text: "#03045e",
                cardBg: "#ffffff",
                lightGray: "#caf0f8"
            },
            lavender: {
                name: "Lavender Dream",
                category: "Calm",
                primary: "#9c89b8",
                secondary: "#b8bedd",
                background: "#f8f9fa",
                text: "#4a4e69",
                cardBg: "#ffffff",
                lightGray: "#f0e6ef"
            },
            gold: {
                name: "Golden Luxury",
                category: "Luxury",
                primary: "#d4af37",
                secondary: "#f9d976",
                background: "#1a1a1a",
                text: "#f5f5f5",
                cardBg: "#2d2d2d",
                lightGray: "#3d3d3d"
            },
            velvet: {
                name: "Velvet Night",
                category: "Luxury",
                primary: "#7209b7",
                secondary: "#3a0ca3",
                background: "#0a0a0a",
                text: "#f5f5f5",
                cardBg: "#1a1a1a",
                lightGray: "#2d2d2d"
            },
            minimalist: {
                name: "Pure Minimal",
                category: "Minimalist",
                primary: "#495057",
                secondary: "#6c757d",
                background: "#ffffff",
                text: "#212529",
                cardBg: "#f8f9fa",
                lightGray: "#e9ecef"
            },
            paper: {
                name: "Paper White",
                category: "Minimalist",
                primary: "#adb5bd",
                secondary: "#ced4da",
                background: "#ffffff",
                text: "#343a40",
                cardBg: "#f8f9fa",
                lightGray: "#e9ecef"
            },
            retro: {
                name: "Retro Diner",
                category: "Retro",
                primary: "#ff6b6b",
                secondary: "#4ecdc4",
                background: "#fff9db",
                text: "#2d3436",
                cardBg: "#ffffff",
                lightGray: "#ffeaa7"
            },
            vintage: {
                name: "Vintage Charm",
                category: "Retro",
                primary: "#dda15e",
                secondary: "#bc6c25",
                background: "#fefae0",
                text: "#283618",
                cardBg: "#ffffff",
                lightGray: "#faedcd"
            },
            corporate: {
                name: "Corporate Blue",
                category: "Professional",
                primary: "#2c3e50",
                secondary: "#3498db",
                background: "#ecf0f1",
                text: "#2c3e50",
                cardBg: "#ffffff",
                lightGray: "#bdc3c7"
            },
            slate: {
                name: "Slate Professional",
                category: "Professional",
                primary: "#34495e",
                secondary: "#7f8c8d",
                background: "#f5f7fa",
                text: "#2c3e50",
                cardBg: "#ffffff",
                lightGray: "#dcdde1"
            },
            candy: {
                name: "Candy Shop",
                category: "Playful",
                primary: "#ff5d8f",
                secondary: "#ff97b7",
                background: "#f8f9fa",
                text: "#212529",
                cardBg: "#ffffff",
                lightGray: "#ffcad4"
            },
            tropical: {
                name: "Tropical Paradise",
                category: "Playful",
                primary: "#06d6a0",
                secondary: "#118ab2",
                background: "#f8f9fa",
                text: "#073b4c",
                cardBg: "#ffffff",
                lightGray: "#cbf3f0"
            }
        };

        // Font definitions
        const fonts = {
            poppins: {
                name: "Poppins",
                primary: "'Poppins', sans-serif",
                secondary: "'Playfair Display', serif"
            },
            roboto: {
                name: "Roboto",
                primary: "'Roboto', sans-serif",
                secondary: "'Roboto Slab', serif"
            },
            opensans: {
                name: "Open Sans",
                primary: "'Open Sans', sans-serif",
                secondary: "'Merriweather', serif"
            },
            lato: {
                name: "Lato",
                primary: "'Lato', sans-serif",
                secondary: "'Playfair Display', serif"
            },
            montserrat: {
                name: "Montserrat",
                primary: "'Montserrat', sans-serif",
                secondary: "'Cardo', serif"
            },
            inter: {
                name: "Inter",
                primary: "'Inter', sans-serif",
                secondary: "'Inter', serif"
            }
        };

        // Important colors for customization
        const importantColors = [
            { id: "primary", label: "Primary Color", description: "Main brand color for buttons" },
            { id: "secondary", label: "Secondary Color", description: "Secondary accent color" },
            { id: "background", label: "Background", description: "Page background color" },
            { id: "text", label: "Text Color", description: "Main text color" },
            { id: "cardBg", label: "Card Background", description: "Background for cards and containers" },
            { id: "lightGray", label: "Light Gray", description: "Background for subtle elements" }
        ];

        // DOM Elements
        const scannerSection = document.getElementById('scannerSection');
        const menuSection = document.getElementById('menuSection');
        const cartSection = document.getElementById('cartSection');
        const paymentSection = document.getElementById('paymentSection');
        const myOrdersSection = document.getElementById('myOrdersSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const adminDashboardSection = document.getElementById('adminDashboardSection');
        const tableInfo = document.getElementById('tableInfo');
        const menuSubtitle = document.getElementById('menuSubtitle');
        const cartSubtitle = document.getElementById('cartSubtitle');
        const myOrdersSubtitle = document.getElementById('myOrdersSubtitle');
        const menuGrid = document.getElementById('menuGrid');
        const categoryTabs = document.getElementById('categoryTabs');
        const cartItems = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');
        const cartFloating = document.getElementById('cartFloating');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const orderNumberDisplay = document.getElementById('orderNumberDisplay');
        const confirmationTable = document.getElementById('confirmationTable');
        const confirmationItems = document.getElementById('confirmationItems');
        const confirmationTotal = document.getElementById('confirmationTotal');
        const confirmationPaymentMethod = document.getElementById('confirmationPaymentMethod');
        const confirmationPaymentTime = document.getElementById('confirmationPaymentTime');
        const confirmationOrderStatus = document.getElementById('confirmationOrderStatus');
        const headerHelpButton = document.getElementById('headerHelpButton');
        const restaurantName = document.getElementById('restaurantName');
        const menuTitle = document.getElementById('menuTitle');
        const estimatedTime = document.getElementById('estimatedTime');
        const myOrdersButton = document.getElementById('myOrdersButton');
        const ordersList = document.getElementById('ordersList');

        // Logo elements
        const logoImage = document.getElementById('logoImage');
        const logoIcon = document.getElementById('logoIcon');

        // Admin Elements
        const adminPanel = document.getElementById('adminPanel');
        const adminClose = document.getElementById('adminClose');
        const adminCodePrompt = document.getElementById('adminCodePrompt');
        const adminCodeInput = document.getElementById('adminCodeInput');
        const submitAdminCodeBtn = document.getElementById('submitAdminCodeBtn');
        const cancelAdminCodeBtn = document.getElementById('cancelAdminCodeBtn');
        const adminChangePrompt = document.getElementById('adminChangePrompt');
        const adminChangeCodeInput = document.getElementById('adminChangeCodeInput');
        const submitChangeCodeBtn = document.getElementById('submitChangeCodeBtn');
        const cancelChangeBtn = document.getElementById('cancelChangeBtn');

        // NEW: Subcategory modal elements
        const subcategoryModal = document.getElementById('subcategoryModal');
        const subcategoryModalClose = document.getElementById('subcategoryModalClose');
        const subcategoryModalTitle = document.getElementById('subcategoryModalTitle');
        const subcategoryModalDescription = document.getElementById('subcategoryModalDescription');
        const subcategoryOptionsContainer = document.getElementById('subcategoryOptionsContainer');
        const subcategoryBasePrice = document.getElementById('subcategoryBasePrice');
        const subcategoryAdditionalPrice = document.getElementById('subcategoryAdditionalPrice');
        const subcategoryTotalPrice = document.getElementById('subcategoryTotalPrice');
        const cancelSubcategoryBtn = document.getElementById('cancelSubcategoryBtn');
        const addToCartWithOptionsBtn = document.getElementById('addToCartWithOptionsBtn');

        // NEW: Refresh buttons for admin order management
        const refreshAdminOrdersBtn = document.getElementById('refreshAdminOrdersBtn');
        const refreshAdminOrdersBtnModal = document.getElementById('refreshAdminOrdersBtnModal');

        // NEW: Real-time order notification elements
        const orderNotification = document.getElementById('orderNotification');
        const orderNotificationText = document.getElementById('orderNotificationText');

        // Sound Elements
        const addToCartSound = document.getElementById('addToCartSound');
        const paymentConfirmSound = document.getElementById('paymentConfirmSound');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function () {
            // Load data from localStorage
            loadFromLocalStorage();
            ensureSortOrders();
            subscribeToOrders();
            subscribeToRestaurantData();

            // Update restaurant info in UI
            updateRestaurantUI();

            // Apply saved customization
            applyCustomization();

            // Set up table selection buttons
            document.querySelectorAll('.table-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const tableName = this.getAttribute('data-table');
                    selectTable(tableName);
                });
            });
            

            // Set up category tabs
            updateCategoryTabs();

            // Set up floating cart button
            cartFloating.addEventListener('click', function () {
                if (state.isAdminMode) return;
                showSection('cartSection');
            });

            // Set up navigation buttons
            document.getElementById('backToMenuBtn').addEventListener('click', function () {
                showSection('menuSection');
            });

            document.getElementById('proceedToPaymentBtn').addEventListener('click', function () {
                if (state.cart.length === 0) {
                    showNotification('Please add items to your cart before proceeding to payment');
                    return;
                }
                updatePaymentSummary();
                showSection('paymentSection');
            });

            document.getElementById('backToCartBtn').addEventListener('click', function () {
                showSection('cartSection');
            });

            // Set up payment options
            document.querySelectorAll('.option-card[data-payment]').forEach(card => {
                card.addEventListener('click', function () {
                    document.querySelectorAll('.option-card[data-payment]').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.selectedPaymentMethod = this.getAttribute('data-payment');
                });
            });

            document.querySelectorAll('.option-card[data-time]').forEach(card => {
                card.addEventListener('click', function () {
                    document.querySelectorAll('.option-card[data-time]').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.selectedPaymentTime = this.getAttribute('data-time');
                });
            });

            // Set up confirm payment button
            document.getElementById('confirmPaymentBtn').addEventListener('click', function () {
                if (!state.selectedPaymentMethod) {
                    showNotification('Please select a payment method');
                    return;
                }

                if (!state.selectedPaymentTime) {
                    showNotification('Please select when you want to pay');
                    return;
                }

                // Play payment confirmation sound
                playPaymentConfirmSound();

                // Generate order number
                const orderNumber = generateOrderNumber();
                state.currentOrderNumber = orderNumber;

                // Calculate order total
                const orderTotal = calculateTotal();
                const orderSubtotal = calculateSubtotal();

                // Create order object
                const order = {
                    orderNumber: orderNumber,
                    table: state.currentTable,
                    items: [...state.cart],
                    paymentMethod: state.selectedPaymentMethod,
                    paymentTime: state.selectedPaymentTime,
                    subtotal: orderSubtotal,
                    total: orderTotal,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    customerNotes: ""
                };

                // Save order
                state.orders.push(order);
                updateOrderStats();
                saveToLocalStorage();
                saveOrderToFirestore(order);

                // NEW: Trigger real-time update for admin panel
                if (state.isAdminMode) {
                    // If in admin mode, update the order list immediately
                    loadOrdersForAdmin();
                    loadSystemStats();
                } else {
                    // Notify admin panel about new order (for cross-tab updates)
                    notifyNewOrder(order);
                }

                // Show confirmation
                showOrderConfirmation(order);
                showSection('confirmationSection');

                showNotification(`Order #${orderNumber} confirmed and sent to kitchen!`);

                // Automatically reset the cart for the next order
                resetCart();
            });

            // Set up order confirmation buttons
            document.getElementById('newOrderBtn').addEventListener('click', function () {
                // Completely reset everything
                resetOrder();
                showSection('scannerSection');
            });

            document.getElementById('viewMyOrdersBtn').addEventListener('click', function () {
                loadMyOrders();
                showSection('myOrdersSection');
            });

            document.getElementById('viewMenuBtn').addEventListener('click', function () {
                // Reset cart and payment selections but keep the table
                resetCart();
                state.selectedPaymentMethod = null;
                state.selectedPaymentTime = null;
                document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));

                // Update menu subtitle to indicate new order
                if (state.currentTable) {
                    menuSubtitle.textContent = `Start a new order for ${state.currentTable}`;
                }

                showSection('menuSection');
                showNotification('Ready to start a new order! Add items to your cart.');
            });

            document.getElementById('needHelpBtn').addEventListener('click', function () {
                showHelpNotification();
            });

            // Set up header help button
            headerHelpButton.addEventListener('click', function () {
                showHelpNotification();
            });

            // My Orders button
            myOrdersButton.addEventListener('click', function () {
                loadMyOrders();
                showSection('myOrdersSection');
            });

            // My Orders section navigation
            document.getElementById('backToMenuFromOrdersBtn').addEventListener('click', function () {
                showSection('menuSection');
            });

            document.getElementById('placeNewOrderBtn').addEventListener('click', function () {
                resetCart();
                showSection('menuSection');
            });

            // Set up refresh orders button
            document.getElementById('refreshOrdersBtn').addEventListener('click', function () {
                refreshMyOrders();
            });

            // Display initial menu
            displayMenuItems('all');

            // Check URL for table parameter
            checkURLForTable();

            // Admin functionality
            setupAdminPanel();

            // NEW: Set up admin order refresh buttons
            if (refreshAdminOrdersBtn) {
                refreshAdminOrdersBtn.addEventListener('click', function () {
                    refreshAdminOrders();
                });
            }

            if (refreshAdminOrdersBtnModal) {
                refreshAdminOrdersBtnModal.addEventListener('click', function () {
                    refreshAdminOrdersModal();
                });
            }

            // Admin code prompt setup
            submitAdminCodeBtn.addEventListener('click', function () {
                const enteredCode = adminCodeInput.value;
                if (enteredCode === state.adminAccessCode) {
                    adminCodePrompt.style.display = 'none';
                    adminCodeInput.value = '';
                    enterAdminMode();
                } else {
                    showNotification("Incorrect admin code. Please try again.");
                    adminCodeInput.value = '';
                    adminCodeInput.focus();
                }
            });

            cancelAdminCodeBtn.addEventListener('click', function () {
                adminCodePrompt.style.display = 'none';
                adminCodeInput.value = '';
                showSection('scannerSection');
            });

            // Admin change confirmation setup
            submitChangeCodeBtn.addEventListener('click', function () {
                const enteredCode = adminChangeCodeInput.value;
                if (enteredCode === state.adminChangeCode) {
                    adminChangePrompt.style.display = 'none';
                    adminChangeCodeInput.value = '';

                    // Execute the pending admin action
                    if (state.pendingAdminAction && typeof state.pendingAdminAction === 'function') {
                        state.pendingAdminAction();
                    }
                    state.pendingAdminAction = null;
                } else {
                    showNotification("Incorrect confirmation code. Changes not saved.");
                    adminChangeCodeInput.value = '';
                    adminChangeCodeInput.focus();
                }
            });

            cancelChangeBtn.addEventListener('click', function () {
                adminChangePrompt.style.display = 'none';
                adminChangeCodeInput.value = '';
                state.pendingAdminAction = null;
                showNotification("Changes cancelled.");
            });
            // NEW: Subcategory modal setup
            subcategoryModalClose.addEventListener('click', function () {
                subcategoryModal.style.display = 'none';
                state.currentSubcategorySelections = null;
                state.currentMenuItemForSubcategories = null;
            });

            cancelSubcategoryBtn.addEventListener('click', function () {
                subcategoryModal.style.display = 'none';
                state.currentSubcategorySelections = null;
                state.currentMenuItemForSubcategories = null;
            });

            addToCartWithOptionsBtn.addEventListener('click', function () {
                addItemWithSubcategoryOptions();
            });   


            // Check if we should be in admin mode from previous session
            if (localStorage.getItem('dineEasyAdminMode') === 'true') {
                // Still require code verification on reload
                showAdminCodePrompt();
            }

            // NEW: Set up real-time order checking
            setupRealTimeOrderUpdates();
        });

        

        // NEW FUNCTION: Setup real-time order updates
        function setupRealTimeOrderUpdates() {
            // Check for new orders every 2 seconds
            setInterval(checkForNewOrders, 2000);

            // Also listen for storage events (for cross-tab updates)
            window.addEventListener('storage', function (e) {
                if (e.key === 'dineEasyOrders') {
                    // Orders were updated in another tab
                    checkForNewOrders();
                }
            });
        }
        // NEW: Subcategory modal setup
            subcategoryModalClose.addEventListener('click', function () {
                subcategoryModal.style.display = 'none';
                state.currentSubcategorySelections = null;
                state.currentMenuItemForSubcategories = null;
            });

            cancelSubcategoryBtn.addEventListener('click', function () {
                subcategoryModal.style.display = 'none';
                state.currentSubcategorySelections = null;
                state.currentMenuItemForSubcategories = null;
            });

            addToCartWithOptionsBtn.addEventListener('click', function () {
                addItemWithSubcategoryOptions();
            });

            // Check if we should be in admin mode from previous session
            if (localStorage.getItem('dineEasyAdminMode') === 'true') {
                // Still require code verification on reload
                showAdminCodePrompt();
            }

            // NEW: Set up real-time order checking
            setupRealTimeOrderUpdates();
        
    
        // NEW FUNCTION: Add item with subcategory options to cart
        function addItemWithSubcategoryOptions() {
            if (!state.currentMenuItemForSubcategories || !state.currentSubcategorySelections) return;

            const menuItem = state.currentMenuItemForSubcategories;
            const selections = state.currentSubcategorySelections;

            // Calculate additional price from selected options
            let additionalPrice = 0;
            Object.keys(selections).forEach(subcategoryId => {
                const optionId = selections[subcategoryId];
                const subcategory = menuItem.subcategories.find(sc => sc.id === subcategoryId);
                if (subcategory) {
                    const option = subcategory.options.find(opt => opt.id === optionId);
                    if (option && option.additionalPrice) {
                        additionalPrice += option.additionalPrice;
                    }
                }
            });

            // Get selected option names for display
            const selectedOptions = [];
            Object.keys(selections).forEach(subcategoryId => {
                const optionId = selections[subcategoryId];
                const subcategory = menuItem.subcategories.find(sc => sc.id === subcategoryId);
                if (subcategory) {
                    const option = subcategory.options.find(opt => opt.id === optionId);
                    if (option) {
                        selectedOptions.push({
                            subcategoryName: subcategory.name,
                            optionName: option.name,
                            additionalPrice: option.additionalPrice || 0
                        });
                    }
                }
            });

            // Check if item already exists in cart
            const existingItem = state.cart.find(item => 
                item.id === menuItem.id && 
                JSON.stringify(item.selectedOptions) === JSON.stringify(selectedOptions)
            );

            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.totalPrice = (menuItem.price + additionalPrice) * existingItem.quantity;
            } else {
                state.cart.push({
                    id: menuItem.id,
                    name: menuItem.name,
                    price: menuItem.price,
                    quantity: 1,
                    selectedOptions: selectedOptions,
                    additionalPrice: additionalPrice,
                    totalPrice: menuItem.price + additionalPrice
                });
            }

            updateCart();
            
            const totalPrice = menuItem.price + additionalPrice;
            showNotification(`${menuItem.name} with options added to cart for $${totalPrice.toFixed(2)}`);

            // Play add to cart sound
            playAddToCartSound();

            // Close modal and reset state
            subcategoryModal.style.display = 'none';
            state.currentSubcategorySelections = null;
            state.currentMenuItemForSubcategories = null;
        }

        // NEW FUNCTION: Show subcategory options modal
        function showSubcategoryOptions(itemId) {
            const menuItem = state.menuItems.find(item => item.id === itemId);
            if (!menuItem) return;

            // Store the current menu item
            state.currentMenuItemForSubcategories = menuItem;
            state.currentSubcategorySelections = {};

            // Reset selections
            if (menuItem.subcategories && menuItem.subcategories.length > 0) {
                menuItem.subcategories.forEach(subcategory => {
                    // Select the first option by default
                    if (subcategory.options && subcategory.options.length > 0) {
                        state.currentSubcategorySelections[subcategory.id] = subcategory.options[0].id;
                    }
                });
            }

            // Update modal title and description
            subcategoryModalTitle.textContent = menuItem.name;
            subcategoryModalDescription.textContent = menuItem.description;

            // Update base price
            subcategoryBasePrice.textContent = `$${menuItem.price.toFixed(2)}`;

            // Clear options container
            subcategoryOptionsContainer.innerHTML = '';

            // Check if item has subcategories
            if (!menuItem.subcategories || menuItem.subcategories.length === 0) {
                subcategoryOptionsContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-info-circle" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>This item has no customization options.</p>
                    </div>
                `;
                // Update price summary
                updateSubcategoryPriceSummary();
                return;
            }

            // Add subcategory options
            menuItem.subcategories.forEach(subcategory => {
                const optionGroup = document.createElement('div');
                optionGroup.className = 'subcategory-option-group';

                const optionTitle = document.createElement('div');
                optionTitle.className = 'subcategory-option-title';
                optionTitle.textContent = subcategory.name;
                optionGroup.appendChild(optionTitle);

                const optionList = document.createElement('div');
                optionList.className = 'subcategory-option-list';

                subcategory.options.forEach(option => {
                    const optionItem = document.createElement('div');
                    optionItem.className = `subcategory-option-item ${state.currentSubcategorySelections[subcategory.id] === option.id ? 'selected' : ''}`;
                    optionItem.setAttribute('data-subcategory-id', subcategory.id);
                    optionItem.setAttribute('data-option-id', option.id);

                    const optionName = document.createElement('div');
                    optionName.className = 'subcategory-option-name';
                    optionName.textContent = option.name;

                    const optionPrice = document.createElement('div');
                    optionPrice.className = 'subcategory-option-price';
                    if (option.additionalPrice && option.additionalPrice > 0) {
                        optionPrice.textContent = `+$${option.additionalPrice.toFixed(2)}`;
                    } else if (option.additionalPrice && option.additionalPrice < 0) {
                        optionPrice.textContent = `-$${Math.abs(option.additionalPrice).toFixed(2)}`;
                        optionPrice.style.color = 'var(--success)';
                    } else {
                        optionPrice.textContent = 'No charge';
                        optionPrice.style.color = 'var(--gray)';
                    }

                    optionItem.appendChild(optionName);
                    optionItem.appendChild(optionPrice);

                    optionItem.addEventListener('click', function () {
                        const subcategoryId = this.getAttribute('data-subcategory-id');
                        const optionId = this.getAttribute('data-option-id');

                        // Update selection
                        state.currentSubcategorySelections[subcategoryId] = optionId;

                        // Update UI
                        document.querySelectorAll(`[data-subcategory-id="${subcategoryId}"]`).forEach(item => {
                            item.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Update price summary
                        updateSubcategoryPriceSummary();
                    });

                    optionList.appendChild(optionItem);
                });

                optionGroup.appendChild(optionList);
                subcategoryOptionsContainer.appendChild(optionGroup);
            });

            // Update price summary
            updateSubcategoryPriceSummary();

            // Show modal
            subcategoryModal.style.display = 'flex';
        }

        // NEW FUNCTION: Update subcategory price summary
        function updateSubcategoryPriceSummary() {
            if (!state.currentMenuItemForSubcategories || !state.currentSubcategorySelections) return;

            const menuItem = state.currentMenuItemForSubcategories;
            let additionalPrice = 0;

            // Calculate total additional price
            Object.keys(state.currentSubcategorySelections).forEach(subcategoryId => {
                const optionId = state.currentSubcategorySelections[subcategoryId];
                const subcategory = menuItem.subcategories.find(sc => sc.id === subcategoryId);
                if (subcategory) {
                    const option = subcategory.options.find(opt => opt.id === optionId);
                    if (option && option.additionalPrice) {
                        additionalPrice += option.additionalPrice;
                    }
                }
            });

            // Update UI
            subcategoryAdditionalPrice.textContent = additionalPrice > 0 ? `+$${additionalPrice.toFixed(2)}` : '$0.00';
            
            const totalPrice = menuItem.price + additionalPrice;
            subcategoryTotalPrice.textContent = `$${totalPrice.toFixed(2)}`;
        }

        // NEW FUNCTION: Check for new orders
        function checkForNewOrders() {
            if (!state.isAdminMode || !adminDashboardSection.classList.contains('active-section')) {
                return;
            }

            // Get the current order count
            const currentOrderCount = state.orders.length;

            // Check if there are new orders since last check
            if (currentOrderCount > state.lastOrderUpdate) {
                const newOrdersCount = currentOrderCount - state.lastOrderUpdate;
                const newOrders = state.orders.slice(-newOrdersCount);

                // Show notification for each new order
                newOrders.forEach(order => {
                    if (order.status === 'pending') {
                        showOrderNotification(`New order #${order.orderNumber} from ${order.table}`);

                        // Update the admin order list
                        loadOrdersForAdmin();
                        loadSystemStats();
                    }
                });

                // Update last order count
                state.lastOrderUpdate = currentOrderCount;
            }
        }

        // NEW FUNCTION: Show order notification
        function showOrderNotification(message) {
            orderNotificationText.textContent = message;
            orderNotification.classList.add('show');

            setTimeout(() => {
                orderNotification.classList.remove('show');
            }, 5000);
        }

        // NEW FUNCTION: Notify about new order (for cross-tab communication)
        function notifyNewOrder(order) {
            // Store a flag in localStorage to notify other tabs
            localStorage.setItem('dineEasyNewOrder', JSON.stringify({
                orderNumber: order.orderNumber,
                table: order.table,
                timestamp: Date.now()
            }));

            // Clear the flag after a short delay
            setTimeout(() => {
                localStorage.removeItem('dineEasyNewOrder');
            }, 100);
        }

        // NEW FUNCTION: Refresh My Orders
        function refreshMyOrders() {
            // Add animation to refresh button
            const refreshBtn = document.getElementById('refreshOrdersBtn');
            const icon = refreshBtn.querySelector('i');
            icon.classList.add('fa-spin');

            // Simulate loading
            setTimeout(() => {
                // Reload orders from localStorage to get latest updates
                loadFromLocalStorage();

                // Reload the orders display
                loadMyOrders();

                // Remove animation
                icon.classList.remove('fa-spin');

                // Show notification
                showNotification("Orders refreshed successfully!");
            }, 500);
        }

        // NEW FUNCTION: Refresh Admin Orders
        function refreshAdminOrders() {
            // Add animation to refresh button
            const refreshBtn = document.getElementById('refreshAdminOrdersBtn');
            const icon = refreshBtn.querySelector('i');
            icon.classList.add('fa-spin');

            // Simulate loading
            setTimeout(() => {
                // Reload orders from localStorage to get latest updates
                loadFromLocalStorage();

                // Reload the admin orders display
                loadOrdersForAdmin();

                // Remove animation
                icon.classList.remove('fa-spin');

                // Show notification
                showNotification("Admin orders refreshed successfully!");
            }, 500);
        }

        // NEW FUNCTION: Refresh Admin Orders Modal
        function refreshAdminOrdersModal() {
            // Add animation to refresh button
            const refreshBtn = document.getElementById('refreshAdminOrdersBtnModal');
            const icon = refreshBtn.querySelector('i');
            icon.classList.add('fa-spin');

            // Simulate loading
            setTimeout(() => {
                // Reload orders from localStorage to get latest updates
                loadFromLocalStorage();

                // Reload the admin orders display for modal
                loadOrdersForAdminModal();

                // Remove animation
                icon.classList.remove('fa-spin');

                // Show notification
                showNotification("Admin orders refreshed successfully!");
            }, 500);
        }

        // Function to update order statistics
        function updateOrderStats() {
            const stats = {
                totalOrders: state.orders.length,
                totalRevenue: 0,
                avgOrderValue: 0,
                pendingOrders: 0,
                preparingOrders: 0,
                readyOrders: 0,
                servedOrders: 0,
                cancelledOrders: 0,
                removedOrders: 0
            };

            state.orders.forEach(order => {
                if (order.status === 'removed') {
                    stats.removedOrders++;
                    // Skip removed orders from revenue calculation
                    return;
                }

                stats.totalRevenue += order.total;

                switch (order.status) {
                    case 'pending': stats.pendingOrders++; break;
                    case 'preparing': stats.preparingOrders++; break;
                    case 'ready': stats.readyOrders++; break;
                    case 'served': stats.servedOrders++; break;
                    case 'cancelled': stats.cancelledOrders++; break;
                }
            });

            // Calculate average order value (excluding removed orders)
            const activeOrders = state.orders.filter(o => o.status !== 'removed').length;
            stats.avgOrderValue = activeOrders > 0 ? stats.totalRevenue / activeOrders : 0;

            state.orderStats = stats;
        }

        // Function to play add to cart sound
        function playAddToCartSound() {
            try {
                addToCartSound.currentTime = 0; // Reset to start
                addToCartSound.play().catch(e => {
                    console.log("Could not play add to cart sound:", e);
                    // Some browsers block autoplay, so we'll fail silently
                });
            } catch (error) {
                console.log("Error playing add to cart sound:", error);
            }
        }

        // Function to play payment confirmation sound
        function playPaymentConfirmSound() {
            try {
                paymentConfirmSound.currentTime = 0; // Reset to start
                paymentConfirmSound.play().catch(e => {
                    console.log("Could not play payment confirmation sound:", e);
                    // Some browsers block autoplay, so we'll fail silently
                });
            } catch (error) {
                console.log("Error playing payment confirmation sound:", error);
            }
        }

        // Function to show admin code prompt
        function showAdminCodePrompt() {
            adminCodePrompt.style.display = 'flex';
            adminCodeInput.focus();
        }

        // Function to show admin change confirmation prompt
        function showAdminChangePrompt(actionCallback) {
            state.pendingAdminAction = actionCallback;
            adminChangePrompt.style.display = 'flex';
            adminChangeCodeInput.focus();
        }

        // Function to load data from localStorage
        function loadFromLocalStorage() {
            const savedRestaurantInfo = localStorage.getItem('dineEasyRestaurantInfo');
            const savedMenuItems = localStorage.getItem('dineEasyMenuItems');
            const savedOrders = localStorage.getItem('dineEasyOrders');
            const savedCategories = localStorage.getItem('dineEasyCategories');
            const savedCustomization = localStorage.getItem('dineEasyCustomization');
            const savedOrderStats = localStorage.getItem('dineEasyOrderStats');

            if (savedRestaurantInfo) {
                state.restaurantInfo = JSON.parse(savedRestaurantInfo);
            }

            if (savedMenuItems) {
                state.menuItems = JSON.parse(savedMenuItems);
                // Ensure all menu items have subcategories array if not present
                state.menuItems.forEach(item => {
                    if (!item.subcategories) {
                        item.subcategories = [];
                    }
                    // Ensure all subcategories have proper structure
                    if (item.subcategories) {
                        item.subcategories.forEach(subcategory => {
                            if (!subcategory.id) subcategory.id = `subcategory-${Date.now()}`;
                            if (!subcategory.options) subcategory.options = [];
                            subcategory.options.forEach(option => {
                                if (!option.id) option.id = `option-${Date.now()}`;
                            });
                        });
                    }
                });
            }

            if (savedOrders) {
                state.orders = JSON.parse(savedOrders);
                state.lastOrderUpdate = state.orders.length;
            }

            if (savedCategories) {
                state.categories = JSON.parse(savedCategories);
            }

            if (savedCustomization) {
                state.customization = JSON.parse(savedCustomization);

                // Determine current theme and font
                determineCurrentTheme();
                determineCurrentFont();
            }

            if (savedOrderStats) {
                state.orderStats = JSON.parse(savedOrderStats);
            } else {
                updateOrderStats();
            }
            ensureSortOrders();
        }

        // Function to determine current theme based on saved colors
        function determineCurrentTheme() {
            // Check which theme matches the current colors
            for (const [themeId, theme] of Object.entries(themes)) {
                if (state.customization.primary === theme.primary &&
                    state.customization.secondary === theme.secondary &&
                    state.customization.background === theme.background) {
                    state.currentTheme = themeId;
                    return;
                }
            }
            state.currentTheme = "custom";
        }

        // Function to determine current font based on saved font
        function determineCurrentFont() {
            for (const [fontId, font] of Object.entries(fonts)) {
                if (state.customization.fontPrimary === font.primary) {
                    state.currentFont = fontId;
                    return;
                }
            }
            state.currentFont = "poppins";
        }

        // Function to save data to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('dineEasyRestaurantInfo', JSON.stringify(state.restaurantInfo));
            localStorage.setItem('dineEasyMenuItems', JSON.stringify(state.menuItems));
            localStorage.setItem('dineEasyOrders', JSON.stringify(state.orders));
            localStorage.setItem('dineEasyCategories', JSON.stringify(state.categories));
            localStorage.setItem('dineEasyCustomization', JSON.stringify(state.customization));
            localStorage.setItem('dineEasyOrderStats', JSON.stringify(state.orderStats));
        }

        // Function to apply customization to the UI
        function applyCustomization() {
            const root = document.documentElement;

            // Apply all CSS custom properties
            Object.keys(state.customization).forEach(key => {
                if (key === 'fontPrimary' || key === 'fontSecondary') {
                    // Fonts need special handling
                    root.style.setProperty(`--${key}`, state.customization[key]);
                } else {
                    root.style.setProperty(`--${key}`, state.customization[key]);
                }
            });

            // Update preview restaurant name
            const previewName = document.getElementById('previewRestaurantName');
            if (previewName) {
                previewName.style.color = state.customization.primary;
                previewName.style.fontFamily = state.customization.fontSecondary;
            }
        }

        // Function to enter admin mode
        function enterAdminMode() {
            state.isAdminMode = true;
            state.currentTable = "Admin";

            // Update header
            document.body.classList.add('admin-mode');

            // Update header elements
            const headerCenter = document.querySelector('.header-center');
            headerCenter.innerHTML = `
                <div class="admin-badge">
                    <i class="fas fa-shield-alt"></i>
                    Administrator Mode
                </div>
            `;

            const headerRight = document.querySelector('.header-right');
            headerRight.innerHTML = `
                <button class="logout-button" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            `;

            // Add logout button event listener
            document.getElementById('logoutButton').addEventListener('click', function () {
                exitAdminMode();
            });

            // Hide customer UI elements
            cartFloating.style.display = 'none';

            // Show admin dashboard
            showSection('adminDashboardSection');

            // Load admin data
            loadAdminDashboardData();

            // Save admin mode state
            localStorage.setItem('dineEasyAdminMode', 'true');

            showNotification("Admin mode activated. Full administrative access granted.");
        }

        // Function to exit admin mode
        function exitAdminMode() {
            state.isAdminMode = false;
            state.currentTable = null;

            // Remove admin mode classes
            document.body.classList.remove('admin-mode');

            // Restore original header
            const headerCenter = document.querySelector('.header-center');
            headerCenter.innerHTML = `
                <button class="help-button" id="headerHelpButton">
                    <i class="fas fa-headset"></i>
                    Need Help?
                </button>
            `;

            const headerRight = document.querySelector('.header-right');
            headerRight.innerHTML = `
                <button class="my-orders-button" id="myOrdersButton" style="display: none;">
                    <i class="fas fa-clipboard-list"></i>
                    My Orders
                </button>
                <div class="table-info" id="tableInfo">
                    <i class="fas fa-qrcode"></i>
                    Scan QR to begin
                </div>
            `;

            // Restore event listeners
            document.getElementById('headerHelpButton').addEventListener('click', function () {
                showHelpNotification();
            });

            // Show customer UI elements
            cartFloating.style.display = 'flex';

            // Show scanner section
            showSection('scannerSection');

            // Remove admin mode state
            localStorage.removeItem('dineEasyAdminMode');

            showNotification("Logged out of admin mode.");
        }

        // Function to load admin dashboard data
        function loadAdminDashboardData() {
            // Load restaurant settings into admin dashboard
            document.getElementById('adminRestaurantName').value = state.restaurantInfo.name;
            document.getElementById('adminTaxRate').value = state.restaurantInfo.taxRate;
            document.getElementById('adminPrepTime').value = state.restaurantInfo.estimatedPrepTime;
            document.getElementById('adminWelcomeMessage').value = state.restaurantInfo.welcomeMessage || '';

            // Load logo preview
            updateLogoPreview();

            // Load menu items for admin
            loadMenuItemsForAdmin();

            // Load categories for admin
            loadCategoriesForAdmin();

            // Load orders for admin
            loadOrdersForAdmin();

            // Load system stats
            loadSystemStats();

            // Load customization settings
            loadCustomizationSettings();

            // Set up admin dashboard tabs
            document.querySelectorAll('#adminDashboardSection .admin-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    // Update active tab
                    document.querySelectorAll('#adminDashboardSection .admin-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Show corresponding content
                    document.querySelectorAll('#adminDashboardSection .admin-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId + 'Tab').classList.add('active');

                    // If customization tab is selected, initialize it
                    if (tabId === 'customization') {
                        setTimeout(() => {
                            initializeCustomizationTab();
                        }, 100);
                    }
                });
            });

            // Set up image upload for logo
            document.getElementById('uploadLogoBtn').addEventListener('click', function () {
                document.getElementById('logoUpload').click();
            });

            document.getElementById('logoUpload').addEventListener('change', function (e) {
                handleLogoUpload(e);
            });

            document.getElementById('removeLogoBtn').addEventListener('click', function () {
                removeLogo();
            });

            // Set up admin dashboard buttons
            document.getElementById('saveRestaurantSettings').addEventListener('click', function () {
                showAdminChangePrompt(saveRestaurantSettings);
            });

            document.getElementById('addMenuItemBtn').addEventListener('click', function () {
                openEditMenuItemForm(null);
            });

            document.getElementById('addCategoryBtn').addEventListener('click', function () {
                showAdminChangePrompt(addNewCategory);
            });

            document.getElementById('orderStatusFilter').addEventListener('change', function () {
                loadOrdersForAdmin();
            });

            document.getElementById('clearOrdersBtn').addEventListener('click', function () {
                showAdminChangePrompt(function () {
                    if (confirm("Are you sure you want to clear ALL orders? This cannot be undone.")) {
                        state.orders = [];
                        updateOrderStats();
                        saveToLocalStorage();
                        
                        // Clear orders from Firebase
                        db.collection("orders").get().then((snapshot) => {
                            const batch = db.batch();
                            snapshot.forEach((doc) => {
                                batch.delete(doc.ref);
                            });
                            return batch.commit();
                        }).then(() => {
                            console.log("All orders deleted from Firebase");
                            showNotification("All orders have been cleared from database.");
                        }).catch((error) => {
                            console.error("Error clearing orders from Firebase: ", error);
                            showNotification("Orders cleared locally, but there was an error with Firebase.");
                        });
                        
                        loadOrdersForAdmin();
                        loadMyOrders();
                    }
                });
            });

            document.getElementById('resetMenuBtn').addEventListener('click', function () {
                showAdminChangePrompt(function () {
                    if (confirm("Reset menu to default items? This will replace all current menu items.")) {
                        state.menuItems = [...defaultMenuItems];
                        saveToLocalStorage();
                        loadMenuItemsForAdmin();
                        displayMenuItems('all');
                        showNotification("Menu has been reset to default.");
                    }
                });
            });

            document.getElementById('exportDataBtn').addEventListener('click', function () {
                exportData();
            });

            document.getElementById('importDataBtn').addEventListener('click', function () {
                document.getElementById('importDataInput').click();
            });

            document.getElementById('importDataInput').addEventListener('change', function (e) {
                showAdminChangePrompt(function () {
                    importData(e);
                });
            });

            // Update order status without requiring admin change code
            adminDashboardSection.addEventListener('click', function (e) {
                // Check if update button was clicked
                if (e.target && (e.target.classList.contains('update-status') || e.target.closest('.update-status'))) {
                    const updateBtn = e.target.classList.contains('update-status') ? e.target : e.target.closest('.update-status');
                    const orderId = updateBtn.getAttribute('data-order-id');
                    const select = document.querySelector(`select[data-order-id="${orderId}"]`);

                    if (select && orderId) {
                        // Directly update order status without admin change code
                        updateOrderStatus(orderId, select.value);
                    }
                }

                // Check if remove order button was clicked
                if (e.target && (e.target.classList.contains('remove-order') || e.target.closest('.remove-order'))) {
                    const removeBtn = e.target.classList.contains('remove-order') ? e.target : e.target.closest('.remove-order');
                    const orderId = removeBtn.getAttribute('data-order-id');

                    if (orderId && confirm("Are you sure you want to remove this order from the management list? The statistics will be preserved.")) {
                        showAdminChangePrompt(function () {
                            removeOrderFromManagement(orderId);
                        });
                    }
                }
            });
        }

        // Function to initialize the updated customization tab with 20 themes
        function initializeCustomizationTab() {
            // Create theme gallery with 20 themes
            const themeGallery = document.getElementById('themeGallery');
            themeGallery.innerHTML = '';

            Object.entries(themes).forEach(([themeId, theme]) => {
                const themeElement = document.createElement('div');
                themeElement.className = `theme-card ${themeId === state.currentTheme ? 'selected' : ''}`;
                themeElement.setAttribute('data-theme', themeId);

                // Create color swatches for the theme (5 colors)
                themeElement.innerHTML = `
                    <div class="theme-colors-preview">
                        <div style="background-color: ${theme.primary};"></div>
                        <div style="background-color: ${theme.secondary};"></div>
                        <div style="background-color: ${theme.background};"></div>
                        <div style="background-color: ${theme.text};"></div>
                        <div style="background-color: ${theme.cardBg};"></div>
                    </div>
                    <div class="theme-info">
                        <div class="theme-name">${theme.name}</div>
                        <span class="theme-category">${theme.category}</span>
                        <div class="theme-preview-small">
                            <div style="background-color: ${theme.primary};"></div>
                            <div style="background-color: ${theme.secondary};"></div>
                            <div style="background-color: ${theme.lightGray};"></div>
                        </div>
                    </div>
                `;

                themeElement.addEventListener('click', function () {
                    // Update selected state
                    document.querySelectorAll('#themeGallery .theme-card').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');

                    // Update current theme name display
                    document.getElementById('currentThemeName').textContent = theme.name;
                    document.getElementById('currentThemeCategory').textContent = theme.category;
                });

                themeGallery.appendChild(themeElement);
            });

            // Apply theme button now requires admin change code
            document.getElementById('applyThemeBtn').addEventListener('click', function () {
                const selectedTheme = document.querySelector('#themeGallery .theme-card.selected');
                if (selectedTheme) {
                    const themeId = selectedTheme.getAttribute('data-theme');
                    showAdminChangePrompt(function () {
                        applyTheme(themeId);
                    });
                }
            });

            // Create font options
            const fontOptions = document.getElementById('fontOptions');
            fontOptions.innerHTML = '';

            Object.entries(fonts).forEach(([fontId, font]) => {
                const fontElement = document.createElement('div');
                fontElement.className = `font-option ${fontId === state.currentFont ? 'selected' : ''}`;
                fontElement.setAttribute('data-font', fontId);
                fontElement.setAttribute('data-primary', font.primary);
                fontElement.setAttribute('data-secondary', font.secondary);

                fontElement.innerHTML = `
                    <div class="font-preview-large" style="font-family: ${font.primary.replace(/'/g, '')};">${font.name}</div>
                    <div class="font-details">
                        <div style="font-family: ${font.primary.replace(/'/g, '')}; margin-bottom: 5px;">The quick brown fox</div>
                        <div style="font-family: ${font.secondary.replace(/'/g, '')}; font-style: italic;">Elegant restaurant menu</div>
                    </div>
                `;

                fontElement.addEventListener('click', function () {
                    // Update selected state
                    document.querySelectorAll('#fontOptions .font-option').forEach(f => f.classList.remove('selected'));
                    this.classList.add('selected');

                    // Update current font name display
                    document.getElementById('currentFontName').textContent = font.name;
                });

                fontOptions.appendChild(fontElement);
            });

            // Apply font button now requires admin change code
            document.getElementById('applyFontBtn').addEventListener('click', function () {
                const selectedFont = document.querySelector('#fontOptions .font-option.selected');
                if (selectedFont) {
                    const fontId = selectedFont.getAttribute('data-font');
                    const fontPrimary = selectedFont.getAttribute('data-primary');
                    const fontSecondary = selectedFont.getAttribute('data-secondary');

                    showAdminChangePrompt(function () {
                        applyFont(fontId, fontPrimary, fontSecondary);
                    });
                }
            });

            // Create color customization options
            const colorCustomization = document.getElementById('colorCustomization');
            colorCustomization.innerHTML = '';

            importantColors.forEach(colorInfo => {
                const colorElement = document.createElement('div');
                colorElement.className = 'color-option';

                colorElement.innerHTML = `
                    <div class="color-label">${colorInfo.label}</div>
                    <div class="color-preview" style="background-color: ${state.customization[colorInfo.id]};"></div>
                    <div class="color-input-group">
                        <input type="color" class="color-input" id="color-${colorInfo.id}" value="${state.customization[colorInfo.id]}">
                        <div class="color-value">${state.customization[colorInfo.id]}</div>
                    </div>
                `;

                const colorInput = colorElement.querySelector('.color-input');
                const colorValue = colorElement.querySelector('.color-value');
                const colorPreview = colorElement.querySelector('.color-preview');

                colorInput.addEventListener('input', function () {
                    const value = this.value;
                    colorValue.textContent = value;
                    colorPreview.style.backgroundColor = value;

                    // Update the color in state for preview
                    state.customization[colorInfo.id] = value;

                    // Update theme to custom
                    state.currentTheme = "custom";
                    document.querySelectorAll('#themeGallery .theme-card').forEach(t => t.classList.remove('selected'));
                    document.getElementById('currentThemeName').textContent = "Custom";
                    document.getElementById('currentThemeCategory').textContent = "Custom";

                    // Apply immediately for preview
                    applyCustomization();
                });

                colorCustomization.appendChild(colorElement);
            });

            // Reset button now requires admin change code
            document.getElementById('resetCustomizationBtn').addEventListener('click', function () {
                showAdminChangePrompt(function () {
                    if (confirm("Reset all visual customization to default values?")) {
                        resetCustomization();
                        // Reinitialize the tab
                        setTimeout(() => {
                            initializeCustomizationTab();
                        }, 100);
                    }
                });
            });

            // Save button now requires admin change code
            document.getElementById('saveCustomizationBtn').addEventListener('click', function () {
                showAdminChangePrompt(saveCustomization);
            });

            // Update current theme and font displays
            const currentTheme = themes[state.currentTheme];
            if (currentTheme) {
                document.getElementById('currentThemeName').textContent = currentTheme.name;
                document.getElementById('currentThemeCategory').textContent = currentTheme.category;
            } else {
                document.getElementById('currentThemeName').textContent = "Custom";
                document.getElementById('currentThemeCategory').textContent = "Custom";
            }

            document.getElementById('currentFontName').textContent = fonts[state.currentFont] ? fonts[state.currentFont].name : "Poppins";
        }

        // NEW FUNCTION: Remove order from management (keeps statistics)
        function removeOrderFromManagement(orderId) {
            const orderIndex = state.orders.findIndex(o => o.orderNumber === orderId);

            if (orderIndex !== -1) {
                // Change status to 'removed' instead of deleting
                state.orders[orderIndex].status = 'removed';

                // Update statistics
                updateOrderStats();

                // Save to localStorage
                saveToLocalStorage();

                // Reload admin orders list
                loadOrdersForAdmin();

                // Also reload my orders if we're viewing them
                const order = state.orders[orderIndex];
                if (state.currentTable === order.table) {
                    loadMyOrders();
                }

                // Reload system stats
                loadSystemStats();

                showNotification(`Order #${orderId} removed from management list. Statistics preserved.`);
            } else {
                showNotification(`Error: Order #${orderId} not found.`);
            }
        }

        // Function to apply a theme
        function applyTheme(themeId) {
            if (!themes[themeId]) return;

            const theme = themes[themeId];
            state.currentTheme = themeId;

            // Update colors from theme
            state.customization.primary = theme.primary;
            state.customization.primaryDark = darkenColor(theme.primary, 20);
            state.customization.secondary = theme.secondary;
            state.customization.background = theme.background;
            state.customization.text = theme.text;
            state.customization.cardBg = theme.cardBg;
            state.customization.lightGray = theme.lightGray;

            // Update button text color based on primary color contrast
            state.customization.buttonText = getContrastColor(theme.primary);

            // Apply the customization
            applyCustomization();

            // Update color inputs
            updateColorInputs();

            // Update theme selection
            document.querySelectorAll('#themeGallery .theme-card').forEach(t => t.classList.remove('selected'));
            const selectedTheme = document.querySelector(`#themeGallery .theme-card[data-theme="${themeId}"]`);
            if (selectedTheme) {
                selectedTheme.classList.add('selected');
                document.getElementById('currentThemeName').textContent = theme.name;
                document.getElementById('currentThemeCategory').textContent = theme.category;
            }

            showNotification(`"${theme.name}" theme applied. Changes are previewed live.`);
        }

        // Function to apply a font
        function applyFont(fontId, fontPrimary, fontSecondary) {
            state.currentFont = fontId;
            state.customization.fontPrimary = fontPrimary;
            state.customization.fontSecondary = fontSecondary;

            // Apply the customization
            applyCustomization();

            // Update font selection
            document.querySelectorAll('#fontOptions .font-option').forEach(f => f.classList.remove('selected'));
            const selectedFont = document.querySelector(`#fontOptions .font-option[data-font="${fontId}"]`);
            if (selectedFont) {
                selectedFont.classList.add('selected');
                document.getElementById('currentFontName').textContent = fonts[fontId].name;
            }

            showNotification(`"${fonts[fontId].name}" font applied. Changes are previewed live.`);
        }

        // Function to update color inputs after theme change
        function updateColorInputs() {
            importantColors.forEach(colorInfo => {
                const colorInput = document.getElementById(`color-${colorInfo.id}`);
                const colorValue = document.querySelector(`#color-${colorInfo.id}`).parentElement.querySelector('.color-value');
                const colorPreview = document.querySelector(`#color-${colorInfo.id}`).parentElement.parentElement.querySelector('.color-preview');

                if (colorInput && colorValue && colorPreview) {
                    colorInput.value = state.customization[colorInfo.id];
                    colorValue.textContent = state.customization[colorInfo.id];
                    colorPreview.style.backgroundColor = state.customization[colorInfo.id];
                }
            });
        }

        // Function to load customization settings
        function loadCustomizationSettings() {
            // This is called when admin dashboard loads
            // Customization tab will be initialized when clicked
        }

        // Function to save customization
        function saveCustomization() {
            // Save to Firestore (Settings/Theme)
            const themeToSave = {
                ...state.customization,
                currentTheme: state.currentTheme,
                currentFont: state.currentFont
            };
            db.collection("settings").doc("theme").set(themeToSave);

            // Save to localStorage
            saveToLocalStorage();

            showNotification("Visual customization saved successfully. Changes will persist across sessions.");
        }

        // Function to reset customization
        function resetCustomization() {
            // Reset to default theme
            state.customization = {
                primary: "#e63946",
                primaryDark: "#c1121f",
                secondary: "#457b9d",
                light: "#f8f9fa",
                dark: "#212529",
                gray: "#6c757d",
                lightGray: "#e9ecef",
                success: "#2a9d8f",
                warning: "#e9c46a",
                danger: "#dc3545",
                shadow: "0 4px 12px rgba(0, 0, 0, 0.08)",
                radius: "12px",
                background: "#fefefe",
                text: "#212529",
                cardBg: "#ffffff",
                headerBg: "#ffffff",
                menuBg: "#ffffff",
                cartBg: "#ffffff",
                paymentBg: "#ffffff",
                buttonText: "#ffffff",
                fontPrimary: "'Poppins', sans-serif",
                fontSecondary: "'Playfair Display', serif"
            };

            state.currentTheme = "default";
            state.currentFont = "poppins";

            // Apply the customization
            applyCustomization();

            showNotification("Customization reset to default values.");
        }

        // Function to update logo preview
        function updateLogoPreview() {
            const logoPreview = document.getElementById('logoPreview');
            const logoPreviewModal = document.getElementById('logoPreviewModal');

            if (state.restaurantInfo.logoImage) {
                logoPreview.innerHTML = `<img src="${state.restaurantInfo.logoImage}" alt="Restaurant Logo">`;
                if (logoPreviewModal) {
                    logoPreviewModal.innerHTML = `<img src="${state.restaurantInfo.logoImage}" alt="Restaurant Logo">`;
                }
            } else {
                logoPreview.innerHTML = `
                    <div class="image-preview-placeholder">
                        <i class="fas fa-image"></i>
                        <p>No logo uploaded</p>
                    </div>
                `;
                if (logoPreviewModal) {
                    logoPreviewModal.innerHTML = `
                        <div class="image-preview-placeholder">
                            <i class="fas fa-image"></i>
                            <p>No logo uploaded</p>
                        </div>
                    `;
                }
            }
        }

        // Function to handle logo upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.match('image.*')) {
                showNotification("Please select an image file.");
                return;
            }

            // Check file size (max 800KB to be safe for Firestore 1MB limit)
            if (file.size > 800 * 1024) {
                showNotification("Image is too large (Max 800KB). Please use a smaller image.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                state.restaurantInfo.logoImage = e.target.result;
                updateLogoPreview();
                updateRestaurantUI();
                showNotification("Logo uploaded successfully. Don't forget to save changes.");
            };
            reader.readAsDataURL(file);
        }

        // Function to remove logo
        function removeLogo() {
            state.restaurantInfo.logoImage = "";
            updateLogoPreview();
            updateRestaurantUI();
            showNotification("Logo removed. Don't forget to save changes.");
        }

        // Function to setup admin panel (modal)
        function setupAdminPanel() {
            // Close admin panel
            adminClose.addEventListener('click', function () {
                adminPanel.style.display = 'none';
            });

            // Admin tabs for modal
            document.querySelectorAll('#adminPanel .admin-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    // Update active tab
                    document.querySelectorAll('#adminPanel .admin-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Show corresponding content
                    document.querySelectorAll('#adminPanel .admin-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId + 'TabModal').classList.add('active');

                    // If customization tab is clicked, initialize it
                    if (tabId === 'customization') {
                        setTimeout(() => {
                            initializeModalCustomizationTab();
                        }, 100);
                    }

                    // If orders tab is clicked, load orders for modal
                    if (tabId === 'orders') {
                        loadOrdersForAdminModal();
                    }
                });
            });

            // Load data for modal admin panel
            document.getElementById('adminRestaurantNameModal').value = state.restaurantInfo.name;
            document.getElementById('adminTaxRateModal').value = state.restaurantInfo.taxRate;
            document.getElementById('adminPrepTimeModal').value = state.restaurantInfo.estimatedPrepTime;
            document.getElementById('adminWelcomeMessageModal').value = state.restaurantInfo.welcomeMessage || '';

            // Update logo preview for modal
            updateLogoPreview();
        }

        // Function to initialize modal customization tab
        function initializeModalCustomizationTab() {
            // Create theme gallery for modal
            const themeGalleryModal = document.getElementById('themeGalleryModal');
            if (!themeGalleryModal) return;

            themeGalleryModal.innerHTML = '';

            // Show first 8 themes in modal (for simplicity)
            const modalThemes = Object.entries(themes).slice(0, 8);

            modalThemes.forEach(([themeId, theme]) => {
                const themeElement = document.createElement('div');
                themeElement.className = `theme-card ${themeId === state.currentTheme ? 'selected' : ''}`;
                themeElement.setAttribute('data-theme', themeId);

                themeElement.innerHTML = `
                    <div class="theme-colors-preview">
                        <div style="background-color: ${theme.primary};"></div>
                        <div style="background-color: ${theme.secondary};"></div>
                        <div style="background-color: ${theme.background};"></div>
                        <div style="background-color: ${theme.text};"></div>
                        <div style="background-color: ${theme.cardBg};"></div>
                    </div>
                    <div class="theme-info">
                        <div class="theme-name">${theme.name}</div>
                        <span class="theme-category">${theme.category}</span>
                    </div>
                `;

                themeElement.addEventListener('click', function () {
                    document.querySelectorAll('#themeGalleryModal .theme-card').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                });

                themeGalleryModal.appendChild(themeElement);
            });

            // Create font options for modal
            const fontOptionsModal = document.getElementById('fontOptionsModal');
            if (!fontOptionsModal) return;

            fontOptionsModal.innerHTML = '';

            Object.entries(fonts).forEach(([fontId, font]) => {
                const fontElement = document.createElement('div');
                fontElement.className = `font-option ${fontId === state.currentFont ? 'selected' : ''}`;
                fontElement.setAttribute('data-font', fontId);

                fontElement.innerHTML = `
                    <div class="font-preview-large" style="font-family: ${font.primary.replace(/'/g, '')};">${font.name}</div>
                `;

                fontElement.addEventListener('click', function () {
                    document.querySelectorAll('#fontOptionsModal .font-option').forEach(f => f.classList.remove('selected'));
                    this.classList.add('selected');
                });

                fontOptionsModal.appendChild(fontElement);
            });

            // Modal buttons now require admin change code
            document.getElementById('resetCustomizationBtnModal').addEventListener('click', function () {
                showAdminChangePrompt(function () {
                    if (confirm("Reset all visual customization to default values?")) {
                        resetCustomization();
                        // Reinitialize the modal tab
                        setTimeout(() => {
                            initializeModalCustomizationTab();
                        }, 100);
                        showNotification("Customization reset in modal.");
                    }
                });
            });

            document.getElementById('saveCustomizationBtnModal').addEventListener('click', function () {
                showAdminChangePrompt(function () {
                    // Get selected theme
                    const selectedTheme = document.querySelector('#themeGalleryModal .theme-card.selected');
                    if (selectedTheme) {
                        const themeId = selectedTheme.getAttribute('data-theme');
                        applyTheme(themeId);
                    }

                    // Get selected font
                    const selectedFont = document.querySelector('#fontOptionsModal .font-option.selected');
                    if (selectedFont) {
                        const fontId = selectedFont.getAttribute('data-font');
                        const font = fonts[fontId];
                        if (font) {
                            applyFont(fontId, font.primary, font.secondary);
                        }
                    }

                    saveCustomization();
                    showNotification("Customization saved from modal.");
                });
            });

            // Setup System Tools
            setupSystemTools();
        }

        // NEW FUNCTION: Create subcategory HTML in edit form
        function createSubcategoryHTML(subcategory, index) {
            const subcategoryId = subcategory.id || `subcategory-${Date.now()}-${index}`;
            
            return `
                <div class="subcategory-item" data-id="${subcategoryId}">
                    <div class="subcategory-item-header">
                        <div class="subcategory-item-title">${subcategory.name || 'New Subcategory'}</div>
                        <div class="admin-card-actions">
                            <button type="button" class="admin-small-btn btn-danger remove-subcategory">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Subcategory Name</label>
                        <input type="text" class="admin-input subcategory-name" value="${subcategory.name || ''}" placeholder="e.g., Sugar Level, Ice Level, Size">
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-label">Options</label>
                        <div class="subcategory-options-container" data-subcategory-id="${subcategoryId}">
                            ${subcategory.options ? subcategory.options.map((option, optIndex) => createSubcategoryOptionHTML(option, optIndex)).join('') : ''}
                        </div>
                        <button type="button" class="btn btn-secondary add-subcategory-option" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>
                </div>
            `;
        }

        // NEW FUNCTION: Create subcategory option HTML
        function createSubcategoryOptionHTML(option, index) {
            const optionId = option.id || `option-${Date.now()}-${index}`;
            
            return `
                <div class="subcategory-option" data-id="${optionId}">
                    <input type="text" class="admin-input" style="flex: 2;" value="${option.name || ''}" placeholder="Option name (e.g., No Sugar, Less Sugar)">
                    <input type="number" class="admin-input" style="flex: 1;" value="${option.additionalPrice || 0}" step="0.01" placeholder="Additional price">
                    <select class="admin-select" style="flex: 1;">
                        <option value="add" ${option.additionalPrice >= 0 ? 'selected' : ''}>Add to price</option>
                        <option value="subtract" ${option.additionalPrice < 0 ? 'selected' : ''}>Subtract from price</option>
                    </select>
                    <button type="button" class="admin-small-btn btn-danger remove-subcategory-option">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        // Function to load my orders for the current table
        function loadMyOrders() {
            if (!state.currentTable || state.isAdminMode) {
                ordersList.innerHTML = `
                    <div class="no-orders-message">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No Table Selected</h3>
                        <p>Please select a table first to view your orders.</p>
                    </div>
                `;
                return;
            }

            const tableOrders = state.orders.filter(order =>
                order.table === state.currentTable && order.status !== 'removed'
            );

            if (tableOrders.length === 0) {
                ordersList.innerHTML = `
                    <div class="no-orders-message">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No Orders Yet</h3>
                        <p>You haven't placed any orders yet. Start by selecting items from the menu.</p>
                    </div>
                `;
                return;
            }

            // Sort by timestamp (newest first)
            tableOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            ordersList.innerHTML = '';

            tableOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';

                // Format date
                const date = new Date(order.timestamp);
                const formattedDate = date.toLocaleString();

                // Status badge
                let statusBadge = '';
                switch (order.status) {
                    case 'pending':
                        statusBadge = '<span class="order-status-badge status-pending">Pending</span>';
                        break;
                    case 'preparing':
                        statusBadge = '<span class="order-status-badge status-preparing">Preparing</span>';
                        break;
                    case 'ready':
                        statusBadge = '<span class="order-status-badge status-ready">Ready</span>';
                        break;
                    case 'served':
                        statusBadge = '<span class="order-status-badge status-served">Served</span>';
                        break;
                    case 'cancelled':
                        statusBadge = '<span class="order-status-badge status-cancelled">Cancelled</span>';
                        break;
                }

                // Items summary (show first 3 items, then "+X more")
                let itemsSummary = '';
                if (order.items.length <= 3) {
                    itemsSummary = order.items.map(item => {
                        let itemPrice = item.totalPrice || (item.price * item.quantity);
                        let optionsText = '';
                        
                        // NEW: Add subcategory options to display
                        if (item.selectedOptions && item.selectedOptions.length > 0) {
                            optionsText = '<div style="font-size: 12px; color: var(--gray); margin-left: 34px;">';
                            item.selectedOptions.forEach(opt => {
                                const priceText = opt.additionalPrice > 0 ? ` (+$${opt.additionalPrice.toFixed(2)})` : 
                                                opt.additionalPrice < 0 ? ` (-$${Math.abs(opt.additionalPrice).toFixed(2)})` : '';
                                optionsText += `${opt.subcategoryName}: ${opt.optionName}${priceText}<br>`;
                            });
                            optionsText += '</div>';
                        }
                        
                        return `
                            <div class="order-item-summary">
                                <div class="order-item-summary-name">
                                    <div class="order-item-summary-quantity">${item.quantity}</div>
                                    <div>${item.name}</div>
                                </div>
                                <div>$${itemPrice.toFixed(2)}</div>
                            </div>
                            ${optionsText}
                        `;
                    }).join('');
                } else {
                    const firstItems = order.items.slice(0, 3);
                    const remainingCount = order.items.length - 3;

                    itemsSummary = firstItems.map(item => {
                        let itemPrice = item.totalPrice || (item.price * item.quantity);
                        return `
                            <div class="order-item-summary">
                                <div class="order-item-summary-name">
                                    <div class="order-item-summary-quantity">${item.quantity}</div>
                                    <div>${item.name}</div>
                                </div>
                                <div>$${itemPrice.toFixed(2)}</div>
                            </div>
                        `;
                    }).join('');

                    itemsSummary += `
                        <div class="order-item-summary">
                            <div class="order-item-summary-name">
                                <div style="margin-left: 10px; font-style: italic;">+${remainingCount} more item${remainingCount > 1 ? 's' : ''}</div>
                            </div>
                            <div></div>
                        </div>
                    `;
                }

                orderCard.innerHTML = `
                    <div class="order-card-header">
                        <div>
                            <div class="order-card-title">Order #${order.orderNumber}</div>
                            <div class="order-card-time">${formattedDate}</div>
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                    <div class="order-card-body">
                        <div class="order-items-summary">
                            ${itemsSummary}
                        </div>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Payment Method:</span>
                                <span>${order.paymentMethod === 'card' ? 'Card' : 'Cash'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Payment Time:</span>
                                <span>${order.paymentTime === 'now' ? 'Pay Now' : 'Pay Later'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="order-card-footer">
                        <div class="order-total-summary">Total: $${order.total.toFixed(2)}</div>
                        <div style="font-size: 14px; color: var(--gray);">
                            ${order.status === 'pending' ? 'Your order is being processed' :
                        order.status === 'preparing' ? 'Your food is being prepared' :
                            order.status === 'ready' ? 'Your order is ready' :
                                order.status === 'served' ? 'Your order has been served' :
                                    'Your order has been cancelled'}
                        </div>
                    </div>
                `;

                ordersList.appendChild(orderCard);
            });

            // Update subtitle
            myOrdersSubtitle.textContent = `You have ${tableOrders.length} order${tableOrders.length !== 1 ? 's' : ''} for ${state.currentTable}`;
        }

        // Function to save restaurant settings
        function saveRestaurantSettings() {
            state.restaurantInfo.name = document.getElementById('adminRestaurantName').value;
            state.restaurantInfo.taxRate = parseFloat(document.getElementById('adminTaxRate').value);
            state.restaurantInfo.estimatedPrepTime = document.getElementById('adminPrepTime').value;
            state.restaurantInfo.welcomeMessage = document.getElementById('adminWelcomeMessage').value;

            // Save to Firestore (Settings/Restaurant)
            db.collection("settings").doc("restaurant").set(state.restaurantInfo);

            saveToLocalStorage();
            updateRestaurantUI();
            showNotification("Restaurant settings saved successfully.");
        }

        // Function to load menu items for admin
        function loadMenuItemsForAdmin() {
                const container = document.getElementById('menuItemsList');
                if (!container) return;
                container.innerHTML = '';
                const sorted = [...state.menuItems].sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));
                if (sorted.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:var(--gray);">No menu items.</p>';
                    return;
                }
                sorted.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'admin-card';
                    card.setAttribute('draggable', 'true');                     // NEW: make draggable
                    card.setAttribute('data-item-id', item.id);               // store ID for drag events
                    card.innerHTML = `
                        ${item.image ? `<div style="height:120px;background-image:url('${item.image}');background-size:cover;border-radius:8px;margin-bottom:10px;"></div>` 
                                    : `<div style="height:120px;background:var(--light-gray);display:flex;align-items:center;justify-content:center;color:var(--gray);"><i class="fas fa-utensils"></i></div>`}
                        <div class="admin-card-header">
                            <div class="admin-card-title">${item.name} ${item.subcategories?.length ? '<span style="background:var(--success);color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:5px;">Customizable</span>' : ''}</div>
                            <div style="display:flex;gap:5px;">
                                <!-- NEW DRAG HANDLE -->
                                <span class="drag-handle" style="cursor:grab; padding:4px; color:var(--gray);"><i class="fas fa-grip-vertical"></i></span>
                                <button class="admin-small-btn btn-primary duplicate-item" data-id="${item.id}"><i class="fas fa-copy"></i></button>
                                <button class="admin-small-btn btn-primary edit-item" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                                <button class="admin-small-btn btn-danger delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <p style="font-size:14px;margin-bottom:10px;">${item.description}</p>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="font-weight:600;color:var(--primary);">$${item.price.toFixed(2)}</span>
                            <span style="font-size:12px;color:var(--gray);">${getCategoryDisplayName(item.category)}</span>
                        </div>
                        <div class="tag-display">${item.tags.map(t => `<span class="tag-item">${t}</span>`).join('')}</div>
                    `;
                    container.appendChild(card);
                });

                // ----- ATTACH DRAG EVENT LISTENERS TO EACH CARD -----
                container.querySelectorAll('.admin-card').forEach(card => {
                    card.addEventListener('dragstart', handleMenuItemDragStart);
                    card.addEventListener('dragover', handleMenuItemDragOver);
                    card.addEventListener('drop', handleMenuItemDrop);
                    card.addEventListener('dragend', handleMenuItemDragEnd);
                });

                // ----- REMOVE OLD ARROW BUTTON LISTENERS -----
                // (the code that used to listen to .move-up/.move-down is now deleted)
            }  
            // ----- DRAG & DROP FOR MENU ITEMS -----
                let draggedMenuItemId = null;

                function handleMenuItemDragStart(e) {
                    e.dataTransfer.effectAllowed = 'move';
                    const card = e.target.closest('.admin-card');
                    if (!card) return;
                    draggedMenuItemId = parseInt(card.dataset.itemId);
                    e.dataTransfer.setData('text/plain', draggedMenuItemId);
                    card.classList.add('dragging');
                }

                function handleMenuItemDragOver(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const targetCard = e.target.closest('.admin-card');
                    if (targetCard) {
                        document.querySelectorAll('.admin-card').forEach(c => c.classList.remove('drag-over'));
                        targetCard.classList.add('drag-over');
                    }
                }

                function handleMenuItemDrop(e) {
                    e.preventDefault();
                    document.querySelectorAll('.admin-card').forEach(c => c.classList.remove('drag-over'));
                    const targetCard = e.target.closest('.admin-card');
                    if (!targetCard) return;
                    const targetId = parseInt(targetCard.dataset.itemId);
                    if (draggedMenuItemId === null || draggedMenuItemId === targetId) return;

                    const sourceIndex = state.menuItems.findIndex(i => i.id === draggedMenuItemId);
                    const targetIndex = state.menuItems.findIndex(i => i.id === targetId);
                    if (sourceIndex === -1 || targetIndex === -1) return;

                    const [movedItem] = state.menuItems.splice(sourceIndex, 1);
                    state.menuItems.splice(targetIndex, 0, movedItem);

                    state.menuItems.forEach((item, idx) => {
                        item.sortOrder = idx;
                    });

                    saveToLocalStorage();

                    const batch = db.batch();
                    state.menuItems.forEach(item => {
                        batch.update(db.collection("menu").doc(item.id.toString()), { sortOrder: item.sortOrder });
                    });
                    batch.commit().catch(console.error);

                    loadMenuItemsForAdmin();
                    if (state.isAdminMode) {
                        loadMenuItemsForAdminModal();
                    }
                    displayMenuItems('all');
                }

                function handleMenuItemDragEnd(e) {
                    const card = e.target.closest('.admin-card');
                    if (card) card.classList.remove('dragging');
                    document.querySelectorAll('.admin-card').forEach(c => c.classList.remove('drag-over'));
                    draggedMenuItemId = null;
                } 


                function loadMenuItemsForAdminModal() {
                    const container = document.getElementById('menuItemsListModal');
                    if (!container) return;
                    container.innerHTML = '';
                    const sorted = [...state.menuItems].sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));
                    if (sorted.length === 0) {
                        container.innerHTML = '<p style="text-align:center;color:var(--gray);">No menu items.</p>';
                        return;
                    }
                    sorted.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'admin-card';
                        card.setAttribute('draggable', 'true');
                        card.setAttribute('data-item-id', item.id);
                        card.innerHTML = `
                            ${item.image ? `<div style="height:120px;background-image:url('${item.image}');background-size:cover;border-radius:8px;margin-bottom:10px;"></div>` 
                                        : `<div style="height:120px;background:var(--light-gray);display:flex;align-items:center;justify-content:center;color:var(--gray);"><i class="fas fa-utensils"></i></div>`}
                            <div class="admin-card-header">
                                <div class="admin-card-title">${item.name} ${item.subcategories?.length ? '<span style="background:var(--success);color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:5px;">Customizable</span>' : ''}</div>
                                <div style="display:flex;gap:5px;">
                                    <!-- DRAG HANDLE -->
                                    <span class="drag-handle" style="cursor:grab; padding:4px; color:var(--gray);"><i class="fas fa-grip-vertical"></i></span>
                                    <button class="admin-small-btn btn-primary duplicate-item" data-id="${item.id}"><i class="fas fa-copy"></i></button>
                                    <button class="admin-small-btn btn-primary edit-item" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                                    <button class="admin-small-btn btn-danger delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <p style="font-size:14px;margin-bottom:10px;">${item.description}</p>
                            <div style="display:flex;justify-content:space-between;">
                                <span style="font-weight:600;color:var(--primary);">$${item.price.toFixed(2)}</span>
                                <span style="font-size:12px;color:var(--gray);">${getCategoryDisplayName(item.category)}</span>
                            </div>
                            <div class="tag-display">${item.tags.map(t => `<span class="tag-item">${t}</span>`).join('')}</div>
                        `;
                        container.appendChild(card);
                    });

                    // ----- ATTACH THE SAME DRAG EVENT LISTENERS (already defined in Step 2) -----
                    container.querySelectorAll('.admin-card').forEach(card => {
                        card.addEventListener('dragstart', handleMenuItemDragStart);
                        card.addEventListener('dragover', handleMenuItemDragOver);
                        card.addEventListener('drop', handleMenuItemDrop);
                        card.addEventListener('dragend', handleMenuItemDragEnd);
                    });

                    // ----- REMOVE OLD ARROW BUTTON LISTENERS (no longer needed) -----
                    // (The previous code that added click listeners to .move-up/.move-down is gone)
                }
        // Function to open edit menu item form
        function openEditMenuItemForm(itemId) {
            const editForm = document.getElementById('editMenuItemForm');
            const menuItemsList = document.getElementById('menuItemsList');

            // Populate category dropdown
            const categorySelect = document.getElementById('editItemCategory');
            categorySelect.innerHTML = '';

            // Add all categories
            state.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.displayName;
                categorySelect.appendChild(option);
            });

            if (itemId) {
                // Edit existing item
                const item = state.menuItems.find(i => i.id === itemId);
                if (item) {
                    document.getElementById('editItemName').value = item.name;
                    document.getElementById('editItemDescription').value = item.description;
                    document.getElementById('editItemPrice').value = item.price;
                    document.getElementById('editItemCategory').value = item.category;
                    document.getElementById('editItemTags').value = item.tags.join(', ');

                    // Update image preview
                    updateItemImagePreview(item.image);

                    // Set current item ID in a data attribute
                    editForm.setAttribute('data-item-id', itemId);

                    // NEW: Load subcategories
                    loadSubcategoriesForEdit(item.subcategories || []);
                }
            } else {
                // Add new item
                document.getElementById('editItemName').value = '';
                document.getElementById('editItemDescription').value = '';
                document.getElementById('editItemPrice').value = '';
                document.getElementById('editItemCategory').value = state.categories.length > 0 ? state.categories[0].id : '';
                document.getElementById('editItemTags').value = '';

                // Clear image preview
                    updateItemImagePreview('');

                // Clear item ID
                editForm.setAttribute('data-item-id', '');
                // NEW: Initialize empty subcategories
                loadSubcategoriesForEdit([]);
            }

            // Set up image upload for menu item
            document.getElementById('uploadItemImageBtn').addEventListener('click', function () {
                document.getElementById('itemImageUpload').click();
            });

            document.getElementById('itemImageUpload').addEventListener('change', function (e) {
                handleItemImageUpload(e);
            });

            document.getElementById('removeItemImageBtn').addEventListener('click', function () {
                updateItemImagePreview('');
                state.currentImageUpload = null;
            });
            // NEW: Set up subcategory functionality
            setupSubcategoryManagement();

            // Show form and hide list
            menuItemsList.style.display = 'none';
            editForm.style.display = 'block';

            // Set up form buttons
            document.getElementById('cancelEditBtn').onclick = function () {
                editForm.style.display = 'none';
                menuItemsList.style.display = 'block';
            };

            document.getElementById('saveMenuItemBtn').onclick = function () {
                showAdminChangePrompt(saveMenuItem);
            };
        }

        // NEW FUNCTION: Load subcategories for edit form
        function loadSubcategoriesForEdit(subcategories) {
            const subcategoriesContainer = document.getElementById('subcategoriesContainer');
            subcategoriesContainer.innerHTML = '';

            if (subcategories.length === 0) {
                subcategoriesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--gray); background-color: var(--light-gray); border-radius: 8px;">
                        <i class="fas fa-list-alt" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        <p>No subcategories added yet. Add subcategories to allow customers to customize this item.</p>
                    </div>
                `;
                return;
            }

            subcategories.forEach((subcategory, index) => {
                const subcategoryHTML = createSubcategoryHTML(subcategory, index);
                subcategoriesContainer.innerHTML += subcategoryHTML;
            });
        }

        // NEW FUNCTION: Setup subcategory management
        function setupSubcategoryManagement() {
            const subcategoriesContainer = document.getElementById('subcategoriesContainer');
            const addSubcategoryBtn = document.getElementById('addSubcategoryBtn');

            // Add subcategory button
            addSubcategoryBtn.addEventListener('click', function () {
                const newSubcategory = {
                    id: `subcategory-${Date.now()}`,
                    name: '',
                    options: []
                };

                const subcategoryHTML = createSubcategoryHTML(newSubcategory, Date.now());
                
                // Remove placeholder if present
                const placeholder = subcategoriesContainer.querySelector('div[style*="text-align: center"]');
                if (placeholder) {
                    subcategoriesContainer.innerHTML = '';
                }
                
                subcategoriesContainer.innerHTML += subcategoryHTML;
                
                // Setup event listeners for the new subcategory
                setupSubcategoryEventListeners();
            });

            // Setup initial event listeners
            setupSubcategoryEventListeners();
        }

        // NEW FUNCTION: Setup subcategory event listeners
        function setupSubcategoryEventListeners() {
            // Remove subcategory buttons
            document.querySelectorAll('.remove-subcategory').forEach(btn => {
                btn.addEventListener('click', function () {
                    const subcategoryItem = this.closest('.subcategory-item');
                    if (subcategoryItem) {
                        subcategoryItem.remove();
                        
                        // Show placeholder if no subcategories left
                        const subcategoriesContainer = document.getElementById('subcategoriesContainer');
                        if (subcategoriesContainer.children.length === 0) {
                            subcategoriesContainer.innerHTML = `
                                <div style="text-align: center; padding: 20px; color: var(--gray); background-color: var(--light-gray); border-radius: 8px;">
                                    <i class="fas fa-list-alt" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                    <p>No subcategories added yet. Add subcategories to allow customers to customize this item.</p>
                                </div>
                            `;
                        }
                    }
                });
            });

            // Add option buttons
            document.querySelectorAll('.add-subcategory-option').forEach(btn => {
                btn.addEventListener('click', function () {
                    const subcategoryItem = this.closest('.subcategory-item');
                    const optionsContainer = subcategoryItem.querySelector('.subcategory-options-container');
                    
                    const newOption = {
                        id: `option-${Date.now()}`,
                        name: '',
                        additionalPrice: 0
                    };
                    
                    const optionHTML = createSubcategoryOptionHTML(newOption, Date.now());
                    optionsContainer.innerHTML += optionHTML;
                    
                    // Setup event listener for the new option's remove button
                    const newRemoveBtn = optionsContainer.lastElementChild.querySelector('.remove-subcategory-option');
                    if (newRemoveBtn) {
                        newRemoveBtn.addEventListener('click', function() {
                            const optionElement = this.closest('.subcategory-option');
                            if (optionElement) {
                                optionElement.remove();
                            }
                        });
                    }
                });
            });

            // Remove option buttons
            document.querySelectorAll('.remove-subcategory-option').forEach(btn => {
                btn.addEventListener('click', function () {
                    const optionElement = this.closest('.subcategory-option');
                    if (optionElement) {
                        optionElement.remove();
                    }
                });
            });
        }

        // Function to update item image preview
        function updateItemImagePreview(imageData) {
            const itemImagePreview = document.getElementById('itemImagePreview');

            if (imageData && imageData.trim() !== '') {
                itemImagePreview.innerHTML = `<img src="${imageData}" alt="Menu Item Image">`;
                state.currentImageUpload = imageData;
            } else {
                itemImagePreview.innerHTML = `
                    <div class="image-preview-placeholder">
                        <i class="fas fa-utensils"></i>
                        <p>No image uploaded</p>
                    </div>
                `;
                state.currentImageUpload = null;
            }
        }

        // Function to handle item image upload
        function handleItemImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.match('image.*')) {
                showNotification("Please select an image file.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                updateItemImagePreview(e.target.result);
                showNotification("Image uploaded successfully. Don't forget to save changes.");
            };
            reader.readAsDataURL(file);
        }

        // UPDATED Function to save menu item with subcategories to Firebase
        function saveMenuItem() {
            const itemId = document.getElementById('editMenuItemForm').getAttribute('data-item-id');
            const name = document.getElementById('editItemName').value;
            const description = document.getElementById('editItemDescription').value;
            const price = parseFloat(document.getElementById('editItemPrice').value);
            const category = document.getElementById('editItemCategory').value;
            const tags = document.getElementById('editItemTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

            if (!name || !description || !price) {
                showNotification("Please fill in all required fields.");
                return;
            }

            if (!category) {
                showNotification("Please select a category.");
                return;
            }

            // NEW: Collect subcategories
            const subcategories = [];
            const subcategoryItems = document.querySelectorAll('.subcategory-item');
            
            subcategoryItems.forEach(subcategoryItem => {
                const subcategoryName = subcategoryItem.querySelector('.subcategory-name').value;
                
                if (subcategoryName.trim() === '') {
                    showNotification("Please provide a name for all subcategories.");
                    return;
                }
                
                const options = [];
                const optionElements = subcategoryItem.querySelectorAll('.subcategory-option');
                
                optionElements.forEach(optionElement => {
                    const optionName = optionElement.querySelector('input[type="text"]').value;
                    const optionPrice = parseFloat(optionElement.querySelector('input[type="number"]').value) || 0;
                    const priceType = optionElement.querySelector('select').value;
                    
                    if (optionName.trim() === '') {
                        showNotification("Please provide a name for all options.");
                        return;
                    }
                    
                    options.push({
                        id: optionElement.getAttribute('data-id') || `option-${Date.now()}`,
                        name: optionName,
                        additionalPrice: priceType === 'subtract' ? -Math.abs(optionPrice) : Math.abs(optionPrice)
                    });
                });
                
                if (options.length === 0) {
                    showNotification(`Please add at least one option to the "${subcategoryName}" subcategory.`);
                    return;
                }
                
                subcategories.push({
                    id: subcategoryItem.getAttribute('data-id') || `subcategory-${Date.now()}`,
                    name: subcategoryName,
                    options: options
                });
            });

            let updatedItem;

            if (itemId) {
                // Update existing item
                const index = state.menuItems.findIndex(item => item.id === parseInt(itemId));
                if (index !== -1) {
                    updatedItem = {
                        ...state.menuItems[index],
                        name,
                        description,
                        price,
                        category,
                        image: state.currentImageUpload || state.menuItems[index].image,
                        tags,
                        subcategories: subcategories
                    };
                    state.menuItems[index] = updatedItem;
                }
            } else {
                // Add new item
                const newId = state.menuItems.length > 0 ? Math.max(...state.menuItems.map(item => item.id)) + 1 : 1;
                updatedItem = {
                    id: newId,
                    name,
                    description,
                    price,
                    category,
                    image: state.currentImageUpload || '',
                    tags,
                    subcategories: subcategories
                };
                state.menuItems.push(updatedItem);
            }

            // Save to Firebase Firestore with subcategories
            db.collection("menu").doc(updatedItem.id.toString()).set(updatedItem)
                .then(() => {
                    console.log("Menu item saved to Firestore with subcategories:", updatedItem.subcategories);
                    
                    // Save to localStorage
                    saveToLocalStorage();

                    // Hide form and show list
                    document.getElementById('editMenuItemForm').style.display = 'none';
                    document.getElementById('menuItemsList').style.display = 'block';

                    // Reset current image upload
                    state.currentImageUpload = null;

                    // Reload menu items
                    loadMenuItemsForAdmin();
                    displayMenuItems('all');

                    showNotification(itemId ? "Menu item updated successfully." : "Menu item added successfully.");
                })
                .catch((error) => {
                    console.error("Error saving menu item to Firestore: ", error);
                    showNotification("Error saving menu item to cloud. Please check console.");
                });
        }



        // Function to save menu item
        function saveMenuItem() {
            const itemId = document.getElementById('editMenuItemForm').getAttribute('data-item-id');
            const name = document.getElementById('editItemName').value;
            const description = document.getElementById('editItemDescription').value;
            const price = parseFloat(document.getElementById('editItemPrice').value);
            const category = document.getElementById('editItemCategory').value;
            const tags = document.getElementById('editItemTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);

            if (!name || !description || !price) {
                showNotification("Please fill in all required fields.");
                return;
            }

            if (!category) {
                showNotification("Please select a category.");
                return;
            }

            if (itemId) {
                // Update existing item
                const index = state.menuItems.findIndex(item => item.id === parseInt(itemId));
                if (index !== -1) {
                    state.menuItems[index] = {
                        ...state.menuItems[index],
                        name,
                        description,
                        price,
                        category,
                        image: state.currentImageUpload || state.menuItems[index].image,
                        tags
                    };
                }
            } else {
                // Add new item
                const newId = state.menuItems.length > 0 ? Math.max(...state.menuItems.map(item => item.id)) + 1 : 1;
                const updatedItem = {   //  use 'const' or 'let' only once
                    id: newId,
                    name,
                    description,
                    price,
                    category,
                    image: state.currentImageUpload || '',
                    tags,
                    subcategories: subcategories,
                    sortOrder: Math.max(...state.menuItems.map(i => i.sortOrder || 0), 0) + 1   //  this line is inside
                };
                state.menuItems.push(updatedItem);
            }

            // Save to Firestore (Menu)
            // Use the item we just modified/added
            const savedItem = itemId ? state.menuItems[index] : state.menuItems[state.menuItems.length - 1];
            db.collection("menu").doc(savedItem.id.toString()).set(savedItem);

            saveToLocalStorage();

            // Hide form and show list
            document.getElementById('editMenuItemForm').style.display = 'none';
            document.getElementById('menuItemsList').style.display = 'block';

            // Reset current image upload
            state.currentImageUpload = null;

            // Reload menu items
            loadMenuItemsForAdmin();
            displayMenuItems('all');

            showNotification(itemId ? "Menu item updated successfully." : "Menu item added successfully.");
        }

        // Function to delete menu item
        function deleteMenuItem(itemId) {
            if (confirm("Are you sure you want to delete this menu item?")) {
                state.menuItems = state.menuItems.filter(item => item.id !== itemId);

                // Delete from Firestore
                db.collection("menu").doc(itemId.toString()).delete();

                saveToLocalStorage();
                loadMenuItemsForAdmin();
                displayMenuItems('all');
                showNotification("Menu item deleted successfully.");
            }
        }

        // Function to load categories for admin
        function loadCategoriesForAdmin() {
            const container = document.getElementById('categoriesListContainer');
            if (!container) return;
            container.innerHTML = '';
            const sorted = [...state.categories].sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:var(--gray);padding:20px;">No categories.</p>';
                return;
            }
            sorted.forEach(cat => {
                const itemCount = state.menuItems.filter(m => m.category === cat.id).length;
                const div = document.createElement('div');
                div.className = 'category-item';
                div.innerHTML = `
                    <div>
                        <span class="category-item-name">${cat.displayName}</span>
                        <span class="category-item-count">${itemCount} item${itemCount!==1?'s':''}</span>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <div class="reorder-arrows">
                            <button class="reorder-btn move-category-up" data-id="${cat.id}"><i class="fas fa-chevron-up"></i></button>
                            <button class="reorder-btn move-category-down" data-id="${cat.id}"><i class="fas fa-chevron-down"></i></button>
                        </div>
                        <button class="admin-small-btn btn-danger delete-category" data-id="${cat.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
            container.querySelectorAll('.move-category-up').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                showAdminChangePrompt(() => moveCategory(id, 'up'));
            });
             });

            container.querySelectorAll('.move-category-down').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                showAdminChangePrompt(() => moveCategory(id, 'down'));
            });
        });

        container.querySelectorAll('.delete-category').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                showAdminChangePrompt(() => deleteCategory(id));
            });
        });
    }
        function loadCategoriesForAdminModal() {
            const container = document.getElementById('categoriesListContainerModal');
            if (!container) return;
            container.innerHTML = '';
            const sorted = [...state.categories].sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            if (sorted.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:var(--gray);padding:20px;">No categories.</p>';
                return;
            }
            sorted.forEach(cat => {
                const itemCount = state.menuItems.filter(m => m.category === cat.id).length;
                const div = document.createElement('div');
                div.className = 'category-item';
                div.innerHTML = `
                    <div>
                        <span class="category-item-name">${cat.displayName}</span>
                        <span class="category-item-count">${itemCount} item${itemCount!==1?'s':''}</span>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <div class="reorder-arrows">
                            <button class="reorder-btn move-category-up" data-id="${cat.id}"><i class="fas fa-chevron-up"></i></button>
                            <button class="reorder-btn move-category-down" data-id="${cat.id}"><i class="fas fa-chevron-down"></i></button>
                        </div>
                        <button class="admin-small-btn btn-danger delete-category" data-id="${cat.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
            container.querySelectorAll('.move-category-up').forEach(btn => 
                btn.addEventListener('click', e => showAdminChangePrompt(() => moveCategory(e.currentTarget.dataset.id, 'up'))));
            container.querySelectorAll('.move-category-down').forEach(btn => 
                btn.addEventListener('click', e => showAdminChangePrompt(() => moveCategory(e.currentTarget.dataset.id, 'down'))));
            container.querySelectorAll('.delete-category').forEach(btn => 
                btn.addEventListener('click', e => showAdminChangePrompt(() => deleteCategory(e.currentTarget.dataset.id))));
        }


        // Function to add a new category
        function addNewCategory() {
            const categoryNameInput = document.getElementById('newCategoryName');
            const displayNameInput = document.getElementById('newCategoryDisplayName');

            const categoryName = categoryNameInput.value.trim().toLowerCase().replace(/\s+/g, '-');
            const displayName = displayNameInput.value.trim() || categoryNameInput.value.trim();

            if (!categoryName) {
                showNotification("Please enter a category name.");
                return;
            }

            // Check if category already exists
            if (state.categories.some(cat => cat.id === categoryName || cat.name === categoryName)) {
                showNotification("A category with this name already exists.");
                return;
            }

            //  Create ONE newCategory object  no duplicate variable names
            const newCategory = {
                id: categoryName,
                name: categoryName,
                displayName: displayName,
                isDefault: false,
                sortOrder: Math.max(...state.categories.map(c => c.sortOrder || 0), 0) + 1
            };

            state.categories.push(newCategory);

            // Save to Firestore
            db.collection("categories").doc(newCategory.id).set(newCategory)
                .then(() => {
                    saveToLocalStorage();
                    categoryNameInput.value = '';
                    displayNameInput.value = '';
                    loadCategoriesForAdmin();
                    loadCategoriesForAdminModal(); // if you have this function
                    updateCategoryTabs();
                    showNotification(`Category "${displayName}" added successfully.`);
                })
                .catch((error) => {
                    console.error("Error saving category to Firestore: ", error);
                    showNotification("Error saving category to cloud. Please check console.");
                });
        }

        // Function to delete a category
        function deleteCategory(categoryId) {
            // Check if category exists
            const category = state.categories.find(cat => cat.id === categoryId);
            if (!category) return;

            // Check if there are menu items in this category
            const itemsInCategory = state.menuItems.filter(item => item.category === categoryId);
            if (itemsInCategory.length > 0) {
                showNotification(`Cannot delete category "${category.displayName}" because it has ${itemsInCategory.length} menu item${itemsInCategory.length !== 1 ? 's' : ''} assigned to them. Reassign or delete those items first.`);
                return;
            }

            if (confirm(`Are you sure you want to delete the category "${category.displayName}"?`)) {
                // Remove category
                state.categories = state.categories.filter(cat => cat.id !== categoryId);

                // Delete from Firestore
                db.collection("categories").doc(categoryId).delete();

                saveToLocalStorage();

                // Reload categories
                loadCategoriesForAdmin();

                // Update category tabs in main menu
                updateCategoryTabs();

                showNotification(`Category "${category.displayName}" deleted successfully.`);
            }
        }

        // Function to get category display name
        function getCategoryDisplayName(categoryId) {
            const category = state.categories.find(cat => cat.id === categoryId);
            return category ? category.displayName : categoryId;
        }

        // Function to load orders for admin
        function loadOrdersForAdmin() {
            const adminOrdersList = document.getElementById('adminOrdersList');
            const statusFilter = document.getElementById('orderStatusFilter').value;

            let filteredOrders = [...state.orders];
            if (statusFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            }

            // Sort by timestamp (newest first)
            filteredOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filteredOrders.length === 0) {
                adminOrdersList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No orders found.</p>';
                return;
            }

            adminOrdersList.innerHTML = '';

            filteredOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'admin-card';
                orderCard.style.marginBottom = '15px';

                // Format date
                const date = new Date(order.timestamp);
                const formattedDate = date.toLocaleString();

                // Status badge
                let statusBadge = '';
                switch (order.status) {
                    case 'pending':
                        statusBadge = '<span class="order-status-badge status-pending">Pending</span>';
                        break;
                    case 'preparing':
                        statusBadge = '<span class="order-status-badge status-preparing">Preparing</span>';
                        break;
                    case 'ready':
                        statusBadge = '<span class="order-status-badge status-ready">Ready</span>';
                        break;
                    case 'served':
                        statusBadge = '<span class="order-status-badge status-served">Served</span>';
                        break;
                    case 'cancelled':
                        statusBadge = '<span class="order-status-badge status-cancelled">Cancelled</span>';
                        break;
                    case 'removed':
                        statusBadge = '<span class="order-status-badge" style="background-color: #6c757d; color: white;">Removed</span>';
                        break;
                }

                // Items summary
                const itemsSummary = order.items.map(item => {
                    let itemText = `${item.quantity}x ${item.name}`;
                    // NEW: Add subcategory options to display
                    if (item.selectedOptions && item.selectedOptions.length > 0) {
                        itemText += ' (Customized)';
                    }
                    return itemText;
                }).join(', ');



                orderCard.innerHTML = `
                    <div class="admin-card-header">
                        <div>
                            <div class="admin-card-title">Order #${order.orderNumber}</div>
                            <div style="font-size: 12px; color: var(--gray);">${formattedDate}</div>
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                    <p style="margin-bottom: 10px; font-size: 14px;">
                        <strong>Table:</strong> ${order.table}<br>
                        <strong>Items:</strong> ${itemsSummary}<br>
                        <strong>Total:</strong> $${order.total.toFixed(2)}<br>
                        <strong>Payment:</strong> ${order.paymentMethod === 'card' ? 'Card' : 'Cash'} (${order.paymentTime === 'now' ? 'Pay Now' : 'Pay Later'})
                    </p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <select class="admin-select" style="flex: 1;" data-order-id="${order.orderNumber}">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                            <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                            <option value="served" ${order.status === 'served' ? 'selected' : ''}>Served</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            <option value="removed" ${order.status === 'removed' ? 'selected' : ''}>Removed</option>
                        </select>
                        <button class="btn btn-primary btn-small update-status" data-order-id="${order.orderNumber}" style="padding: 8px 15px;">
                            Update
                        </button>
                        <button class="btn btn-danger btn-small remove-order" data-order-id="${order.orderNumber}" style="padding: 8px 15px;">
                            Remove
                        </button>
                    </div>
                `;

                adminOrdersList.appendChild(orderCard);
            });
        }

        // Function to load orders for admin modal
        function loadOrdersForAdminModal() {
            const adminOrdersListModal = document.getElementById('adminOrdersListModal');
            const statusFilterModal = document.getElementById('orderStatusFilterModal').value;

            let filteredOrders = [...state.orders];
            if (statusFilterModal !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilterModal);
            }

            // Sort by timestamp (newest first)
            filteredOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filteredOrders.length === 0) {
                adminOrdersListModal.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No orders found.</p>';
                return;
            }

            adminOrdersListModal.innerHTML = '';

            filteredOrders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'admin-card';
                orderCard.style.marginBottom = '15px';

                // Format date
                const date = new Date(order.timestamp);
                const formattedDate = date.toLocaleString();

                // Status badge
                let statusBadge = '';
                switch (order.status) {
                    case 'pending':
                        statusBadge = '<span class="order-status-badge status-pending">Pending</span>';
                        break;
                    case 'preparing':
                        statusBadge = '<span class="order-status-badge status-preparing">Preparing</span>';
                        break;
                    case 'ready':
                        statusBadge = '<span class="order-status-badge status-ready">Ready</span>';
                        break;
                    case 'served':
                        statusBadge = '<span class="order-status-badge status-served">Served</span>';
                        break;
                    case 'cancelled':
                        statusBadge = '<span class="order-status-badge status-cancelled">Cancelled</span>';
                        break;
                    case 'removed':
                        statusBadge = '<span class="order-status-badge" style="background-color: #6c757d; color: white;">Removed</span>';
                        break;
                }

                // Items summary
                const itemsSummary = order.items.map(item => `${item.quantity}x ${item.name}`).join(', ');

                orderCard.innerHTML = `
                    <div class="admin-card-header">
                        <div>
                            <div class="admin-card-title">Order #${order.orderNumber}</div>
                            <div style="font-size: 12px; color: var(--gray);">${formattedDate}</div>
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                    <p style="margin-bottom: 10px; font-size: 14px;">
                        <strong>Table:</strong> ${order.table}<br>
                        <strong>Items:</strong> ${itemsSummary}<br>
                        <strong>Total:</strong> $${order.total.toFixed(2)}<br>
                        <strong>Payment:</strong> ${order.paymentMethod === 'card' ? 'Card' : 'Cash'} (${order.paymentTime === 'now' ? 'Pay Now' : 'Pay Later'})
                    </p>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <select class="admin-select" style="flex: 1;" data-order-id="${order.orderNumber}">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                            <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                            <option value="served" ${order.status === 'served' ? 'selected' : ''}>Served</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            <option value="removed" ${order.status === 'removed' ? 'selected' : ''}>Removed</option>
                        </select>
                        <button class="btn btn-primary btn-small update-status" data-order-id="${order.orderNumber}" style="padding: 8px 15px;">
                            Update
                        </button>
                        <button class="btn btn-danger btn-small remove-order" data-order-id="${order.orderNumber}" style="padding: 8px 15px;">
                            Remove
                        </button>
                    </div>
                `;

                adminOrdersListModal.appendChild(orderCard);
            });
        }

        // Function to update order status (no admin change code required)
        function updateOrderStatus(orderId, newStatus) {
            // Find the order index
            const orderIndex = state.orders.findIndex(o => o.orderNumber === orderId);

            if (orderIndex !== -1) {
                // Update the order status
                state.orders[orderIndex].status = newStatus;

                // Update statistics
                updateOrderStats();

                // Save to localStorage
                saveToLocalStorage();
                updateOrderStatusInFirestore(orderId, newStatus);

                // Reload admin orders list
                loadOrdersForAdmin();

                // Also reload my orders if we're viewing them
                const order = state.orders[orderIndex];
                if (state.currentTable === order.table) {
                    loadMyOrders();
                }

                // Reload system stats
                loadSystemStats();

                showNotification(`Order #${orderId} status updated to ${newStatus}.`);
            } else {
                showNotification(`Error: Order #${orderId} not found.`);
            }
        }

        // Function to load system stats
        function loadSystemStats() {
            const systemStats = document.getElementById('systemStats');

            systemStats.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background-color: var(--light); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);">${state.orderStats.totalOrders}</div>
                        <div style="font-size: 14px; color: var(--gray);">Total Orders</div>
                    </div>
                    <div style="background-color: var(--light); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);">$${state.orderStats.totalRevenue.toFixed(2)}</div>
                        <div style="font-size: 14px; color: var(--gray);">Total Revenue</div>
                    </div>
                    <div style="background-color: var(--light); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);">$${state.orderStats.avgOrderValue.toFixed(2)}</div>
                        <div style="font-size: 14px; color: var(--gray);">Average Order</div>
                    </div>
                    <div style="background-color: var(--light); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);">${state.menuItems.length}</div>
                        <div style="font-size: 14px; color: var(--gray);">Menu Items</div>
                    </div>
                    <div style="background-color: var(--light); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);">${state.categories.length}</div>
                        <div style="font-size: 14px; color: var(--gray);">Categories</div>
                    </div>
                    <div style="background-color: var(--light); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 600; color: var(--primary);">${state.orderStats.removedOrders}</div>
                        <div style="font-size: 14px; color: var(--gray);">Removed Orders</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <h5 style="margin-bottom: 10px;">Order Status Distribution</h5>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #fff3cd; border-radius: 2px;"></div>
                            <span>Pending: ${state.orderStats.pendingOrders}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #d1ecf1; border-radius: 2px;"></div>
                            <span>Preparing: ${state.orderStats.preparingOrders}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #d4edda; border-radius: 2px;"></div>
                            <span>Ready: ${state.orderStats.readyOrders}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #cce5ff; border-radius: 2px;"></div>
                            <span>Served: ${state.orderStats.servedOrders}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #f8d7da; border-radius: 2px;"></div>
                            <span>Cancelled: ${state.orderStats.cancelledOrders}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 12px; height: 12px; background-color: #6c757d; border-radius: 2px;"></div>
                            <span>Removed: ${state.orderStats.removedOrders}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to export data
        function exportData() {
            const data = {
                restaurantInfo: state.restaurantInfo,
                menuItems: state.menuItems,
                orders: state.orders,
                categories: state.categories,
                customization: state.customization,
                orderStats: state.orderStats,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = `dineeasy-backup-${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            showNotification("Data exported successfully.");
        }

        // Function to import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (confirm("Importing data will replace ALL current data. Are you sure?")) {
                        if (importedData.restaurantInfo) state.restaurantInfo = importedData.restaurantInfo;
                        if (importedData.menuItems) state.menuItems = importedData.menuItems;
                        if (importedData.orders) state.orders = importedData.orders;
                        if (importedData.categories) state.categories = importedData.categories;
                        if (importedData.customization) state.customization = importedData.customization;
                        if (importedData.orderStats) state.orderStats = importedData.orderStats;

                        saveToLocalStorage();

                        // Update UI
                        updateRestaurantUI();
                        displayMenuItems('all');
                        updateCategoryTabs();
                        applyCustomization();

                        // Reload admin panels
                        loadMenuItemsForAdmin();
                        loadCategoriesForAdmin();
                        loadOrdersForAdmin();
                        loadSystemStats();

                        showNotification("Data imported successfully.");
                    }
                } catch (error) {
                    showNotification("Error importing data. Invalid file format.");
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Function to setup system tools listeners
        function setupSystemTools() {
            // Clear Orders Buttons
            const clearBtn = document.getElementById('clearOrdersBtn');
            const clearBtnModal = document.getElementById('clearOrdersBtnModal');

            if (clearBtn) clearBtn.addEventListener('click', () => showAdminChangePrompt(clearAllOrders));
            if (clearBtnModal) clearBtnModal.addEventListener('click', () => showAdminChangePrompt(clearAllOrders));

            // Reset Menu Buttons
            const resetMenuBtn = document.getElementById('resetMenuBtn');
            const resetMenuBtnModal = document.getElementById('resetMenuBtnModal');

            if (resetMenuBtn) resetMenuBtn.addEventListener('click', () => showAdminChangePrompt(resetMenu));
            if (resetMenuBtnModal) resetMenuBtnModal.addEventListener('click', () => showAdminChangePrompt(resetMenu));

            // Export Data
            const exportBtn = document.getElementById('exportDataBtn');
            const exportBtnModal = document.getElementById('exportDataBtnModal');

            if (exportBtn) exportBtn.addEventListener('click', exportData);
            if (exportBtnModal) exportBtnModal.addEventListener('click', exportData);

            // Import Data
            const importBtn = document.getElementById('importDataBtn');
            const importInput = document.getElementById('importDataInput');
            const importBtnModal = document.getElementById('importDataBtnModal');
            const importInputModal = document.getElementById('importDataInputModal');

            if (importBtn && importInput) {
                importBtn.addEventListener('click', () => importInput.click());
                importInput.addEventListener('change', importData);
            }

            if (importBtnModal && importInputModal) {
                importBtnModal.addEventListener('click', () => importInputModal.click());
                importInputModal.addEventListener('change', importData);
            }
        }

        // UPDATED FUNCTION: Clear all orders from Firebase database
        function clearAllOrders() {
            if (confirm("Are you sure you want to PERMANENTLY DELETE ALL orders? This cannot be undone.")) {
                // 1. Clear local state
                state.orders = [];
                state.orderStats = {
                    totalOrders: 0,
                    totalRevenue: 0,
                    avgOrderValue: 0,
                    pendingOrders: 0,
                    preparingOrders: 0,
                    readyOrders: 0,
                    servedOrders: 0,
                    cancelledOrders: 0,
                    removedOrders: 0
                };

                // 2. Clear localStorage
                saveToLocalStorage();

                // 3. Clear Firestore Collection
                db.collection("orders").get().then((snapshot) => {
                    const batch = db.batch();
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                }).then(() => {
                    console.log("All orders deleted from Firebase");
                    showNotification("All orders have been cleared from database.");
                    
                    // 4. Update UI
                    loadOrdersForAdmin();
                    loadSystemStats();
                    updateOrderStats();
                }).catch((error) => {
                    console.error("Error clearing orders from Firebase: ", error);
                    showNotification("Orders cleared locally, but there was an error with Firebase.");
                    
                    // Still update UI even if Firebase failed
                    loadOrdersForAdmin();
                    loadSystemStats();
                    updateOrderStats();
                });
            }
        }

        // Function to reset menu
        function resetMenu() {
            if (confirm("This will delete your current menu and categories. Are you sure?")) {
                // In a real app we'd load defaults. Since we don't have them hardcoded here,
                // we'll just clear it for now or keep it as is.
                // For safety, let's just warn correct behavior.
                alert("Default menu data is not configured. Menu has not been changed.");

                // If we had defaults:
                // state.menuItems = [...defaultMenuItems];
                // saveToLocalStorage();
                // displayMenuItems('all');
                // ... sync to Firestore ...
            }
        }

        // Function to check URL for table parameter
        function checkURLForTable() {
            const urlParams = new URLSearchParams(window.location.search);
            const tableFromURL = urlParams.get('table');

            if (tableFromURL) {
                selectTable(tableFromURL);
                return true;
            }
            return false;
        }
        // Function to handle table selection
function selectTable(tableName) {
    state.currentTable = tableName;
    
    // Check if the selected table is the "Admin" portal
    if (tableName === 'Admin') {
        showAdminCodePrompt();
    } else {
        // For regular tables, go straight to the menu
        showSection('menuSection');
        updateTableInfo();
        showNotification(`Welcome! You are at ${tableName}`);
    }
}

        // Function to update restaurant UI
        function updateRestaurantUI() {
            restaurantName.textContent = state.restaurantInfo.name;
            menuTitle.textContent = state.restaurantInfo.name + " Menu";
            estimatedTime.textContent = state.restaurantInfo.estimatedPrepTime;

            // Update logo if available
            if (state.restaurantInfo.logoImage && state.restaurantInfo.logoImage.trim() !== '') {
                logoImage.src = state.restaurantInfo.logoImage;
                logoImage.style.display = 'block';
                logoIcon.style.display = 'none';
            } else {
                logoImage.style.display = 'none';
                logoIcon.style.display = 'block';
            }
        }

        // Function to update category tabs
        function updateCategoryTabs() {
            categoryTabs.innerHTML = '';

            // Add "All" tab if there are menu items
            const allTab = document.createElement('button');
            allTab.className = 'category-tab active';
            allTab.setAttribute('data-category', 'all');
            allTab.textContent = 'All';
            allTab.addEventListener('click', function () {
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                displayMenuItems('all');
            });
            categoryTabs.appendChild(allTab);

            // Add other categories
            const sortedCats = [...state.categories].sort((a,b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            sortedCats.forEach(cat => {
                const tab = document.createElement('button');
                tab.className = 'category-tab';
                tab.setAttribute('data-category', cat.id);
                tab.textContent = cat.displayName;
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    displayMenuItems(cat.id);
                });
                categoryTabs.appendChild(tab);
            });
        }

        // Function to show help notification
        function showHelpNotification() {
            if (state.currentTable) {
                showNotification(`A server has been notified and will be with you shortly at ${state.currentTable}.`);
            } else {
                showNotification('A server has been notified and will be with you shortly.');
            }
        }

        // Function to generate a random order number
        function generateOrderNumber() {
            const prefix = 'ORD';
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `${prefix}-${randomNum}`;
        }


       // UPDATED Function to calculate subtotal (now includes subcategory options)
        function calculateSubtotal() {
            return state.cart.reduce((sum, item) => {
                const itemPrice = item.totalPrice || (item.price * item.quantity);
                return sum + itemPrice;
            }, 0);
        }

        // Function to calculate total (same as subtotal since tax is already included)
        function calculateTotal() {
            return calculateSubtotal();
        }

        // UPDATED Function to show order confirmation (now includes subcategory options)
        function showOrderConfirmation(order) {
            orderNumberDisplay.textContent = order.orderNumber;
            confirmationTable.textContent = `Table: ${order.table}`;

            confirmationItems.innerHTML = '';
            order.items.forEach(item => {
                const itemTotal = item.totalPrice || (item.price * item.quantity);
                const orderItemElement = document.createElement('div');
                orderItemElement.className = 'order-item';
                
                let optionsHTML = '';
                if (item.selectedOptions && item.selectedOptions.length > 0) {
                    optionsHTML = '<div style="font-size: 13px; color: var(--gray); margin-left: 38px;">';
                    item.selectedOptions.forEach(opt => {
                        const priceText = opt.additionalPrice > 0 ? ` (+$${opt.additionalPrice.toFixed(2)})` : 
                                        opt.additionalPrice < 0 ? ` (-$${Math.abs(opt.additionalPrice).toFixed(2)})` : '';
                        optionsHTML += `${opt.subcategoryName}: ${opt.optionName}${priceText}<br>`;
                    });
                    optionsHTML += '</div>';
                }
                
                orderItemElement.innerHTML = `
                    <div class="order-item-name">
                        <div class="order-item-quantity">${item.quantity}</div>
                        <div>${item.name}</div>
                    </div>
                    <div class="order-item-price">$${itemTotal.toFixed(2)}</div>
                    ${optionsHTML}
                `;
                confirmationItems.appendChild(orderItemElement);
            });

            confirmationTotal.textContent = `$${order.total.toFixed(2)}`;

            const paymentMethodText = order.paymentMethod === 'card' ? 'Credit/Debit Card' : 'Cash';
            confirmationPaymentMethod.textContent = paymentMethodText;

            const paymentTimeText = order.paymentTime === 'now' ? 'Pay Now' : 'Pay Later';
            confirmationPaymentTime.textContent = paymentTimeText;

            // Show actual order status
            confirmationOrderStatus.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);

            // Color code based on status
            switch (order.status) {
                case 'pending':
                    confirmationOrderStatus.style.color = 'var(--warning)';
                    break;
                case 'preparing':
                    confirmationOrderStatus.style.color = '#0c5460';
                    break;
                case 'ready':
                    confirmationOrderStatus.style.color = 'var(--success)';
                    break;
                case 'served':
                    confirmationOrderStatus.style.color = '#004085';
                    break;
                case 'cancelled':
                    confirmationOrderStatus.style.color = 'var(--danger)';
                    break;
            }
        }

        // Function to reset cart only
        function resetCart() {
            state.cart = [];
            updateCart();
        }

        // Function to completely reset order
        function resetOrder() {
            state.cart = [];
            state.selectedPaymentMethod = null;
            state.selectedPaymentTime = null;
            state.currentOrderNumber = null;
            state.currentTable = null;

            updateCart();
            document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));

            tableInfo.innerHTML = `<i class="fas fa-qrcode"></i> Scan QR to begin`;
            menuSubtitle.textContent = 'Select items to add to your order';

            // Hide My Orders button
            myOrdersButton.style.display = 'none';
        }

        // Function to select a table
        function selectTable(tableName) {
            state.currentTable = tableName;

            // Check if the table is "Admin"
            if (tableName.toLowerCase() === "admin") {
                showAdminCodePrompt();
                return;
            } else {
                // Regular table selected
                tableInfo.innerHTML = `<i class="fas fa-chair"></i> ${tableName}`;
                menuSubtitle.textContent = `Select items to add to your order for ${tableName}`;
                cartSubtitle.textContent = `Your order for ${tableName}`;

                localStorage.setItem('dineEasyTable', tableName);

                showNotification(`Table ${tableName} selected. Welcome!`);

                resetCart();
                updateCategoryTabs();
                displayMenuItems('all');

                // Show My Orders button
                myOrdersButton.style.display = 'flex';

                showSection('menuSection');
            }
        }

        // Function to show a specific section
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.app-section, .admin-dashboard-section').forEach(section => {
                section.classList.remove('active-section');
                section.style.display = 'none';
            });

            // Show the requested section
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
                setTimeout(() => {
                    section.classList.add('active-section');
                }, 10);
            }

            // Update subtitles if needed
            if (sectionId === 'cartSection' && state.currentTable && !state.isAdminMode) {
                cartSubtitle.textContent = `Your order for ${state.currentTable}`;
            }

            if (sectionId === 'menuSection' && state.currentTable && !state.isAdminMode) {
                if (state.cart.length === 0) {
                    menuSubtitle.textContent = `Select items to add to your order for ${state.currentTable}`;
                } else {
                    menuSubtitle.textContent = `Continue adding items to your order for ${state.currentTable}`;
                }
            }

            if (sectionId === 'myOrdersSection' && state.currentTable && !state.isAdminMode) {
                loadMyOrders();
            }

            // Hide floating cart in admin mode
            if (state.isAdminMode) {
                cartFloating.style.display = 'none';
            } else if (sectionId !== 'scannerSection') {
                cartFloating.style.display = 'flex';
            }
        }

        // UPDATED Function to display menu items (now shows customizable badge)
        function displayMenuItems(category) {
            menuGrid.innerHTML = '';

            const filteredItems = category === 'all'
                ? state.menuItems
                : state.menuItems.filter(item => item.category === category);

            if (filteredItems.length === 0) {
                menuGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-utensils" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>No items in this category yet.</p>
                    </div>
                `;
                return;
            }

            filteredItems.forEach(item => {
                const menuItemElement = document.createElement('div');
                menuItemElement.className = 'menu-item';

                const imageStyle = item.image && item.image.trim() !== ''
                    ? `background-image: url('${item.image}')`
                    : 'background-color: var(--light-gray)';

                // Check if item has subcategories
                const hasSubcategories = item.subcategories && item.subcategories.length > 0;
                const customizableBadge = hasSubcategories ? 
                    '<span style="font-size: 11px; background-color: var(--success); color: white; padding: 2px 8px; border-radius: 10px; margin-left: 5px;">Customizable</span>' : '';

                menuItemElement.innerHTML = `
                    <div class="item-image" style="${imageStyle}"></div>
                    <div class="item-content">
                        <div class="item-header">
                            <div class="item-name">${item.name} ${customizableBadge}</div>
                            <div class="item-price">$${item.price.toFixed(2)}</div>
                        </div>
                        <div class="item-description">${item.description}</div>
                        <div class="item-footer">
                            <div class="item-tags">
                                ${item.tags.map(tag => `<span class="item-tag">${tag}</span>`).join('')}
                            </div>
                            <button class="add-to-cart" data-id="${item.id}">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;

                menuGrid.appendChild(menuItemElement);

                menuItemElement.querySelector('.add-to-cart').addEventListener('click', function () {
                    // NEW: Check if item has subcategories
                    if (hasSubcategories) {
                        showSubcategoryOptions(item.id);
                    } else {
                        addToCart(item.id);
                    }
                });
            });
        }

        // UPDATED Function to add an item to the cart (now handles items without subcategories)
        function addToCart(itemId) {
            if (state.isAdminMode) return;

            const menuItem = state.menuItems.find(item => item.id === itemId);
            if (!menuItem) return;

            const existingItem = state.cart.find(item => 
                item.id === itemId && 
                (!item.selectedOptions || item.selectedOptions.length === 0)
            );

            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.totalPrice = existingItem.price * existingItem.quantity;
            } else {
                state.cart.push({
                    id: menuItem.id,
                    name: menuItem.name,
                    price: menuItem.price,
                    quantity: 1,
                    selectedOptions: [],
                    additionalPrice: 0,
                    totalPrice: menuItem.price
                });
            }

            updateCart();
            showNotification(`${menuItem.name} added to cart`);

            // Play add to cart sound
            playAddToCartSound();
        }

        // UPDATED Function to update the cart display (now shows subcategory options)
        function updateCart() {
            if (state.isAdminMode) return;

            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;

            if (state.cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-cart" style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Your cart is empty</p>
                    </div>
                `;
            } else {
                cartItems.innerHTML = '';
                state.cart.forEach(item => {
                    const cartItemElement = document.createElement('div');
                    cartItemElement.className = 'cart-item';
                    
                    // Calculate item total
                    const itemTotal = item.totalPrice || (item.price * item.quantity);
                    
                    // NEW: Add subcategory options display
                    let optionsHTML = '';
                    if (item.selectedOptions && item.selectedOptions.length > 0) {
                        optionsHTML = '<div class="cart-subcategory-options">';
                        item.selectedOptions.forEach(opt => {
                            const priceText = opt.additionalPrice > 0 ? ` (+$${opt.additionalPrice.toFixed(2)})` : 
                                            opt.additionalPrice < 0 ? ` (-$${Math.abs(opt.additionalPrice).toFixed(2)})` : '';
                            optionsHTML += `<span class="cart-subcategory-option">${opt.subcategoryName}: ${opt.optionName}${priceText}</span>`;
                        });
                        optionsHTML += '</div>';
                    }
                    
                    cartItemElement.innerHTML = `
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">$${itemTotal.toFixed(2)}</div>
                            ${optionsHTML}
                        </div>
                        <div class="cart-item-controls">
                            <div class="quantity-control">
                                <button class="quantity-btn decrease" data-id="${item.id}" data-has-options="${item.selectedOptions && item.selectedOptions.length > 0 ? 'true' : 'false'}">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="quantity-btn increase" data-id="${item.id}" data-has-options="${item.selectedOptions && item.selectedOptions.length > 0 ? 'true' : 'false'}">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="remove-item" data-id="${item.id}" data-has-options="${item.selectedOptions && item.selectedOptions.length > 0 ? 'true' : 'false'}">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    `;
                    cartItems.appendChild(cartItemElement);
                });

                document.querySelectorAll('.decrease').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const itemId = parseInt(this.getAttribute('data-id'));
                        const hasOptions = this.getAttribute('data-has-options') === 'true';
                        updateCartItemQuantity(itemId, -1, hasOptions);
                    });
                });

                document.querySelectorAll('.increase').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const itemId = parseInt(this.getAttribute('data-id'));
                        const hasOptions = this.getAttribute('data-has-options') === 'true';
                        updateCartItemQuantity(itemId, 1, hasOptions);
                    });
                });

                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const itemId = parseInt(this.getAttribute('data-id'));
                        const hasOptions = this.getAttribute('data-has-options') === 'true';
                        removeFromCart(itemId, hasOptions);
                    });
                });
            }

            updateCartSummary();
        }

        // UPDATED Function to update cart item quantity (now handles items with options)
        function updateCartItemQuantity(itemId, change, hasOptions = false) {
            let item;
            
            if (hasOptions) {
                // For items with options, we need to find the exact match
                // This is handled by the click event which passes the specific item
                // For now, we'll find the first matching item
                item = state.cart.find(item => item.id === itemId);
            } else {
                item = state.cart.find(item => item.id === itemId && (!item.selectedOptions || item.selectedOptions.length === 0));
            }

            if (item) {
                item.quantity += change;

                if (item.quantity <= 0) {
                    if (hasOptions) {
                        state.cart = state.cart.filter(cartItem => 
                            !(cartItem.id === itemId && 
                              JSON.stringify(cartItem.selectedOptions) === JSON.stringify(item.selectedOptions))
                        );
                    } else {
                        state.cart = state.cart.filter(cartItem => 
                            !(cartItem.id === itemId && 
                              (!cartItem.selectedOptions || cartItem.selectedOptions.length === 0))
                        );
                    }
                } else {
                    // Update total price
                    item.totalPrice = (item.price + item.additionalPrice) * item.quantity;
                }

                updateCart();
            }
        }

        // UPDATED Function to remove an item from cart (now handles items with options)
        function removeFromCart(itemId, hasOptions = false) {
            let item;
            
            if (hasOptions) {
                // For items with options, we need to find the exact match
                item = state.cart.find(item => item.id === itemId);
            } else {
                item = state.cart.find(item => item.id === itemId && (!item.selectedOptions || item.selectedOptions.length === 0));
            }
            
            if (item) {
                if (hasOptions) {
                    state.cart = state.cart.filter(cartItem => 
                        !(cartItem.id === itemId && 
                          JSON.stringify(cartItem.selectedOptions) === JSON.stringify(item.selectedOptions))
                    );
                } else {
                    state.cart = state.cart.filter(cartItem => 
                        !(cartItem.id === itemId && 
                          (!cartItem.selectedOptions || cartItem.selectedOptions.length === 0))
                    );
                }
                
                updateCart();
                showNotification(`${item.name} removed from cart`);
            }
        }

        // Function to update cart summary
        function updateCartSummary() {
            const subtotal = calculateSubtotal();
            const total = calculateTotal();

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        // Function to update payment summary
        function updatePaymentSummary() {
            const subtotal = calculateSubtotal();
            const total = calculateTotal();

            document.getElementById('paymentSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('paymentTotal').textContent = `$${total.toFixed(2)}`;
        }

        // Function to show notification
        function showNotification(message) {
            notificationText.textContent = message;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Helper function to darken a color
        function darkenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;

            return "#" + (
                0x1000000 +
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }

        // Helper function to get contrast color (white or black)
        function getContrastColor(hexcolor) {
            const r = parseInt(hexcolor.substr(1, 2), 16);
            const g = parseInt(hexcolor.substr(3, 2), 16);
            const b = parseInt(hexcolor.substr(5, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }

        // --- FIREBASE INTEGRATION FUNCTIONS ---

        // Function to subscribe to orders from Firestore
        function subscribeToOrders() {
            // Listen to 'orders' collection
            db.collection("orders").onSnapshot((snapshot) => {
                const cloudOrders = [];
                snapshot.forEach((doc) => {
                    cloudOrders.push(doc.data());
                });

                // Update local state by replacing with cloud data
                // This ensures all clients are in sync
                state.orders = cloudOrders;
                state.lastOrderUpdate = state.orders.length;

                // Update Storage as backup
                saveToLocalStorage();

                // Update UI based on new data
                updateOrderStats();
                loadSystemStats();

                // If we are in Admin Mode, refresh the list
                if (state.isAdminMode) {
                    loadOrdersForAdmin();
                }

                // If we are a customer, refresh 'My Orders'
                if (!state.isAdminMode && state.currentTable) {
                    loadMyOrders();
                }

            }, (error) => {
                console.error("Error getting real-time updates: ", error);
            });
        }

        // Function to save a single order to Firestore
        function saveOrderToFirestore(order) {
            db.collection("orders").doc(order.orderNumber).set(order)
                .then(() => {
                    console.log("Order written to database!");
                })
                .catch((error) => {
                    console.error("Error writing order: ", error);
                    showNotification("Error saving order to cloud. Please try again.");
                });
        }

        // Function to update order status in Firestore
        function updateOrderStatusInFirestore(orderNumber, newStatus) {
            db.collection("orders").doc(orderNumber).update({
                status: newStatus
            }).catch((error) => {
                console.error("Error updating status: ", error);
            });
        }

        // Function to subscribe to ALL restaurant data (Logo, Menu, Theme, etc.)
        function subscribeToRestaurantData() {
            // 1. Restaurant Info (Name, Logo, Tax, etc.)
            db.collection("settings").doc("restaurant").onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    // Merge with local state to preserve defaults if missing
                    state.restaurantInfo = { ...state.restaurantInfo, ...data };

                    // Force update UI
                    updateRestaurantUI();

                    // Small delay to ensure DOM is ready for some updates
                    setTimeout(updateRestaurantUI, 100);
                } else {
                    // Migration: If cloud doc doesn't exist, upload our local copy
                    // This handles the "Keep everything" request
                    console.log("Uploading local restaurant info to cloud...");
                    db.collection("settings").doc("restaurant").set(state.restaurantInfo);
                }
            });

            // 2. Customization (Theme, Fonts, Colors)
            db.collection("settings").doc("theme").onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    state.customization = { ...state.customization, ...data };
                    state.currentTheme = data.currentTheme || state.currentTheme;
                    state.currentFont = data.currentFont || state.currentFont;

                    applyCustomization();
                } else {
                    // Migration: If cloud theme doesn't exist, upload local
                    console.log("Uploading local theme to cloud...");
                    // Add current theme/font IDs to the customization object for saving
                    const themeToSave = {
                        ...state.customization,
                        currentTheme: state.currentTheme,
                        currentFont: state.currentFont
                    };
                    db.collection("settings").doc("theme").set(themeToSave);
                }
            });

            // 3. Categories
            db.collection("categories").onSnapshot((snapshot) => {
                if (!snapshot.empty) {
                    const cloudCategories = [];
                    snapshot.forEach(doc => cloudCategories.push(doc.data()));
                    state.categories = cloudCategories;
                    updateCategoryTabs();
                } else if (state.categories.length > 0) {
                    // Migration: Upload local categories
                    console.log("Uploading local categories to cloud...");
                    state.categories.forEach(cat => {
                        db.collection("categories").doc(cat.id).set(cat);
                    });
                }
            });

            // 4. Menu Items with Subcategories
            db.collection("menu").onSnapshot((snapshot) => {
                if (!snapshot.empty) {
                    const cloudItems = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        cloudItems.push(data);
                    });
                    
                    // IMPORTANT: Replace local menu items with cloud data
                    state.menuItems = cloudItems;

                    // Ensure all menu items have subcategories array if not present
                    state.menuItems.forEach(item => {
                        if (!item.subcategories) {
                            item.subcategories = [];
                        }
                        // Ensure all subcategories have proper structure
                        if (item.subcategories) {
                            item.subcategories.forEach(subcategory => {
                                if (!subcategory.id) subcategory.id = `subcategory-${Date.now()}`;
                                if (!subcategory.options) subcategory.options = [];
                                subcategory.options.forEach(option => {
                                    if (!option.id) option.id = `option-${Date.now()}`;
                                });
                            });
                        }
                    });

                    // Refresh displays
                    displayMenuItems('all');

                    // If Admin, refresh admin list
                    if (state.isAdminMode) {
                        loadMenuItemsForAdmin();
                    }
                    
                    // Save to localStorage as backup
                    saveToLocalStorage();
                    
                } else if (state.menuItems.length > 0) {
                    // Migration: Upload local menu items (including subcategories) to cloud
                    console.log("Uploading local menu items with subcategories to cloud...");
                    state.menuItems.forEach(item => {
                        // Ensure ID is string for doc name, or use numeric ID
                        db.collection("menu").doc(item.id.toString()).set(item);
                    });
                }
            });
        }

    </script>

</body>

</html>
