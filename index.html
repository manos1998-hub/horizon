<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Dining App - Firebase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* ========== COMPLETE ORIGINAL STYLES ========== */
        :root {
            --primary: #e63946;
            --primary-dark: #c1121f;
            --secondary: #457b9d;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success: #2a9d8f;
            --warning: #e9c46a;
            --danger: #dc3545;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --admin: #6c757d;
            --background: #fefefe;
            --text: #212529;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
            --menu-bg: #ffffff;
            --cart-bg: #ffffff;
            --payment-bg: #ffffff;
            --button-text: #ffffff;
            --font-primary: 'Poppins', sans-serif;
            --font-secondary: 'Playfair Display', serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-primary); background-color: var(--background); color: var(--text); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header { background-color: var(--header-bg); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; position: relative; }
        .logo { font-family: var(--font-secondary); font-size: 36px; font-weight: 600; color: var(--primary); display: flex; align-items: center; flex: 1; }
        .logo i { margin-right: 10px; }
        .logo-img { width: 70px; height: 70px; border-radius: 8px; margin-right: 12px; object-fit: cover; display: none; }
        .header-center { display: flex; justify-content: center; flex: 1; }
        .help-button { background-color: transparent; border: 2px solid var(--secondary); color: var(--secondary); padding: 8px 20px; border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .help-button:hover { background-color: var(--secondary); color: var(--button-text); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(69, 123, 157, 0.2); }
        .header-right { display: flex; justify-content: flex-end; align-items: center; flex: 1; gap: 15px; }
        .my-orders-button { background-color: var(--secondary); color: var(--button-text); border: none; padding: 8px 16px; border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 15px; white-space: nowrap; }
        .my-orders-button:hover { background-color: var(--secondary); filter: brightness(0.9); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(69, 123, 157, 0.2); }
        .table-info { background-color: var(--light-gray); padding: 8px 16px; border-radius: 50px; font-weight: 500; display: flex; align-items: center; }
        .table-info i { margin-right: 8px; color: var(--secondary); }
        .app-section { display: none; padding: 30px 0; min-height: calc(100vh - 80px); background-color: var(--background); }
        .active-section { display: block; }
        .scanner-section { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .scanner-container { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 40px; width: 100%; max-width: 500px; margin: 20px auto; }
        .qr-placeholder { width: 250px; height: 250px; background: linear-gradient(45deg, var(--light-gray), var(--card-bg)); border-radius: 12px; margin: 30px auto; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .qr-placeholder::before { content: ""; position: absolute; width: 100%; height: 100%; background-image: linear-gradient(90deg, transparent 49%, rgba(0,0,0,0.05) 50%, transparent 51%), linear-gradient(transparent 49%, rgba(0,0,0,0.05) 50%, transparent 51%); background-size: 30px 30px; }
        .qr-placeholder i { font-size: 70px; color: var(--gray); margin-bottom: 15px; z-index: 1; }
        .qr-placeholder span { color: var(--gray); font-size: 16px; z-index: 1; }
        .demo-tables { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 30px; }
        .table-btn { padding: 12px 24px; background-color: var(--card-bg); border: 2px solid var(--light-gray); border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s; color: var(--text); }
        .table-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .section-title { font-family: var(--font-secondary); font-size: 32px; margin-bottom: 10px; color: var(--text); }
        .section-subtitle { color: var(--gray); margin-bottom: 30px; font-size: 16px; }
        .category-tabs { display: flex; overflow-x: auto; margin-bottom: 30px; padding-bottom: 5px; }
        .category-tab { padding: 10px 20px; background-color: var(--card-bg); border: none; border-bottom: 3px solid transparent; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.3s; color: var(--text); }
        .category-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .menu-item { background-color: var(--card-bg); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: transform 0.3s; }
        .menu-item:hover { transform: translateY(-5px); }
        .item-image { height: 180px; background-color: var(--light-gray); background-size: cover; background-position: center; position: relative; }
        .item-content { padding: 20px; }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .item-name { font-size: 18px; font-weight: 600; color: var(--text); }
        .item-price { color: var(--primary); font-weight: 600; font-size: 18px; }
        .item-description { color: var(--gray); font-size: 14px; margin-bottom: 15px; }
        .item-footer { display: flex; justify-content: space-between; align-items: center; }
        .item-tags { display: flex; gap: 5px; }
        .item-tag { font-size: 11px; padding: 3px 8px; border-radius: 20px; background-color: var(--light-gray); color: var(--text); }
        .add-to-cart { background-color: var(--primary); color: var(--button-text); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.3s; }
        .add-to-cart:hover { background-color: var(--primary-dark); }
        .cart-container { display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; }
        .cart-items { background-color: var(--cart-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 25px; margin-bottom: 25px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--light-gray); }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-name { font-weight: 500; margin-bottom: 5px; color: var(--text); }
        .cart-item-price { color: var(--primary); font-weight: 500; }
        .cart-item-controls { display: flex; align-items: center; gap: 15px; }
        .quantity-control { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { width: 30px; height: 30px; border-radius: 50%; background-color: var(--light-gray); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); }
        .quantity { font-weight: 500; min-width: 20px; text-align: center; color: var(--text); }
        .remove-item { color: var(--gray); cursor: pointer; transition: color 0.3s; }
        .remove-item:hover { color: var(--primary); }
        .cart-summary { background-color: var(--cart-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 25px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; color: var(--text); }
        .summary-total { font-size: 20px; font-weight: 600; border-top: 2px solid var(--light-gray); padding-top: 15px; margin-top: 10px; }
        .summary-total .amount { color: var(--primary); }
        .payment-container { max-width: 600px; margin: 0 auto; }
        .payment-options { background-color: var(--payment-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; margin-bottom: 25px; }
        .option-group { margin-bottom: 30px; }
        .option-group:last-child { margin-bottom: 0; }
        .option-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--text); }
        .option-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .option-card { border: 2px solid var(--light-gray); border-radius: 10px; padding: 20px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; text-align: center; background-color: var(--card-bg); color: var(--text); }
        .option-card:hover { border-color: var(--primary); }
        .option-card.selected { border-color: var(--primary); background-color: rgba(230, 57, 70, 0.05); }
        .option-icon { font-size: 28px; margin-bottom: 10px; color: var(--secondary); }
        .option-name { font-weight: 500; margin-bottom: 5px; }
        .option-desc { font-size: 13px; color: var(--gray); }
        .payment-actions { display: flex; justify-content: space-between; margin-top: 30px; }
        .btn { padding: 15px 30px; border-radius: 8px; font-weight: 500; cursor: pointer; border: none; font-size: 16px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: var(--primary); color: var(--button-text); }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--card-bg); color: var(--text); border: 2px solid var(--light-gray); }
        .btn-secondary:hover { border-color: var(--gray); }
        .btn-success { background-color: var(--success); color: var(--button-text); }
        .btn-success:hover { background-color: #21867a; }
        .btn-danger { background-color: var(--danger); color: var(--button-text); }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: var(--warning); color: var(--text); }
        .btn-warning:hover { background-color: #d4ac2e; }
        .btn-help { background-color: var(--secondary); color: var(--button-text); border: none; }
        .btn-help:hover { background-color: #386c8a; }
        .btn i { margin-right: 8px; }
        .my-orders-container { max-width: 900px; margin: 0 auto; }
        .orders-list { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .order-card { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; transition: transform 0.3s; }
        .order-card:hover { transform: translateY(-3px); }
        .order-card-header { padding: 20px; border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; background-color: var(--light); }
        .order-card-title { font-size: 18px; font-weight: 600; color: var(--text); }
        .order-card-time { font-size: 14px; color: var(--gray); }
        .order-card-body { padding: 20px; }
        .order-items-summary { margin-bottom: 15px; }
        .order-item-summary { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--light-gray); color: var(--text); }
        .order-item-summary:last-child { border-bottom: none; }
        .order-item-summary-name { display: flex; align-items: center; gap: 10px; }
        .order-item-summary-quantity { background-color: var(--light-gray); color: var(--text); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        .order-card-footer { padding: 15px 20px; background-color: var(--light); border-top: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center; }
        .order-total-summary { font-weight: 600; color: var(--primary); }
        .order-status-badge { display: inline-block; padding: 6px 15px; border-radius: 20px; font-size: 13px; font-weight: 500; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-preparing { background-color: #d1ecf1; color: #0c5460; }
        .status-ready { background-color: #d4edda; color: #155724; }
        .status-served { background-color: #cce5ff; color: #004085; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .no-orders-message { text-align: center; padding: 60px 20px; color: var(--gray); }
        .no-orders-message i { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }
        .no-orders-message h3 { margin-bottom: 10px; font-size: 22px; }
        .confirmation-container { max-width: 700px; margin: 0 auto; }
        .confirmation-card { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 40px; margin-bottom: 25px; text-align: center; }
        .confirmation-icon { width: 80px; height: 80px; background-color: rgba(42, 157, 143, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; }
        .confirmation-icon i { font-size: 36px; color: var(--success); }
        .order-number { font-size: 28px; font-weight: 600; color: var(--text); margin-bottom: 10px; }
        .order-number span { color: var(--primary); }
        .order-message { color: var(--gray); margin-bottom: 30px; font-size: 16px; }
        .order-details { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; margin-bottom: 25px; }
        .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--light-gray); }
        .details-title { font-size: 20px; font-weight: 600; color: var(--text); }
        .details-table { font-weight: 500; color: var(--secondary); }
        .order-items { margin-bottom: 30px; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--light-gray); color: var(--text); }
        .order-item:last-child { border-bottom: none; }
        .order-item-name { display: flex; align-items: center; gap: 10px; }
        .order-item-quantity { background-color: var(--light-gray); color: var(--text); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; }
        .order-item-price { font-weight: 500; }
        .order-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: 600; padding-top: 15px; margin-top: 15px; border-top: 2px solid var(--light-gray); color: var(--text); }
        .order-total .amount { color: var(--primary); }
        .payment-details { background-color: rgba(69, 123, 157, 0.05); border-radius: 10px; padding: 20px; margin-top: 25px; }
        .payment-details-title { font-weight: 600; margin-bottom: 15px; color: var(--secondary); }
        .payment-info { display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--text); }
        .payment-info:last-child { margin-bottom: 0; }
        .info-label { color: var(--gray); }
        .info-value { font-weight: 500; }
        .estimated-time { background-color: rgba(233, 196, 106, 0.1); border-radius: 10px; padding: 20px; margin-top: 25px; display: flex; align-items: center; gap: 15px; }
        .time-icon { font-size: 24px; color: var(--warning); }
        .time-text { font-size: 15px; color: var(--text); }
        .time-text strong { color: var(--text); }
        .cart-floating { position: fixed; bottom: 30px; right: 30px; background-color: var(--primary); color: var(--button-text); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; box-shadow: 0 6px 20px rgba(230, 57, 70, 0.3); z-index: 99; transition: all 0.3s; }
        .cart-floating:hover { background-color: var(--primary-dark); transform: translateY(-3px); }
        .cart-count { position: absolute; top: -5px; right: -5px; background-color: var(--secondary); color: var(--button-text); width: 24px; height: 24px; border-radius: 50%; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .admin-mode header { border-bottom: 3px solid var(--warning); }
        .admin-mode .admin-badge { background-color: var(--warning); color: var(--text); padding: 8px 16px; border-radius: 50px; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .admin-mode .logout-button { background-color: var(--danger); color: var(--button-text); border: none; padding: 8px 16px; border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .logout-button:hover { background-color: #c82333; transform: translateY(-2px); }
        .admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .admin-container { background-color: var(--card-bg); border-radius: var(--radius); width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative; }
        .admin-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; color: var(--gray); cursor: pointer; }
        .admin-tabs { display: flex; border-bottom: 2px solid var(--light-gray); margin-bottom: 25px; overflow-x: auto; }
        .admin-tab { padding: 12px 25px; background: none; border: none; font-weight: 500; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; color: var(--text); white-space: nowrap; }
        .admin-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .admin-content { display: none; }
        .admin-content.active { display: block; }
        .admin-form-group { margin-bottom: 20px; }
        .admin-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text); }
        .admin-input, .admin-textarea, .admin-select { width: 100%; padding: 10px 15px; border: 1px solid var(--light-gray); border-radius: 8px; font-family: var(--font-primary); font-size: 14px; background-color: var(--card-bg); color: var(--text); }
        .admin-textarea { min-height: 100px; resize: vertical; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .admin-card { background-color: var(--light); border-radius: 10px; padding: 20px; border: 1px solid var(--light-gray); transition: all 0.2s; }
        .admin-card:active { opacity: 0.7; }
        .admin-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .admin-card-title { font-weight: 600; font-size: 16px; color: var(--text); }
        .admin-card-actions { display: flex; gap: 8px; }
        .admin-small-btn { padding: 5px 10px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; }
        .tag-input-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .tag-display { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .tag-item { background-color: var(--light-gray); padding: 3px 8px; border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 5px; color: var(--text); }
        .categories-management { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .categories-list { flex: 1; min-width: 300px; }
        .add-category-form { flex: 1; min-width: 300px; }
        .categories-list-container { background-color: var(--light); border-radius: 10px; padding: 20px; max-height: 300px; overflow-y: auto; }
        .category-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--card-bg); border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--light-gray); }
        .category-item:last-child { margin-bottom: 0; }
        .category-item-name { font-weight: 500; color: var(--text); }
        .category-item-count { background-color: var(--light-gray); color: var(--text); padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .theme-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; max-height: 500px; overflow-y: auto; padding: 10px; }
        .theme-card { border: 2px solid var(--light-gray); border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s; background-color: var(--card-bg); }
        .theme-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .theme-card.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2); }
        .theme-colors-preview { height: 100px; display: grid; grid-template-columns: repeat(5, 1fr); }
        .theme-info { padding: 15px; text-align: center; }
        .theme-name { font-weight: 600; margin-bottom: 5px; color: var(--text); }
        .theme-category { font-size: 12px; color: var(--gray); background-color: var(--light-gray); padding: 2px 8px; border-radius: 10px; display: inline-block; }
        .theme-preview-small { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .theme-preview-small div { height: 4px; border-radius: 2px; }
        .customization-panel { display: flex; flex-direction: column; gap: 30px; }
        .customization-section { background-color: var(--light); border-radius: var(--radius); padding: 25px; box-shadow: var(--shadow); }
        .section-title-small { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .font-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .font-option { padding: 20px; border-radius: 10px; border: 2px solid var(--light-gray); background-color: var(--card-bg); cursor: pointer; transition: all 0.3s; text-align: left; }
        .font-option:hover { border-color: var(--primary); transform: translateY(-2px); }
        .font-option.selected { border-color: var(--primary); background-color: rgba(230, 57, 70, 0.1); }
        .font-preview-large { font-size: 20px; font-weight: 600; margin-bottom: 10px; }
        .font-details { font-size: 14px; color: var(--gray); }
        .color-customization { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .color-option { padding: 15px; border-radius: 10px; background-color: var(--card-bg); border: 1px solid var(--light-gray); }
        .color-label { font-weight: 600; margin-bottom: 10px; display: block; color: var(--text); }
        .color-preview { width: 100%; height: 40px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.1); }
        .color-input-group { display: flex; align-items: center; gap: 10px; }
        .color-input { width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer; background: none; }
        .color-value { font-family: monospace; font-size: 14px; flex: 1; }
        .customization-preview { background-color: var(--card-bg); border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow); border: 2px solid var(--light-gray); margin-top: 20px; }
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray); }
        .preview-restaurant-name { font-family: var(--font-secondary); font-size: 22px; font-weight: 600; color: var(--primary); }
        .preview-content-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .preview-card { padding: 20px; border-radius: 10px; background-color: var(--light-gray); margin-bottom: 15px; }
        .preview-menu-item { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .preview-button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .preview-btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; border: none; }
        .customization-actions { display: flex; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray); }
        .image-upload-container { margin-bottom: 20px; }
        .image-preview { width: 100%; height: 200px; background-color: var(--light-gray); border-radius: 8px; margin-top: 10px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        .image-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-preview-placeholder { text-align: center; color: var(--gray); }
        .image-preview-placeholder i { font-size: 48px; margin-bottom: 10px; opacity: 0.5; }
        .upload-actions { display: flex; gap: 10px; margin-top: 10px; }
        .upload-btn { flex: 1; }
        .remove-image-btn { background-color: var(--light-gray); color: var(--text); border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .remove-image-btn:hover { background-color: var(--gray); color: var(--button-text); }
        .notification { position: fixed; top: 100px; right: 30px; background-color: var(--card-bg); color: var(--text); padding: 15px 25px; border-radius: 8px; box-shadow: var(--shadow); display: flex; align-items: center; z-index: 1000; transform: translateX(150%); transition: transform 0.5s; border-left: 4px solid var(--success); }
        .notification.show { transform: translateX(0); }
        .notification i { margin-right: 10px; color: var(--success); font-size: 20px; }
        .admin-dashboard-section { display: none; padding: 30px 0; min-height: calc(100vh - 80px); }
        .admin-dashboard-section.active-section { display: block; }
        .admin-dashboard-container { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; width: 100%; }
        .admin-code-prompt { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .admin-code-container { background-color: var(--card-bg); border-radius: var(--radius); width: 100%; max-width: 400px; padding: 40px; text-align: center; box-shadow: var(--shadow); }
        .admin-code-icon { width: 80px; height: 80px; background-color: rgba(233, 196, 106, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; }
        .admin-code-icon i { font-size: 36px; color: var(--warning); }
        .admin-code-title { font-size: 24px; font-weight: 600; margin-bottom: 15px; color: var(--text); }
        .admin-code-subtitle { color: var(--gray); margin-bottom: 25px; }
        .admin-code-input { width: 100%; padding: 15px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 18px; text-align: center; letter-spacing: 3px; margin-bottom: 20px; font-family: 'Poppins', monospace; background-color: var(--card-bg); color: var(--text); }
        .admin-code-input:focus { border-color: var(--primary); outline: none; }

        /* ===== NEW STYLES FOR SUBCATEGORIES (OPTIONS) ===== */
        .item-options-indicator { font-size: 12px; color: var(--secondary); margin-top: 8px; display: flex; align-items: center; gap: 5px; }
        .item-options-indicator i { font-size: 12px; }
        .options-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2001; display: none; align-items: center; justify-content: center; padding: 20px; }
        .options-modal-container { background-color: var(--card-bg); border-radius: var(--radius); max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 30px; box-shadow: var(--shadow); }
        .options-modal-title { font-family: var(--font-secondary); font-size: 24px; margin-bottom: 5px; color: var(--text); }
        .options-modal-price { color: var(--primary); font-weight: 600; font-size: 20px; margin-bottom: 20px; }
        .option-group { margin-bottom: 25px; border-bottom: 1px solid var(--light-gray); padding-bottom: 20px; }
        .option-group-title { font-weight: 600; margin-bottom: 15px; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .option-group-title i { color: var(--secondary); }
        .choice-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-left: 10px; }
        .choice-label { display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1; }
        .choice-name { color: var(--text); }
        .choice-price { color: var(--gray); font-size: 14px; }
        .choice-price-positive { color: var(--success); }
        .choice-price-negative { color: var(--danger); }
        .options-total { margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--light-gray); display: flex; justify-content: space-between; font-size: 18px; font-weight: 600; }
        .options-total-amount { color: var(--primary); }
        .options-modal-actions { display: flex; gap: 15px; margin-top: 25px; }
        .option-group-radio, .option-group-checkbox { display: flex; flex-direction: column; gap: 8px; }
        .admin-options-section { margin-top: 25px; padding: 20px; background-color: var(--light); border-radius: 10px; }
        .admin-option-group { background-color: var(--card-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--light-gray); }
        .admin-option-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .admin-option-group-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .admin-choice-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .admin-choice-input { flex: 1; }
        .admin-choice-price { width: 100px; }
        .add-choice-btn { margin-top: 10px; }
        /* ===== NEW STYLE FOR COMMENT FIELDS ===== */
        .comment-field { margin: 10px 0; }
        .comment-field textarea { width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: 8px; font-family: var(--font-primary); resize: vertical; }
        /* ===== DRAG AND DROP STYLES ===== */
        .admin-card.dragging { opacity: 0.5; cursor: grabbing; }
        .admin-card[draggable="true"] { cursor: grab; }
        .admin-card[draggable="true"]:active { cursor: grabbing; }
        .drag-handle { cursor: grab; padding: 5px; margin-right: 8px; color: var(--gray); }

        @media (max-width: 992px) { .theme-gallery { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); } .font-options { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
        @media (max-width: 768px) { 
            .theme-gallery { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); } 
            .preview-content-grid { grid-template-columns: 1fr; } 
            .customization-actions { flex-direction: column; } 
            .payment-actions { flex-direction: column; gap: 15px; } 
            .btn { width: 100%; } 
            .cart-floating { bottom: 20px; right: 20px; width: 55px; height: 55px; } 
            .confirmation-card, .order-details { padding: 25px 20px; } 
            .details-header { flex-direction: column; align-items: flex-start; gap: 10px; } 
            .nav-container { flex-direction: column; gap: 15px; padding: 15px 0; } 
            .logo, .header-center, .header-right { width: 100%; justify-content: center; } 
            .header-center { order: 3; margin-top: 10px; } 
            .help-button { width: 100%; justify-content: center; } 
            .header-right { flex-direction: column; gap: 10px; } 
            .my-orders-button { width: 100%; justify-content: center; } 
            .table-info { margin-top: 10px; width: 100%; justify-content: center; } 
            .admin-container { padding: 20px 15px; } 
            .admin-tabs { flex-wrap: wrap; } 
            .admin-tab { padding: 10px 15px; font-size: 14px; } 
            .categories-management { flex-direction: column; } 
            .upload-actions { flex-direction: column; } 
            .color-customization { grid-template-columns: 1fr; } 
            .options-modal-container { padding: 20px; } 
            .choice-item { flex-direction: column; align-items: flex-start; gap: 5px; } 
            .options-modal-actions { flex-direction: column; } 
        }
        @media (max-width: 480px) { 
            .theme-gallery { grid-template-columns: repeat(2, 1fr); } 
            .scanner-container { padding: 25px 20px; } 
            .qr-placeholder { width: 200px; height: 200px; } 
            .section-title { font-size: 26px; } 
            .option-cards { grid-template-columns: 1fr; } 
            .order-number { font-size: 24px; } 
            .help-button { padding: 8px 15px; font-size: 14px; } 
            .my-orders-button { padding: 8px 15px; font-size: 14px; } 
            .theme-previews { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>
    <!-- ========== HEADER ========== -->
    <header>
        <div class="container nav-container">
            <div class="logo" id="restaurantLogo">
                <img src="" alt="Restaurant Logo" class="logo-img" id="logoImage">
                <i class="fas fa-utensils" id="logoIcon"></i>
                <span id="restaurantName">DineEasy</span>
            </div>
            <div class="header-center">
                <button class="help-button" id="headerHelpButton">
                    <i class="fas fa-headset"></i> Χρειάζεστε βοήθεια?
                </button>
            </div>
            <div class="header-right">
                <button class="my-orders-button" id="myOrdersButton" style="display: none;">
                    <i class="fas fa-clipboard-list"></i> Οι Παραγγελίες μου
                </button>
                <div class="table-info" id="tableInfo">
                    <i class="fas fa-qrcode"></i> Scan QR to begin
                </div>
            </div>
        </div>
    </header>

    <!-- ========== MAIN SECTIONS ========== -->
    <section id="scannerSection" class="app-section active-section">
        <div class="container scanner-section">
            <div class="scanner-container">
                <h2 class="section-title">Scan Table QR Code</h2>
                <p class="section-subtitle">Point your camera at the QR code on your table to get started</p>
                <div class="qr-placeholder">
                    <i class="fas fa-qrcode"></i>
                    <span>QR Scanner Area</span>
                </div>
                <p style="margin: 20px 0; color: var(--gray);">For demo purposes, select a table:</p>
                <div class="demo-tables">
                    <button class="table-btn" data-table="Table 1">Table 1</button>
                    <button class="table-btn" data-table="Table 2">Table 2</button>
                    <button class="table-btn" data-table="Table 3">Table 3</button>
                    <button class="table-btn" data-table="Table 4">Table 4</button>
                    <button class="table-btn" data-table="Table 5">Table 5</button>
                    <button class="table-btn" data-table="VIP Table">VIP Table</button>
                    <button class="table-btn" data-table="Admin" style="border-color: var(--warning); color: var(--warning);">Admin</button>
                </div>
                <p style="margin-top: 30px; font-size: 14px; color: var(--gray);"><i class="fas fa-info-circle"></i> Once scanned, you'll be able to view the menu and place your order.</p>
                <p style="margin-top: 10px; font-size: 14px; color: var(--warning);"><i class="fas fa-shield-alt"></i> Select "Admin" table to access the admin panel (requires code).</p>
            </div>
        </div>
    </section>

    <section id="menuSection" class="app-section">
        <div class="container">
            <h2 class="section-title" id="menuTitle">Our Menu</h2>
            <p class="section-subtitle" id="menuSubtitle">Select items to add to your order</p>
            <div class="category-tabs" id="categoryTabs"></div>
            <div class="menu-grid" id="menuGrid"></div>
        </div>
    </section>

    <section id="cartSection" class="app-section">
        <div class="container">
            <h2 class="section-title">Your Order</h2>
            <p class="section-subtitle" id="cartSubtitle">Review your order before payment</p>
            <div class="cart-container">
                <div class="cart-items" id="cartItems">
                    <div class="empty-cart" style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Your cart is empty</p>
                    </div>
                </div>
                <div class="cart-summary">
                    <div class="summary-row"><span>Subtotal (tax included)</span><span id="subtotal">$0.00</span></div>
                    <div class="summary-row summary-total"><span>Total</span><span class="amount" id="total">$0.00</span></div>
                    <div class="payment-actions">
                        <button class="btn btn-secondary" id="backToMenuBtn"><i class="fas fa-arrow-left"></i> Πίσω στο Μενού</button>
                        <button class="btn btn-primary" id="proceedToPaymentBtn">Proceed to Payment <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="paymentSection" class="app-section">
        <div class="container">
            <h2 class="section-title">Payment</h2>
            <p class="section-subtitle">Complete your order with payment</p>
            <div class="payment-container">
                <div class="payment-options">
                    <div class="option-group">
                        <div class="option-title">Payment Method</div>
                        <div class="option-cards">
                            <div class="option-card" data-payment="card"><div class="option-icon"><i class="fas fa-credit-card"></i></div><div class="option-name">Credit/Debit Card</div><div class="option-desc">Pay with your card</div></div>
                            <div class="option-card" data-payment="cash"><div class="option-icon"><i class="fas fa-money-bill-wave"></i></div><div class="option-name">Cash</div><div class="option-desc">Pay with cash</div></div>
                        </div>
                    </div>
                    <div class="option-group">
                        <div class="option-title">Payment Time</div>
                        <div class="option-cards">
                            <div class="option-card" data-time="now"><div class="option-icon"><i class="fas fa-bolt"></i></div><div class="option-name">Pay Now</div><div class="option-desc">Complete payment immediately</div></div>
                            <div class="option-card" data-time="later"><div class="option-icon"><i class="fas fa-clock"></i></div><div class="option-name">Pay Later</div><div class="option-desc">Pay at the counter when leaving</div></div>
                        </div>
                    </div>
                </div>
                <div class="cart-summary">
                    <div class="summary-row"><span>Subtotal (tax included)</span><span id="paymentSubtotal">$0.00</span></div>
                    <div class="summary-row summary-total"><span>Total</span><span class="amount" id="paymentTotal">$0.00</span></div>
                    <div class="payment-actions">
                        <button class="btn btn-secondary" id="backToCartBtn"><i class="fas fa-arrow-left"></i> Back to Cart</button>
                        <button class="btn btn-primary" id="confirmPaymentBtn"><i class="fas fa-check"></i> Confirm Payment</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="myOrdersSection" class="app-section">
        <div class="container my-orders-container">
            <h2 class="section-title">Οι Παραγγελίες μου</h2>
            <p class="section-subtitle" id="myOrdersSubtitle">View all your current and past orders</p>
            <div class="orders-list" id="ordersList"></div>
            <div class="payment-actions">
                <button class="btn btn-secondary" id="backToMenuFromOrdersBtn"><i class="fas fa-arrow-left"></i> Πίσω στο Μενού</button>
                <button class="btn btn-primary" id="placeNewOrderBtn"><i class="fas fa-plus"></i> Νέα Παραγγελία</button>
            </div>
        </div>
    </section>

    <section id="confirmationSection" class="app-section">
        <div class="container confirmation-container">
            <div class="confirmation-card">
                <div class="confirmation-icon"><i class="fas fa-check"></i></div>
                <h2 class="section-title">Order Confirmed!</h2>
                <div class="order-number">Order #<span id="orderNumberDisplay">0000</span></div>
                <p class="order-message">Thank you for your order. Your food will be prepared shortly.</p>
                <div class="payment-actions" style="justify-content: center; gap: 15px;">
                    <button class="btn btn-success" id="newOrderBtn"><i class="fas fa-utensils"></i> Start New Order</button>
                    <button class="btn btn-secondary" id="viewMyOrdersBtn"><i class="fas fa-clipboard-list"></i> Προβολή των Παραγγελιών μου</button>
                </div>
            </div>
            <div class="order-details">
                <div class="details-header"><div class="details-title">Order Details</div><div class="details-table" id="confirmationTable">Table: -</div></div>
                <div class="order-items" id="confirmationItems"></div>
                <div class="order-total"><span>Total Amount (tax included)</span><span class="amount" id="confirmationTotal">$0.00</span></div>
                <div class="payment-details">
                    <div class="payment-details-title">Payment Information</div>
                    <div class="payment-info"><div class="info-label">Payment Method:</div><div class="info-value" id="confirmationPaymentMethod">-</div></div>
                    <div class="payment-info"><div class="info-label">Payment Time:</div><div class="info-value" id="confirmationPaymentTime">-</div></div>
                    <div class="payment-info"><div class="info-label">Order Status:</div><div class="info-value" id="confirmationOrderStatus" style="color: var(--success);">Confirmed</div></div>
                </div>
                <div class="estimated-time"><div class="time-icon"><i class="fas fa-clock"></i></div><div class="time-text"><strong>Estimated preparation time:</strong> <span id="estimatedTime">15-25</span> minutes</div></div>
            </div>
            <div class="payment-actions">
                <button class="btn btn-secondary" id="viewMenuBtn"><i class="fas fa-book-open"></i> View Full Menu</button>
                <button class="btn btn-primary" id="needHelpBtn"><i class="fas fa-headset"></i> Χρειάζεστε βοήθεια?</button>
            </div>
        </div>
    </section>

    <section id="adminDashboardSection" class="admin-dashboard-section">
        <div class="container">
            <div class="admin-dashboard-container">
                <h2 style="margin-bottom: 25px; color: var(--primary);"><i class="fas fa-lock"></i> Admin Control Panel</h2>
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="restaurant">Restaurant Settings</button>
                    <button class="admin-tab" data-tab="menu">Menu Management</button>
                    <button class="admin-tab" data-tab="categories">Category Management</button>
                    <button class="admin-tab" data-tab="orders">Order Management</button>
                    <button class="admin-tab" data-tab="customization">Visual Customization</button>
                    <button class="admin-tab" data-tab="system">System Tools</button>
                </div>
                <!-- Restaurant Settings -->
                <div class="admin-content active" id="restaurantTab">
                    <div class="admin-form-group"><label class="admin-label">Restaurant Name</label><input type="text" class="admin-input" id="adminRestaurantName" value="DineEasy"></div>
                    <div class="image-upload-container">
                        <label class="admin-label">Restaurant Logo</label>
                        <div class="image-preview" id="logoPreview"><div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div></div>
                        <div class="upload-actions">
                            <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                            <button class="btn btn-secondary upload-btn" id="uploadLogoBtn"><i class="fas fa-upload"></i> Upload Logo</button>
                            <button class="remove-image-btn" id="removeLogoBtn"><i class="fas fa-trash"></i> Remove</button>
                        </div>
                    </div>
                    <div class="admin-form-group"><label class="admin-label">Tax Rate (%)</label><input type="number" class="admin-input" id="adminTaxRate" value="8" min="0" max="50" step="0.1"></div>
                    <div class="admin-form-group"><label class="admin-label">Estimated Preparation Time (minutes)</label><input type="text" class="admin-input" id="adminPrepTime" value="15-25"></div>
                    <div class="admin-form-group"><label class="admin-label">Welcome Message</label><textarea class="admin-textarea" id="adminWelcomeMessage" placeholder="Welcome to our restaurant..."></textarea></div>
                    <button class="btn btn-primary" id="saveRestaurantSettings"><i class="fas fa-save"></i> Save Restaurant Settings</button>
                </div>
                <!-- Menu Management -->
                <div class="admin-content" id="menuTab">
                    <div style="margin-bottom: 25px;"><button class="btn btn-success" id="addMenuItemBtn"><i class="fas fa-plus"></i> Add New Menu Item</button></div>
                    <div class="admin-grid" id="menuItemsList"></div>
                    <div id="editMenuItemForm" style="display: none;">
                        <h3 style="margin-bottom: 20px;">Edit Menu Item</h3>
                        <div class="admin-form-group"><label class="admin-label">Item Name</label><input type="text" class="admin-input" id="editItemName"></div>
                        <div class="admin-form-group"><label class="admin-label">Description</label><textarea class="admin-textarea" id="editItemDescription"></textarea></div>
                        <div class="admin-form-group"><label class="admin-label">Price (with tax)</label><input type="number" class="admin-input" id="editItemPrice" step="0.01" min="0"></div>
                        <div class="admin-form-group"><label class="admin-label">Category</label><select class="admin-select" id="editItemCategory"></select></div>
                        <div class="image-upload-container">
                            <label class="admin-label">Item Image</label>
                            <div class="image-preview" id="itemImagePreview"><div class="image-preview-placeholder"><i class="fas fa-utensils"></i><p>No image uploaded</p></div></div>
                            <div class="upload-actions">
                                <input type="file" id="itemImageUpload" accept="image/*" style="display: none;">
                                <button class="btn btn-secondary upload-btn" id="uploadItemImageBtn"><i class="fas fa-upload"></i> Upload Image</button>
                                <button class="remove-image-btn" id="removeItemImageBtn"><i class="fas fa-trash"></i> Remove</button>
                            </div>
                        </div>
                        <div class="admin-form-group"><label class="admin-label">Tags (separate with commas)</label><input type="text" class="admin-input" id="editItemTags" placeholder="Vegetarian, Popular, Spicy"></div>
                        <!-- Options / Subcategories will be injected here dynamically via JavaScript -->
                        <div class="payment-actions">
                            <button class="btn btn-secondary" id="cancelEditBtn"><i class="fas fa-times"></i> Cancel</button>
                            <button class="btn btn-primary" id="saveMenuItemBtn"><i class="fas fa-save"></i> Save Changes</button>
                        </div>
                    </div>
                </div>
                <!-- Category Management -->
                <div class="admin-content" id="categoriesTab">
                    <h3 style="margin-bottom: 20px;">Manage Categories</h3>
                    <p style="margin-bottom: 25px; color: var(--gray);">Add, edit, or remove menu categories. Note: You cannot delete categories that have menu items assigned to them.</p>
                    <div class="categories-management">
                        <div class="categories-list"><h4 style="margin-bottom: 15px;">Existing Categories</h4><div class="categories-list-container" id="categoriesListContainer"></div></div>
                        <div class="add-category-form">
                            <h4 style="margin-bottom: 15px;">Add New Category</h4>
                            <div class="admin-form-group"><label class="admin-label">Category Name</label><input type="text" class="admin-input" id="newCategoryName" placeholder="e.g., Sides, Salads, Breakfast"></div>
                            <div class="admin-form-group"><label class="admin-label">Display Name</label><input type="text" class="admin-input" id="newCategoryDisplayName" placeholder="e.g., Side Dishes"><small style="color: var(--gray);">How it will appear in the menu tabs</small></div>
                            <button class="btn btn-success" id="addCategoryBtn"><i class="fas fa-plus"></i> Add Category</button>
                        </div>
                    </div>
                </div>
                <!-- Order Management (modified to show options and direct status update) -->
                <div class="admin-content" id="ordersTab">
                    <div class="admin-form-group"><label class="admin-label">Filter by Status</label><select class="admin-select" id="orderStatusFilter"><option value="all">All Orders</option><option value="pending">Pending</option><option value="preparing">Preparing</option><option value="ready">Ready</option><option value="served">Served</option><option value="cancelled">Cancelled</option></select></div>
                    <div id="adminOrdersList"><p style="text-align: center; color: var(--gray); padding: 40px;">No orders yet. Orders will appear here when customers place them.</p></div>
                </div>
                <!-- Visual Customization (20 themes) -->
                <div class="admin-content" id="customizationTab">
                    <div class="customization-panel">
                        <div class="customization-section">
                            <div class="section-title-small"><i class="fas fa-palette"></i> Choose a Theme (20 Unique Options)</div>
                            <p style="margin-bottom: 20px; color: var(--gray);">Select from our collection of 20 modern and cozy themes.</p>
                            <div class="theme-gallery" id="themeGallery"></div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                                <div style="font-weight: 500; margin-bottom: 10px; color: var(--text);">Current Theme: <span id="currentThemeName">Default</span> <span class="theme-category" id="currentThemeCategory">Modern</span></div>
                                <button class="btn btn-primary" id="applyThemeBtn" style="width: 100%;"><i class="fas fa-check"></i> Apply Selected Theme</button>
                            </div>
                        </div>
                        <div class="customization-section">
                            <div class="section-title-small"><i class="fas fa-font"></i> Font Selection</div>
                            <p style="margin-bottom: 20px; color: var(--gray);">Choose a font that matches your restaurant's personality.</p>
                            <div class="font-options" id="fontOptions"></div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                                <div style="font-weight: 500; margin-bottom: 10px; color: var(--text);">Current Font: <span id="currentFontName">Poppins</span></div>
                                <button class="btn btn-secondary" id="applyFontBtn" style="width: 100%;"><i class="fas fa-check"></i> Apply Selected Font</button>
                            </div>
                        </div>
                        <div class="customization-section">
                            <div class="section-title-small"><i class="fas fa-sliders-h"></i> Custom Color Adjustments</div>
                            <p style="margin-bottom: 20px; color: var(--gray);">Fine-tune individual colors if needed.</p>
                            <div class="color-customization" id="colorCustomization"></div>
                        </div>
                    </div>
                    <div class="customization-preview">
                        <div class="preview-header"><div class="preview-restaurant-name" id="previewRestaurantName">Restaurant Preview</div><div style="font-size: 14px; color: var(--gray);">Live Preview</div></div>
                        <div class="preview-content-grid">
                            <div>
                                <div class="preview-card"><div style="font-weight: 600; margin-bottom: 15px; color: var(--text);">Sample Menu Item</div>
                                    <div class="preview-menu-item"><span>Margherita Pizza</span><span style="color: var(--primary); font-weight: 600;">$14.99</span></div>
                                    <div class="preview-menu-item"><span>Caesar Salad</span><span style="color: var(--primary); font-weight: 600;">$9.99</span></div>
                                    <div style="margin-top: 15px;"><button style="background-color: var(--primary); color: var(--button-text); border: none; padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer;">Add to Cart</button></div>
                                </div>
                                <div style="background-color: var(--background); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid var(--light-gray);">
                                    <div style="color: var(--text); font-weight: 500; margin-bottom: 10px;">Customer Note:</div>
                                    <div style="color: var(--gray); font-size: 14px;">"The theme creates a welcoming atmosphere for our guests."</div>
                                </div>
                            </div>
                            <div>
                                <div class="preview-button-group">
                                    <button class="preview-btn" style="background-color: var(--primary); color: var(--button-text);">Primary Button</button>
                                    <button class="preview-btn" style="background-color: var(--secondary); color: white;">Secondary Button</button>
                                    <button class="preview-btn" style="background-color: var(--success); color: white;">Success Button</button>
                                </div>
                                <div class="preview-card" style="margin-top: 15px;"><div style="font-weight: 600; margin-bottom: 10px; color: var(--text);">Order Summary</div>
                                    <div class="preview-menu-item"><span>Subtotal</span><span>$24.98</span></div>
                                    <div class="preview-menu-item"><span>Total</span><span style="color: var(--primary); font-weight: 600;">$24.98</span></div>
                                </div>
                                <div style="background-color: var(--light-gray); padding: 15px; border-radius: 8px; margin-top: 15px;"><div style="color: var(--text); font-size: 14px;">This is how text will appear in light gray areas.</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="customization-actions">
                        <button class="btn btn-secondary" id="resetCustomizationBtn"><i class="fas fa-undo"></i> Reset to Default</button>
                        <button class="btn btn-primary" id="saveCustomizationBtn"><i class="fas fa-save"></i> Save All Changes</button>
                    </div>
                </div>
                <!-- System Tools -->
                <div class="admin-content" id="systemTab">
                    <h3 style="margin-bottom: 20px;">System Management</h3>
                    <div class="admin-grid">
                        <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Clear All Orders</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Remove all order history from the system.</p><button class="btn btn-danger" id="clearOrdersBtn"><i class="fas fa-trash"></i> Clear Orders</button></div>
                        <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Reset Menu to Default</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Restore the original menu items.</p><button class="btn btn-warning" id="resetMenuBtn"><i class="fas fa-redo"></i> Reset Menu</button></div>
                        <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Export Data</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Download all restaurant data as JSON.</p><button class="btn btn-secondary" id="exportDataBtn"><i class="fas fa-download"></i> Export Data</button></div>
                        <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Import Data</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Upload and restore from a backup file.</p><input type="file" id="importDataInput" style="display: none;" accept=".json"><button class="btn btn-secondary" id="importDataBtn"><i class="fas fa-upload"></i> Import Data</button></div>
                    </div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);"><h4 style="margin-bottom: 15px;">System Statistics</h4><div id="systemStats"></div></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Panel (Modal) -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-container">
            <button class="admin-close" id="adminClose"><i class="fas fa-times"></i></button>
            <h2 style="margin-bottom: 25px; color: var(--primary);"><i class="fas fa-lock"></i> Admin Control Panel</h2>
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="restaurant">Restaurant Settings</button>
                <button class="admin-tab" data-tab="menu">Menu Management</button>
                <button class="admin-tab" data-tab="categories">Category Management</button>
                <button class="admin-tab" data-tab="orders">Order Management</button>
                <button class="admin-tab" data-tab="customization">Visual Customization</button>
                <button class="admin-tab" data-tab="system">System Tools</button>
            </div>
            <!-- Restaurant Settings Modal -->
            <div class="admin-content active" id="restaurantTabModal">
                <div class="admin-form-group"><label class="admin-label">Restaurant Name</label><input type="text" class="admin-input" id="adminRestaurantNameModal" value="DineEasy"></div>
                <div class="image-upload-container">
                    <label class="admin-label">Restaurant Logo</label>
                    <div class="image-preview" id="logoPreviewModal"><div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div></div>
                    <div class="upload-actions">
                        <input type="file" id="logoUploadModal" accept="image/*" style="display: none;">
                        <button class="btn btn-secondary upload-btn" id="uploadLogoBtnModal"><i class="fas fa-upload"></i> Upload Logo</button>
                        <button class="remove-image-btn" id="removeLogoBtnModal"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                </div>
                <div class="admin-form-group"><label class="admin-label">Tax Rate (%)</label><input type="number" class="admin-input" id="adminTaxRateModal" value="8" min="0" max="50" step="0.1"></div>
                <div class="admin-form-group"><label class="admin-label">Estimated Preparation Time (minutes)</label><input type="text" class="admin-input" id="adminPrepTimeModal" value="15-25"></div>
                <div class="admin-form-group"><label class="admin-label">Welcome Message</label><textarea class="admin-textarea" id="adminWelcomeMessageModal" placeholder="Welcome to our restaurant..."></textarea></div>
                <button class="btn btn-primary" id="saveRestaurantSettingsModal"><i class="fas fa-save"></i> Save Restaurant Settings</button>
            </div>
            <!-- Menu Management Modal -->
            <div class="admin-content" id="menuTabModal">
                <div style="margin-bottom: 25px;"><button class="btn btn-success" id="addMenuItemBtnModal"><i class="fas fa-plus"></i> Add New Menu Item</button></div>
                <div class="admin-grid" id="menuItemsListModal"></div>
            </div>
            <!-- Category Management Modal -->
            <div class="admin-content" id="categoriesTabModal">
                <h3 style="margin-bottom: 20px;">Manage Categories</h3>
                <p style="margin-bottom: 25px; color: var(--gray);">Add, edit, or remove menu categories. Note: You cannot delete categories that have menu items assigned to them.</p>
                <div class="categories-management">
                    <div class="categories-list"><h4 style="margin-bottom: 15px;">Existing Categories</h4><div class="categories-list-container" id="categoriesListContainerModal"></div></div>
                    <div class="add-category-form">
                        <h4 style="margin-bottom: 15px;">Add New Category</h4>
                        <div class="admin-form-group"><label class="admin-label">Category Name</label><input type="text" class="admin-input" id="newCategoryNameModal" placeholder="e.g., Sides, Salads, Breakfast"></div>
                        <div class="admin-form-group"><label class="admin-label">Display Name</label><input type="text" class="admin-input" id="newCategoryDisplayNameModal" placeholder="e.g., Side Dishes"><small style="color: var(--gray);">How it will appear in the menu tabs</small></div>
                        <button class="btn btn-success" id="addCategoryBtnModal"><i class="fas fa-plus"></i> Add Category</button>
                    </div>
                </div>
            </div>
            <!-- Order Management Modal -->
            <div class="admin-content" id="ordersTabModal">
                <div class="admin-form-group"><label class="admin-label">Filter by Status</label><select class="admin-select" id="orderStatusFilterModal"><option value="all">All Orders</option><option value="pending">Pending</option><option value="preparing">Preparing</option><option value="ready">Ready</option><option value="served">Served</option><option value="cancelled">Cancelled</option></select></div>
                <div id="adminOrdersListModal"><p style="text-align: center; color: var(--gray); padding: 40px;">No orders yet. Orders will appear here when customers place them.</p></div>
            </div>
            <!-- Visual Customization Modal (simplified) -->
            <div class="admin-content" id="customizationTabModal">
                <h3 style="margin-bottom: 20px;">Visual Customization</h3>
                <p style="margin-bottom: 25px; color: var(--gray);">Quick visual customization options.</p>
                <div style="margin-bottom: 30px;"><div style="font-weight: 500; margin-bottom: 15px; color: var(--text);">Theme Selection</div><div class="theme-gallery" id="themeGalleryModal"></div></div>
                <div style="margin-bottom: 30px;"><div style="font-weight: 500; margin-bottom: 15px; color: var(--text);">Font Selection</div><div class="font-options" id="fontOptionsModal"></div></div>
                <div class="customization-actions"><button class="btn btn-secondary" id="resetCustomizationBtnModal"><i class="fas fa-undo"></i> Reset</button><button class="btn btn-primary" id="saveCustomizationBtnModal"><i class="fas fa-save"></i> Save</button></div>
            </div>
            <!-- System Tools Modal -->
            <div class="admin-content" id="systemTabModal">
                <h3 style="margin-bottom: 20px;">System Management</h3>
                <div class="admin-grid">
                    <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Clear All Orders</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Remove all order history from the system.</p><button class="btn btn-danger" id="clearOrdersBtnModal"><i class="fas fa-trash"></i> Clear Orders</button></div>
                    <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Reset Menu to Default</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Restore the original menu items.</p><button class="btn btn-warning" id="resetMenuBtnModal"><i class="fas fa-redo"></i> Reset Menu</button></div>
                    <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Export Data</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Download all restaurant data as JSON.</p><button class="btn btn-secondary" id="exportDataBtnModal"><i class="fas fa-download"></i> Export Data</button></div>
                    <div class="admin-card"><div class="admin-card-header"><div class="admin-card-title">Import Data</div></div><p style="margin-bottom: 15px; font-size: 14px; color: var(--gray);">Upload and restore from a backup file.</p><input type="file" id="importDataInputModal" style="display: none;" accept=".json"><button class="btn btn-secondary" id="importDataBtnModal"><i class="fas fa-upload"></i> Import Data</button></div>
                </div>
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light-gray);"><h4 style="margin-bottom: 15px;">System Statistics</h4><div id="systemStatsModal"></div></div>
            </div>
        </div>
    </div>

    <!-- Admin Code Prompt -->
    <div class="admin-code-prompt" id="adminCodePrompt">
        <div class="admin-code-container">
            <div class="admin-code-icon"><i class="fas fa-lock"></i></div>
            <h3 class="admin-code-title">Admin Access Required</h3>
            <p class="admin-code-subtitle">Please enter the admin code to continue</p>
            <input type="password" class="admin-code-input" id="adminCodeInput" placeholder="Enter 4-digit code" maxlength="4" autocomplete="off">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancelAdminCodeBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="submitAdminCodeBtn" style="flex: 1;">Submit</button>
            </div>
        </div>
    </div>

    <!-- Admin Change Confirmation Prompt (kept for other actions, but order status updates bypass it) -->
    <div class="admin-code-prompt" id="adminChangePrompt">
        <div class="admin-code-container">
            <div class="admin-code-icon"><i class="fas fa-shield-alt"></i></div>
            <h3 class="admin-code-title">Confirm Changes</h3>
            <p class="admin-code-subtitle">Please enter the confirmation code to save changes</p>
            <input type="password" class="admin-code-input" id="adminChangeCodeInput" placeholder="Enter 4-digit code" maxlength="4" autocomplete="off">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" id="cancelChangeBtn" style="flex: 1;">Cancel</button>
                <button class="btn btn-primary" id="submitChangeCodeBtn" style="flex: 1;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- ===== NEW MODAL FOR ITEM OPTIONS ===== -->
    <div class="options-modal" id="optionsModal">
        <div class="options-modal-container">
            <div id="optionsModalContent"></div>
        </div>
    </div>

    <!-- Cart Floating Button -->
    <div class="cart-floating" id="cartFloating">
        <i class="fas fa-shopping-cart"></i>
        <div class="cart-count" id="cartCount">0</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div id="notificationText">Item added to cart!</div>
    </div>

    <script>
        // ========== FIREBASE INITIALIZATION ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCtO20G2Ssl9cvB6CP1xfCh2Ldf4GMdGUg",
            authDomain: "foodmenu-b1fc2.firebaseapp.com",
            projectId: "foodmenu-b1fc2",
            storageBucket: "foodmenu-b1fc2.firebasestorage.app",
            messagingSenderId: "730100337020",
            appId: "1:730100337020:web:dd3dc58846c8207a693cf9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ========== APPLICATION STATE ==========
        const state = {
            currentTable: null,
            cart: [],
            selectedPaymentMethod: null,
            selectedPaymentTime: null,
            currentOrderNumber: null,
            restaurantInfo: {
                name: "DineEasy",
                taxRate: 8,
                estimatedPrepTime: "15-25",
                logoImage: "",
                welcomeMessage: ""
            },
            menuItems: [],   // Each item may have "options" array and "displayOrder"
            orders: [],
            adminAccessCode: "3232",
            adminChangeCode: "6262",
            categories: [],
            isAdminMode: false,
            pendingAdminAction: null,
            currentImageUpload: null,
            customization: {
                primary: "#e63946",
                primaryDark: "#c1121f",
                secondary: "#457b9d",
                light: "#f8f9fa",
                dark: "#212529",
                gray: "#6c757d",
                lightGray: "#e9ecef",
                success: "#2a9d8f",
                warning: "#e9c46a",
                danger: "#dc3545",
                shadow: "0 4px 12px rgba(0, 0, 0, 0.08)",
                radius: "12px",
                background: "#fefefe",
                text: "#212529",
                cardBg: "#ffffff",
                headerBg: "#ffffff",
                menuBg: "#ffffff",
                cartBg: "#ffffff",
                paymentBg: "#ffffff",
                buttonText: "#ffffff",
                fontPrimary: "'Poppins', sans-serif",
                fontSecondary: "'Playfair Display', serif"
            },
            currentTheme: "default",
            currentFont: "poppins",
            // Permanent orders listener (for real‑time customer updates)
            ordersListener: null
        };

        // ========== DEFAULT DATA ==========
        const defaultMenuItems = []; // NO DEFAULT PRODUCTS – completely empty
        const defaultCategories = [
            { id: "pizza", name: "pizza", displayName: "Pizza", isDefault: true },
            { id: "salads", name: "salads", displayName: "Salads", isDefault: true },
            { id: "pasta", name: "pasta", displayName: "Pasta", isDefault: true },
            { id: "main", name: "main", displayName: "Main Courses", isDefault: true },
            { id: "desserts", name: "desserts", displayName: "Desserts", isDefault: true },
            { id: "beverages", name: "beverages", displayName: "Beverages", isDefault: true }
        ];

        // ========== 20 THEMES (unchanged) ==========
        const themes = {
            default: { name: "Classic Modern", category: "Modern", primary: "#e63946", secondary: "#457b9d", background: "#fefefe", text: "#212529", cardBg: "#ffffff", lightGray: "#e9ecef" },
            midnight: { name: "Midnight Elegance", category: "Modern", primary: "#6c63ff", secondary: "#4cc9f0", background: "#121212", text: "#f5f5f5", cardBg: "#1e1e1e", lightGray: "#2d2d2d" },
            autumn: { name: "Autumn Cozy", category: "Cozy", primary: "#e76f51", secondary: "#f4a261", background: "#fefae0", text: "#283618", cardBg: "#ffffff", lightGray: "#faedcd" },
            coffee: { name: "Coffee Shop", category: "Cozy", primary: "#6f4e37", secondary: "#c19a6b", background: "#f5e9d9", text: "#3e2723", cardBg: "#ffffff", lightGray: "#e6d5c3" },
            forest: { name: "Forest Retreat", category: "Natural", primary: "#2a9d8f", secondary: "#e9c46a", background: "#f1faee", text: "#1d3557", cardBg: "#ffffff", lightGray: "#a8dadc" },
            sage: { name: "Sage Garden", category: "Natural", primary: "#84a98c", secondary: "#52796f", background: "#f8f9fa", text: "#354f52", cardBg: "#ffffff", lightGray: "#cad2c5" },
            citrus: { name: "Citrus Fresh", category: "Vibrant", primary: "#ff9f1c", secondary: "#ffbf69", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#ffe8d6" },
            berry: { name: "Berry Bliss", category: "Vibrant", primary: "#9d4edd", secondary: "#c77dff", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#e0aaff" },
            ocean: { name: "Ocean Breeze", category: "Calm", primary: "#0077b6", secondary: "#00b4d8", background: "#f8f9fa", text: "#03045e", cardBg: "#ffffff", lightGray: "#caf0f8" },
            lavender: { name: "Lavender Dream", category: "Calm", primary: "#9c89b8", secondary: "#b8bedd", background: "#f8f9fa", text: "#4a4e69", cardBg: "#ffffff", lightGray: "#f0e6ef" },
            gold: { name: "Golden Luxury", category: "Luxury", primary: "#d4af37", secondary: "#f9d976", background: "#1a1a1a", text: "#f5f5f5", cardBg: "#2d2d2d", lightGray: "#3d3d3d" },
            velvet: { name: "Velvet Night", category: "Luxury", primary: "#7209b7", secondary: "#3a0ca3", background: "#0a0a0a", text: "#f5f5f5", cardBg: "#1a1a1a", lightGray: "#2d2d2d" },
            minimalist: { name: "Pure Minimal", category: "Minimalist", primary: "#495057", secondary: "#6c757d", background: "#ffffff", text: "#212529", cardBg: "#f8f9fa", lightGray: "#e9ecef" },
            paper: { name: "Paper White", category: "Minimalist", primary: "#adb5bd", secondary: "#ced4da", background: "#ffffff", text: "#343a40", cardBg: "#f8f9fa", lightGray: "#e9ecef" },
            retro: { name: "Retro Diner", category: "Retro", primary: "#ff6b6b", secondary: "#4ecdc4", background: "#fff9db", text: "#2d3436", cardBg: "#ffffff", lightGray: "#ffeaa7" },
            vintage: { name: "Vintage Charm", category: "Retro", primary: "#dda15e", secondary: "#bc6c25", background: "#fefae0", text: "#283618", cardBg: "#ffffff", lightGray: "#faedcd" },
            corporate: { name: "Corporate Blue", category: "Professional", primary: "#2c3e50", secondary: "#3498db", background: "#ecf0f1", text: "#2c3e50", cardBg: "#ffffff", lightGray: "#bdc3c7" },
            slate: { name: "Slate Professional", category: "Professional", primary: "#34495e", secondary: "#7f8c8d", background: "#f5f7fa", text: "#2c3e50", cardBg: "#ffffff", lightGray: "#dcdde1" },
            candy: { name: "Candy Shop", category: "Playful", primary: "#ff5d8f", secondary: "#ff97b7", background: "#f8f9fa", text: "#212529", cardBg: "#ffffff", lightGray: "#ffcad4" },
            tropical: { name: "Tropical Paradise", category: "Playful", primary: "#06d6a0", secondary: "#118ab2", background: "#f8f9fa", text: "#073b4c", cardBg: "#ffffff", lightGray: "#cbf3f0" }
        };

        const fonts = {
            poppins: { name: "Poppins", primary: "'Poppins', sans-serif", secondary: "'Playfair Display', serif" },
            roboto: { name: "Roboto", primary: "'Roboto', sans-serif", secondary: "'Roboto Slab', serif" },
            opensans: { name: "Open Sans", primary: "'Open Sans', sans-serif", secondary: "'Merriweather', serif" },
            lato: { name: "Lato", primary: "'Lato', sans-serif", secondary: "'Playfair Display', serif" },
            montserrat: { name: "Montserrat", primary: "'Montserrat', sans-serif", secondary: "'Cardo', serif" },
            inter: { name: "Inter", primary: "'Inter', sans-serif", secondary: "'Inter', serif" }
        };

        const importantColors = [
            { id: "primary", label: "Primary Color", description: "Main brand color for buttons" },
            { id: "secondary", label: "Secondary Color", description: "Secondary accent color" },
            { id: "background", label: "Background", description: "Page background color" },
            { id: "text", label: "Text Color", description: "Main text color" },
            { id: "cardBg", label: "Card Background", description: "Background for cards and containers" },
            { id: "lightGray", label: "Light Gray", description: "Background for subtle elements" }
        ];

        // ========== DOM ELEMENTS ==========
        const scannerSection = document.getElementById('scannerSection');
        const menuSection = document.getElementById('menuSection');
        const cartSection = document.getElementById('cartSection');
        const paymentSection = document.getElementById('paymentSection');
        const myOrdersSection = document.getElementById('myOrdersSection');
        const confirmationSection = document.getElementById('confirmationSection');
        const adminDashboardSection = document.getElementById('adminDashboardSection');
        const tableInfo = document.getElementById('tableInfo');
        const menuSubtitle = document.getElementById('menuSubtitle');
        const cartSubtitle = document.getElementById('cartSubtitle');
        const myOrdersSubtitle = document.getElementById('myOrdersSubtitle');
        const menuGrid = document.getElementById('menuGrid');
        const categoryTabs = document.getElementById('categoryTabs');
        const cartItems = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');
        const cartFloating = document.getElementById('cartFloating');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');
        const orderNumberDisplay = document.getElementById('orderNumberDisplay');
        const confirmationTable = document.getElementById('confirmationTable');
        const confirmationItems = document.getElementById('confirmationItems');
        const confirmationTotal = document.getElementById('confirmationTotal');
        const confirmationPaymentMethod = document.getElementById('confirmationPaymentMethod');
        const confirmationPaymentTime = document.getElementById('confirmationPaymentTime');
        const confirmationOrderStatus = document.getElementById('confirmationOrderStatus');
        const headerHelpButton = document.getElementById('headerHelpButton');
        const restaurantName = document.getElementById('restaurantName');
        const menuTitle = document.getElementById('menuTitle');
        const estimatedTime = document.getElementById('estimatedTime');
        const myOrdersButton = document.getElementById('myOrdersButton');
        const ordersList = document.getElementById('ordersList');
        const logoImage = document.getElementById('logoImage');
        const logoIcon = document.getElementById('logoIcon');
        const adminPanel = document.getElementById('adminPanel');
        const adminClose = document.getElementById('adminClose');
        const adminCodePrompt = document.getElementById('adminCodePrompt');
        const adminCodeInput = document.getElementById('adminCodeInput');
        const submitAdminCodeBtn = document.getElementById('submitAdminCodeBtn');
        const cancelAdminCodeBtn = document.getElementById('cancelAdminCodeBtn');
        const adminChangePrompt = document.getElementById('adminChangePrompt');
        const adminChangeCodeInput = document.getElementById('adminChangeCodeInput');
        const submitChangeCodeBtn = document.getElementById('submitChangeCodeBtn');
        const cancelChangeBtn = document.getElementById('cancelChangeBtn');
        const optionsModal = document.getElementById('optionsModal');
        const optionsModalContent = document.getElementById('optionsModalContent');

        // ========== FIRESTORE LOAD & SAVE ==========
        async function loadFromFirestore() {
            try {
                const restaurantDoc = await db.collection('settings').doc('restaurantInfo').get();
                if (restaurantDoc.exists) state.restaurantInfo = restaurantDoc.data();
                else await db.collection('settings').doc('restaurantInfo').set(state.restaurantInfo);

                const menuSnapshot = await db.collection('menuItems').get();
                if (!menuSnapshot.empty) {
                    state.menuItems = menuSnapshot.docs.map(doc => {
                        const data = doc.data();
                        // Ensure displayOrder exists, default to id or increment later
                        if (data.displayOrder === undefined) {
                            data.displayOrder = Number(doc.id) || 999;
                        }
                        return {
                            id: Number(doc.id),
                            ...data,
                            options: data.options || []
                        };
                    });
                    // Sort by displayOrder
                    state.menuItems.sort((a, b) => (a.displayOrder || 0) - (b.displayOrder || 0));
                } else {
                    state.menuItems = [];
                }

                const ordersSnapshot = await db.collection('orders').get();
                if (!ordersSnapshot.empty) {
                    state.orders = ordersSnapshot.docs.map(doc => ({
                        ...doc.data(),
                        orderNumber: doc.id
                    }));
                }

                const categoriesDoc = await db.collection('settings').doc('categories').get();
                if (categoriesDoc.exists) {
                    state.categories = categoriesDoc.data().list || [];
                } else {
                    state.categories = [...defaultCategories];
                    await db.collection('settings').doc('categories').set({ list: state.categories });
                }

                const customDoc = await db.collection('settings').doc('customization').get();
                if (customDoc.exists) state.customization = customDoc.data();
                else await db.collection('settings').doc('customization').set(state.customization);

                determineCurrentTheme();
                determineCurrentFont();
            } catch (error) {
                console.error("Firestore load error:", error);
            }
        }

        async function saveToFirestore() {
            try {
                await db.collection('settings').doc('restaurantInfo').set(state.restaurantInfo);
                await Promise.all(state.menuItems.map(item => 
                    db.collection('menuItems').doc(item.id.toString()).set(item)
                ));
                const existingIds = (await db.collection('menuItems').get()).docs.map(d => d.id);
                const currentIds = state.menuItems.map(i => i.id.toString());
                await Promise.all(existingIds.filter(id => !currentIds.includes(id)).map(id => 
                    db.collection('menuItems').doc(id).delete()
                ));
                await db.collection('settings').doc('categories').set({ list: state.categories });
                await db.collection('settings').doc('customization').set(state.customization);
                await Promise.all(state.orders.map(order => 
                    db.collection('orders').doc(order.orderNumber).set(order)
                ));
                const existingOrderDocs = await db.collection('orders').get();
                const existingOrderIds = existingOrderDocs.docs.map(d => d.id);
                const currentOrderIds = state.orders.map(o => o.orderNumber);
                await Promise.all(existingOrderIds.filter(id => !currentOrderIds.includes(id)).map(id => 
                    db.collection('orders').doc(id).delete()
                ));
            } catch (error) {
                console.error("Firestore save error:", error);
            }
        }

        // ========== HELPERS ==========
        function determineCurrentTheme() {
            for (const [themeId, theme] of Object.entries(themes)) {
                if (state.customization.primary === theme.primary &&
                    state.customization.secondary === theme.secondary &&
                    state.customization.background === theme.background) {
                    state.currentTheme = themeId;
                    return;
                }
            }
            state.currentTheme = "custom";
        }
        function determineCurrentFont() {
            for (const [fontId, font] of Object.entries(fonts)) {
                if (state.customization.fontPrimary === font.primary) {
                    state.currentFont = fontId;
                    return;
                }
            }
            state.currentFont = "poppins";
        }

        // ========== UI UPDATE FUNCTIONS ==========
        function applyCustomization() {
            const root = document.documentElement;
            Object.keys(state.customization).forEach(key => {
                if (key === 'fontPrimary' || key === 'fontSecondary') root.style.setProperty(`--${key}`, state.customization[key]);
                else root.style.setProperty(`--${key}`, state.customization[key]);
            });
            const previewName = document.getElementById('previewRestaurantName');
            if (previewName) { 
                previewName.style.color = state.customization.primary; 
                previewName.style.fontFamily = state.customization.fontSecondary; 
            }
        }
        function updateRestaurantUI() {
            restaurantName.textContent = state.restaurantInfo.name;
            menuTitle.textContent = state.restaurantInfo.name + " Menu";
            estimatedTime.textContent = state.restaurantInfo.estimatedPrepTime;
            if (state.restaurantInfo.logoImage && state.restaurantInfo.logoImage.trim() !== '') {
                logoImage.src = state.restaurantInfo.logoImage;
                logoImage.style.display = 'block';
                logoIcon.style.display = 'none';
            } else { 
                logoImage.style.display = 'none'; 
                logoIcon.style.display = 'block'; 
            }
        }
        function updateCategoryTabs() {
            categoryTabs.innerHTML = '';
            const allTab = document.createElement('button');
            allTab.className = 'category-tab active';
            allTab.setAttribute('data-category', 'all');
            allTab.textContent = 'All';
            allTab.addEventListener('click', function() { 
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active')); 
                this.classList.add('active'); 
                displayMenuItems('all'); 
            });
            categoryTabs.appendChild(allTab);
            state.categories.forEach(category => {
                const tab = document.createElement('button');
                tab.className = 'category-tab';
                tab.setAttribute('data-category', category.id);
                tab.textContent = category.displayName;
                tab.addEventListener('click', function() { 
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active')); 
                    this.classList.add('active'); 
                    displayMenuItems(category.id); 
                });
                categoryTabs.appendChild(tab);
            });
        }

        // ========== DISPLAY MENU ITEMS (with options indicator) ==========
        function displayMenuItems(category) {
            menuGrid.innerHTML = '';
            const filteredItems = category === 'all' ? 
                [...state.menuItems].sort((a,b) => (a.displayOrder || 0) - (b.displayOrder || 0)) : 
                state.menuItems.filter(item => item.category === category).sort((a,b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            if (filteredItems.length === 0) { 
                menuGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-utensils" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i><p>No items in this category yet.</p></div>'; 
                return; 
            }
            filteredItems.forEach(item => {
                const menuItemElement = document.createElement('div');
                menuItemElement.className = 'menu-item';
                const imageStyle = item.image && item.image.trim() !== '' ? `background-image: url('${item.image}')` : 'background-color: var(--light-gray)';
                let optionsIndicator = '';
                if (item.options && item.options.length > 0) {
                    optionsIndicator = `<div class="item-options-indicator"><i class="fas fa-sliders-h"></i> Με επιλογές</div>`;
                }
                menuItemElement.innerHTML = `<div class="item-image" style="${imageStyle}"></div>
                                            <div class="item-content">
                                                <div class="item-header">
                                                    <div class="item-name">${item.name}</div>
                                                    <div class="item-price">$${item.price.toFixed(2)}</div>
                                                </div>
                                                <div class="item-description">${item.description}</div>
                                                ${optionsIndicator}
                                                <div class="item-footer">
                                                    <div class="item-tags">${item.tags.map(tag => `<span class="item-tag">${tag}</span>`).join('')}</div>
                                                    <button class="add-to-cart" data-id="${item.id}"><i class="fas fa-plus"></i></button>
                                                </div>
                                            </div>`;
                menuGrid.appendChild(menuItemElement);
                menuItemElement.querySelector('.add-to-cart').addEventListener('click', function() { 
                    addToCart(item.id); 
                });
            });
        }

        // ========== OPTIONS / SUBCATEGORY PRICE CALCULATION ==========
        function calculateItemPrice(basePrice, selectedOptions) {
            let total = basePrice;
            if (selectedOptions && selectedOptions.length) {
                selectedOptions.forEach(opt => {
                    total += opt.price || 0;
                });
            }
            return total;
        }

        // ========== ADD TO CART (with options) ==========
        function addToCartWithOptions(itemId, selectedOptions = []) {
            if (state.isAdminMode) return;
            const menuItem = state.menuItems.find(item => item.id === itemId);
            if (!menuItem) return;
            const itemPrice = calculateItemPrice(menuItem.price, selectedOptions);
            const cartItem = {
                id: menuItem.id,
                name: menuItem.name,
                basePrice: menuItem.price,
                price: itemPrice,
                quantity: 1,
                selectedOptions: selectedOptions.map(opt => ({
                    groupName: opt.groupName,
                    choiceName: opt.choiceName,
                    price: opt.price,
                    isComment: opt.isComment || false
                }))
            };
            // Check if same item with identical options already exists (ignore comment fields for grouping)
            const existingIndex = state.cart.findIndex(item => 
                item.id === cartItem.id && 
                JSON.stringify(item.selectedOptions.filter(o => !o.isComment)) === JSON.stringify(cartItem.selectedOptions.filter(o => !o.isComment))
            );
            if (existingIndex !== -1) {
                const existingItem = state.cart[existingIndex];
                const sameComments = JSON.stringify(existingItem.selectedOptions.filter(o => o.isComment)) === JSON.stringify(cartItem.selectedOptions.filter(o => o.isComment));
                if (sameComments) {
                    existingItem.quantity += 1;
                } else {
                    state.cart.push(cartItem);
                }
            } else {
                state.cart.push(cartItem);
            }
            updateCart();
            showNotification(`${menuItem.name} added to cart`);
        }

        // Override original addToCart
        function addToCart(itemId) {
            const menuItem = state.menuItems.find(item => item.id === itemId);
            if (!menuItem) return;
            if (menuItem.options && menuItem.options.length > 0) {
                openOptionsModal(menuItem);
            } else {
                addToCartWithOptions(itemId, []);
            }
        }

        // ========== OPTIONS MODAL (with comment field support) ==========
        function openOptionsModal(item) {
            let basePrice = item.price;
            let modalHtml = `<h3 class="options-modal-title">${item.name}</h3>
                             <div class="options-modal-price">$${basePrice.toFixed(2)}</div>
                             <div class="item-description" style="margin-bottom:20px;">${item.description}</div>`;
            
            item.options.forEach((group, gIndex) => {
                if (group.type === 'text') {
                    // Render a comment field
                    modalHtml += `<div class="option-group" data-group-index="${gIndex}">
                                    <div class="option-group-title">
                                        <i class="fas fa-comment"></i> ${group.name}
                                    </div>
                                    <div class="comment-field">
                                        <textarea class="admin-textarea" placeholder="Enter your comment here..." id="comment_${group.id || gIndex}" data-group-name="${group.name}"></textarea>
                                    </div>
                                </div>`;
                } else {
                    // Radio / Checkbox
                    modalHtml += `<div class="option-group" data-group-index="${gIndex}">
                                    <div class="option-group-title">
                                        <i class="fas fa-tag"></i> ${group.name}
                                        ${group.type === 'radio' ? '<span style="font-size:12px; color:var(--gray);">(choose one)</span>' : '<span style="font-size:12px; color:var(--gray);">(choose any)</span>'}
                                    </div>
                                    <div class="${group.type === 'radio' ? 'option-group-radio' : 'option-group-checkbox'}">`;
                    
                    group.choices.forEach((choice, cIndex) => {
                        let priceText = '';
                        let priceClass = '';
                        if (choice.price > 0) { priceText = `+$${choice.price.toFixed(2)}`; priceClass = 'choice-price-positive'; }
                        else if (choice.price < 0) { priceText = `-$${Math.abs(choice.price).toFixed(2)}`; priceClass = 'choice-price-negative'; }
                        
                        if (group.type === 'radio') {
                            modalHtml += `<div class="choice-item">
                                            <label class="choice-label">
                                                <input type="radio" name="group_${group.id || gIndex}" value="${choice.name}" data-price="${choice.price}" data-group-name="${group.name}" data-choice-name="${choice.name}">
                                                <span class="choice-name">${choice.name}</span>
                                            </label>
                                            <span class="choice-price ${priceClass}">${priceText}</span>
                                          </div>`;
                        } else {
                            modalHtml += `<div class="choice-item">
                                            <label class="choice-label">
                                                <input type="checkbox" name="group_${group.id || gIndex}" value="${choice.name}" data-price="${choice.price}" data-group-name="${group.name}" data-choice-name="${choice.name}">
                                                <span class="choice-name">${choice.name}</span>
                                            </label>
                                            <span class="choice-price ${priceClass}">${priceText}</span>
                                          </div>`;
                        }
                    });
                    modalHtml += `</div></div>`;
                }
            });

            modalHtml += `<div class="options-total">
                            <span>Total:</span>
                            <span class="options-total-amount" id="optionsTotalAmount">$${basePrice.toFixed(2)}</span>
                          </div>
                          <div class="options-modal-actions">
                            <button class="btn btn-secondary" id="cancelOptionsBtn"><i class="fas fa-times"></i> Cancel</button>
                            <button class="btn btn-primary" id="confirmOptionsBtn"><i class="fas fa-check"></i> Add to Cart</button>
                          </div>`;

            optionsModalContent.innerHTML = modalHtml;
            optionsModal.style.display = 'flex';

            // Update total for radio/checkbox groups
            const inputs = optionsModal.querySelectorAll('input[type="radio"], input[type="checkbox"]');
            const updateTotal = () => {
                let extra = 0;
                inputs.forEach(input => {
                    if (input.type === 'radio' && input.checked) {
                        extra += parseFloat(input.dataset.price || 0);
                    } else if (input.type === 'checkbox' && input.checked) {
                        extra += parseFloat(input.dataset.price || 0);
                    }
                });
                document.getElementById('optionsTotalAmount').textContent = `$${(basePrice + extra).toFixed(2)}`;
            };
            inputs.forEach(input => input.addEventListener('change', updateTotal));

            document.getElementById('cancelOptionsBtn').addEventListener('click', () => {
                optionsModal.style.display = 'none';
            });

            document.getElementById('confirmOptionsBtn').addEventListener('click', () => {
                let selected = [];
                // Collect radio/checkbox choices
                inputs.forEach(input => {
                    if (input.checked) {
                        selected.push({
                            groupName: input.dataset.groupName,
                            choiceName: input.dataset.choiceName,
                            price: parseFloat(input.dataset.price || 0),
                            isComment: false
                        });
                    }
                });
                // Collect comment fields
                item.options.forEach((group, gIndex) => {
                    if (group.type === 'text') {
                        const commentField = document.getElementById(`comment_${group.id || gIndex}`);
                        if (commentField && commentField.value.trim() !== '') {
                            selected.push({
                                groupName: group.name,
                                choiceName: commentField.value.trim(),
                                price: 0,
                                isComment: true
                            });
                        }
                    }
                });
                addToCartWithOptions(item.id, selected);
                optionsModal.style.display = 'none';
            });
        }

        // ========== UPDATE CART (with options display) ==========
        function updateCart() {
            if (state.isAdminMode) return;
            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            if (state.cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart" style="text-align: center; padding: 40px; color: var(--gray);"><i class="fas fa-shopping-cart" style="font-size: 50px; margin-bottom: 15px; opacity: 0.5;"></i><p>Your cart is empty</p></div>';
            } else {
                cartItems.innerHTML = '';
                state.cart.forEach(item => {
                    const cartItemElement = document.createElement('div');
                    cartItemElement.className = 'cart-item';
                    
                    let optionsHtml = '';
                    if (item.selectedOptions && item.selectedOptions.length) {
                        optionsHtml = '<div style="font-size:12px; color:var(--gray); margin-top:5px;">';
                        item.selectedOptions.forEach(opt => {
                            if (opt.isComment) {
                                optionsHtml += `<div><i class="fas fa-comment"></i> ${opt.groupName}: "${opt.choiceName}"</div>`;
                            } else {
                                optionsHtml += `<div>• ${opt.groupName}: ${opt.choiceName} ${opt.price > 0 ? `+$${opt.price.toFixed(2)}` : opt.price < 0 ? `-$${Math.abs(opt.price).toFixed(2)}` : ''}</div>`;
                            }
                        });
                        optionsHtml += '</div>';
                    }

                    cartItemElement.innerHTML = `<div class="cart-item-info">
                                                    <div class="cart-item-name">${item.name}</div>
                                                    ${optionsHtml}
                                                    <div class="cart-item-price">$${item.price.toFixed(2)}</div>
                                                 </div>
                                                 <div class="cart-item-controls">
                                                    <div class="quantity-control">
                                                        <button class="quantity-btn decrease" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-minus"></i></button>
                                                        <span class="quantity">${item.quantity}</span>
                                                        <button class="quantity-btn increase" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-plus"></i></button>
                                                    </div>
                                                    <div class="remove-item" data-id="${item.id}" data-options='${JSON.stringify(item.selectedOptions)}'><i class="fas fa-trash"></i></div>
                                                 </div>`;
                    cartItems.appendChild(cartItemElement);
                });
                document.querySelectorAll('.decrease').forEach(btn => { 
                    btn.addEventListener('click', function() { 
                        const itemId = parseInt(this.getAttribute('data-id')); 
                        const options = JSON.parse(this.getAttribute('data-options') || '[]');
                        updateCartItemQuantity(itemId, options, -1); 
                    }); 
                });
                document.querySelectorAll('.increase').forEach(btn => { 
                    btn.addEventListener('click', function() { 
                        const itemId = parseInt(this.getAttribute('data-id')); 
                        const options = JSON.parse(this.getAttribute('data-options') || '[]');
                        updateCartItemQuantity(itemId, options, 1); 
                    }); 
                });
                document.querySelectorAll('.remove-item').forEach(btn => { 
                    btn.addEventListener('click', function() { 
                        const itemId = parseInt(this.getAttribute('data-id')); 
                        const options = JSON.parse(this.getAttribute('data-options') || '[]');
                        removeFromCart(itemId, options); 
                    }); 
                });
            }
            updateCartSummary();
        }

        function updateCartItemQuantity(itemId, options, change) {
            const index = state.cart.findIndex(item => 
                item.id === itemId && 
                JSON.stringify(item.selectedOptions) === JSON.stringify(options)
            );
            if (index !== -1) {
                state.cart[index].quantity += change;
                if (state.cart[index].quantity <= 0) {
                    state.cart.splice(index, 1);
                }
                updateCart();
            }
        }

        function removeFromCart(itemId, options) {
            const index = state.cart.findIndex(item => 
                item.id === itemId && 
                JSON.stringify(item.selectedOptions) === JSON.stringify(options)
            );
            if (index !== -1) {
                const item = state.cart[index];
                state.cart.splice(index, 1);
                updateCart();
                showNotification(`${item.name} removed from cart`);
            }
        }

        function updateCartSummary() {
            const subtotal = calculateSubtotal();
            const total = calculateTotal();
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        function updatePaymentSummary() {
            const subtotal = calculateSubtotal();
            const total = calculateTotal();
            document.getElementById('paymentSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('paymentTotal').textContent = `$${total.toFixed(2)}`;
        }

        function calculateSubtotal() {
            return state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        function calculateTotal() {
            return calculateSubtotal();
        }

        function generateOrderNumber() {
            const prefix = 'ORD';
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `${prefix}-${randomNum}`;
        }

        // ========== ORDER CONFIRMATION ==========
        function showOrderConfirmation(order) {
            orderNumberDisplay.textContent = order.orderNumber;
            confirmationTable.textContent = `Table: ${order.table}`;
            confirmationItems.innerHTML = '';
            order.items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                let optionsText = '';
                if (item.selectedOptions && item.selectedOptions.length) {
                    optionsText = '<div style="font-size:12px; color:var(--gray);">' + 
                        item.selectedOptions.map(opt => {
                            if (opt.isComment) {
                                return `${opt.groupName}: "${opt.choiceName}"`;
                            } else {
                                return `${opt.groupName}: ${opt.choiceName}`;
                            }
                        }).join(', ') + 
                        '</div>';
                }
                confirmationItems.innerHTML += `<div class="order-item">
                                                    <div class="order-item-name">
                                                        <div class="order-item-quantity">${item.quantity}</div>
                                                        <div>
                                                            ${item.name}
                                                            ${optionsText}
                                                        </div>
                                                    </div>
                                                    <div class="order-item-price">$${itemTotal.toFixed(2)}</div>
                                                </div>`;
            });
            confirmationTotal.textContent = `$${order.total.toFixed(2)}`;
            confirmationPaymentMethod.textContent = order.paymentMethod === 'card' ? 'Credit/Debit Card' : 'Cash';
            confirmationPaymentTime.textContent = order.paymentTime === 'now' ? 'Pay Now' : 'Pay Later';
            confirmationOrderStatus.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
        }

        // ========== RESET ==========
        function resetCart() { state.cart = []; updateCart(); }
        function resetOrder() {
            state.cart = []; state.selectedPaymentMethod = null; state.selectedPaymentTime = null; state.currentOrderNumber = null; state.currentTable = null;
            updateCart(); document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
            tableInfo.innerHTML = `<i class="fas fa-qrcode"></i> Scan QR to begin`;
            menuSubtitle.textContent = 'Select items to add to your order';
            myOrdersButton.style.display = 'none';
        }

        // ========== TABLE SELECTION ==========
        function selectTable(tableName) {
            state.currentTable = tableName;
            if (tableName.toLowerCase() === "admin") { showAdminCodePrompt(); return; }
            tableInfo.innerHTML = `<i class="fas fa-chair"></i> ${tableName}`;
            menuSubtitle.textContent = `Select items to add to your order for ${tableName}`;
            cartSubtitle.textContent = `Your order for ${tableName}`;
            localStorage.setItem('dineEasyTable', tableName);
            showNotification(`Table ${tableName} selected. Welcome!`);
            resetCart();
            updateCategoryTabs();
            displayMenuItems('all');
            myOrdersButton.style.display = 'flex';
            showSection('menuSection');
        }

        // ========== SECTION SWITCHING ==========
        function showSection(sectionId) {
            document.querySelectorAll('.app-section, .admin-dashboard-section').forEach(section => { section.classList.remove('active-section'); section.style.display = 'none'; });
            const section = document.getElementById(sectionId);
            if (section) { section.style.display = 'block'; setTimeout(() => section.classList.add('active-section'), 10); }
            if (sectionId === 'cartSection' && state.currentTable && !state.isAdminMode) cartSubtitle.textContent = `Your order for ${state.currentTable}`;
            if (sectionId === 'menuSection' && state.currentTable && !state.isAdminMode) menuSubtitle.textContent = state.cart.length === 0 ? `Select items to add to your order for ${state.currentTable}` : `Continue adding items to your order for ${state.currentTable}`;
            if (sectionId === 'myOrdersSection' && state.currentTable && !state.isAdminMode) loadMyOrders();
            if (state.isAdminMode) cartFloating.style.display = 'none'; else if (sectionId !== 'scannerSection') cartFloating.style.display = 'flex';
        }

        // ========== MY ORDERS ==========
        function loadMyOrders() {
            if (!state.currentTable || state.isAdminMode) { ordersList.innerHTML = '<div class="no-orders-message"><i class="fas fa-clipboard-list"></i><h3>No Table Selected</h3><p>Please select a table first to view your orders.</p></div>'; return; }
            const tableOrders = state.orders.filter(order => order.table === state.currentTable);
            if (tableOrders.length === 0) { ordersList.innerHTML = '<div class="no-orders-message"><i class="fas fa-clipboard-list"></i><h3>No Orders Yet</h3><p>You haven\'t placed any orders yet. Start by selecting items from the menu.</p></div>'; return; }
            tableOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            ordersList.innerHTML = '';
            tableOrders.forEach(order => {
                const orderCard = document.createElement('div'); orderCard.className = 'order-card';
                const date = new Date(order.timestamp); const formattedDate = date.toLocaleString();
                let statusBadge = ''; switch(order.status) { case 'pending': statusBadge = '<span class="order-status-badge status-pending">Pending</span>'; break; case 'preparing': statusBadge = '<span class="order-status-badge status-preparing">Preparing</span>'; break; case 'ready': statusBadge = '<span class="order-status-badge status-ready">Ready</span>'; break; case 'served': statusBadge = '<span class="order-status-badge status-served">Served</span>'; break; case 'cancelled': statusBadge = '<span class="order-status-badge status-cancelled">Cancelled</span>'; break; }
                let itemsSummary = '';
                if (order.items.length <= 3) {
                    itemsSummary = order.items.map(item => `<div class="order-item-summary"><div class="order-item-summary-name"><div class="order-item-summary-quantity">${item.quantity}</div><div>${item.name}</div></div><div>$${(item.price * item.quantity).toFixed(2)}</div></div>`).join('');
                } else {
                    const firstItems = order.items.slice(0,3); const remainingCount = order.items.length - 3;
                    itemsSummary = firstItems.map(item => `<div class="order-item-summary"><div class="order-item-summary-name"><div class="order-item-summary-quantity">${item.quantity}</div><div>${item.name}</div></div><div>$${(item.price * item.quantity).toFixed(2)}</div></div>`).join('');
                    itemsSummary += `<div class="order-item-summary"><div class="order-item-summary-name" style="margin-left: 10px; font-style: italic;">+${remainingCount} more item${remainingCount > 1 ? 's' : ''}</div><div></div></div>`;
                }
                orderCard.innerHTML = `<div class="order-card-header"><div><div class="order-card-title">Order #${order.orderNumber}</div><div class="order-card-time">${formattedDate}</div></div><div>${statusBadge}</div></div><div class="order-card-body"><div class="order-items-summary">${itemsSummary}</div><div style="margin-top: 15px;"><div style="display: flex; justify-content: space-between; margin-bottom: 5px;"><span>Payment Method:</span><span>${order.paymentMethod === 'card' ? 'Card' : 'Cash'}</span></div><div style="display: flex; justify-content: space-between;"><span>Payment Time:</span><span>${order.paymentTime === 'now' ? 'Pay Now' : 'Pay Later'}</span></div></div></div><div class="order-card-footer"><div class="order-total-summary">Total: $${order.total.toFixed(2)}</div><div style="font-size: 14px; color: var(--gray);">${order.status === 'pending' ? 'Your order is being processed' : order.status === 'preparing' ? 'Your food is being prepared' : order.status === 'ready' ? 'Your order is ready' : order.status === 'served' ? 'Your order has been served' : 'Your order has been cancelled'}</div></div>`;
                ordersList.appendChild(orderCard);
            });
            myOrdersSubtitle.textContent = `You have ${tableOrders.length} order${tableOrders.length !== 1 ? 's' : ''} for ${state.currentTable}`;
        }

        // ========== NOTIFICATION ==========
        function showNotification(message) { notificationText.textContent = message; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }

        // ========== ADMIN MODE ==========
        function showAdminCodePrompt() { adminCodePrompt.style.display = 'flex'; adminCodeInput.focus(); }
        function showAdminChangePrompt(actionCallback) { state.pendingAdminAction = actionCallback; adminChangePrompt.style.display = 'flex'; adminChangeCodeInput.focus(); }
        function enterAdminMode() {
            state.isAdminMode = true; state.currentTable = "Admin";
            document.body.classList.add('admin-mode');
            document.querySelector('.header-center').innerHTML = '<div class="admin-badge"><i class="fas fa-shield-alt"></i> Administrator Mode</div>';
            document.querySelector('.header-right').innerHTML = '<button class="logout-button" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</button>';
            document.getElementById('logoutButton').addEventListener('click', exitAdminMode);
            cartFloating.style.display = 'none';
            showSection('adminDashboardSection');
            loadAdminDashboardData();

            // ---- INSTANT ORDER UPDATES FOR ADMIN ----
            if (!state.ordersListener) {
                state.ordersListener = db.collection('orders').onSnapshot((snapshot) => {
                    // Update state.orders with the latest data from Firestore
                    state.orders = snapshot.docs.map(doc => ({
                        ...doc.data(),
                        orderNumber: doc.id
                    }));
                    // If admin dashboard is currently visible, refresh orders and stats
                    if (state.isAdminMode && document.querySelector('#adminDashboardSection.active-section')) {
                        loadOrdersForAdmin();
                        loadSystemStats();
                    }
                    // Also refresh the "My Orders" view if the customer is looking at his orders
                    if (document.querySelector('#myOrdersSection.active-section')) {
                        loadMyOrders();
                    }
                }, (error) => {
                    console.error("Orders snapshot error:", error);
                });
            }

            localStorage.setItem('dineEasyAdminMode', 'true');
            showNotification("Admin mode activated. Full administrative access granted.");
        }
        function exitAdminMode() {
            // ---- REMOVE REAL‑TIME LISTENER ----
            if (state.ordersListener) {
                state.ordersListener();
                state.ordersListener = null;
            }

            state.isAdminMode = false; state.currentTable = null;
            document.body.classList.remove('admin-mode');
            document.querySelector('.header-center').innerHTML = '<button class="help-button" id="headerHelpButton"><i class="fas fa-headset"></i> Χρειάζεστε βοήθεια?</button>';
            document.querySelector('.header-right').innerHTML = '<button class="my-orders-button" id="myOrdersButton" style="display: none;"><i class="fas fa-clipboard-list"></i> Οι Παραγγελίες μου</button><div class="table-info" id="tableInfo"><i class="fas fa-qrcode"></i> Scan QR to begin</div>';
            document.getElementById('headerHelpButton').addEventListener('click', function() { showHelpNotification(); });
            cartFloating.style.display = 'flex';
            showSection('scannerSection');
            localStorage.removeItem('dineEasyAdminMode');
            showNotification("Logged out of admin mode.");
        }
        function showHelpNotification() { if (state.currentTable) showNotification(`Ένας σερβιτόρος θα σας εξυπηρετήσει σύντομα.`); else showNotification('Ένας σερβιτόρος θα σας εξυπηρετήσει σύντομα.'); }

        // ========== DRAG AND DROP REORDER FUNCTIONS ==========
        function makeAdminGridDraggable(containerId) {
            const grid = document.getElementById(containerId);
            if (!grid) return;
            
            let draggedItem = null;
            
            // Attach dragstart to each card
            grid.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('admin-card') || e.target.closest('.admin-card')) {
                    const card = e.target.classList.contains('admin-card') ? e.target : e.target.closest('.admin-card');
                    draggedItem = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', card.dataset.itemId || '');
                }
            });
            
            grid.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            
            grid.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            grid.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!draggedItem) return;
                
                const targetCard = e.target.classList.contains('admin-card') ? e.target : e.target.closest('.admin-card');
                if (!targetCard || targetCard === draggedItem) return;
                
                // Get positions
                const parent = grid;
                const items = Array.from(parent.children).filter(el => el.classList.contains('admin-card'));
                const draggedIndex = items.indexOf(draggedItem);
                const targetIndex = items.indexOf(targetCard);
                
                if (draggedIndex === -1 || targetIndex === -1) return;
                
                // Reorder DOM
                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedItem, targetCard.nextSibling);
                } else {
                    parent.insertBefore(draggedItem, targetCard);
                }
                
                // Update displayOrder in state and Firestore
                const updatedItems = Array.from(parent.children).filter(el => el.classList.contains('admin-card'));
                updatedItems.forEach((card, idx) => {
                    const itemId = parseInt(card.dataset.itemId);
                    const menuItem = state.menuItems.find(i => i.id === itemId);
                    if (menuItem) {
                        menuItem.displayOrder = idx;
                    }
                });
                
                // Save to Firestore
                saveToFirestore().then(() => {
                    // Refresh the menu display if visible
                    if (document.querySelector('#menuSection.active-section')) {
                        displayMenuItems('all');
                    }
                    showNotification("Menu order updated");
                });
            });
        }

        // ========== ADMIN DASHBOARD DATA ==========
        function loadAdminDashboardData() {
            document.getElementById('adminRestaurantName').value = state.restaurantInfo.name;
            document.getElementById('adminTaxRate').value = state.restaurantInfo.taxRate;
            document.getElementById('adminPrepTime').value = state.restaurantInfo.estimatedPrepTime;
            document.getElementById('adminWelcomeMessage').value = state.restaurantInfo.welcomeMessage || '';
            updateLogoPreview();
            loadMenuItemsForAdmin();
            loadCategoriesForAdmin();
            loadOrdersForAdmin();
            loadSystemStats();
            loadCustomizationSettings();

            document.querySelectorAll('#adminDashboardSection .admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('#adminDashboardSection .admin-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('#adminDashboardSection .admin-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + 'Tab').classList.add('active');
                    if (tabId === 'customization') setTimeout(() => initializeCustomizationTab(), 100);
                });
            });
            document.getElementById('uploadLogoBtn').addEventListener('click', () => document.getElementById('logoUpload').click());
            document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
            document.getElementById('removeLogoBtn').addEventListener('click', removeLogo);
            document.getElementById('saveRestaurantSettings').addEventListener('click', () => showAdminChangePrompt(saveRestaurantSettings));
            document.getElementById('addMenuItemBtn').addEventListener('click', () => openEditMenuItemForm(null));
            document.getElementById('addCategoryBtn').addEventListener('click', () => showAdminChangePrompt(addNewCategory));
            document.getElementById('orderStatusFilter').addEventListener('change', loadOrdersForAdmin);
            document.getElementById('clearOrdersBtn').addEventListener('click', () => showAdminChangePrompt(async function() { if (confirm("Clear ALL orders?")) { state.orders = []; await saveToFirestore(); loadOrdersForAdmin(); loadMyOrders(); showNotification("All orders cleared."); } }));
            document.getElementById('resetMenuBtn').addEventListener('click', () => showAdminChangePrompt(async function() { if (confirm("Reset menu to default?")) { state.menuItems = [...defaultMenuItems]; await saveToFirestore(); loadMenuItemsForAdmin(); displayMenuItems('all'); showNotification("Menu reset."); } }));
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importDataInput').click());
            document.getElementById('importDataInput').addEventListener('change', (e) => showAdminChangePrompt(() => importData(e)));
            adminDashboardSection.addEventListener('click', function(e) {
                if (e.target && (e.target.classList.contains('update-status') || e.target.closest('.update-status'))) {
                    const updateBtn = e.target.classList.contains('update-status') ? e.target : e.target.closest('.update-status');
                    const orderId = updateBtn.getAttribute('data-order-id');
                    const select = document.querySelector(`select[data-order-id="${orderId}"]`);
                    if (select && orderId) {
                        // DIRECT UPDATE – NO CODE PROMPT
                        updateOrderStatus(orderId, select.value);
                    }
                }
            });
            
            // Initialize drag and drop for admin grid after loading
            setTimeout(() => {
                makeAdminGridDraggable('menuItemsList');
            }, 500);
        }

        function updateLogoPreview() {
            const logoPreview = document.getElementById('logoPreview'); const logoPreviewModal = document.getElementById('logoPreviewModal');
            if (state.restaurantInfo.logoImage) { logoPreview.innerHTML = `<img src="${state.restaurantInfo.logoImage}" alt="Restaurant Logo">`; if (logoPreviewModal) logoPreviewModal.innerHTML = `<img src="${state.restaurantInfo.logoImage}" alt="Restaurant Logo">`; }
            else { logoPreview.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div>'; if (logoPreviewModal) logoPreviewModal.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-image"></i><p>No logo uploaded</p></div>'; }
        }
        function handleLogoUpload(event) { const file = event.target.files[0]; if (!file) return; if (!file.type.match('image.*')) { showNotification("Please select an image file."); return; } const reader = new FileReader(); reader.onload = function(e) { state.restaurantInfo.logoImage = e.target.result; updateLogoPreview(); updateRestaurantUI(); showNotification("Logo uploaded. Don't forget to save."); }; reader.readAsDataURL(file); }
        function removeLogo() { state.restaurantInfo.logoImage = ""; updateLogoPreview(); updateRestaurantUI(); showNotification("Logo removed. Don't forget to save."); }
        async function saveRestaurantSettings() {
            state.restaurantInfo.name = document.getElementById('adminRestaurantName').value;
            state.restaurantInfo.taxRate = parseFloat(document.getElementById('adminTaxRate').value);
            state.restaurantInfo.estimatedPrepTime = document.getElementById('adminPrepTime').value;
            state.restaurantInfo.welcomeMessage = document.getElementById('adminWelcomeMessage').value;
            await saveToFirestore(); updateRestaurantUI(); showNotification("Restaurant settings saved.");
        }

        // ========== ADMIN MENU ITEMS (with options UI + DUPLICATE BUTTON + COMMENT FIELD + DRAG DROP) ==========
        function loadMenuItemsForAdmin() {
            const menuItemsList = document.getElementById('menuItemsList'); menuItemsList.innerHTML = '';
            if (state.menuItems.length === 0) { menuItemsList.innerHTML = '<p style="text-align: center; color: var(--gray);">No menu items found.</p>'; return; }
            // Sort by displayOrder
            const sortedItems = [...state.menuItems].sort((a,b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            sortedItems.forEach(item => {
                const itemCard = document.createElement('div'); itemCard.className = 'admin-card';
                itemCard.setAttribute('draggable', 'true');
                itemCard.setAttribute('data-item-id', item.id);
                const hasImage = item.image && item.image.trim() !== '';
                const imageContent = hasImage ? `<div style="height: 120px; background-image: url('${item.image}'); background-size: cover; background-position: center; border-radius: 8px; margin-bottom: 10px;"></div>` : `<div style="height: 120px; background-color: var(--light-gray); border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: var(--gray);"><i class="fas fa-utensils"></i></div>`;
                itemCard.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><i class="fas fa-grip-vertical drag-handle"></i></div>${imageContent}<div class="admin-card-header"><div class="admin-card-title">${item.name}</div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-item" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-secondary duplicate-item" data-id="${item.id}"><i class="fas fa-copy"></i></button><button class="admin-small-btn btn-danger delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div><p style="margin-bottom: 10px; font-size: 14px;">${item.description}</p><div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-weight: 600; color: var(--primary);">$${item.price.toFixed(2)}</span><span style="font-size: 12px; color: var(--gray);">${getCategoryDisplayName(item.category)}</span></div><div class="tag-display">${item.tags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}</div>`;
                if (item.options && item.options.length) {
                    itemCard.innerHTML += `<div style="margin-top:10px; font-size:12px; color:var(--secondary);"><i class="fas fa-tasks"></i> ${item.options.length} option group(s)</div>`;
                }
                menuItemsList.appendChild(itemCard);
            });
            document.querySelectorAll('.edit-item').forEach(btn => { btn.addEventListener('click', function() { const itemId = parseInt(this.getAttribute('data-id')); openEditMenuItemForm(itemId); }); });
            document.querySelectorAll('.duplicate-item').forEach(btn => { btn.addEventListener('click', function() { const itemId = parseInt(this.getAttribute('data-id')); duplicateMenuItem(itemId); }); });
            document.querySelectorAll('.delete-item').forEach(btn => { btn.addEventListener('click', function() { const itemId = parseInt(this.getAttribute('data-id')); showAdminChangePrompt(() => deleteMenuItem(itemId)); }); });
            
            // Re-attach drag and drop
            makeAdminGridDraggable('menuItemsList');
        }

        // NEW: Duplicate a menu item
        async function duplicateMenuItem(itemId) {
            const original = state.menuItems.find(item => item.id === itemId);
            if (!original) return;
            const newId = state.menuItems.length > 0 ? Math.max(...state.menuItems.map(item => item.id)) + 1 : 1;
            const maxOrder = state.menuItems.reduce((max, i) => Math.max(max, i.displayOrder || 0), 0);
            const newItem = {
                ...original,
                id: newId,
                name: `${original.name} (copy)`,
                displayOrder: maxOrder + 1
            };
            state.menuItems.push(newItem);
            await saveToFirestore();
            loadMenuItemsForAdmin();
            displayMenuItems('all');
            showNotification(`"${newItem.name}" duplicated.`);
        }

        function openEditMenuItemForm(itemId) {
            const editForm = document.getElementById('editMenuItemForm');
            const menuItemsList = document.getElementById('menuItemsList');
            const categorySelect = document.getElementById('editItemCategory');
            categorySelect.innerHTML = '';
            state.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.displayName;
                categorySelect.appendChild(option);
            });

            // Remove previous options UI if exists
            const oldOptionsSection = document.getElementById('adminOptionsSection');
            if (oldOptionsSection) oldOptionsSection.remove();

            if (itemId) {
                const item = state.menuItems.find(i => i.id === itemId);
                if (item) {
                    document.getElementById('editItemName').value = item.name;
                    document.getElementById('editItemDescription').value = item.description;
                    document.getElementById('editItemPrice').value = item.price;
                    document.getElementById('editItemCategory').value = item.category;
                    document.getElementById('editItemTags').value = item.tags.join(', ');
                    updateItemImagePreview(item.image);
                    editForm.setAttribute('data-item-id', itemId);
                    buildOptionsAdminUI(item.options || []);
                }
            } else {
                document.getElementById('editItemName').value = '';
                document.getElementById('editItemDescription').value = '';
                document.getElementById('editItemPrice').value = '';
                document.getElementById('editItemCategory').value = state.categories.length > 0 ? state.categories[0].id : '';
                document.getElementById('editItemTags').value = '';
                updateItemImagePreview('');
                editForm.setAttribute('data-item-id', '');
                buildOptionsAdminUI([]);
            }

            document.getElementById('uploadItemImageBtn').addEventListener('click', () => document.getElementById('itemImageUpload').click());
            document.getElementById('itemImageUpload').addEventListener('change', handleItemImageUpload);
            document.getElementById('removeItemImageBtn').addEventListener('click', () => { updateItemImagePreview(''); state.currentImageUpload = null; });

            menuItemsList.style.display = 'none';
            editForm.style.display = 'block';

            document.getElementById('cancelEditBtn').onclick = function() {
                editForm.style.display = 'none';
                menuItemsList.style.display = 'block';
            };

            document.getElementById('saveMenuItemBtn').onclick = function() {
                showAdminChangePrompt(saveMenuItem);
            };
        }

        function buildOptionsAdminUI(options) {
            const editForm = document.getElementById('editMenuItemForm');
            const optionsSection = document.createElement('div');
            optionsSection.id = 'adminOptionsSection';
            optionsSection.className = 'admin-options-section';
            optionsSection.innerHTML = `<h4 style="margin-bottom:15px;"><i class="fas fa-tasks"></i> Options / Subcategories</h4>
                                        <div id="optionsGroupsContainer"></div>
                                        <button type="button" class="btn btn-secondary" id="addOptionGroupBtn"><i class="fas fa-plus"></i> Add Option Group</button>`;
            // Insert after tags input
            const tagsGroup = document.querySelector('.admin-form-group:has(#editItemTags)');
            if (tagsGroup) {
                tagsGroup.parentNode.insertBefore(optionsSection, tagsGroup.nextSibling);
            } else {
                editForm.appendChild(optionsSection);
            }

            const container = document.getElementById('optionsGroupsContainer');
            function renderGroups() {
                container.innerHTML = '';
                options.forEach((group, gIndex) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'admin-option-group';
                    groupDiv.innerHTML = `<div class="admin-option-group-header">
                                            <div class="admin-option-group-title">
                                                <i class="fas fa-layer-group"></i> 
                                                <input type="text" class="admin-input" style="width:150px;" placeholder="Group name" value="${group.name}" data-group-index="${gIndex}" id="group_name_${gIndex}">
                                                <select class="admin-select" style="width:140px;" data-group-index="${gIndex}" id="group_type_${gIndex}">
                                                    <option value="radio" ${group.type === 'radio' ? 'selected' : ''}>Single choice</option>
                                                    <option value="checkbox" ${group.type === 'checkbox' ? 'selected' : ''}>Multiple choice</option>
                                                    <option value="text" ${group.type === 'text' ? 'selected' : ''}>Comment field</option>
                                                </select>
                                            </div>
                                            <button class="admin-small-btn btn-danger remove-group" data-index="${gIndex}"><i class="fas fa-trash"></i></button>
                                        </div>
                                        <div id="choices_${gIndex}" class="choices-container"></div>
                                        ${group.type !== 'text' ? `<button class="btn btn-secondary add-choice-btn" data-group-index="${gIndex}"><i class="fas fa-plus"></i> Add Choice</button>` : ''}`;
                    container.appendChild(groupDiv);

                    if (group.type !== 'text') {
                        const choicesContainer = document.getElementById(`choices_${gIndex}`);
                        group.choices.forEach((choice, cIndex) => {
                            addChoiceRow(choicesContainer, gIndex, cIndex, choice);
                        });

                        groupDiv.querySelector('.add-choice-btn').addEventListener('click', function() {
                            group.choices.push({ name: '', price: 0 });
                            renderGroups();
                        });
                    }

                    groupDiv.querySelector('.remove-group').addEventListener('click', function() {
                        options.splice(gIndex, 1);
                        renderGroups();
                    });

                    groupDiv.querySelector(`#group_name_${gIndex}`).addEventListener('input', function(e) {
                        options[gIndex].name = e.target.value;
                    });
                    groupDiv.querySelector(`#group_type_${gIndex}`).addEventListener('change', function(e) {
                        options[gIndex].type = e.target.value;
                        // If switching to/from text, reset choices
                        if (options[gIndex].type === 'text') {
                            options[gIndex].choices = [];
                        } else if (!options[gIndex].choices) {
                            options[gIndex].choices = [];
                        }
                        renderGroups();
                    });
                });
            }

            function addChoiceRow(container, gIndex, cIndex, choice) {
                const choiceRow = document.createElement('div');
                choiceRow.className = 'admin-choice-item';
                choiceRow.innerHTML = `<input type="text" class="admin-input admin-choice-input" placeholder="Choice name" value="${choice.name || ''}" data-group="${gIndex}" data-choice="${cIndex}" id="choice_name_${gIndex}_${cIndex}">
                                        <input type="number" class="admin-input admin-choice-price" placeholder="Price adj." step="0.01" value="${choice.price || 0}" data-group="${gIndex}" data-choice="${cIndex}" id="choice_price_${gIndex}_${cIndex}">
                                        <button class="admin-small-btn btn-danger remove-choice" data-group="${gIndex}" data-choice="${cIndex}"><i class="fas fa-times"></i></button>`;
                container.appendChild(choiceRow);

                choiceRow.querySelector(`#choice_name_${gIndex}_${cIndex}`).addEventListener('input', function(e) {
                    if (!options[gIndex].choices[cIndex]) options[gIndex].choices[cIndex] = {};
                    options[gIndex].choices[cIndex].name = e.target.value;
                });
                choiceRow.querySelector(`#choice_price_${gIndex}_${cIndex}`).addEventListener('input', function(e) {
                    if (!options[gIndex].choices[cIndex]) options[gIndex].choices[cIndex] = {};
                    options[gIndex].choices[cIndex].price = parseFloat(e.target.value) || 0;
                });
                choiceRow.querySelector('.remove-choice').addEventListener('click', function() {
                    options[gIndex].choices.splice(cIndex, 1);
                    renderGroups();
                });
            }

            renderGroups();

            document.getElementById('addOptionGroupBtn').addEventListener('click', function() {
                options.push({ id: Date.now() + Math.random(), name: 'New Group', type: 'radio', choices: [] });
                renderGroups();
            });
        }

        function updateItemImagePreview(imageData) {
            const itemImagePreview = document.getElementById('itemImagePreview');
            if (imageData && imageData.trim() !== '') { itemImagePreview.innerHTML = `<img src="${imageData}" alt="Menu Item Image">`; state.currentImageUpload = imageData; }
            else { itemImagePreview.innerHTML = '<div class="image-preview-placeholder"><i class="fas fa-utensils"></i><p>No image uploaded</p></div>'; state.currentImageUpload = null; }
        }
        function handleItemImageUpload(event) { const file = event.target.files[0]; if (!file) return; if (!file.type.match('image.*')) { showNotification("Please select an image file."); return; } const reader = new FileReader(); reader.onload = function(e) { updateItemImagePreview(e.target.result); showNotification("Image uploaded. Don't forget to save."); }; reader.readAsDataURL(file); }

        async function saveMenuItem() {
            const itemId = document.getElementById('editMenuItemForm').getAttribute('data-item-id');
            const name = document.getElementById('editItemName').value;
            const description = document.getElementById('editItemDescription').value;
            const price = parseFloat(document.getElementById('editItemPrice').value);
            const category = document.getElementById('editItemCategory').value;
            const tags = document.getElementById('editItemTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            if (!name || !description || !price) { showNotification("Please fill in all required fields."); return; }
            if (!category) { showNotification("Please select a category."); return; }

            // Collect options from UI
            let options = [];
            const optionsSection = document.getElementById('adminOptionsSection');
            if (optionsSection) {
                const groupDivs = optionsSection.querySelectorAll('.admin-option-group');
                groupDivs.forEach((groupDiv, gIndex) => {
                    const groupNameInput = groupDiv.querySelector(`#group_name_${gIndex}`);
                    const groupTypeSelect = groupDiv.querySelector(`#group_type_${gIndex}`);
                    if (!groupNameInput) return;
                    const groupName = groupNameInput.value;
                    const groupType = groupTypeSelect ? groupTypeSelect.value : 'radio';
                    const choices = [];
                    if (groupType !== 'text') {
                        const choiceRows = groupDiv.querySelectorAll('.admin-choice-item');
                        choiceRows.forEach((row, cIndex) => {
                            const nameInput = row.querySelector(`#choice_name_${gIndex}_${cIndex}`);
                            const priceInput = row.querySelector(`#choice_price_${gIndex}_${cIndex}`);
                            if (nameInput && nameInput.value.trim() !== '') {
                                choices.push({
                                    name: nameInput.value.trim(),
                                    price: parseFloat(priceInput.value) || 0
                                });
                            }
                        });
                    }
                    if (groupName.trim() !== '' && (groupType === 'text' || choices.length > 0)) {
                        options.push({
                            id: 'opt_' + Date.now() + '_' + gIndex,
                            name: groupName.trim(),
                            type: groupType,
                            choices: choices
                        });
                    }
                });
            }

            if (itemId) {
                const index = state.menuItems.findIndex(item => item.id === parseInt(itemId));
                if (index !== -1) {
                    state.menuItems[index] = {
                        ...state.menuItems[index],
                        name, description, price, category,
                        image: state.currentImageUpload || state.menuItems[index].image,
                        tags,
                        options: options
                    };
                }
            } else {
                const newId = state.menuItems.length > 0 ? Math.max(...state.menuItems.map(item => item.id)) + 1 : 1;
                const maxOrder = state.menuItems.reduce((max, i) => Math.max(max, i.displayOrder || 0), 0);
                state.menuItems.push({
                    id: newId, name, description, price, category,
                    image: state.currentImageUpload || '',
                    tags,
                    options: options,
                    displayOrder: maxOrder + 1
                });
            }

            await saveToFirestore();
            document.getElementById('editMenuItemForm').style.display = 'none';
            document.getElementById('menuItemsList').style.display = 'block';
            state.currentImageUpload = null;
            loadMenuItemsForAdmin();
            displayMenuItems('all');
            showNotification(itemId ? "Menu item updated." : "Menu item added.");
        }

        async function deleteMenuItem(itemId) { if (confirm("Delete this menu item?")) { state.menuItems = state.menuItems.filter(item => item.id !== itemId); await saveToFirestore(); loadMenuItemsForAdmin(); displayMenuItems('all'); showNotification("Menu item deleted."); } }

        // ========== CATEGORY MANAGEMENT ==========
        function loadCategoriesForAdmin() {
            const categoriesListContainer = document.getElementById('categoriesListContainer'); categoriesListContainer.innerHTML = '';
            if (state.categories.length === 0) categoriesListContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">No categories added yet.</p>';
            else state.categories.forEach(category => { const itemCount = state.menuItems.filter(item => item.category === category.id).length; const categoryItem = document.createElement('div'); categoryItem.className = 'category-item'; categoryItem.innerHTML = `<div><span class="category-item-name">${category.displayName}</span><span class="category-item-count">${itemCount} item${itemCount !== 1 ? 's' : ''}</span></div><div class="admin-card-actions"><button class="admin-small-btn btn-danger delete-category" data-id="${category.id}"><i class="fas fa-trash"></i></button></div>`; categoriesListContainer.appendChild(categoryItem); });
            document.querySelectorAll('.delete-category').forEach(btn => { btn.addEventListener('click', function() { const categoryId = this.getAttribute('data-id'); showAdminChangePrompt(() => deleteCategory(categoryId)); }); });
        }
        async function addNewCategory() {
            const categoryNameInput = document.getElementById('newCategoryName'); const displayNameInput = document.getElementById('newCategoryDisplayName');
            const categoryName = categoryNameInput.value.trim().toLowerCase().replace(/\s+/g, '-'); const displayName = displayNameInput.value.trim() || categoryNameInput.value.trim();
            if (!categoryName) { showNotification("Please enter a category name."); return; }
            if (state.categories.some(cat => cat.id === categoryName || cat.name === categoryName)) { showNotification("A category with this name already exists."); return; }
            state.categories.push({ id: categoryName, name: categoryName, displayName: displayName, isDefault: false });
            await saveToFirestore(); categoryNameInput.value = ''; displayNameInput.value = ''; loadCategoriesForAdmin(); updateCategoryTabs(); showNotification(`Category "${displayName}" added.`);
        }
        async function deleteCategory(categoryId) {
            const category = state.categories.find(cat => cat.id === categoryId); if (!category) return;
            const itemsInCategory = state.menuItems.filter(item => item.category === categoryId);
            if (itemsInCategory.length > 0) { showNotification(`Cannot delete "${category.displayName}" because it has ${itemsInCategory.length} menu item(s).`); return; }
            if (confirm(`Delete category "${category.displayName}"?`)) { state.categories = state.categories.filter(cat => cat.id !== categoryId); await saveToFirestore(); loadCategoriesForAdmin(); updateCategoryTabs(); showNotification(`Category "${category.displayName}" deleted.`); }
        }
        function getCategoryDisplayName(categoryId) { const category = state.categories.find(cat => cat.id === categoryId); return category ? category.displayName : categoryId; }

        // ========== ORDER MANAGEMENT – MODIFIED TO SHOW OPTIONS AND DIRECT UPDATE ==========
        function loadOrdersForAdmin() {
            const adminOrdersList = document.getElementById('adminOrdersList'); const statusFilter = document.getElementById('orderStatusFilter').value;
            let filteredOrders = [...state.orders]; if (statusFilter !== 'all') filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            filteredOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (filteredOrders.length === 0) { adminOrdersList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 40px;">No orders found.</p>'; return; }
            adminOrdersList.innerHTML = '';
            filteredOrders.forEach(order => {
                const orderCard = document.createElement('div'); orderCard.className = 'admin-card'; orderCard.style.marginBottom = '15px';
                const date = new Date(order.timestamp); const formattedDate = date.toLocaleString();
                let statusBadge = ''; switch(order.status) { case 'pending': statusBadge = '<span class="order-status-badge status-pending">Pending</span>'; break; case 'preparing': statusBadge = '<span class="order-status-badge status-preparing">Preparing</span>'; break; case 'ready': statusBadge = '<span class="order-status-badge status-ready">Ready</span>'; break; case 'served': statusBadge = '<span class="order-status-badge status-served">Served</span>'; break; case 'cancelled': statusBadge = '<span class="order-status-badge status-cancelled">Cancelled</span>'; break; }
                
                // Build detailed items HTML with options
                let itemsHtml = '';
                order.items.forEach(item => {
                    itemsHtml += `<div style="margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span><strong>${item.quantity}x ${item.name}</strong></span>
                                        <span style="color: var(--primary);">$${(item.price * item.quantity).toFixed(2)}</span>
                                    </div>`;
                    if (item.selectedOptions && item.selectedOptions.length) {
                        itemsHtml += '<div style="margin-left: 20px; font-size: 12px; color: var(--gray);">';
                        item.selectedOptions.forEach(opt => {
                            if (opt.isComment) {
                                itemsHtml += `<div><i class="fas fa-comment"></i> ${opt.groupName}: "${opt.choiceName}"</div>`;
                            } else {
                                itemsHtml += `<div>• ${opt.groupName}: ${opt.choiceName} ${opt.price > 0 ? `(+$${opt.price.toFixed(2)})` : opt.price < 0 ? `(-$${Math.abs(opt.price).toFixed(2)})` : ''}</div>`;
                            }
                        });
                        itemsHtml += '</div>';
                    }
                    itemsHtml += '</div>';
                });

                orderCard.innerHTML = `<div class="admin-card-header">
                                            <div>
                                                <div class="admin-card-title">Order #${order.orderNumber}</div>
                                                <div style="font-size: 12px; color: var(--gray);">${formattedDate}</div>
                                            </div>
                                            <div>${statusBadge}</div>
                                        </div>
                                        <p style="margin-bottom: 10px; font-size: 14px;">
                                            <strong>Table:</strong> ${order.table}<br>
                                            <strong>Items:</strong>
                                        </p>
                                        <div style="margin-bottom: 15px;">${itemsHtml}</div>
                                        <p style="margin-bottom: 10px; font-size: 14px;">
                                            <strong>Total:</strong> $${order.total.toFixed(2)}<br>
                                            <strong>Payment:</strong> ${order.paymentMethod === 'card' ? 'Card' : 'Cash'} (${order.paymentTime === 'now' ? 'Pay Now' : 'Pay Later'})
                                        </p>
                                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                                            <select class="admin-select" style="flex: 1;" data-order-id="${order.orderNumber}">
                                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                                                <option value="served" ${order.status === 'served' ? 'selected' : ''}>Served</option>
                                                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                            </select>
                                            <button class="btn btn-primary btn-small update-status" data-order-id="${order.orderNumber}" style="padding: 8px 15px;">Update</button>
                                        </div>`;
                adminOrdersList.appendChild(orderCard);
            });
        }

        async function updateOrderStatus(orderId, newStatus) {
            const orderIndex = state.orders.findIndex(o => o.orderNumber === orderId);
            if (orderIndex !== -1) { 
                state.orders[orderIndex].status = newStatus; 
                await saveToFirestore(); 
                loadOrdersForAdmin(); 
                if (state.currentTable === state.orders[orderIndex].table) loadMyOrders(); 
                showNotification(`Order #${orderId} status updated.`); 
            } else showNotification(`Error: Order #${orderId} not found.`);
        }

        function loadSystemStats() {
            const systemStats = document.getElementById('systemStats');
            const totalOrders = state.orders.length; const totalRevenue = state.orders.reduce((sum, order) => sum + order.total, 0); const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            const pendingOrders = state.orders.filter(o => o.status === 'pending').length; const preparingOrders = state.orders.filter(o => o.status === 'preparing').length; const readyOrders = state.orders.filter(o => o.status === 'ready').length; const servedOrders = state.orders.filter(o => o.status === 'served').length; const cancelledOrders = state.orders.filter(o => o.status === 'cancelled').length;
            systemStats.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;"><div style="background-color: var(--light); padding: 15px; border-radius: 8px;"><div style="font-size: 24px; font-weight: 600; color: var(--primary);">${totalOrders}</div><div style="font-size: 14px; color: var(--gray);">Total Orders</div></div><div style="background-color: var(--light); padding: 15px; border-radius: 8px;"><div style="font-size: 24px; font-weight: 600; color: var(--primary);">$${totalRevenue.toFixed(2)}</div><div style="font-size: 14px; color: var(--gray);">Total Revenue</div></div><div style="background-color: var(--light); padding: 15px; border-radius: 8px;"><div style="font-size: 24px; font-weight: 600; color: var(--primary);">$${avgOrderValue.toFixed(2)}</div><div style="font-size: 14px; color: var(--gray);">Average Order</div></div><div style="background-color: var(--light); padding: 15px; border-radius: 8px;"><div style="font-size: 24px; font-weight: 600; color: var(--primary);">${state.menuItems.length}</div><div style="font-size: 14px; color: var(--gray);">Menu Items</div></div><div style="background-color: var(--light); padding: 15px; border-radius: 8px;"><div style="font-size: 24px; font-weight: 600; color: var(--primary);">${state.categories.length}</div><div style="font-size: 14px; color: var(--gray);">Categories</div></div></div><div style="margin-top: 20px;"><h5 style="margin-bottom: 10px;">Order Status Distribution</h5><div style="display: flex; gap: 10px; flex-wrap: wrap;"><div style="display: flex; align-items: center; gap: 5px;"><div style="width: 12px; height: 12px; background-color: #fff3cd; border-radius: 2px;"></div><span>Pending: ${pendingOrders}</span></div><div style="display: flex; align-items: center; gap: 5px;"><div style="width: 12px; height: 12px; background-color: #d1ecf1; border-radius: 2px;"></div><span>Preparing: ${preparingOrders}</span></div><div style="display: flex; align-items: center; gap: 5px;"><div style="width: 12px; height: 12px; background-color: #d4edda; border-radius: 2px;"></div><span>Ready: ${readyOrders}</span></div><div style="display: flex; align-items: center; gap: 5px;"><div style="width: 12px; height: 12px; background-color: #cce5ff; border-radius: 2px;"></div><span>Served: ${servedOrders}</span></div><div style="display: flex; align-items: center; gap: 5px;"><div style="width: 12px; height: 12px; background-color: #f8d7da; border-radius: 2px;"></div><span>Cancelled: ${cancelledOrders}</span></div></div></div>`;
        }
        function exportData() {
            const data = { restaurantInfo: state.restaurantInfo, menuItems: state.menuItems, orders: state.orders, categories: state.categories, customization: state.customization, exportDate: new Date().toISOString() };
            const dataStr = JSON.stringify(data, null, 2); const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `dineeasy-backup-${new Date().toISOString().split('T')[0]}.json`;
            const linkElement = document.createElement('a'); linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', exportFileDefaultName); linkElement.click(); showNotification("Data exported successfully.");
        }
        async function importData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try { const importedData = JSON.parse(e.target.result); if (confirm("Importing data will replace ALL current data. Are you sure?")) { if (importedData.restaurantInfo) state.restaurantInfo = importedData.restaurantInfo; if (importedData.menuItems) state.menuItems = importedData.menuItems; if (importedData.orders) state.orders = importedData.orders; if (importedData.categories) state.categories = importedData.categories; if (importedData.customization) state.customization = importedData.customization; await saveToFirestore(); updateRestaurantUI(); displayMenuItems('all'); updateCategoryTabs(); applyCustomization(); loadMenuItemsForAdmin(); loadCategoriesForAdmin(); loadOrdersForAdmin(); loadSystemStats(); showNotification("Data imported successfully."); } } catch (error) { showNotification("Error importing data. Invalid file format."); }
            }; reader.readAsText(file); event.target.value = '';
        }

        // ========== CUSTOMIZATION (themes, fonts) ==========
        function loadCustomizationSettings() {}
        function initializeCustomizationTab() {
            const themeGallery = document.getElementById('themeGallery'); themeGallery.innerHTML = '';
            Object.entries(themes).forEach(([themeId, theme]) => {
                const themeElement = document.createElement('div');
                themeElement.className = `theme-card ${themeId === state.currentTheme ? 'selected' : ''}`;
                themeElement.setAttribute('data-theme', themeId);
                themeElement.innerHTML = `<div class="theme-colors-preview"><div style="background-color: ${theme.primary};"></div><div style="background-color: ${theme.secondary};"></div><div style="background-color: ${theme.background};"></div><div style="background-color: ${theme.text};"></div><div style="background-color: ${theme.cardBg};"></div></div><div class="theme-info"><div class="theme-name">${theme.name}</div><span class="theme-category">${theme.category}</span><div class="theme-preview-small"><div style="background-color: ${theme.primary};"></div><div style="background-color: ${theme.secondary};"></div><div style="background-color: ${theme.lightGray};"></div></div></div>`;
                themeElement.addEventListener('click', function() { document.querySelectorAll('#themeGallery .theme-card').forEach(t => t.classList.remove('selected')); this.classList.add('selected'); document.getElementById('currentThemeName').textContent = theme.name; document.getElementById('currentThemeCategory').textContent = theme.category; });
                themeGallery.appendChild(themeElement);
            });
            document.getElementById('applyThemeBtn').addEventListener('click', function() { const selectedTheme = document.querySelector('#themeGallery .theme-card.selected'); if (selectedTheme) { const themeId = selectedTheme.getAttribute('data-theme'); applyTheme(themeId); } });
            const fontOptions = document.getElementById('fontOptions'); fontOptions.innerHTML = '';
            Object.entries(fonts).forEach(([fontId, font]) => {
                const fontElement = document.createElement('div');
                fontElement.className = `font-option ${fontId === state.currentFont ? 'selected' : ''}`;
                fontElement.setAttribute('data-font', fontId); fontElement.setAttribute('data-primary', font.primary); fontElement.setAttribute('data-secondary', font.secondary);
                fontElement.innerHTML = `<div class="font-preview-large" style="font-family: ${font.primary.replace(/'/g, '')};">${font.name}</div><div class="font-details"><div style="font-family: ${font.primary.replace(/'/g, '')}; margin-bottom: 5px;">The quick brown fox</div><div style="font-family: ${font.secondary.replace(/'/g, '')}; font-style: italic;">Elegant restaurant menu</div></div>`;
                fontElement.addEventListener('click', function() { document.querySelectorAll('#fontOptions .font-option').forEach(f => f.classList.remove('selected')); this.classList.add('selected'); document.getElementById('currentFontName').textContent = font.name; });
                fontOptions.appendChild(fontElement);
            });
            document.getElementById('applyFontBtn').addEventListener('click', function() { const selectedFont = document.querySelector('#fontOptions .font-option.selected'); if (selectedFont) { const fontId = selectedFont.getAttribute('data-font'); const fontPrimary = selectedFont.getAttribute('data-primary'); const fontSecondary = selectedFont.getAttribute('data-secondary'); applyFont(fontId, fontPrimary, fontSecondary); } });
            const colorCustomization = document.getElementById('colorCustomization'); colorCustomization.innerHTML = '';
            importantColors.forEach(colorInfo => {
                const colorElement = document.createElement('div'); colorElement.className = 'color-option';
                colorElement.innerHTML = `<div class="color-label">${colorInfo.label}</div><div class="color-preview" style="background-color: ${state.customization[colorInfo.id]};"></div><div class="color-input-group"><input type="color" class="color-input" id="color-${colorInfo.id}" value="${state.customization[colorInfo.id]}"><div class="color-value">${state.customization[colorInfo.id]}</div></div>`;
                const colorInput = colorElement.querySelector('.color-input'); const colorValue = colorElement.querySelector('.color-value'); const colorPreview = colorElement.querySelector('.color-preview');
                colorInput.addEventListener('input', function() { const value = this.value; colorValue.textContent = value; colorPreview.style.backgroundColor = value; state.customization[colorInfo.id] = value; state.currentTheme = "custom"; document.querySelectorAll('#themeGallery .theme-card').forEach(t => t.classList.remove('selected')); document.getElementById('currentThemeName').textContent = "Custom"; document.getElementById('currentThemeCategory').textContent = "Custom"; applyCustomization(); });
                colorCustomization.appendChild(colorElement);
            });
            document.getElementById('resetCustomizationBtn').addEventListener('click', function() { if (confirm("Reset all visual customization to default values?")) { resetCustomization(); setTimeout(() => { initializeCustomizationTab(); }, 100); } });
            document.getElementById('saveCustomizationBtn').addEventListener('click', saveCustomization);
            const currentTheme = themes[state.currentTheme]; if (currentTheme) { document.getElementById('currentThemeName').textContent = currentTheme.name; document.getElementById('currentThemeCategory').textContent = currentTheme.category; } else { document.getElementById('currentThemeName').textContent = "Custom"; document.getElementById('currentThemeCategory').textContent = "Custom"; }
            document.getElementById('currentFontName').textContent = fonts[state.currentFont] ? fonts[state.currentFont].name : "Poppins";
        }
        function applyTheme(themeId) { if (!themes[themeId]) return; const theme = themes[themeId]; state.currentTheme = themeId; state.customization.primary = theme.primary; state.customization.primaryDark = darkenColor(theme.primary, 20); state.customization.secondary = theme.secondary; state.customization.background = theme.background; state.customization.text = theme.text; state.customization.cardBg = theme.cardBg; state.customization.lightGray = theme.lightGray; state.customization.buttonText = getContrastColor(theme.primary); applyCustomization(); updateColorInputs(); document.querySelectorAll('#themeGallery .theme-card').forEach(t => t.classList.remove('selected')); const selectedTheme = document.querySelector(`#themeGallery .theme-card[data-theme="${themeId}"]`); if (selectedTheme) { selectedTheme.classList.add('selected'); document.getElementById('currentThemeName').textContent = theme.name; document.getElementById('currentThemeCategory').textContent = theme.category; } showNotification(`"${theme.name}" theme applied.`); }
        function applyFont(fontId, fontPrimary, fontSecondary) { state.currentFont = fontId; state.customization.fontPrimary = fontPrimary; state.customization.fontSecondary = fontSecondary; applyCustomization(); document.querySelectorAll('#fontOptions .font-option').forEach(f => f.classList.remove('selected')); const selectedFont = document.querySelector(`#fontOptions .font-option[data-font="${fontId}"]`); if (selectedFont) { selectedFont.classList.add('selected'); document.getElementById('currentFontName').textContent = fonts[fontId].name; } showNotification(`"${fonts[fontId].name}" font applied.`); }
        function updateColorInputs() { importantColors.forEach(colorInfo => { const colorInput = document.getElementById(`color-${colorInfo.id}`); if (colorInput) { const colorValue = colorInput.parentElement.querySelector('.color-value'); const colorPreview = colorInput.parentElement.parentElement.querySelector('.color-preview'); if (colorInput && colorValue && colorPreview) { colorInput.value = state.customization[colorInfo.id]; colorValue.textContent = state.customization[colorInfo.id]; colorPreview.style.backgroundColor = state.customization[colorInfo.id]; } } }); }
        async function saveCustomization() { await saveToFirestore(); showNotification("Visual customization saved."); }
        function resetCustomization() {
            state.customization = { primary: "#e63946", primaryDark: "#c1121f", secondary: "#457b9d", light: "#f8f9fa", dark: "#212529", gray: "#6c757d", lightGray: "#e9ecef", success: "#2a9d8f", warning: "#e9c46a", danger: "#dc3545", shadow: "0 4px 12px rgba(0, 0, 0, 0.08)", radius: "12px", background: "#fefefe", text: "#212529", cardBg: "#ffffff", headerBg: "#ffffff", menuBg: "#ffffff", cartBg: "#ffffff", paymentBg: "#ffffff", buttonText: "#ffffff", fontPrimary: "'Poppins', sans-serif", fontSecondary: "'Playfair Display', serif" };
            state.currentTheme = "default"; state.currentFont = "poppins"; applyCustomization(); showNotification("Customization reset to default.");
        }
        function darkenColor(color, percent) { const num = parseInt(color.replace("#", ""), 16); const amt = Math.round(2.55 * percent); const R = (num >> 16) - amt; const G = (num >> 8 & 0x00FF) - amt; const B = (num & 0x0000FF) - amt; return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1); }
        function getContrastColor(hexcolor) { const r = parseInt(hexcolor.substr(1, 2), 16); const g = parseInt(hexcolor.substr(3, 2), 16); const b = parseInt(hexcolor.substr(5, 2), 16); const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000; return (yiq >= 128) ? '#000000' : '#ffffff'; }

        // ========== MODAL ADMIN (simplified) – also need drag drop here, but we'll do separately if needed ==========
        function setupAdminPanel() {
            adminClose.addEventListener('click', () => adminPanel.style.display = 'none');
            document.querySelectorAll('#adminPanel .admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('#adminPanel .admin-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('#adminPanel .admin-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + 'TabModal').classList.add('active');
                    if (tabId === 'customization') setTimeout(() => initializeModalCustomizationTab(), 100);
                    if (tabId === 'menu') setTimeout(() => {
                        // Also make modal menu items draggable
                        makeAdminGridDraggable('menuItemsListModal');
                    }, 500);
                });
            });
            document.getElementById('adminRestaurantNameModal').value = state.restaurantInfo.name;
            document.getElementById('adminTaxRateModal').value = state.restaurantInfo.taxRate;
            document.getElementById('adminPrepTimeModal').value = state.restaurantInfo.estimatedPrepTime;
            document.getElementById('adminWelcomeMessageModal').value = state.restaurantInfo.welcomeMessage || '';
            updateLogoPreview();
            
            // Load menu items for modal with drag drop
            loadMenuItemsForAdminModal();
        }

        function loadMenuItemsForAdminModal() {
            const menuItemsList = document.getElementById('menuItemsListModal'); 
            if (!menuItemsList) return;
            menuItemsList.innerHTML = '';
            if (state.menuItems.length === 0) { menuItemsList.innerHTML = '<p style="text-align: center; color: var(--gray);">No menu items found.</p>'; return; }
            const sortedItems = [...state.menuItems].sort((a,b) => (a.displayOrder || 0) - (b.displayOrder || 0));
            sortedItems.forEach(item => {
                const itemCard = document.createElement('div'); itemCard.className = 'admin-card';
                itemCard.setAttribute('draggable', 'true');
                itemCard.setAttribute('data-item-id', item.id);
                const hasImage = item.image && item.image.trim() !== '';
                const imageContent = hasImage ? `<div style="height: 120px; background-image: url('${item.image}'); background-size: cover; background-position: center; border-radius: 8px; margin-bottom: 10px;"></div>` : `<div style="height: 120px; background-color: var(--light-gray); border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: var(--gray);"><i class="fas fa-utensils"></i></div>`;
                itemCard.innerHTML = `<div style="display:flex; align-items:center; margin-bottom:5px;"><i class="fas fa-grip-vertical drag-handle"></i></div>${imageContent}<div class="admin-card-header"><div class="admin-card-title">${item.name}</div><div class="admin-card-actions"><button class="admin-small-btn btn-primary edit-item-modal" data-id="${item.id}"><i class="fas fa-edit"></i></button><button class="admin-small-btn btn-secondary duplicate-item-modal" data-id="${item.id}"><i class="fas fa-copy"></i></button><button class="admin-small-btn btn-danger delete-item-modal" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div><p style="margin-bottom: 10px; font-size: 14px;">${item.description}</p><div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-weight: 600; color: var(--primary);">$${item.price.toFixed(2)}</span><span style="font-size: 12px; color: var(--gray);">${getCategoryDisplayName(item.category)}</span></div><div class="tag-display">${item.tags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}</div>`;
                if (item.options && item.options.length) {
                    itemCard.innerHTML += `<div style="margin-top:10px; font-size:12px; color:var(--secondary);"><i class="fas fa-tasks"></i> ${item.options.length} option group(s)</div>`;
                }
                menuItemsList.appendChild(itemCard);
            });
            document.querySelectorAll('.edit-item-modal').forEach(btn => { btn.addEventListener('click', function() { const itemId = parseInt(this.getAttribute('data-id')); openEditMenuItemForm(itemId); adminPanel.style.display = 'none'; }); });
            document.querySelectorAll('.duplicate-item-modal').forEach(btn => { btn.addEventListener('click', function() { const itemId = parseInt(this.getAttribute('data-id')); duplicateMenuItem(itemId); }); });
            document.querySelectorAll('.delete-item-modal').forEach(btn => { btn.addEventListener('click', function() { const itemId = parseInt(this.getAttribute('data-id')); showAdminChangePrompt(() => deleteMenuItem(itemId)); }); });
            
            makeAdminGridDraggable('menuItemsListModal');
        }

        function initializeModalCustomizationTab() {
            const themeGalleryModal = document.getElementById('themeGalleryModal'); if (!themeGalleryModal) return;
            themeGalleryModal.innerHTML = '';
            const modalThemes = Object.entries(themes).slice(0, 8);
            modalThemes.forEach(([themeId, theme]) => {
                const themeElement = document.createElement('div');
                themeElement.className = `theme-card ${themeId === state.currentTheme ? 'selected' : ''}`;
                themeElement.setAttribute('data-theme', themeId);
                themeElement.innerHTML = `<div class="theme-colors-preview"><div style="background-color: ${theme.primary};"></div><div style="background-color: ${theme.secondary};"></div><div style="background-color: ${theme.background};"></div><div style="background-color: ${theme.text};"></div><div style="background-color: ${theme.cardBg};"></div></div><div class="theme-info"><div class="theme-name">${theme.name}</div><span class="theme-category">${theme.category}</span></div>`;
                themeElement.addEventListener('click', function() { document.querySelectorAll('#themeGalleryModal .theme-card').forEach(t => t.classList.remove('selected')); this.classList.add('selected'); });
                themeGalleryModal.appendChild(themeElement);
            });
            const fontOptionsModal = document.getElementById('fontOptionsModal'); if (!fontOptionsModal) return;
            fontOptionsModal.innerHTML = '';
            Object.entries(fonts).forEach(([fontId, font]) => {
                const fontElement = document.createElement('div');
                fontElement.className = `font-option ${fontId === state.currentFont ? 'selected' : ''}`;
                fontElement.setAttribute('data-font', fontId);
                fontElement.innerHTML = `<div class="font-preview-large" style="font-family: ${font.primary.replace(/'/g, '')};">${font.name}</div>`;
                fontElement.addEventListener('click', function() { document.querySelectorAll('#fontOptionsModal .font-option').forEach(f => f.classList.remove('selected')); this.classList.add('selected'); });
                fontOptionsModal.appendChild(fontElement);
            });
            document.getElementById('resetCustomizationBtnModal').addEventListener('click', function() { if (confirm("Reset all visual customization to default values?")) { resetCustomization(); setTimeout(() => initializeModalCustomizationTab(), 100); showNotification("Customization reset in modal."); } });
            document.getElementById('saveCustomizationBtnModal').addEventListener('click', function() {
                const selectedTheme = document.querySelector('#themeGalleryModal .theme-card.selected'); if (selectedTheme) { const themeId = selectedTheme.getAttribute('data-theme'); applyTheme(themeId); }
                const selectedFont = document.querySelector('#fontOptionsModal .font-option.selected'); if (selectedFont) { const fontId = selectedFont.getAttribute('data-font'); const font = fonts[fontId]; if (font) applyFont(fontId, font.primary, font.secondary); }
                saveCustomization(); showNotification("Customization saved from modal.");
            });
        }

        // ========== INITIALIZATION ==========
        async function initApp() {
            await loadFromFirestore();
            applyCustomization();
            updateRestaurantUI();
            updateCategoryTabs();
            displayMenuItems('all');
            setupAdminPanel();

            // ---- PERMANENT ORDERS LISTENER FOR REAL‑TIME CUSTOMER UPDATES ----
            if (!state.ordersListener) {
                state.ordersListener = db.collection('orders').onSnapshot((snapshot) => {
                    state.orders = snapshot.docs.map(doc => ({
                        ...doc.data(),
                        orderNumber: doc.id
                    }));
                    // Refresh "My Orders" if the customer is viewing it and not in admin mode
                    if (!state.isAdminMode && document.querySelector('#myOrdersSection.active-section')) {
                        loadMyOrders();
                    }
                }, (error) => {
                    console.error("Permanent orders snapshot error:", error);
                });
            }

            // Event listeners
            document.querySelectorAll('.table-btn').forEach(btn => btn.addEventListener('click', function() { selectTable(this.getAttribute('data-table')); }));
            cartFloating.addEventListener('click', function() { if (!state.isAdminMode) showSection('cartSection'); });
            document.getElementById('backToMenuBtn').addEventListener('click', () => showSection('menuSection'));
            document.getElementById('proceedToPaymentBtn').addEventListener('click', function() { if (state.cart.length === 0) { showNotification('Please add items to your cart before proceeding to payment'); return; } updatePaymentSummary(); showSection('paymentSection'); });
            document.getElementById('backToCartBtn').addEventListener('click', () => showSection('cartSection'));
            document.querySelectorAll('.option-card[data-payment]').forEach(card => { card.addEventListener('click', function() { document.querySelectorAll('.option-card[data-payment]').forEach(c => c.classList.remove('selected')); this.classList.add('selected'); state.selectedPaymentMethod = this.getAttribute('data-payment'); }); });
            document.querySelectorAll('.option-card[data-time]').forEach(card => { card.addEventListener('click', function() { document.querySelectorAll('.option-card[data-time]').forEach(c => c.classList.remove('selected')); this.classList.add('selected'); state.selectedPaymentTime = this.getAttribute('data-time'); }); });
            document.getElementById('confirmPaymentBtn').addEventListener('click', async function() {
                if (!state.selectedPaymentMethod) { showNotification('Please select a payment method'); return; }
                if (!state.selectedPaymentTime) { showNotification('Please select when you want to pay'); return; }
                const orderNumber = generateOrderNumber(); state.currentOrderNumber = orderNumber;
                const orderTotal = calculateTotal(); const orderSubtotal = calculateSubtotal();
                const order = {
                    orderNumber: orderNumber,
                    table: state.currentTable,
                    items: state.cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        basePrice: item.basePrice,
                        selectedOptions: item.selectedOptions
                    })),
                    paymentMethod: state.selectedPaymentMethod,
                    paymentTime: state.selectedPaymentTime,
                    subtotal: orderSubtotal,
                    total: orderTotal,
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    customerNotes: ""
                };
                state.orders.push(order);
                await saveToFirestore();
                showOrderConfirmation(order);
                showSection('confirmationSection');
                showNotification(`Order #${orderNumber} confirmed!`);
                resetCart();
            });
            document.getElementById('newOrderBtn').addEventListener('click', function() { resetOrder(); showSection('scannerSection'); });
            document.getElementById('viewMyOrdersBtn').addEventListener('click', function() { loadMyOrders(); showSection('myOrdersSection'); });
            document.getElementById('viewMenuBtn').addEventListener('click', function() { resetCart(); state.selectedPaymentMethod = null; state.selectedPaymentTime = null; document.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected')); if (state.currentTable) menuSubtitle.textContent = `Start a new order for ${state.currentTable}`; showSection('menuSection'); showNotification('Ready to start a new order!'); });
            document.getElementById('needHelpBtn').addEventListener('click', showHelpNotification);
            headerHelpButton.addEventListener('click', showHelpNotification);
            myOrdersButton.addEventListener('click', function() { loadMyOrders(); showSection('myOrdersSection'); });
            document.getElementById('backToMenuFromOrdersBtn').addEventListener('click', () => showSection('menuSection'));
            document.getElementById('placeNewOrderBtn').addEventListener('click', function() { resetCart(); showSection('menuSection'); });
            submitAdminCodeBtn.addEventListener('click', function() { const enteredCode = adminCodeInput.value; if (enteredCode === state.adminAccessCode) { adminCodePrompt.style.display = 'none'; adminCodeInput.value = ''; enterAdminMode(); } else { showNotification("Incorrect admin code."); adminCodeInput.value = ''; adminCodeInput.focus(); } });
            cancelAdminCodeBtn.addEventListener('click', function() { adminCodePrompt.style.display = 'none'; adminCodeInput.value = ''; showSection('scannerSection'); });
            submitChangeCodeBtn.addEventListener('click', function() { const enteredCode = adminChangeCodeInput.value; if (enteredCode === state.adminChangeCode) { adminChangePrompt.style.display = 'none'; adminChangeCodeInput.value = ''; if (state.pendingAdminAction && typeof state.pendingAdminAction === 'function') { state.pendingAdminAction(); } state.pendingAdminAction = null; } else { showNotification("Incorrect confirmation code."); adminChangeCodeInput.value = ''; adminChangeCodeInput.focus(); } });
            cancelChangeBtn.addEventListener('click', function() { adminChangePrompt.style.display = 'none'; adminChangeCodeInput.value = ''; state.pendingAdminAction = null; showNotification("Changes cancelled."); });
            if (localStorage.getItem('dineEasyAdminMode') === 'true') { showAdminCodePrompt(); }
        }
        initApp();
    </script>
</body>
</html>
